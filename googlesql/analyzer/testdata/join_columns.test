[default use_database=TpchCatalog]
FROM Nation
--
ERROR: Table Nation has column Region with unsupported ROW type [at 1:6]
FROM Nation
     ^
==

# TODO Get the default test modes working.
[default no_run_deserializer]
[default no_run_sqlbuilder]
[default language_features=MAXIMUM,+ROW_TYPE]
[default enabled_ast_rewrites=DEFAULTS]
# This works because the join columns are pseudo-columns and they get pruned,
# so it isn't trying to return ROW types.
FROM Nation
--
QueryStmt
+-output_column_list=
| +-Nation.N_NATIONKEY#1 AS N_NATIONKEY [UINT64]
| +-Nation.N_NAME#2 AS N_NAME [STRING]
| +-Nation.N_REGIONKEY#3 AS N_REGIONKEY [UINT64]
| +-Nation.N_COMMENT#4 AS N_COMMENT [STRING]
+-query=
  +-TableScan(column_list=Nation.[N_NATIONKEY#1, N_NAME#2, N_REGIONKEY#3, N_COMMENT#4], table=Nation, column_index_list=[0, 1, 2, 3])
==

[enabled_ast_rewrites=NONE]
FROM Nation
|> DESCRIBE
--
QueryStmt
+-output_column_list=
| +-$pipe_describe.Describe#8 AS Describe [STRING]
+-query=
  +-DescribeScan
    +-column_list=[$pipe_describe.Describe#8]
    +-input_scan=
    | +-TableScan(table=Nation)
    +-describe_expr=
      +-Describe#8 := Literal(type=STRING, value="**Columns**:\nTable Alias  Column Name  Type\n-----------  -----------  ------\nNation       N_NATIONKEY  UINT64\nNation       N_NAME       STRING\nNation       N_REGIONKEY  UINT64\nNation       N_COMMENT    STRING\n\n**Pseudo-columns**:\nTable Alias  Column Name  Type\n-----------  -----------  ------------------\nNation       Customers    MULTIROW<Customer>\nNation       Region       ROW<Region>\nNation       Suppliers    MULTIROW<Supplier>\n\n**Table Aliases**:\nTable Alias  Columns                                      Pseudo-columns\n-----------  -------------------------------------------  ----------------------------\nNation       N_NATIONKEY, N_NAME, N_REGIONKEY, N_COMMENT  Customers, Region, Suppliers\n")

[DESCRIBE output]
**Columns**:
Table Alias  Column Name  Type
\-----------  -----------  ------
Nation       N_NATIONKEY  UINT64
Nation       N_NAME       STRING
Nation       N_REGIONKEY  UINT64
Nation       N_COMMENT    STRING

**Pseudo-columns**:
Table Alias  Column Name  Type
\-----------  -----------  ------------------
Nation       Customers    MULTIROW<Customer>
Nation       Region       ROW<Region>
Nation       Suppliers    MULTIROW<Supplier>

**Table Aliases**:
Table Alias  Columns                                      Pseudo-columns
\-----------  -------------------------------------------  ----------------------------
Nation       N_NATIONKEY, N_NAME, N_REGIONKEY, N_COMMENT  Customers, Region, Suppliers
\
==

FROM Nation n
|> SELECT n.Region
--
ERROR: Returning expressions of type ROW is not allowed [at 1:1]
FROM Nation n
^
==

FROM Nation n
|> SELECT n.Region r
|> SELECT r.r_name
--
QueryStmt
+-output_column_list=
| +-$pipe_select.r_name#8 AS r_name [STRING]
+-query=
  +-ProjectScan
    +-column_list=[$pipe_select.r_name#8]
    +-expr_list=
    | +-r_name#8 :=
    |   +-GetRowField
    |     +-type=STRING
    |     +-expr=
    |     | +-ColumnRef(type=ROW<Region (join)>, column=Nation.Region#5)
    |     +-column=Region.R_NAME
    +-input_scan=
      +-ProjectScan
        +-column_list=[Nation.Region#5]
        +-input_scan=
          +-TableScan(column_list=[Nation.Region#5], table=Nation, column_index_list=[4], alias="n")


[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-$pipe_select.r_name#8 AS r_name [STRING]
+-query=
  +-ProjectScan
    +-column_list=[$pipe_select.r_name#8]
    +-expr_list=
    | +-r_name#8 :=
    |   +-SubqueryExpr
    |     +-type=STRING
    |     +-subquery_type=SCALAR
    |     +-parameter_list=
    |     | +-ColumnRef(type=STRUCT<R_REGIONKEY UINT64>, column=Nation.$Region$join_row#11)
    |     +-subquery=
    |       +-FilterScan
    |         +-column_list=[Region.R_NAME#10]
    |         +-input_scan=
    |         | +-TableScan(column_list=Region.[R_REGIONKEY#9, R_NAME#10], table=Region, table_column_list=[Region.R_REGIONKEY,Region.R_NAME])
    |         +-filter_expr=
    |           +-FunctionCall(GoogleSQL:$equal(STRUCT<R_REGIONKEY UINT64>, STRUCT<R_REGIONKEY UINT64>) -> BOOL)
    |             +-MakeStruct
    |             | +-type=STRUCT<R_REGIONKEY UINT64>
    |             | +-field_list=
    |             |   +-ColumnRef(type=UINT64, column=Region.R_REGIONKEY#9)
    |             +-ColumnRef(type=STRUCT<R_REGIONKEY UINT64>, column=Nation.$Region$join_row#11, is_correlated=TRUE)
    +-input_scan=
      +-ProjectScan
        +-column_list=[Nation.$Region$join_row#11]
        +-input_scan=
          +-ProjectScan
            +-column_list=[Nation.$Region$join_row#11]
            +-expr_list=
            | +-$Region$join_row#11 :=
            |   +-MakeStruct
            |     +-type=STRUCT<R_REGIONKEY UINT64>
            |     +-field_list=
            |       +-ColumnRef(type=UINT64, column=Nation.N_REGIONKEY#12)
            +-input_scan=
              +-TableScan(column_list=[Nation.N_REGIONKEY#12], table=Nation, alias="n", table_column_list=[Nation.N_REGIONKEY])
==

FROM Nation n
|> SELECT n.n_name, n.Region.r_name
--
QueryStmt
+-output_column_list=
| +-Nation.N_NAME#2 AS n_name [STRING]
| +-$pipe_select.r_name#8 AS r_name [STRING]
+-query=
  +-ProjectScan
    +-column_list=[Nation.N_NAME#2, $pipe_select.r_name#8]
    +-expr_list=
    | +-r_name#8 :=
    |   +-GetRowField
    |     +-type=STRING
    |     +-expr=
    |     | +-ColumnRef(type=ROW<Region (join)>, column=Nation.Region#5)
    |     +-column=Region.R_NAME
    +-input_scan=
      +-TableScan(column_list=Nation.[N_NAME#2, Region#5], table=Nation, column_index_list=[1, 4], alias="n")


[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-Nation.N_NAME#2 AS n_name [STRING]
| +-$pipe_select.r_name#8 AS r_name [STRING]
+-query=
  +-ProjectScan
    +-column_list=[Nation.N_NAME#2, $pipe_select.r_name#8]
    +-expr_list=
    | +-r_name#8 :=
    |   +-SubqueryExpr
    |     +-type=STRING
    |     +-subquery_type=SCALAR
    |     +-parameter_list=
    |     | +-ColumnRef(type=STRUCT<R_REGIONKEY UINT64>, column=Nation.$Region$join_row#11)
    |     +-subquery=
    |       +-FilterScan
    |         +-column_list=[Region.R_NAME#10]
    |         +-input_scan=
    |         | +-TableScan(column_list=Region.[R_REGIONKEY#9, R_NAME#10], table=Region, table_column_list=[Region.R_REGIONKEY,Region.R_NAME])
    |         +-filter_expr=
    |           +-FunctionCall(GoogleSQL:$equal(STRUCT<R_REGIONKEY UINT64>, STRUCT<R_REGIONKEY UINT64>) -> BOOL)
    |             +-MakeStruct
    |             | +-type=STRUCT<R_REGIONKEY UINT64>
    |             | +-field_list=
    |             |   +-ColumnRef(type=UINT64, column=Region.R_REGIONKEY#9)
    |             +-ColumnRef(type=STRUCT<R_REGIONKEY UINT64>, column=Nation.$Region$join_row#11, is_correlated=TRUE)
    +-input_scan=
      +-ProjectScan
        +-column_list=Nation.[N_NAME#2, $Region$join_row#11]
        +-expr_list=
        | +-$Region$join_row#11 :=
        |   +-MakeStruct
        |     +-type=STRUCT<R_REGIONKEY UINT64>
        |     +-field_list=
        |       +-ColumnRef(type=UINT64, column=Nation.N_REGIONKEY#12)
        +-input_scan=
          +-TableScan(column_list=Nation.[N_NAME#2, N_REGIONKEY#12], table=Nation, alias="n", table_column_list=[Nation.N_NAME,Nation.N_REGIONKEY])
==

FROM Nation n
|> SELECT n.Region.xxx
--
ERROR: Table Region does not have a column xxx [at 2:20]
|> SELECT n.Region.xxx
                   ^
==

FROM Region r
|> SELECT r.Nations.xxx
--
ERROR: Cannot access fields on an expression with type MULTIROW<Nation>; Fields of MULTIROW columns can be read in JOIN, UNNEST, and FLATTEN [at 2:21]
|> SELECT r.Nations.xxx
                    ^
==

FROM Region r
|> SELECT r.Nations.n_name
--
ERROR: Cannot access fields on an expression with type MULTIROW<Nation>; Fields of MULTIROW columns can be read in JOIN, UNNEST, and FLATTEN [at 2:21]
|> SELECT r.Nations.n_name
                    ^
==

FROM LineItem li
|> SELECT li.Order.Customer.Nation.n_name
--
QueryStmt
+-output_column_list=
| +-$pipe_select.n_name#22 AS n_name [STRING]
+-query=
  +-ProjectScan
    +-column_list=[$pipe_select.n_name#22]
    +-expr_list=
    | +-n_name#22 :=
    |   +-GetRowField
    |     +-type=STRING
    |     +-expr=
    |     | +-GetRowField
    |     |   +-type=ROW<Nation (join)>
    |     |   +-expr=
    |     |   | +-GetRowField
    |     |   |   +-type=ROW<Customer (join)>
    |     |   |   +-expr=
    |     |   |   | +-ColumnRef(type=ROW<Orders (join)>, column=LineItem.Order#17)
    |     |   |   +-column=Orders.Customer
    |     |   +-column=Customer.Nation
    |     +-column=Nation.N_NAME
    +-input_scan=
      +-TableScan(column_list=[LineItem.Order#17], table=LineItem, column_index_list=[16], alias="li")


[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-$pipe_select.n_name#22 AS n_name [STRING]
+-query=
  +-ProjectScan
    +-column_list=[$pipe_select.n_name#22]
    +-expr_list=
    | +-n_name#22 :=
    |   +-SubqueryExpr
    |     +-type=STRING
    |     +-subquery_type=SCALAR
    |     +-parameter_list=
    |     | +-ColumnRef(type=STRUCT<O_ORDERKEY UINT64>, column=LineItem.$Order$join_row#35)
    |     +-subquery=
    |       +-ProjectScan
    |         +-column_list=[$with_expr.injected#38]
    |         +-expr_list=
    |         | +-injected#38 :=
    |         |   +-SubqueryExpr
    |         |     +-type=STRING
    |         |     +-subquery_type=SCALAR
    |         |     +-parameter_list=
    |         |     | +-ColumnRef(type=STRUCT<N_NATIONKEY UINT64>, column=$with_expr.$with_col#32)
    |         |     +-subquery=
    |         |       +-FilterScan
    |         |         +-column_list=[Nation.N_NAME#34]
    |         |         +-input_scan=
    |         |         | +-TableScan(column_list=Nation.[N_NATIONKEY#33, N_NAME#34], table=Nation, table_column_list=[Nation.N_NATIONKEY,Nation.N_NAME])
    |         |         +-filter_expr=
    |         |           +-FunctionCall(GoogleSQL:$equal(STRUCT<N_NATIONKEY UINT64>, STRUCT<N_NATIONKEY UINT64>) -> BOOL)
    |         |             +-MakeStruct
    |         |             | +-type=STRUCT<N_NATIONKEY UINT64>
    |         |             | +-field_list=
    |         |             |   +-ColumnRef(type=UINT64, column=Nation.N_NATIONKEY#33)
    |         |             +-ColumnRef(type=STRUCT<N_NATIONKEY UINT64>, column=$with_expr.$with_col#32, is_correlated=TRUE)
    |         +-input_scan=
    |           +-ProjectScan
    |             +-column_list=[$with_expr.$with_col#32]
    |             +-expr_list=
    |             | +-$with_col#32 :=
    |             |   +-SubqueryExpr
    |             |     +-type=STRUCT<N_NATIONKEY UINT64>
    |             |     +-subquery_type=SCALAR
    |             |     +-parameter_list=
    |             |     | +-ColumnRef(type=STRUCT<O_ORDERKEY UINT64>, column=LineItem.$Order$join_row#35, is_correlated=TRUE)
    |             |     +-subquery=
    |             |       +-ProjectScan
    |             |         +-column_list=[$with_expr.injected#37]
    |             |         +-expr_list=
    |             |         | +-injected#37 :=
    |             |         |   +-SubqueryExpr
    |             |         |     +-type=STRUCT<N_NATIONKEY UINT64>
    |             |         |     +-subquery_type=SCALAR
    |             |         |     +-parameter_list=
    |             |         |     | +-ColumnRef(type=STRUCT<C_CUSTKEY UINT64>, column=$with_expr.$with_col#27)
    |             |         |     +-subquery=
    |             |         |       +-FilterScan
    |             |         |         +-column_list=[Customer.$Nation$join_row#30]
    |             |         |         +-input_scan=
    |             |         |         | +-ProjectScan
    |             |         |         |   +-column_list=Customer.[C_CUSTKEY#28, $Nation$join_row#30]
    |             |         |         |   +-expr_list=
    |             |         |         |   | +-$Nation$join_row#30 :=
    |             |         |         |   |   +-MakeStruct
    |             |         |         |   |     +-type=STRUCT<N_NATIONKEY UINT64>
    |             |         |         |   |     +-field_list=
    |             |         |         |   |       +-ColumnRef(type=UINT64, column=Customer.C_NATIONKEY#31)
    |             |         |         |   +-input_scan=
    |             |         |         |     +-TableScan(column_list=Customer.[C_CUSTKEY#28, C_NATIONKEY#31], table=Customer, table_column_list=[Customer.C_CUSTKEY,Customer.C_NATIONKEY])
    |             |         |         +-filter_expr=
    |             |         |           +-FunctionCall(GoogleSQL:$equal(STRUCT<C_CUSTKEY UINT64>, STRUCT<C_CUSTKEY UINT64>) -> BOOL)
    |             |         |             +-MakeStruct
    |             |         |             | +-type=STRUCT<C_CUSTKEY UINT64>
    |             |         |             | +-field_list=
    |             |         |             |   +-ColumnRef(type=UINT64, column=Customer.C_CUSTKEY#28)
    |             |         |             +-ColumnRef(type=STRUCT<C_CUSTKEY UINT64>, column=$with_expr.$with_col#27, is_correlated=TRUE)
    |             |         +-input_scan=
    |             |           +-ProjectScan
    |             |             +-column_list=[$with_expr.$with_col#27]
    |             |             +-expr_list=
    |             |             | +-$with_col#27 :=
    |             |             |   +-SubqueryExpr
    |             |             |     +-type=STRUCT<C_CUSTKEY UINT64>
    |             |             |     +-subquery_type=SCALAR
    |             |             |     +-parameter_list=
    |             |             |     | +-ColumnRef(type=STRUCT<O_ORDERKEY UINT64>, column=LineItem.$Order$join_row#35, is_correlated=TRUE)
    |             |             |     +-subquery=
    |             |             |       +-FilterScan
    |             |             |         +-column_list=[Orders.$Customer$join_row#25]
    |             |             |         +-input_scan=
    |             |             |         | +-ProjectScan
    |             |             |         |   +-column_list=Orders.[O_ORDERKEY#23, $Customer$join_row#25]
    |             |             |         |   +-expr_list=
    |             |             |         |   | +-$Customer$join_row#25 :=
    |             |             |         |   |   +-MakeStruct
    |             |             |         |   |     +-type=STRUCT<C_CUSTKEY UINT64>
    |             |             |         |   |     +-field_list=
    |             |             |         |   |       +-ColumnRef(type=UINT64, column=Orders.O_CUSTKEY#26)
    |             |             |         |   +-input_scan=
    |             |             |         |     +-TableScan(column_list=Orders.[O_ORDERKEY#23, O_CUSTKEY#26], table=Orders, table_column_list=[Orders.O_ORDERKEY,Orders.O_CUSTKEY])
    |             |             |         +-filter_expr=
    |             |             |           +-FunctionCall(GoogleSQL:$equal(STRUCT<O_ORDERKEY UINT64>, STRUCT<O_ORDERKEY UINT64>) -> BOOL)
    |             |             |             +-MakeStruct
    |             |             |             | +-type=STRUCT<O_ORDERKEY UINT64>
    |             |             |             | +-field_list=
    |             |             |             |   +-ColumnRef(type=UINT64, column=Orders.O_ORDERKEY#23)
    |             |             |             +-ColumnRef(type=STRUCT<O_ORDERKEY UINT64>, column=LineItem.$Order$join_row#35, is_correlated=TRUE)
    |             |             +-input_scan=
    |             |               +-SingleRowScan
    |             +-input_scan=
    |               +-SingleRowScan
    +-input_scan=
      +-ProjectScan
        +-column_list=[LineItem.$Order$join_row#35]
        +-expr_list=
        | +-$Order$join_row#35 :=
        |   +-MakeStruct
        |     +-type=STRUCT<O_ORDERKEY UINT64>
        |     +-field_list=
        |       +-ColumnRef(type=UINT64, column=LineItem.L_ORDERKEY#36)
        +-input_scan=
          +-TableScan(column_list=[LineItem.L_ORDERKEY#36], table=LineItem, alias="li", table_column_list=[LineItem.L_ORDERKEY])
==

# Dot-star on join column.
FROM Nation n
|> SELECT n.Region.*
--
QueryStmt
+-output_column_list=
| +-$pipe_select.R_REGIONKEY#8 AS R_REGIONKEY [UINT64]
| +-$pipe_select.R_NAME#9 AS R_NAME [STRING]
| +-$pipe_select.R_COMMENT#10 AS R_COMMENT [STRING]
+-query=
  +-ProjectScan
    +-column_list=$pipe_select.[R_REGIONKEY#8, R_NAME#9, R_COMMENT#10]
    +-expr_list=
    | +-R_REGIONKEY#8 :=
    | | +-GetRowField
    | |   +-type=UINT64
    | |   +-expr=
    | |   | +-ColumnRef(type=ROW<Region (join)>, column=Nation.Region#5)
    | |   +-column=Region.R_REGIONKEY
    | +-R_NAME#9 :=
    | | +-GetRowField
    | |   +-type=STRING
    | |   +-expr=
    | |   | +-ColumnRef(type=ROW<Region (join)>, column=Nation.Region#5)
    | |   +-column=Region.R_NAME
    | +-R_COMMENT#10 :=
    |   +-GetRowField
    |     +-type=STRING
    |     +-expr=
    |     | +-ColumnRef(type=ROW<Region (join)>, column=Nation.Region#5)
    |     +-column=Region.R_COMMENT
    +-input_scan=
      +-TableScan(column_list=[Nation.Region#5], table=Nation, column_index_list=[4], alias="n")


[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-$pipe_select.R_REGIONKEY#8 AS R_REGIONKEY [UINT64]
| +-$pipe_select.R_NAME#9 AS R_NAME [STRING]
| +-$pipe_select.R_COMMENT#10 AS R_COMMENT [STRING]
+-query=
  +-ProjectScan
    +-column_list=$pipe_select.[R_REGIONKEY#8, R_NAME#9, R_COMMENT#10]
    +-expr_list=
    | +-R_REGIONKEY#8 :=
    | | +-SubqueryExpr
    | |   +-type=UINT64
    | |   +-subquery_type=SCALAR
    | |   +-parameter_list=
    | |   | +-ColumnRef(type=STRUCT<R_REGIONKEY UINT64>, column=Nation.$Region$join_row#16)
    | |   +-subquery=
    | |     +-FilterScan
    | |       +-column_list=[Region.R_REGIONKEY#11]
    | |       +-input_scan=
    | |       | +-TableScan(column_list=[Region.R_REGIONKEY#11], table=Region, table_column_list=[Region.R_REGIONKEY])
    | |       +-filter_expr=
    | |         +-FunctionCall(GoogleSQL:$equal(STRUCT<R_REGIONKEY UINT64>, STRUCT<R_REGIONKEY UINT64>) -> BOOL)
    | |           +-MakeStruct
    | |           | +-type=STRUCT<R_REGIONKEY UINT64>
    | |           | +-field_list=
    | |           |   +-ColumnRef(type=UINT64, column=Region.R_REGIONKEY#11)
    | |           +-ColumnRef(type=STRUCT<R_REGIONKEY UINT64>, column=Nation.$Region$join_row#16, is_correlated=TRUE)
    | +-R_NAME#9 :=
    | | +-SubqueryExpr
    | |   +-type=STRING
    | |   +-subquery_type=SCALAR
    | |   +-parameter_list=
    | |   | +-ColumnRef(type=STRUCT<R_REGIONKEY UINT64>, column=Nation.$Region$join_row#16)
    | |   +-subquery=
    | |     +-FilterScan
    | |       +-column_list=[Region.R_NAME#13]
    | |       +-input_scan=
    | |       | +-TableScan(column_list=Region.[R_REGIONKEY#12, R_NAME#13], table=Region, table_column_list=[Region.R_REGIONKEY,Region.R_NAME])
    | |       +-filter_expr=
    | |         +-FunctionCall(GoogleSQL:$equal(STRUCT<R_REGIONKEY UINT64>, STRUCT<R_REGIONKEY UINT64>) -> BOOL)
    | |           +-MakeStruct
    | |           | +-type=STRUCT<R_REGIONKEY UINT64>
    | |           | +-field_list=
    | |           |   +-ColumnRef(type=UINT64, column=Region.R_REGIONKEY#12)
    | |           +-ColumnRef(type=STRUCT<R_REGIONKEY UINT64>, column=Nation.$Region$join_row#16, is_correlated=TRUE)
    | +-R_COMMENT#10 :=
    |   +-SubqueryExpr
    |     +-type=STRING
    |     +-subquery_type=SCALAR
    |     +-parameter_list=
    |     | +-ColumnRef(type=STRUCT<R_REGIONKEY UINT64>, column=Nation.$Region$join_row#16)
    |     +-subquery=
    |       +-FilterScan
    |         +-column_list=[Region.R_COMMENT#15]
    |         +-input_scan=
    |         | +-TableScan(column_list=Region.[R_REGIONKEY#14, R_COMMENT#15], table=Region, table_column_list=[Region.R_REGIONKEY,Region.R_COMMENT])
    |         +-filter_expr=
    |           +-FunctionCall(GoogleSQL:$equal(STRUCT<R_REGIONKEY UINT64>, STRUCT<R_REGIONKEY UINT64>) -> BOOL)
    |             +-MakeStruct
    |             | +-type=STRUCT<R_REGIONKEY UINT64>
    |             | +-field_list=
    |             |   +-ColumnRef(type=UINT64, column=Region.R_REGIONKEY#14)
    |             +-ColumnRef(type=STRUCT<R_REGIONKEY UINT64>, column=Nation.$Region$join_row#16, is_correlated=TRUE)
    +-input_scan=
      +-ProjectScan
        +-column_list=[Nation.$Region$join_row#16]
        +-expr_list=
        | +-$Region$join_row#16 :=
        |   +-MakeStruct
        |     +-type=STRUCT<R_REGIONKEY UINT64>
        |     +-field_list=
        |       +-ColumnRef(type=UINT64, column=Nation.N_REGIONKEY#17)
        +-input_scan=
          +-TableScan(column_list=[Nation.N_REGIONKEY#17], table=Nation, alias="n", table_column_list=[Nation.N_REGIONKEY])
==

FROM Nation n
|> SELECT n.Region.* EXCEPT ({{r_comment|bad}})
--
ALTERNATION GROUP: r_comment
--
QueryStmt
+-output_column_list=
| +-$pipe_select.R_REGIONKEY#8 AS R_REGIONKEY [UINT64]
| +-$pipe_select.R_NAME#9 AS R_NAME [STRING]
+-query=
  +-ProjectScan
    +-column_list=$pipe_select.[R_REGIONKEY#8, R_NAME#9]
    +-expr_list=
    | +-R_REGIONKEY#8 :=
    | | +-GetRowField
    | |   +-type=UINT64
    | |   +-expr=
    | |   | +-ColumnRef(type=ROW<Region (join)>, column=Nation.Region#5)
    | |   +-column=Region.R_REGIONKEY
    | +-R_NAME#9 :=
    |   +-GetRowField
    |     +-type=STRING
    |     +-expr=
    |     | +-ColumnRef(type=ROW<Region (join)>, column=Nation.Region#5)
    |     +-column=Region.R_NAME
    +-input_scan=
      +-TableScan(column_list=[Nation.Region#5], table=Nation, column_index_list=[4], alias="n")


[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-$pipe_select.R_REGIONKEY#8 AS R_REGIONKEY [UINT64]
| +-$pipe_select.R_NAME#9 AS R_NAME [STRING]
+-query=
  +-ProjectScan
    +-column_list=$pipe_select.[R_REGIONKEY#8, R_NAME#9]
    +-expr_list=
    | +-R_REGIONKEY#8 :=
    | | +-SubqueryExpr
    | |   +-type=UINT64
    | |   +-subquery_type=SCALAR
    | |   +-parameter_list=
    | |   | +-ColumnRef(type=STRUCT<R_REGIONKEY UINT64>, column=Nation.$Region$join_row#13)
    | |   +-subquery=
    | |     +-FilterScan
    | |       +-column_list=[Region.R_REGIONKEY#10]
    | |       +-input_scan=
    | |       | +-TableScan(column_list=[Region.R_REGIONKEY#10], table=Region, table_column_list=[Region.R_REGIONKEY])
    | |       +-filter_expr=
    | |         +-FunctionCall(GoogleSQL:$equal(STRUCT<R_REGIONKEY UINT64>, STRUCT<R_REGIONKEY UINT64>) -> BOOL)
    | |           +-MakeStruct
    | |           | +-type=STRUCT<R_REGIONKEY UINT64>
    | |           | +-field_list=
    | |           |   +-ColumnRef(type=UINT64, column=Region.R_REGIONKEY#10)
    | |           +-ColumnRef(type=STRUCT<R_REGIONKEY UINT64>, column=Nation.$Region$join_row#13, is_correlated=TRUE)
    | +-R_NAME#9 :=
    |   +-SubqueryExpr
    |     +-type=STRING
    |     +-subquery_type=SCALAR
    |     +-parameter_list=
    |     | +-ColumnRef(type=STRUCT<R_REGIONKEY UINT64>, column=Nation.$Region$join_row#13)
    |     +-subquery=
    |       +-FilterScan
    |         +-column_list=[Region.R_NAME#12]
    |         +-input_scan=
    |         | +-TableScan(column_list=Region.[R_REGIONKEY#11, R_NAME#12], table=Region, table_column_list=[Region.R_REGIONKEY,Region.R_NAME])
    |         +-filter_expr=
    |           +-FunctionCall(GoogleSQL:$equal(STRUCT<R_REGIONKEY UINT64>, STRUCT<R_REGIONKEY UINT64>) -> BOOL)
    |             +-MakeStruct
    |             | +-type=STRUCT<R_REGIONKEY UINT64>
    |             | +-field_list=
    |             |   +-ColumnRef(type=UINT64, column=Region.R_REGIONKEY#11)
    |             +-ColumnRef(type=STRUCT<R_REGIONKEY UINT64>, column=Nation.$Region$join_row#13, is_correlated=TRUE)
    +-input_scan=
      +-ProjectScan
        +-column_list=[Nation.$Region$join_row#13]
        +-expr_list=
        | +-$Region$join_row#13 :=
        |   +-MakeStruct
        |     +-type=STRUCT<R_REGIONKEY UINT64>
        |     +-field_list=
        |       +-ColumnRef(type=UINT64, column=Nation.N_REGIONKEY#14)
        +-input_scan=
          +-TableScan(column_list=[Nation.N_REGIONKEY#14], table=Nation, alias="n", table_column_list=[Nation.N_REGIONKEY])
--
ALTERNATION GROUP: bad
--
ERROR: Column bad in SELECT * EXCEPT list does not exist [at 2:30]
|> SELECT n.Region.* EXCEPT (bad)
                             ^
==

# FLATTEN through a 1:N MULTIROW join column.
FROM Customer c
|> SELECT FLATTEN(c.Orders.o_orderdate)
--
QueryStmt
+-output_column_list=
| +-$pipe_select.$col1#11 AS `$col1` [ARRAY<DATE>]
+-query=
  +-ProjectScan
    +-column_list=[$pipe_select.$col1#11]
    +-expr_list=
    | +-$col1#11 :=
    |   +-Flatten
    |     +-type=ARRAY<DATE>
    |     +-expr=
    |     | +-ColumnRef(type=MULTIROW<Orders (join)>, column=Customer.Orders#9)
    |     +-get_field_list=
    |       +-GetRowField
    |         +-type=DATE
    |         +-expr=
    |         | +-FlattenedArg(type=ROW<Orders>)
    |         +-column=Orders.O_ORDERDATE
    +-input_scan=
      +-TableScan(column_list=[Customer.Orders#9], table=Customer, column_index_list=[8], alias="c")


[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-$pipe_select.$col1#11 AS `$col1` [ARRAY<DATE>]
+-query=
  +-ProjectScan
    +-column_list=[$pipe_select.$col1#11]
    +-expr_list=
    | +-$col1#11 :=
    |   +-SubqueryExpr
    |     +-type=ARRAY<DATE>
    |     +-subquery_type=SCALAR
    |     +-parameter_list=
    |     | +-ColumnRef(type=STRUCT<O_CUSTKEY UINT64>, column=Customer.$Orders$join_multirow#18)
    |     +-subquery=
    |       +-ProjectScan
    |         +-column_list=[$with_expr.injected#21]
    |         +-expr_list=
    |         | +-injected#21 :=
    |         |   +-FunctionCall(GoogleSQL:if(BOOL, ARRAY<DATE>, ARRAY<DATE>) -> ARRAY<DATE>)
    |         |     +-FunctionCall(GoogleSQL:$is_null(STRUCT<O_CUSTKEY UINT64>) -> BOOL)
    |         |     | +-ColumnRef(type=STRUCT<O_CUSTKEY UINT64>, column=$flatten_input.$injected$join_multirow#20)
    |         |     +-Literal(type=ARRAY<DATE>, value=NULL)
    |         |     +-SubqueryExpr
    |         |       +-type=ARRAY<DATE>
    |         |       +-subquery_type=ARRAY
    |         |       +-parameter_list=
    |         |       | +-ColumnRef(type=STRUCT<O_CUSTKEY UINT64>, column=$flatten_input.$injected$join_multirow#20)
    |         |       +-subquery=
    |         |         +-ProjectScan
    |         |           +-column_list=[$flatten.injected#14]
    |         |           +-expr_list=
    |         |           | +-injected#14 :=
    |         |           |   +-GetStructField
    |         |           |     +-type=DATE
    |         |           |     +-expr=
    |         |           |     | +-ColumnRef(type=STRUCT<O_ORDERDATE DATE>, column=$flatten.$injected$scanrow#15)
    |         |           |     +-field_idx=0
    |         |           +-input_scan=
    |         |             +-JoinScan
    |         |               +-column_list=[$flatten.$injected$scanrow#15]
    |         |               +-left_scan=
    |         |               | +-SingleRowScan
    |         |               +-right_scan=
    |         |               | +-ProjectScan
    |         |               |   +-column_list=[Orders.O_CUSTKEY#16, $flatten.$injected$scanrow#15]
    |         |               |   +-expr_list=
    |         |               |   | +-$injected$scanrow#15 :=
    |         |               |   |   +-MakeStruct
    |         |               |   |     +-type=STRUCT<O_ORDERDATE DATE>
    |         |               |   |     +-field_list=
    |         |               |   |       +-ColumnRef(type=DATE, column=Orders.O_ORDERDATE#17)
    |         |               |   +-input_scan=
    |         |               |     +-TableScan(column_list=Orders.[O_CUSTKEY#16, O_ORDERDATE#17], table=Orders, table_column_list=[Orders.O_CUSTKEY,Orders.O_ORDERDATE])
    |         |               +-join_expr=
    |         |                 +-FunctionCall(GoogleSQL:$equal(STRUCT<O_CUSTKEY UINT64>, STRUCT<O_CUSTKEY UINT64>) -> BOOL)
    |         |                   +-MakeStruct
    |         |                   | +-type=STRUCT<O_CUSTKEY UINT64>
    |         |                   | +-field_list=
    |         |                   |   +-ColumnRef(type=UINT64, column=Orders.O_CUSTKEY#16)
    |         |                   +-ColumnRef(type=STRUCT<O_CUSTKEY UINT64>, column=$flatten_input.$injected$join_multirow#20, is_correlated=TRUE)
    |         +-input_scan=
    |           +-ProjectScan
    |             +-column_list=[$flatten_input.$injected$join_multirow#20]
    |             +-expr_list=
    |             | +-$injected$join_multirow#20 := ColumnRef(type=STRUCT<O_CUSTKEY UINT64>, column=Customer.$Orders$join_multirow#18, is_correlated=TRUE)
    |             +-input_scan=
    |               +-SingleRowScan
    +-input_scan=
      +-ProjectScan
        +-column_list=[Customer.$Orders$join_multirow#18]
        +-expr_list=
        | +-$Orders$join_multirow#18 :=
        |   +-MakeStruct
        |     +-type=STRUCT<O_CUSTKEY UINT64>
        |     +-field_list=
        |       +-ColumnRef(type=UINT64, column=Customer.C_CUSTKEY#19)
        +-input_scan=
          +-TableScan(column_list=[Customer.C_CUSTKEY#19], table=Customer, alias="c", table_column_list=[Customer.C_CUSTKEY])
==

# FLATTEN through an N:1 ROW join column.
FROM Customer c
|> SELECT FLATTEN(c.Nation.n_name)
--
QueryStmt
+-output_column_list=
| +-$pipe_select.$col1#11 AS `$col1` [ARRAY<STRING>]
+-query=
  +-ProjectScan
    +-column_list=[$pipe_select.$col1#11]
    +-expr_list=
    | +-$col1#11 :=
    |   +-Flatten
    |     +-type=ARRAY<STRING>
    |     +-expr=
    |     | +-ColumnRef(type=ROW<Nation (join)>, column=Customer.Nation#10)
    |     +-get_field_list=
    |       +-GetRowField
    |         +-type=STRING
    |         +-expr=
    |         | +-FlattenedArg(type=ROW<Nation>)
    |         +-column=Nation.N_NAME
    +-input_scan=
      +-TableScan(column_list=[Customer.Nation#10], table=Customer, column_index_list=[9], alias="c")


[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-$pipe_select.$col1#11 AS `$col1` [ARRAY<STRING>]
+-query=
  +-ProjectScan
    +-column_list=[$pipe_select.$col1#11]
    +-expr_list=
    | +-$col1#11 :=
    |   +-SubqueryExpr
    |     +-type=ARRAY<STRING>
    |     +-subquery_type=SCALAR
    |     +-parameter_list=
    |     | +-ColumnRef(type=STRUCT<N_NATIONKEY UINT64>, column=Customer.$Nation$join_row#18)
    |     +-subquery=
    |       +-ProjectScan
    |         +-column_list=[$with_expr.injected#21]
    |         +-expr_list=
    |         | +-injected#21 :=
    |         |   +-FunctionCall(GoogleSQL:if(BOOL, ARRAY<STRING>, ARRAY<STRING>) -> ARRAY<STRING>)
    |         |     +-FunctionCall(GoogleSQL:$is_null(STRUCT<N_NATIONKEY UINT64>) -> BOOL)
    |         |     | +-ColumnRef(type=STRUCT<N_NATIONKEY UINT64>, column=$flatten_input.$injected$join_row#20)
    |         |     +-Literal(type=ARRAY<STRING>, value=NULL)
    |         |     +-SubqueryExpr
    |         |       +-type=ARRAY<STRING>
    |         |       +-subquery_type=ARRAY
    |         |       +-parameter_list=
    |         |       | +-ColumnRef(type=STRUCT<N_NATIONKEY UINT64>, column=$flatten_input.$injected$join_row#20)
    |         |       +-subquery=
    |         |         +-ProjectScan
    |         |           +-column_list=[$flatten.injected#14]
    |         |           +-expr_list=
    |         |           | +-injected#14 :=
    |         |           |   +-GetStructField
    |         |           |     +-type=STRING
    |         |           |     +-expr=
    |         |           |     | +-ColumnRef(type=STRUCT<N_NAME STRING>, column=$flatten.$injected$scanrow#15)
    |         |           |     +-field_idx=0
    |         |           +-input_scan=
    |         |             +-JoinScan
    |         |               +-column_list=[$flatten.$injected$scanrow#15]
    |         |               +-left_scan=
    |         |               | +-SingleRowScan
    |         |               +-right_scan=
    |         |               | +-ProjectScan
    |         |               |   +-column_list=[Nation.N_NATIONKEY#16, $flatten.$injected$scanrow#15]
    |         |               |   +-expr_list=
    |         |               |   | +-$injected$scanrow#15 :=
    |         |               |   |   +-MakeStruct
    |         |               |   |     +-type=STRUCT<N_NAME STRING>
    |         |               |   |     +-field_list=
    |         |               |   |       +-ColumnRef(type=STRING, column=Nation.N_NAME#17)
    |         |               |   +-input_scan=
    |         |               |     +-TableScan(column_list=Nation.[N_NATIONKEY#16, N_NAME#17], table=Nation, table_column_list=[Nation.N_NATIONKEY,Nation.N_NAME])
    |         |               +-join_expr=
    |         |                 +-FunctionCall(GoogleSQL:$equal(STRUCT<N_NATIONKEY UINT64>, STRUCT<N_NATIONKEY UINT64>) -> BOOL)
    |         |                   +-MakeStruct
    |         |                   | +-type=STRUCT<N_NATIONKEY UINT64>
    |         |                   | +-field_list=
    |         |                   |   +-ColumnRef(type=UINT64, column=Nation.N_NATIONKEY#16)
    |         |                   +-ColumnRef(type=STRUCT<N_NATIONKEY UINT64>, column=$flatten_input.$injected$join_row#20, is_correlated=TRUE)
    |         +-input_scan=
    |           +-ProjectScan
    |             +-column_list=[$flatten_input.$injected$join_row#20]
    |             +-expr_list=
    |             | +-$injected$join_row#20 := ColumnRef(type=STRUCT<N_NATIONKEY UINT64>, column=Customer.$Nation$join_row#18, is_correlated=TRUE)
    |             +-input_scan=
    |               +-SingleRowScan
    +-input_scan=
      +-ProjectScan
        +-column_list=[Customer.$Nation$join_row#18]
        +-expr_list=
        | +-$Nation$join_row#18 :=
        |   +-MakeStruct
        |     +-type=STRUCT<N_NATIONKEY UINT64>
        |     +-field_list=
        |       +-ColumnRef(type=UINT64, column=Customer.C_NATIONKEY#19)
        +-input_scan=
          +-TableScan(column_list=[Customer.C_NATIONKEY#19], table=Customer, alias="c", table_column_list=[Customer.C_NATIONKEY])
==

# Multi-step FLATTEN with ROWs and MULTIROWS.
# PartSupp has a multi-part key.
FROM Customer c
|> SELECT FLATTEN(c.Orders.Lineitems.PartSupp.Part.p_name)
--
QueryStmt
+-output_column_list=
| +-$pipe_select.$col1#11 AS `$col1` [ARRAY<STRING>]
+-query=
  +-ProjectScan
    +-column_list=[$pipe_select.$col1#11]
    +-expr_list=
    | +-$col1#11 :=
    |   +-Flatten
    |     +-type=ARRAY<STRING>
    |     +-expr=
    |     | +-ColumnRef(type=MULTIROW<Orders (join)>, column=Customer.Orders#9)
    |     +-get_field_list=
    |       +-GetRowField
    |       | +-type=MULTIROW<LineItem (join)>
    |       | +-expr=
    |       | | +-FlattenedArg(type=ROW<Orders>)
    |       | +-column=Orders.LineItems
    |       +-GetRowField
    |       | +-type=ROW<PartSupp (join)>
    |       | +-expr=
    |       | | +-FlattenedArg(type=ROW<LineItem>)
    |       | +-column=LineItem.PartSupp
    |       +-GetRowField
    |       | +-type=ROW<Part (join)>
    |       | +-expr=
    |       | | +-FlattenedArg(type=ROW<PartSupp>)
    |       | +-column=PartSupp.Part
    |       +-GetRowField
    |         +-type=STRING
    |         +-expr=
    |         | +-FlattenedArg(type=ROW<Part>)
    |         +-column=Part.P_NAME
    +-input_scan=
      +-TableScan(column_list=[Customer.Orders#9], table=Customer, column_index_list=[8], alias="c")


[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-$pipe_select.$col1#11 AS `$col1` [ARRAY<STRING>]
+-query=
  +-ProjectScan
    +-column_list=[$pipe_select.$col1#11]
    +-expr_list=
    | +-$col1#11 :=
    |   +-SubqueryExpr
    |     +-type=ARRAY<STRING>
    |     +-subquery_type=SCALAR
    |     +-parameter_list=
    |     | +-ColumnRef(type=STRUCT<O_CUSTKEY UINT64>, column=Customer.$Orders$join_multirow#31)
    |     +-subquery=
    |       +-ProjectScan
    |         +-column_list=[$with_expr.injected#34]
    |         +-expr_list=
    |         | +-injected#34 :=
    |         |   +-FunctionCall(GoogleSQL:if(BOOL, ARRAY<STRING>, ARRAY<STRING>) -> ARRAY<STRING>)
    |         |     +-FunctionCall(GoogleSQL:$is_null(STRUCT<O_CUSTKEY UINT64>) -> BOOL)
    |         |     | +-ColumnRef(type=STRUCT<O_CUSTKEY UINT64>, column=$flatten_input.$injected$join_multirow#33)
    |         |     +-Literal(type=ARRAY<STRING>, value=NULL)
    |         |     +-SubqueryExpr
    |         |       +-type=ARRAY<STRING>
    |         |       +-subquery_type=ARRAY
    |         |       +-parameter_list=
    |         |       | +-ColumnRef(type=STRUCT<O_CUSTKEY UINT64>, column=$flatten_input.$injected$join_multirow#33)
    |         |       +-subquery=
    |         |         +-ProjectScan
    |         |           +-column_list=[$flatten.injected#17]
    |         |           +-expr_list=
    |         |           | +-injected#17 :=
    |         |           |   +-GetStructField
    |         |           |     +-type=STRING
    |         |           |     +-expr=
    |         |           |     | +-ColumnRef(type=STRUCT<P_NAME STRING>, column=$flatten.$injected$scanrow#18)
    |         |           |     +-field_idx=0
    |         |           +-input_scan=
    |         |             +-JoinScan
    |         |               +-column_list=$flatten.[$injected$scanrow#20, $injected$scanrow#23, $injected$scanrow#28, $injected$scanrow#18]
    |         |               +-left_scan=
    |         |               | +-JoinScan
    |         |               |   +-column_list=$flatten.[$injected$scanrow#20, $injected$scanrow#23, $injected$scanrow#28]
    |         |               |   +-left_scan=
    |         |               |   | +-JoinScan
    |         |               |   |   +-column_list=$flatten.[$injected$scanrow#20, $injected$scanrow#23]
    |         |               |   |   +-left_scan=
    |         |               |   |   | +-JoinScan
    |         |               |   |   |   +-column_list=[$flatten.$injected$scanrow#20]
    |         |               |   |   |   +-left_scan=
    |         |               |   |   |   | +-SingleRowScan
    |         |               |   |   |   +-right_scan=
    |         |               |   |   |   | +-ProjectScan
    |         |               |   |   |   |   +-column_list=[Orders.O_CUSTKEY#19, $flatten.$injected$scanrow#20]
    |         |               |   |   |   |   +-expr_list=
    |         |               |   |   |   |   | +-$injected$scanrow#20 :=
    |         |               |   |   |   |   |   +-MakeStruct
    |         |               |   |   |   |   |     +-type=STRUCT<LineItems STRUCT<L_ORDERKEY UINT64>>
    |         |               |   |   |   |   |     +-field_list=
    |         |               |   |   |   |   |       +-MakeStruct
    |         |               |   |   |   |   |         +-type=STRUCT<L_ORDERKEY UINT64>
    |         |               |   |   |   |   |         +-field_list=
    |         |               |   |   |   |   |           +-ColumnRef(type=UINT64, column=Orders.O_ORDERKEY#21)
    |         |               |   |   |   |   +-input_scan=
    |         |               |   |   |   |     +-TableScan(column_list=Orders.[O_CUSTKEY#19, O_ORDERKEY#21], table=Orders, table_column_list=[Orders.O_CUSTKEY,Orders.O_ORDERKEY])
    |         |               |   |   |   +-join_expr=
    |         |               |   |   |     +-FunctionCall(GoogleSQL:$equal(STRUCT<O_CUSTKEY UINT64>, STRUCT<O_CUSTKEY UINT64>) -> BOOL)
    |         |               |   |   |       +-MakeStruct
    |         |               |   |   |       | +-type=STRUCT<O_CUSTKEY UINT64>
    |         |               |   |   |       | +-field_list=
    |         |               |   |   |       |   +-ColumnRef(type=UINT64, column=Orders.O_CUSTKEY#19)
    |         |               |   |   |       +-ColumnRef(type=STRUCT<O_CUSTKEY UINT64>, column=$flatten_input.$injected$join_multirow#33, is_correlated=TRUE)
    |         |               |   |   +-right_scan=
    |         |               |   |   | +-ProjectScan
    |         |               |   |   |   +-column_list=[LineItem.L_ORDERKEY#22, $flatten.$injected$scanrow#23]
    |         |               |   |   |   +-expr_list=
    |         |               |   |   |   | +-$injected$scanrow#23 :=
    |         |               |   |   |   |   +-MakeStruct
    |         |               |   |   |   |     +-type=STRUCT<PartSupp STRUCT<PS_PARTKEY UINT64, PS_SUPPKEY UINT64>>
    |         |               |   |   |   |     +-field_list=
    |         |               |   |   |   |       +-MakeStruct
    |         |               |   |   |   |         +-type=STRUCT<PS_PARTKEY UINT64, PS_SUPPKEY UINT64>
    |         |               |   |   |   |         +-field_list=
    |         |               |   |   |   |           +-ColumnRef(type=UINT64, column=LineItem.L_PARTKEY#24)
    |         |               |   |   |   |           +-ColumnRef(type=UINT64, column=LineItem.L_SUPPKEY#25)
    |         |               |   |   |   +-input_scan=
    |         |               |   |   |     +-TableScan(column_list=LineItem.[L_ORDERKEY#22, L_PARTKEY#24, L_SUPPKEY#25], table=LineItem, table_column_list=[LineItem.L_ORDERKEY,LineItem.L_PARTKEY,LineItem.L_SUPPKEY])
    |         |               |   |   +-join_expr=
    |         |               |   |     +-FunctionCall(GoogleSQL:$equal(STRUCT<L_ORDERKEY UINT64>, STRUCT<L_ORDERKEY UINT64>) -> BOOL)
    |         |               |   |       +-MakeStruct
    |         |               |   |       | +-type=STRUCT<L_ORDERKEY UINT64>
    |         |               |   |       | +-field_list=
    |         |               |   |       |   +-ColumnRef(type=UINT64, column=LineItem.L_ORDERKEY#22)
    |         |               |   |       +-GetStructField
    |         |               |   |         +-type=STRUCT<L_ORDERKEY UINT64>
    |         |               |   |         +-expr=
    |         |               |   |         | +-ColumnRef(type=STRUCT<LineItems STRUCT<L_ORDERKEY UINT64>>, column=$flatten.$injected$scanrow#20)
    |         |               |   |         +-field_idx=0
    |         |               |   +-right_scan=
    |         |               |   | +-ProjectScan
    |         |               |   |   +-column_list=[PartSupp.PS_PARTKEY#26, PartSupp.PS_SUPPKEY#27, $flatten.$injected$scanrow#28]
    |         |               |   |   +-expr_list=
    |         |               |   |   | +-$injected$scanrow#28 :=
    |         |               |   |   |   +-MakeStruct
    |         |               |   |   |     +-type=STRUCT<Part STRUCT<P_PARTKEY UINT64>>
    |         |               |   |   |     +-field_list=
    |         |               |   |   |       +-MakeStruct
    |         |               |   |   |         +-type=STRUCT<P_PARTKEY UINT64>
    |         |               |   |   |         +-field_list=
    |         |               |   |   |           +-ColumnRef(type=UINT64, column=PartSupp.PS_PARTKEY#26)
    |         |               |   |   +-input_scan=
    |         |               |   |     +-TableScan(column_list=PartSupp.[PS_PARTKEY#26, PS_SUPPKEY#27], table=PartSupp, table_column_list=[PartSupp.PS_PARTKEY,PartSupp.PS_SUPPKEY])
    |         |               |   +-join_expr=
    |         |               |     +-FunctionCall(GoogleSQL:$equal(STRUCT<PS_PARTKEY UINT64, PS_SUPPKEY UINT64>, STRUCT<PS_PARTKEY UINT64, PS_SUPPKEY UINT64>) -> BOOL)
    |         |               |       +-MakeStruct
    |         |               |       | +-type=STRUCT<PS_PARTKEY UINT64, PS_SUPPKEY UINT64>
    |         |               |       | +-field_list=
    |         |               |       |   +-ColumnRef(type=UINT64, column=PartSupp.PS_PARTKEY#26)
    |         |               |       |   +-ColumnRef(type=UINT64, column=PartSupp.PS_SUPPKEY#27)
    |         |               |       +-GetStructField
    |         |               |         +-type=STRUCT<PS_PARTKEY UINT64, PS_SUPPKEY UINT64>
    |         |               |         +-expr=
    |         |               |         | +-ColumnRef(type=STRUCT<PartSupp STRUCT<PS_PARTKEY UINT64, PS_SUPPKEY UINT64>>, column=$flatten.$injected$scanrow#23)
    |         |               |         +-field_idx=0
    |         |               +-right_scan=
    |         |               | +-ProjectScan
    |         |               |   +-column_list=[Part.P_PARTKEY#29, $flatten.$injected$scanrow#18]
    |         |               |   +-expr_list=
    |         |               |   | +-$injected$scanrow#18 :=
    |         |               |   |   +-MakeStruct
    |         |               |   |     +-type=STRUCT<P_NAME STRING>
    |         |               |   |     +-field_list=
    |         |               |   |       +-ColumnRef(type=STRING, column=Part.P_NAME#30)
    |         |               |   +-input_scan=
    |         |               |     +-TableScan(column_list=Part.[P_PARTKEY#29, P_NAME#30], table=Part, table_column_list=[Part.P_PARTKEY,Part.P_NAME])
    |         |               +-join_expr=
    |         |                 +-FunctionCall(GoogleSQL:$equal(STRUCT<P_PARTKEY UINT64>, STRUCT<P_PARTKEY UINT64>) -> BOOL)
    |         |                   +-MakeStruct
    |         |                   | +-type=STRUCT<P_PARTKEY UINT64>
    |         |                   | +-field_list=
    |         |                   |   +-ColumnRef(type=UINT64, column=Part.P_PARTKEY#29)
    |         |                   +-GetStructField
    |         |                     +-type=STRUCT<P_PARTKEY UINT64>
    |         |                     +-expr=
    |         |                     | +-ColumnRef(type=STRUCT<Part STRUCT<P_PARTKEY UINT64>>, column=$flatten.$injected$scanrow#28)
    |         |                     +-field_idx=0
    |         +-input_scan=
    |           +-ProjectScan
    |             +-column_list=[$flatten_input.$injected$join_multirow#33]
    |             +-expr_list=
    |             | +-$injected$join_multirow#33 := ColumnRef(type=STRUCT<O_CUSTKEY UINT64>, column=Customer.$Orders$join_multirow#31, is_correlated=TRUE)
    |             +-input_scan=
    |               +-SingleRowScan
    +-input_scan=
      +-ProjectScan
        +-column_list=[Customer.$Orders$join_multirow#31]
        +-expr_list=
        | +-$Orders$join_multirow#31 :=
        |   +-MakeStruct
        |     +-type=STRUCT<O_CUSTKEY UINT64>
        |     +-field_list=
        |       +-ColumnRef(type=UINT64, column=Customer.C_CUSTKEY#32)
        +-input_scan=
          +-TableScan(column_list=[Customer.C_CUSTKEY#32], table=Customer, alias="c", table_column_list=[Customer.C_CUSTKEY])
==

# The FLATTEN path cannot currently end with a row type (which would make
# an ARRAY of ROW types).
# Note: If this works, is the result type an ARRAY or just a ROW/MULTIROW?
FROM Customer c
|> SELECT FLATTEN(c.Orders.Lineitems)
--
ERROR: ROW-typed values cannot be passed as function arguments [at 2:19]
|> SELECT FLATTEN(c.Orders.Lineitems)
                  ^
==

FROM Customer c
|> SELECT FLATTEN(c.Orders.bad)
--
ERROR: Table Orders does not have a column bad [at 2:28]
|> SELECT FLATTEN(c.Orders.bad)
                           ^
==

# Join a 1:N MULTIROW join column
# Same result with or without UNNEST, and with or without range variables.
FROM Customer c
|> JOIN {{UNNEST(c.Orders)|c.Orders}} o
|> SELECT {{|c.}}c_name, {{|o.}}o_orderdate
--
QueryStmt
+-output_column_list=
| +-Customer.C_NAME#2 AS c_name [STRING]
| +-$pipe_select.o_orderdate#12 AS o_orderdate [DATE]
+-query=
  +-ProjectScan
    +-column_list=[Customer.C_NAME#2, $pipe_select.o_orderdate#12]
    +-expr_list=
    | +-o_orderdate#12 :=
    |   +-GetRowField
    |     +-type=DATE
    |     +-expr=
    |     | +-ColumnRef(type=ROW<Orders>, column=$array.o#11)
    |     +-column=Orders.O_ORDERDATE
    +-input_scan=
      +-ArrayScan
        +-column_list=[Customer.C_NAME#2, Customer.Orders#9, $array.o#11]
        +-input_scan=
        | +-TableScan(column_list=Customer.[C_NAME#2, Orders#9], table=Customer, column_index_list=[1, 8], alias="c")
        +-array_expr_list=
        | +-ColumnRef(type=MULTIROW<Orders (join)>, column=Customer.Orders#9)
        +-element_column_list=[$array.o#11]


[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-Customer.C_NAME#2 AS c_name [STRING]
| +-$pipe_select.o_orderdate#12 AS o_orderdate [DATE]
+-query=
  +-ProjectScan
    +-column_list=[Customer.C_NAME#2, $pipe_select.o_orderdate#12]
    +-expr_list=
    | +-o_orderdate#12 :=
    |   +-GetStructField
    |     +-type=DATE
    |     +-expr=
    |     | +-ColumnRef(type=STRUCT<O_ORDERDATE DATE>, column=$array.$o$scanrow#13)
    |     +-field_idx=0
    +-input_scan=
      +-JoinScan
        +-column_list=[Customer.C_NAME#2, Customer.$Orders$join_multirow#14, $array.$o$scanrow#13]
        +-left_scan=
        | +-ProjectScan
        |   +-column_list=Customer.[C_NAME#2, $Orders$join_multirow#14]
        |   +-expr_list=
        |   | +-$Orders$join_multirow#14 :=
        |   |   +-MakeStruct
        |   |     +-type=STRUCT<O_CUSTKEY UINT64>
        |   |     +-field_list=
        |   |       +-ColumnRef(type=UINT64, column=Customer.C_CUSTKEY#15)
        |   +-input_scan=
        |     +-TableScan(column_list=Customer.[C_NAME#2, C_CUSTKEY#15], table=Customer, alias="c", table_column_list=[Customer.C_NAME,Customer.C_CUSTKEY])
        +-right_scan=
        | +-ProjectScan
        |   +-column_list=[Orders.O_CUSTKEY#16, $array.$o$scanrow#13]
        |   +-expr_list=
        |   | +-$o$scanrow#13 :=
        |   |   +-MakeStruct
        |   |     +-type=STRUCT<O_ORDERDATE DATE>
        |   |     +-field_list=
        |   |       +-ColumnRef(type=DATE, column=Orders.O_ORDERDATE#17)
        |   +-input_scan=
        |     +-TableScan(column_list=Orders.[O_CUSTKEY#16, O_ORDERDATE#17], table=Orders, table_column_list=[Orders.O_CUSTKEY,Orders.O_ORDERDATE])
        +-join_expr=
          +-FunctionCall(GoogleSQL:$equal(STRUCT<O_CUSTKEY UINT64>, STRUCT<O_CUSTKEY UINT64>) -> BOOL)
            +-MakeStruct
            | +-type=STRUCT<O_CUSTKEY UINT64>
            | +-field_list=
            |   +-ColumnRef(type=UINT64, column=Orders.O_CUSTKEY#16)
            +-ColumnRef(type=STRUCT<O_CUSTKEY UINT64>, column=Customer.$Orders$join_multirow#14)
==

# JOIN an N:1 ROW join column
# Same result with or without UNNEST, and with or without range variables.
FROM Customer c
|> JOIN {{UNNEST(c.Nation)|c.Nation}} n
|> SELECT {{|c.}}c_name, {{|n.}}n_name
--
QueryStmt
+-output_column_list=
| +-Customer.C_NAME#2 AS c_name [STRING]
| +-$pipe_select.n_name#12 AS n_name [STRING]
+-query=
  +-ProjectScan
    +-column_list=[Customer.C_NAME#2, $pipe_select.n_name#12]
    +-expr_list=
    | +-n_name#12 :=
    |   +-GetRowField
    |     +-type=STRING
    |     +-expr=
    |     | +-ColumnRef(type=ROW<Nation>, column=$array.n#11)
    |     +-column=Nation.N_NAME
    +-input_scan=
      +-ArrayScan
        +-column_list=[Customer.C_NAME#2, Customer.Nation#10, $array.n#11]
        +-input_scan=
        | +-TableScan(column_list=Customer.[C_NAME#2, Nation#10], table=Customer, column_index_list=[1, 9], alias="c")
        +-array_expr_list=
        | +-ColumnRef(type=ROW<Nation (join)>, column=Customer.Nation#10)
        +-element_column_list=[$array.n#11]


[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-Customer.C_NAME#2 AS c_name [STRING]
| +-$pipe_select.n_name#12 AS n_name [STRING]
+-query=
  +-ProjectScan
    +-column_list=[Customer.C_NAME#2, $pipe_select.n_name#12]
    +-expr_list=
    | +-n_name#12 :=
    |   +-GetStructField
    |     +-type=STRING
    |     +-expr=
    |     | +-ColumnRef(type=STRUCT<N_NAME STRING>, column=$array.$n$scanrow#13)
    |     +-field_idx=0
    +-input_scan=
      +-JoinScan
        +-column_list=[Customer.C_NAME#2, Customer.$Nation$join_row#14, $array.$n$scanrow#13]
        +-left_scan=
        | +-ProjectScan
        |   +-column_list=Customer.[C_NAME#2, $Nation$join_row#14]
        |   +-expr_list=
        |   | +-$Nation$join_row#14 :=
        |   |   +-MakeStruct
        |   |     +-type=STRUCT<N_NATIONKEY UINT64>
        |   |     +-field_list=
        |   |       +-ColumnRef(type=UINT64, column=Customer.C_NATIONKEY#15)
        |   +-input_scan=
        |     +-TableScan(column_list=Customer.[C_NAME#2, C_NATIONKEY#15], table=Customer, alias="c", table_column_list=[Customer.C_NAME,Customer.C_NATIONKEY])
        +-right_scan=
        | +-ProjectScan
        |   +-column_list=[Nation.N_NATIONKEY#16, $array.$n$scanrow#13]
        |   +-expr_list=
        |   | +-$n$scanrow#13 :=
        |   |   +-MakeStruct
        |   |     +-type=STRUCT<N_NAME STRING>
        |   |     +-field_list=
        |   |       +-ColumnRef(type=STRING, column=Nation.N_NAME#17)
        |   +-input_scan=
        |     +-TableScan(column_list=Nation.[N_NATIONKEY#16, N_NAME#17], table=Nation, table_column_list=[Nation.N_NATIONKEY,Nation.N_NAME])
        +-join_expr=
          +-FunctionCall(GoogleSQL:$equal(STRUCT<N_NATIONKEY UINT64>, STRUCT<N_NATIONKEY UINT64>) -> BOOL)
            +-MakeStruct
            | +-type=STRUCT<N_NATIONKEY UINT64>
            | +-field_list=
            |   +-ColumnRef(type=UINT64, column=Nation.N_NATIONKEY#16)
            +-ColumnRef(type=STRUCT<N_NATIONKEY UINT64>, column=Customer.$Nation$join_row#14)
==

# WITH OFFSET is not allowed with join columns (which are unordered)
FROM Region r
|> JOIN {{UNNEST(r.Nations)|r.Nations}} WITH OFFSET
|> select 1 #remove
--
ALTERNATION GROUP: UNNEST(r.Nations)
--
ERROR: WITH OFFSET is not allowed when scanning values with ROW type [at 2:27]
|> JOIN UNNEST(r.Nations) WITH OFFSET
                          ^
--
ALTERNATION GROUP: r.Nations
--
ERROR: WITH OFFSET is not allowed when scanning values with ROW type [at 2:19]
|> JOIN r.Nations WITH OFFSET
                  ^
==

# Multi-arg UNNEST is not allowed with join columns (because they are unordered)
FROM Region r
|> JOIN UNNEST(r.Nations AS r1, r.Nations AS r2)
|> select 1 #remove
--
ERROR: Multi-argument UNNEST not allowed for value with ROW type [at 2:16]
|> JOIN UNNEST(r.Nations AS r1, r.Nations AS r2)
               ^
==

FROM Region r
|> JOIN UNNEST(r.Nations AS r1, [1,2] AS r2)
--
ERROR: Multi-argument UNNEST not allowed for value with ROW type [at 2:16]
|> JOIN UNNEST(r.Nations AS r1, [1,2] AS r2)
               ^
==

FROM Region r
|> JOIN UNNEST([1,2] AS r1, r.Nations AS r2)
--
ERROR: Multi-argument UNNEST not allowed for value with ROW type [at 2:29]
|> JOIN UNNEST([1,2] AS r1, r.Nations AS r2)
                            ^
==

# Multi-step join through multiple join columns, ending on a row type.
# Uses Flatten.
FROM Customer c
|> JOIN {{UNNEST(c.Orders.Lineitems)|c.Orders.Lineitems}} l
|> SELECT {{|c.}}c_name, {{|l.}}l_quantity
--
QueryStmt
+-output_column_list=
| +-Customer.C_NAME#2 AS c_name [STRING]
| +-$pipe_select.l_quantity#12 AS l_quantity [DOUBLE]
+-query=
  +-ProjectScan
    +-column_list=[Customer.C_NAME#2, $pipe_select.l_quantity#12]
    +-expr_list=
    | +-l_quantity#12 :=
    |   +-GetRowField
    |     +-type=DOUBLE
    |     +-expr=
    |     | +-ColumnRef(type=ROW<LineItem>, column=$array.l#11)
    |     +-column=LineItem.L_QUANTITY
    +-input_scan=
      +-ArrayScan
        +-column_list=[Customer.C_NAME#2, Customer.Orders#9, $array.l#11]
        +-input_scan=
        | +-TableScan(column_list=Customer.[C_NAME#2, Orders#9], table=Customer, column_index_list=[1, 8], alias="c")
        +-array_expr_list=
        | +-Flatten
        |   +-type=MULTIROW<LineItem (join)>
        |   +-expr=
        |   | +-ColumnRef(type=MULTIROW<Orders (join)>, column=Customer.Orders#9)
        |   +-get_field_list=
        |     +-GetRowField
        |       +-type=MULTIROW<LineItem (join)>
        |       +-expr=
        |       | +-FlattenedArg(type=ROW<Orders>)
        |       +-column=Orders.LineItems
        +-element_column_list=[$array.l#11]


[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-Customer.C_NAME#2 AS c_name [STRING]
| +-$pipe_select.l_quantity#12 AS l_quantity [DOUBLE]
+-query=
  +-ProjectScan
    +-column_list=[Customer.C_NAME#2, $pipe_select.l_quantity#12]
    +-expr_list=
    | +-l_quantity#12 :=
    |   +-GetStructField
    |     +-type=DOUBLE
    |     +-expr=
    |     | +-ColumnRef(type=STRUCT<L_QUANTITY DOUBLE>, column=$array.$l$scanrow#15)
    |     +-field_idx=0
    +-input_scan=
      +-ProjectScan
        +-column_list=[Customer.C_NAME#2, Customer.$Orders$join_multirow#16, $array.$l$scanrow#15]
        +-expr_list=
        | +-$l$scanrow#15 := ColumnRef(type=STRUCT<L_QUANTITY DOUBLE>, column=$flatten.$injected$scanrow#22)
        +-input_scan=
          +-JoinScan
            +-column_list=[Customer.C_NAME#2, Customer.$Orders$join_multirow#16, $flatten.$injected$scanrow#19, $flatten.$injected$scanrow#22]
            +-left_scan=
            | +-JoinScan
            |   +-column_list=[Customer.C_NAME#2, Customer.$Orders$join_multirow#16, $flatten.$injected$scanrow#19]
            |   +-left_scan=
            |   | +-ProjectScan
            |   |   +-column_list=Customer.[C_NAME#2, $Orders$join_multirow#16]
            |   |   +-expr_list=
            |   |   | +-$Orders$join_multirow#16 :=
            |   |   |   +-MakeStruct
            |   |   |     +-type=STRUCT<O_CUSTKEY UINT64>
            |   |   |     +-field_list=
            |   |   |       +-ColumnRef(type=UINT64, column=Customer.C_CUSTKEY#17)
            |   |   +-input_scan=
            |   |     +-TableScan(column_list=Customer.[C_NAME#2, C_CUSTKEY#17], table=Customer, alias="c", table_column_list=[Customer.C_NAME,Customer.C_CUSTKEY])
            |   +-right_scan=
            |   | +-ProjectScan
            |   |   +-column_list=[Orders.O_CUSTKEY#18, $flatten.$injected$scanrow#19]
            |   |   +-expr_list=
            |   |   | +-$injected$scanrow#19 :=
            |   |   |   +-MakeStruct
            |   |   |     +-type=STRUCT<LineItems STRUCT<L_ORDERKEY UINT64>>
            |   |   |     +-field_list=
            |   |   |       +-MakeStruct
            |   |   |         +-type=STRUCT<L_ORDERKEY UINT64>
            |   |   |         +-field_list=
            |   |   |           +-ColumnRef(type=UINT64, column=Orders.O_ORDERKEY#20)
            |   |   +-input_scan=
            |   |     +-TableScan(column_list=Orders.[O_CUSTKEY#18, O_ORDERKEY#20], table=Orders, table_column_list=[Orders.O_CUSTKEY,Orders.O_ORDERKEY])
            |   +-join_expr=
            |     +-FunctionCall(GoogleSQL:$equal(STRUCT<O_CUSTKEY UINT64>, STRUCT<O_CUSTKEY UINT64>) -> BOOL)
            |       +-MakeStruct
            |       | +-type=STRUCT<O_CUSTKEY UINT64>
            |       | +-field_list=
            |       |   +-ColumnRef(type=UINT64, column=Orders.O_CUSTKEY#18)
            |       +-ColumnRef(type=STRUCT<O_CUSTKEY UINT64>, column=Customer.$Orders$join_multirow#16)
            +-right_scan=
            | +-ProjectScan
            |   +-column_list=[LineItem.L_ORDERKEY#21, $flatten.$injected$scanrow#22]
            |   +-expr_list=
            |   | +-$injected$scanrow#22 :=
            |   |   +-MakeStruct
            |   |     +-type=STRUCT<L_QUANTITY DOUBLE>
            |   |     +-field_list=
            |   |       +-ColumnRef(type=DOUBLE, column=LineItem.L_QUANTITY#23)
            |   +-input_scan=
            |     +-TableScan(column_list=LineItem.[L_ORDERKEY#21, L_QUANTITY#23], table=LineItem, table_column_list=[LineItem.L_ORDERKEY,LineItem.L_QUANTITY])
            +-join_expr=
              +-FunctionCall(GoogleSQL:$equal(STRUCT<L_ORDERKEY UINT64>, STRUCT<L_ORDERKEY UINT64>) -> BOOL)
                +-MakeStruct
                | +-type=STRUCT<L_ORDERKEY UINT64>
                | +-field_list=
                |   +-ColumnRef(type=UINT64, column=LineItem.L_ORDERKEY#21)
                +-GetStructField
                  +-type=STRUCT<L_ORDERKEY UINT64>
                  +-expr=
                  | +-ColumnRef(type=STRUCT<LineItems STRUCT<L_ORDERKEY UINT64>>, column=$flatten.$injected$scanrow#19)
                  +-field_idx=0
==

# Multi-step join through multiple join columns, ending on a scalar field
# after the last row type.
# Uses Flatten.
FROM Customer c
|> JOIN {{UNNEST(c.Orders.Lineitems.l_quantity)|c.Orders.Lineitems.l_quantity}} q
|> SELECT c.c_name, q
--
QueryStmt
+-output_column_list=
| +-Customer.C_NAME#2 AS c_name [STRING]
| +-$array.q#11 AS q [DOUBLE]
+-query=
  +-ProjectScan
    +-column_list=[Customer.C_NAME#2, $array.q#11]
    +-input_scan=
      +-ArrayScan
        +-column_list=[Customer.C_NAME#2, Customer.Orders#9, $array.q#11]
        +-input_scan=
        | +-TableScan(column_list=Customer.[C_NAME#2, Orders#9], table=Customer, column_index_list=[1, 8], alias="c")
        +-array_expr_list=
        | +-Flatten
        |   +-type=ARRAY<DOUBLE>
        |   +-expr=
        |   | +-ColumnRef(type=MULTIROW<Orders (join)>, column=Customer.Orders#9)
        |   +-get_field_list=
        |     +-GetRowField
        |     | +-type=MULTIROW<LineItem (join)>
        |     | +-expr=
        |     | | +-FlattenedArg(type=ROW<Orders>)
        |     | +-column=Orders.LineItems
        |     +-GetRowField
        |       +-type=DOUBLE
        |       +-expr=
        |       | +-FlattenedArg(type=ROW<LineItem>)
        |       +-column=LineItem.L_QUANTITY
        +-element_column_list=[$array.q#11]


[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-Customer.C_NAME#2 AS c_name [STRING]
| +-$array.q#11 AS q [DOUBLE]
+-query=
  +-ProjectScan
    +-column_list=[Customer.C_NAME#2, $array.q#11]
    +-input_scan=
      +-ProjectScan
        +-column_list=[Customer.C_NAME#2, Customer.$Orders$join_multirow#16, $array.q#11]
        +-expr_list=
        | +-q#11 := ColumnRef(type=DOUBLE, column=$flatten.injected#14)
        +-input_scan=
          +-ProjectScan
            +-column_list=[Customer.C_NAME#2, Customer.$Orders$join_multirow#16, $flatten.$injected$scanrow#19, $flatten.$injected$scanrow#15, $flatten.injected#14]
            +-expr_list=
            | +-injected#14 :=
            |   +-GetStructField
            |     +-type=DOUBLE
            |     +-expr=
            |     | +-ColumnRef(type=STRUCT<L_QUANTITY DOUBLE>, column=$flatten.$injected$scanrow#15)
            |     +-field_idx=0
            +-input_scan=
              +-JoinScan
                +-column_list=[Customer.C_NAME#2, Customer.$Orders$join_multirow#16, $flatten.$injected$scanrow#19, $flatten.$injected$scanrow#15]
                +-left_scan=
                | +-JoinScan
                |   +-column_list=[Customer.C_NAME#2, Customer.$Orders$join_multirow#16, $flatten.$injected$scanrow#19]
                |   +-left_scan=
                |   | +-ProjectScan
                |   |   +-column_list=Customer.[C_NAME#2, $Orders$join_multirow#16]
                |   |   +-expr_list=
                |   |   | +-$Orders$join_multirow#16 :=
                |   |   |   +-MakeStruct
                |   |   |     +-type=STRUCT<O_CUSTKEY UINT64>
                |   |   |     +-field_list=
                |   |   |       +-ColumnRef(type=UINT64, column=Customer.C_CUSTKEY#17)
                |   |   +-input_scan=
                |   |     +-TableScan(column_list=Customer.[C_NAME#2, C_CUSTKEY#17], table=Customer, alias="c", table_column_list=[Customer.C_NAME,Customer.C_CUSTKEY])
                |   +-right_scan=
                |   | +-ProjectScan
                |   |   +-column_list=[Orders.O_CUSTKEY#18, $flatten.$injected$scanrow#19]
                |   |   +-expr_list=
                |   |   | +-$injected$scanrow#19 :=
                |   |   |   +-MakeStruct
                |   |   |     +-type=STRUCT<LineItems STRUCT<L_ORDERKEY UINT64>>
                |   |   |     +-field_list=
                |   |   |       +-MakeStruct
                |   |   |         +-type=STRUCT<L_ORDERKEY UINT64>
                |   |   |         +-field_list=
                |   |   |           +-ColumnRef(type=UINT64, column=Orders.O_ORDERKEY#20)
                |   |   +-input_scan=
                |   |     +-TableScan(column_list=Orders.[O_CUSTKEY#18, O_ORDERKEY#20], table=Orders, table_column_list=[Orders.O_CUSTKEY,Orders.O_ORDERKEY])
                |   +-join_expr=
                |     +-FunctionCall(GoogleSQL:$equal(STRUCT<O_CUSTKEY UINT64>, STRUCT<O_CUSTKEY UINT64>) -> BOOL)
                |       +-MakeStruct
                |       | +-type=STRUCT<O_CUSTKEY UINT64>
                |       | +-field_list=
                |       |   +-ColumnRef(type=UINT64, column=Orders.O_CUSTKEY#18)
                |       +-ColumnRef(type=STRUCT<O_CUSTKEY UINT64>, column=Customer.$Orders$join_multirow#16)
                +-right_scan=
                | +-ProjectScan
                |   +-column_list=[LineItem.L_ORDERKEY#21, $flatten.$injected$scanrow#15]
                |   +-expr_list=
                |   | +-$injected$scanrow#15 :=
                |   |   +-MakeStruct
                |   |     +-type=STRUCT<L_QUANTITY DOUBLE>
                |   |     +-field_list=
                |   |       +-ColumnRef(type=DOUBLE, column=LineItem.L_QUANTITY#22)
                |   +-input_scan=
                |     +-TableScan(column_list=LineItem.[L_ORDERKEY#21, L_QUANTITY#22], table=LineItem, table_column_list=[LineItem.L_ORDERKEY,LineItem.L_QUANTITY])
                +-join_expr=
                  +-FunctionCall(GoogleSQL:$equal(STRUCT<L_ORDERKEY UINT64>, STRUCT<L_ORDERKEY UINT64>) -> BOOL)
                    +-MakeStruct
                    | +-type=STRUCT<L_ORDERKEY UINT64>
                    | +-field_list=
                    |   +-ColumnRef(type=UINT64, column=LineItem.L_ORDERKEY#21)
                    +-GetStructField
                      +-type=STRUCT<L_ORDERKEY UINT64>
                      +-expr=
                      | +-ColumnRef(type=STRUCT<LineItems STRUCT<L_ORDERKEY UINT64>>, column=$flatten.$injected$scanrow#19)
                      +-field_idx=0
==

# Implicit flattening in the FROM table name.
# This is like `FROM TableName.array.array`.
FROM Customer.Orders.Lineitems
|> SELECT l_quantity
--
QueryStmt
+-output_column_list=
| +-$pipe_select.l_quantity#12 AS l_quantity [DOUBLE]
+-query=
  +-ProjectScan
    +-column_list=[$pipe_select.l_quantity#12]
    +-expr_list=
    | +-l_quantity#12 :=
    |   +-GetRowField
    |     +-type=DOUBLE
    |     +-expr=
    |     | +-ColumnRef(type=ROW<LineItem>, column=$array.Lineitems#11)
    |     +-column=LineItem.L_QUANTITY
    +-input_scan=
      +-ArrayScan
        +-column_list=[$array.Lineitems#11]
        +-node_source="single_table_array_name_path"
        +-input_scan=
        | +-TableScan(column_list=[Customer.Orders#9], table=Customer, column_index_list=[8])
        +-array_expr_list=
        | +-Flatten
        |   +-type=MULTIROW<LineItem (join)>
        |   +-expr=
        |   | +-ColumnRef(type=MULTIROW<Orders (join)>, column=Customer.Orders#9)
        |   +-get_field_list=
        |     +-GetRowField
        |       +-type=MULTIROW<LineItem (join)>
        |       +-expr=
        |       | +-FlattenedArg(type=ROW<Orders>)
        |       +-column=Orders.LineItems
        +-element_column_list=[$array.Lineitems#11]


[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-$pipe_select.l_quantity#12 AS l_quantity [DOUBLE]
+-query=
  +-ProjectScan
    +-column_list=[$pipe_select.l_quantity#12]
    +-expr_list=
    | +-l_quantity#12 :=
    |   +-GetStructField
    |     +-type=DOUBLE
    |     +-expr=
    |     | +-ColumnRef(type=STRUCT<L_QUANTITY DOUBLE>, column=$array.$Lineitems$scanrow#15)
    |     +-field_idx=0
    +-input_scan=
      +-ProjectScan
        +-column_list=[$array.$Lineitems$scanrow#15]
        +-expr_list=
        | +-$Lineitems$scanrow#15 := ColumnRef(type=STRUCT<L_QUANTITY DOUBLE>, column=$flatten.$injected$scanrow#22)
        +-input_scan=
          +-JoinScan
            +-column_list=[Customer.$Orders$join_multirow#16, $flatten.$injected$scanrow#19, $flatten.$injected$scanrow#22]
            +-left_scan=
            | +-JoinScan
            |   +-column_list=[Customer.$Orders$join_multirow#16, $flatten.$injected$scanrow#19]
            |   +-left_scan=
            |   | +-ProjectScan
            |   |   +-column_list=[Customer.$Orders$join_multirow#16]
            |   |   +-expr_list=
            |   |   | +-$Orders$join_multirow#16 :=
            |   |   |   +-MakeStruct
            |   |   |     +-type=STRUCT<O_CUSTKEY UINT64>
            |   |   |     +-field_list=
            |   |   |       +-ColumnRef(type=UINT64, column=Customer.C_CUSTKEY#17)
            |   |   +-input_scan=
            |   |     +-TableScan(column_list=[Customer.C_CUSTKEY#17], table=Customer, table_column_list=[Customer.C_CUSTKEY])
            |   +-right_scan=
            |   | +-ProjectScan
            |   |   +-column_list=[Orders.O_CUSTKEY#18, $flatten.$injected$scanrow#19]
            |   |   +-expr_list=
            |   |   | +-$injected$scanrow#19 :=
            |   |   |   +-MakeStruct
            |   |   |     +-type=STRUCT<LineItems STRUCT<L_ORDERKEY UINT64>>
            |   |   |     +-field_list=
            |   |   |       +-MakeStruct
            |   |   |         +-type=STRUCT<L_ORDERKEY UINT64>
            |   |   |         +-field_list=
            |   |   |           +-ColumnRef(type=UINT64, column=Orders.O_ORDERKEY#20)
            |   |   +-input_scan=
            |   |     +-TableScan(column_list=Orders.[O_CUSTKEY#18, O_ORDERKEY#20], table=Orders, table_column_list=[Orders.O_CUSTKEY,Orders.O_ORDERKEY])
            |   +-join_expr=
            |     +-FunctionCall(GoogleSQL:$equal(STRUCT<O_CUSTKEY UINT64>, STRUCT<O_CUSTKEY UINT64>) -> BOOL)
            |       +-MakeStruct
            |       | +-type=STRUCT<O_CUSTKEY UINT64>
            |       | +-field_list=
            |       |   +-ColumnRef(type=UINT64, column=Orders.O_CUSTKEY#18)
            |       +-ColumnRef(type=STRUCT<O_CUSTKEY UINT64>, column=Customer.$Orders$join_multirow#16)
            +-right_scan=
            | +-ProjectScan
            |   +-column_list=[LineItem.L_ORDERKEY#21, $flatten.$injected$scanrow#22]
            |   +-expr_list=
            |   | +-$injected$scanrow#22 :=
            |   |   +-MakeStruct
            |   |     +-type=STRUCT<L_QUANTITY DOUBLE>
            |   |     +-field_list=
            |   |       +-ColumnRef(type=DOUBLE, column=LineItem.L_QUANTITY#23)
            |   +-input_scan=
            |     +-TableScan(column_list=LineItem.[L_ORDERKEY#21, L_QUANTITY#23], table=LineItem, table_column_list=[LineItem.L_ORDERKEY,LineItem.L_QUANTITY])
            +-join_expr=
              +-FunctionCall(GoogleSQL:$equal(STRUCT<L_ORDERKEY UINT64>, STRUCT<L_ORDERKEY UINT64>) -> BOOL)
                +-MakeStruct
                | +-type=STRUCT<L_ORDERKEY UINT64>
                | +-field_list=
                |   +-ColumnRef(type=UINT64, column=LineItem.L_ORDERKEY#21)
                +-GetStructField
                  +-type=STRUCT<L_ORDERKEY UINT64>
                  +-expr=
                  | +-ColumnRef(type=STRUCT<LineItems STRUCT<L_ORDERKEY UINT64>>, column=$flatten.$injected$scanrow#19)
                  +-field_idx=0
==

# Implicit flattening in the FROM table name, all the way to a scalar field,
# making a scalar value table.
FROM Customer.Orders.Lineitems.l_quantity
--
QueryStmt
+-output_column_list=
| +-$array.l_quantity#11 AS `$value` [DOUBLE]
+-is_value_table=TRUE
+-query=
  +-ArrayScan
    +-column_list=[$array.l_quantity#11]
    +-node_source="single_table_array_name_path"
    +-input_scan=
    | +-TableScan(column_list=[Customer.Orders#9], table=Customer, column_index_list=[8])
    +-array_expr_list=
    | +-Flatten
    |   +-type=ARRAY<DOUBLE>
    |   +-expr=
    |   | +-ColumnRef(type=MULTIROW<Orders (join)>, column=Customer.Orders#9)
    |   +-get_field_list=
    |     +-GetRowField
    |     | +-type=MULTIROW<LineItem (join)>
    |     | +-expr=
    |     | | +-FlattenedArg(type=ROW<Orders>)
    |     | +-column=Orders.LineItems
    |     +-GetRowField
    |       +-type=DOUBLE
    |       +-expr=
    |       | +-FlattenedArg(type=ROW<LineItem>)
    |       +-column=LineItem.L_QUANTITY
    +-element_column_list=[$array.l_quantity#11]


[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-$array.l_quantity#11 AS `$value` [DOUBLE]
+-is_value_table=TRUE
+-query=
  +-ProjectScan
    +-column_list=[$array.l_quantity#11]
    +-expr_list=
    | +-l_quantity#11 := ColumnRef(type=DOUBLE, column=$flatten.injected#14)
    +-input_scan=
      +-ProjectScan
        +-column_list=[Customer.$Orders$join_multirow#16, $flatten.$injected$scanrow#19, $flatten.$injected$scanrow#15, $flatten.injected#14]
        +-expr_list=
        | +-injected#14 :=
        |   +-GetStructField
        |     +-type=DOUBLE
        |     +-expr=
        |     | +-ColumnRef(type=STRUCT<L_QUANTITY DOUBLE>, column=$flatten.$injected$scanrow#15)
        |     +-field_idx=0
        +-input_scan=
          +-JoinScan
            +-column_list=[Customer.$Orders$join_multirow#16, $flatten.$injected$scanrow#19, $flatten.$injected$scanrow#15]
            +-left_scan=
            | +-JoinScan
            |   +-column_list=[Customer.$Orders$join_multirow#16, $flatten.$injected$scanrow#19]
            |   +-left_scan=
            |   | +-ProjectScan
            |   |   +-column_list=[Customer.$Orders$join_multirow#16]
            |   |   +-expr_list=
            |   |   | +-$Orders$join_multirow#16 :=
            |   |   |   +-MakeStruct
            |   |   |     +-type=STRUCT<O_CUSTKEY UINT64>
            |   |   |     +-field_list=
            |   |   |       +-ColumnRef(type=UINT64, column=Customer.C_CUSTKEY#17)
            |   |   +-input_scan=
            |   |     +-TableScan(column_list=[Customer.C_CUSTKEY#17], table=Customer, table_column_list=[Customer.C_CUSTKEY])
            |   +-right_scan=
            |   | +-ProjectScan
            |   |   +-column_list=[Orders.O_CUSTKEY#18, $flatten.$injected$scanrow#19]
            |   |   +-expr_list=
            |   |   | +-$injected$scanrow#19 :=
            |   |   |   +-MakeStruct
            |   |   |     +-type=STRUCT<LineItems STRUCT<L_ORDERKEY UINT64>>
            |   |   |     +-field_list=
            |   |   |       +-MakeStruct
            |   |   |         +-type=STRUCT<L_ORDERKEY UINT64>
            |   |   |         +-field_list=
            |   |   |           +-ColumnRef(type=UINT64, column=Orders.O_ORDERKEY#20)
            |   |   +-input_scan=
            |   |     +-TableScan(column_list=Orders.[O_CUSTKEY#18, O_ORDERKEY#20], table=Orders, table_column_list=[Orders.O_CUSTKEY,Orders.O_ORDERKEY])
            |   +-join_expr=
            |     +-FunctionCall(GoogleSQL:$equal(STRUCT<O_CUSTKEY UINT64>, STRUCT<O_CUSTKEY UINT64>) -> BOOL)
            |       +-MakeStruct
            |       | +-type=STRUCT<O_CUSTKEY UINT64>
            |       | +-field_list=
            |       |   +-ColumnRef(type=UINT64, column=Orders.O_CUSTKEY#18)
            |       +-ColumnRef(type=STRUCT<O_CUSTKEY UINT64>, column=Customer.$Orders$join_multirow#16)
            +-right_scan=
            | +-ProjectScan
            |   +-column_list=[LineItem.L_ORDERKEY#21, $flatten.$injected$scanrow#15]
            |   +-expr_list=
            |   | +-$injected$scanrow#15 :=
            |   |   +-MakeStruct
            |   |     +-type=STRUCT<L_QUANTITY DOUBLE>
            |   |     +-field_list=
            |   |       +-ColumnRef(type=DOUBLE, column=LineItem.L_QUANTITY#22)
            |   +-input_scan=
            |     +-TableScan(column_list=LineItem.[L_ORDERKEY#21, L_QUANTITY#22], table=LineItem, table_column_list=[LineItem.L_ORDERKEY,LineItem.L_QUANTITY])
            +-join_expr=
              +-FunctionCall(GoogleSQL:$equal(STRUCT<L_ORDERKEY UINT64>, STRUCT<L_ORDERKEY UINT64>) -> BOOL)
                +-MakeStruct
                | +-type=STRUCT<L_ORDERKEY UINT64>
                | +-field_list=
                |   +-ColumnRef(type=UINT64, column=LineItem.L_ORDERKEY#21)
                +-GetStructField
                  +-type=STRUCT<L_ORDERKEY UINT64>
                  +-expr=
                  | +-ColumnRef(type=STRUCT<LineItems STRUCT<L_ORDERKEY UINT64>>, column=$flatten.$injected$scanrow#19)
                  +-field_idx=0
==

# RIGHT and FULL outer joins aren't allowed, to either ROW or MULTIROW.
FROM Customer c
|> {{RIGHT|FULL}} JOIN c.{{Nation|Orders}} x
|> AGGREGATE COUNT(*)
--
ALTERNATION GROUP: RIGHT,Nation
--
ERROR: Correlated array references are not allowed with RIGHT JOIN: c.Nation [at 2:15]
|> RIGHT JOIN c.Nation x
              ^
--
ALTERNATION GROUP: RIGHT,Orders
--
ERROR: Correlated array references are not allowed with RIGHT JOIN: c.Orders [at 2:15]
|> RIGHT JOIN c.Orders x
              ^
--
ALTERNATION GROUP: FULL,Nation
--
ERROR: Correlated array references are not allowed with FULL JOIN: c.Nation [at 2:14]
|> FULL JOIN c.Nation x
             ^
--
ALTERNATION GROUP: FULL,Orders
--
ERROR: Correlated array references are not allowed with FULL JOIN: c.Orders [at 2:14]
|> FULL JOIN c.Orders x
             ^
==

# LEFT outer join to ROW.
FROM Customer c
|> LEFT JOIN c.Nation
|> AGGREGATE COUNT(n_comment)
--
QueryStmt
+-output_column_list=
| +-$aggregate.$agg1#12 AS `$col1` [INT64]
+-query=
  +-AggregateScan
    +-column_list=[$aggregate.$agg1#12]
    +-input_scan=
    | +-ArrayScan
    |   +-column_list=[Customer.Nation#10, $array.Nation#11]
    |   +-input_scan=
    |   | +-TableScan(column_list=[Customer.Nation#10], table=Customer, column_index_list=[9], alias="c")
    |   +-array_expr_list=
    |   | +-ColumnRef(type=ROW<Nation (join)>, column=Customer.Nation#10)
    |   +-element_column_list=[$array.Nation#11]
    |   +-is_outer=TRUE
    +-aggregate_list=
      +-$agg1#12 :=
        +-AggregateFunctionCall(GoogleSQL:count(STRING) -> INT64)
          +-GetRowField
            +-type=STRING
            +-expr=
            | +-ColumnRef(type=ROW<Nation>, column=$array.Nation#11)
            +-column=Nation.N_COMMENT


[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-$aggregate.$agg1#12 AS `$col1` [INT64]
+-query=
  +-AggregateScan
    +-column_list=[$aggregate.$agg1#12]
    +-input_scan=
    | +-JoinScan
    |   +-column_list=[Customer.$Nation$join_row#13, $array.$Nation$scanrow#16]
    |   +-join_type=LEFT
    |   +-left_scan=
    |   | +-ProjectScan
    |   |   +-column_list=[Customer.$Nation$join_row#13]
    |   |   +-expr_list=
    |   |   | +-$Nation$join_row#13 :=
    |   |   |   +-MakeStruct
    |   |   |     +-type=STRUCT<N_NATIONKEY UINT64>
    |   |   |     +-field_list=
    |   |   |       +-ColumnRef(type=UINT64, column=Customer.C_NATIONKEY#14)
    |   |   +-input_scan=
    |   |     +-TableScan(column_list=[Customer.C_NATIONKEY#14], table=Customer, alias="c", table_column_list=[Customer.C_NATIONKEY])
    |   +-right_scan=
    |   | +-ProjectScan
    |   |   +-column_list=[Nation.N_NATIONKEY#15, $array.$Nation$scanrow#16]
    |   |   +-expr_list=
    |   |   | +-$Nation$scanrow#16 :=
    |   |   |   +-MakeStruct
    |   |   |     +-type=STRUCT<N_COMMENT STRING>
    |   |   |     +-field_list=
    |   |   |       +-ColumnRef(type=STRING, column=Nation.N_COMMENT#17)
    |   |   +-input_scan=
    |   |     +-TableScan(column_list=Nation.[N_NATIONKEY#15, N_COMMENT#17], table=Nation, table_column_list=[Nation.N_NATIONKEY,Nation.N_COMMENT])
    |   +-join_expr=
    |     +-FunctionCall(GoogleSQL:$equal(STRUCT<N_NATIONKEY UINT64>, STRUCT<N_NATIONKEY UINT64>) -> BOOL)
    |       +-MakeStruct
    |       | +-type=STRUCT<N_NATIONKEY UINT64>
    |       | +-field_list=
    |       |   +-ColumnRef(type=UINT64, column=Nation.N_NATIONKEY#15)
    |       +-ColumnRef(type=STRUCT<N_NATIONKEY UINT64>, column=Customer.$Nation$join_row#13)
    +-aggregate_list=
      +-$agg1#12 :=
        +-AggregateFunctionCall(GoogleSQL:count(STRING) -> INT64)
          +-GetStructField
            +-type=STRING
            +-expr=
            | +-ColumnRef(type=STRUCT<N_COMMENT STRING>, column=$array.$Nation$scanrow#16)
            +-field_idx=0
==

# Test doing a join column expansion but not reading any columns from it.
# This requires rewrites triggered from the ArrayScan only.
FROM Customer c
|> JOIN c.Orders
|> AGGREGATE COUNT(*)
--
QueryStmt
+-output_column_list=
| +-$aggregate.$agg1#12 AS `$col1` [INT64]
+-query=
  +-AggregateScan
    +-column_list=[$aggregate.$agg1#12]
    +-input_scan=
    | +-ArrayScan
    |   +-column_list=[Customer.Orders#9]
    |   +-input_scan=
    |   | +-TableScan(column_list=[Customer.Orders#9], table=Customer, column_index_list=[8], alias="c")
    |   +-array_expr_list=
    |   | +-ColumnRef(type=MULTIROW<Orders (join)>, column=Customer.Orders#9)
    |   +-element_column_list=[$array.Orders#11]
    +-aggregate_list=
      +-$agg1#12 := AggregateFunctionCall(GoogleSQL:$count_star() -> INT64)


[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-$aggregate.$agg1#12 AS `$col1` [INT64]
+-query=
  +-AggregateScan
    +-column_list=[$aggregate.$agg1#12]
    +-input_scan=
    | +-JoinScan
    |   +-column_list=[Customer.$Orders$join_multirow#13]
    |   +-left_scan=
    |   | +-ProjectScan
    |   |   +-column_list=[Customer.$Orders$join_multirow#13]
    |   |   +-expr_list=
    |   |   | +-$Orders$join_multirow#13 :=
    |   |   |   +-MakeStruct
    |   |   |     +-type=STRUCT<O_CUSTKEY UINT64>
    |   |   |     +-field_list=
    |   |   |       +-ColumnRef(type=UINT64, column=Customer.C_CUSTKEY#14)
    |   |   +-input_scan=
    |   |     +-TableScan(column_list=[Customer.C_CUSTKEY#14], table=Customer, alias="c", table_column_list=[Customer.C_CUSTKEY])
    |   +-right_scan=
    |   | +-ProjectScan
    |   |   +-column_list=[Orders.O_CUSTKEY#15, $array.$Orders$scanrow#16]
    |   |   +-expr_list=
    |   |   | +-$Orders$scanrow#16 := MakeStruct(type=STRUCT<>)
    |   |   +-input_scan=
    |   |     +-TableScan(column_list=[Orders.O_CUSTKEY#15], table=Orders, table_column_list=[Orders.O_CUSTKEY])
    |   +-join_expr=
    |     +-FunctionCall(GoogleSQL:$equal(STRUCT<O_CUSTKEY UINT64>, STRUCT<O_CUSTKEY UINT64>) -> BOOL)
    |       +-MakeStruct
    |       | +-type=STRUCT<O_CUSTKEY UINT64>
    |       | +-field_list=
    |       |   +-ColumnRef(type=UINT64, column=Orders.O_CUSTKEY#15)
    |       +-ColumnRef(type=STRUCT<O_CUSTKEY UINT64>, column=Customer.$Orders$join_multirow#13)
    +-aggregate_list=
      +-$agg1#12 := AggregateFunctionCall(GoogleSQL:$count_star() -> INT64)
==

# LEFT outer join to MULTIROW.
FROM Customer c
|> LEFT JOIN c.Orders
|> AGGREGATE COUNT(o_comment)
--
QueryStmt
+-output_column_list=
| +-$aggregate.$agg1#12 AS `$col1` [INT64]
+-query=
  +-AggregateScan
    +-column_list=[$aggregate.$agg1#12]
    +-input_scan=
    | +-ArrayScan
    |   +-column_list=[Customer.Orders#9, $array.Orders#11]
    |   +-input_scan=
    |   | +-TableScan(column_list=[Customer.Orders#9], table=Customer, column_index_list=[8], alias="c")
    |   +-array_expr_list=
    |   | +-ColumnRef(type=MULTIROW<Orders (join)>, column=Customer.Orders#9)
    |   +-element_column_list=[$array.Orders#11]
    |   +-is_outer=TRUE
    +-aggregate_list=
      +-$agg1#12 :=
        +-AggregateFunctionCall(GoogleSQL:count(STRING) -> INT64)
          +-GetRowField
            +-type=STRING
            +-expr=
            | +-ColumnRef(type=ROW<Orders>, column=$array.Orders#11)
            +-column=Orders.O_COMMENT


[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-$aggregate.$agg1#12 AS `$col1` [INT64]
+-query=
  +-AggregateScan
    +-column_list=[$aggregate.$agg1#12]
    +-input_scan=
    | +-JoinScan
    |   +-column_list=[Customer.$Orders$join_multirow#13, $array.$Orders$scanrow#16]
    |   +-join_type=LEFT
    |   +-left_scan=
    |   | +-ProjectScan
    |   |   +-column_list=[Customer.$Orders$join_multirow#13]
    |   |   +-expr_list=
    |   |   | +-$Orders$join_multirow#13 :=
    |   |   |   +-MakeStruct
    |   |   |     +-type=STRUCT<O_CUSTKEY UINT64>
    |   |   |     +-field_list=
    |   |   |       +-ColumnRef(type=UINT64, column=Customer.C_CUSTKEY#14)
    |   |   +-input_scan=
    |   |     +-TableScan(column_list=[Customer.C_CUSTKEY#14], table=Customer, alias="c", table_column_list=[Customer.C_CUSTKEY])
    |   +-right_scan=
    |   | +-ProjectScan
    |   |   +-column_list=[Orders.O_CUSTKEY#15, $array.$Orders$scanrow#16]
    |   |   +-expr_list=
    |   |   | +-$Orders$scanrow#16 :=
    |   |   |   +-MakeStruct
    |   |   |     +-type=STRUCT<O_COMMENT STRING>
    |   |   |     +-field_list=
    |   |   |       +-ColumnRef(type=STRING, column=Orders.O_COMMENT#17)
    |   |   +-input_scan=
    |   |     +-TableScan(column_list=Orders.[O_CUSTKEY#15, O_COMMENT#17], table=Orders, table_column_list=[Orders.O_CUSTKEY,Orders.O_COMMENT])
    |   +-join_expr=
    |     +-FunctionCall(GoogleSQL:$equal(STRUCT<O_CUSTKEY UINT64>, STRUCT<O_CUSTKEY UINT64>) -> BOOL)
    |       +-MakeStruct
    |       | +-type=STRUCT<O_CUSTKEY UINT64>
    |       | +-field_list=
    |       |   +-ColumnRef(type=UINT64, column=Orders.O_CUSTKEY#15)
    |       +-ColumnRef(type=STRUCT<O_CUSTKEY UINT64>, column=Customer.$Orders$join_multirow#13)
    +-aggregate_list=
      +-$agg1#12 :=
        +-AggregateFunctionCall(GoogleSQL:count(STRING) -> INT64)
          +-GetStructField
            +-type=STRING
            +-expr=
            | +-ColumnRef(type=STRUCT<O_COMMENT STRING>, column=$array.$Orders$scanrow#16)
            +-field_idx=0
==

# Joins with a condition with ON
FROM Customer c
|> {{|LEFT}} JOIN c.Nation ON c_name=n_name
|> SELECT c_name, n_name
--
ALTERNATION GROUP: <empty>
--
QueryStmt
+-output_column_list=
| +-Customer.C_NAME#2 AS c_name [STRING]
| +-$pipe_select.n_name#12 AS n_name [STRING]
+-query=
  +-ProjectScan
    +-column_list=[Customer.C_NAME#2, $pipe_select.n_name#12]
    +-expr_list=
    | +-n_name#12 :=
    |   +-GetRowField
    |     +-type=STRING
    |     +-expr=
    |     | +-ColumnRef(type=ROW<Nation>, column=$array.Nation#11)
    |     +-column=Nation.N_NAME
    +-input_scan=
      +-ArrayScan
        +-column_list=[Customer.C_NAME#2, Customer.Nation#10, $array.Nation#11]
        +-input_scan=
        | +-TableScan(column_list=Customer.[C_NAME#2, Nation#10], table=Customer, column_index_list=[1, 9], alias="c")
        +-array_expr_list=
        | +-ColumnRef(type=ROW<Nation (join)>, column=Customer.Nation#10)
        +-element_column_list=[$array.Nation#11]
        +-join_expr=
          +-FunctionCall(GoogleSQL:$equal(STRING, STRING) -> BOOL)
            +-ColumnRef(type=STRING, column=Customer.C_NAME#2)
            +-GetRowField
              +-type=STRING
              +-expr=
              | +-ColumnRef(type=ROW<Nation>, column=$array.Nation#11)
              +-column=Nation.N_NAME


[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-Customer.C_NAME#2 AS c_name [STRING]
| +-$pipe_select.n_name#12 AS n_name [STRING]
+-query=
  +-ProjectScan
    +-column_list=[Customer.C_NAME#2, $pipe_select.n_name#12]
    +-expr_list=
    | +-n_name#12 :=
    |   +-GetStructField
    |     +-type=STRING
    |     +-expr=
    |     | +-ColumnRef(type=STRUCT<N_NAME STRING>, column=$array.$Nation$scanrow#13)
    |     +-field_idx=0
    +-input_scan=
      +-JoinScan
        +-column_list=[Customer.C_NAME#2, Customer.$Nation$join_row#14, $array.$Nation$scanrow#13]
        +-left_scan=
        | +-ProjectScan
        |   +-column_list=Customer.[C_NAME#2, $Nation$join_row#14]
        |   +-expr_list=
        |   | +-$Nation$join_row#14 :=
        |   |   +-MakeStruct
        |   |     +-type=STRUCT<N_NATIONKEY UINT64>
        |   |     +-field_list=
        |   |       +-ColumnRef(type=UINT64, column=Customer.C_NATIONKEY#15)
        |   +-input_scan=
        |     +-TableScan(column_list=Customer.[C_NAME#2, C_NATIONKEY#15], table=Customer, alias="c", table_column_list=[Customer.C_NAME,Customer.C_NATIONKEY])
        +-right_scan=
        | +-ProjectScan
        |   +-column_list=[Nation.N_NATIONKEY#16, $array.$Nation$scanrow#13]
        |   +-expr_list=
        |   | +-$Nation$scanrow#13 :=
        |   |   +-MakeStruct
        |   |     +-type=STRUCT<N_NAME STRING>
        |   |     +-field_list=
        |   |       +-ColumnRef(type=STRING, column=Nation.N_NAME#17)
        |   +-input_scan=
        |     +-TableScan(column_list=Nation.[N_NATIONKEY#16, N_NAME#17], table=Nation, table_column_list=[Nation.N_NATIONKEY,Nation.N_NAME])
        +-join_expr=
          +-FunctionCall(GoogleSQL:$and(BOOL, repeated(1) BOOL) -> BOOL)
            +-FunctionCall(GoogleSQL:$equal(STRUCT<N_NATIONKEY UINT64>, STRUCT<N_NATIONKEY UINT64>) -> BOOL)
            | +-MakeStruct
            | | +-type=STRUCT<N_NATIONKEY UINT64>
            | | +-field_list=
            | |   +-ColumnRef(type=UINT64, column=Nation.N_NATIONKEY#16)
            | +-ColumnRef(type=STRUCT<N_NATIONKEY UINT64>, column=Customer.$Nation$join_row#14)
            +-FunctionCall(GoogleSQL:$equal(STRING, STRING) -> BOOL)
              +-ColumnRef(type=STRING, column=Customer.C_NAME#2)
              +-GetStructField
                +-type=STRING
                +-expr=
                | +-ColumnRef(type=STRUCT<N_NAME STRING>, column=$array.$Nation$scanrow#13)
                +-field_idx=0
--
ALTERNATION GROUP: LEFT
--
QueryStmt
+-output_column_list=
| +-Customer.C_NAME#2 AS c_name [STRING]
| +-$pipe_select.n_name#12 AS n_name [STRING]
+-query=
  +-ProjectScan
    +-column_list=[Customer.C_NAME#2, $pipe_select.n_name#12]
    +-expr_list=
    | +-n_name#12 :=
    |   +-GetRowField
    |     +-type=STRING
    |     +-expr=
    |     | +-ColumnRef(type=ROW<Nation>, column=$array.Nation#11)
    |     +-column=Nation.N_NAME
    +-input_scan=
      +-ArrayScan
        +-column_list=[Customer.C_NAME#2, Customer.Nation#10, $array.Nation#11]
        +-input_scan=
        | +-TableScan(column_list=Customer.[C_NAME#2, Nation#10], table=Customer, column_index_list=[1, 9], alias="c")
        +-array_expr_list=
        | +-ColumnRef(type=ROW<Nation (join)>, column=Customer.Nation#10)
        +-element_column_list=[$array.Nation#11]
        +-join_expr=
        | +-FunctionCall(GoogleSQL:$equal(STRING, STRING) -> BOOL)
        |   +-ColumnRef(type=STRING, column=Customer.C_NAME#2)
        |   +-GetRowField
        |     +-type=STRING
        |     +-expr=
        |     | +-ColumnRef(type=ROW<Nation>, column=$array.Nation#11)
        |     +-column=Nation.N_NAME
        +-is_outer=TRUE


[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-Customer.C_NAME#2 AS c_name [STRING]
| +-$pipe_select.n_name#12 AS n_name [STRING]
+-query=
  +-ProjectScan
    +-column_list=[Customer.C_NAME#2, $pipe_select.n_name#12]
    +-expr_list=
    | +-n_name#12 :=
    |   +-GetStructField
    |     +-type=STRING
    |     +-expr=
    |     | +-ColumnRef(type=STRUCT<N_NAME STRING>, column=$array.$Nation$scanrow#13)
    |     +-field_idx=0
    +-input_scan=
      +-JoinScan
        +-column_list=[Customer.C_NAME#2, Customer.$Nation$join_row#14, $array.$Nation$scanrow#13]
        +-join_type=LEFT
        +-left_scan=
        | +-ProjectScan
        |   +-column_list=Customer.[C_NAME#2, $Nation$join_row#14]
        |   +-expr_list=
        |   | +-$Nation$join_row#14 :=
        |   |   +-MakeStruct
        |   |     +-type=STRUCT<N_NATIONKEY UINT64>
        |   |     +-field_list=
        |   |       +-ColumnRef(type=UINT64, column=Customer.C_NATIONKEY#15)
        |   +-input_scan=
        |     +-TableScan(column_list=Customer.[C_NAME#2, C_NATIONKEY#15], table=Customer, alias="c", table_column_list=[Customer.C_NAME,Customer.C_NATIONKEY])
        +-right_scan=
        | +-ProjectScan
        |   +-column_list=[Nation.N_NATIONKEY#16, $array.$Nation$scanrow#13]
        |   +-expr_list=
        |   | +-$Nation$scanrow#13 :=
        |   |   +-MakeStruct
        |   |     +-type=STRUCT<N_NAME STRING>
        |   |     +-field_list=
        |   |       +-ColumnRef(type=STRING, column=Nation.N_NAME#17)
        |   +-input_scan=
        |     +-TableScan(column_list=Nation.[N_NATIONKEY#16, N_NAME#17], table=Nation, table_column_list=[Nation.N_NATIONKEY,Nation.N_NAME])
        +-join_expr=
          +-FunctionCall(GoogleSQL:$and(BOOL, repeated(1) BOOL) -> BOOL)
            +-FunctionCall(GoogleSQL:$equal(STRUCT<N_NATIONKEY UINT64>, STRUCT<N_NATIONKEY UINT64>) -> BOOL)
            | +-MakeStruct
            | | +-type=STRUCT<N_NATIONKEY UINT64>
            | | +-field_list=
            | |   +-ColumnRef(type=UINT64, column=Nation.N_NATIONKEY#16)
            | +-ColumnRef(type=STRUCT<N_NATIONKEY UINT64>, column=Customer.$Nation$join_row#14)
            +-FunctionCall(GoogleSQL:$equal(STRING, STRING) -> BOOL)
              +-ColumnRef(type=STRING, column=Customer.C_NAME#2)
              +-GetStructField
                +-type=STRING
                +-expr=
                | +-ColumnRef(type=STRUCT<N_NAME STRING>, column=$array.$Nation$scanrow#13)
                +-field_idx=0
==

# Joins with a condition with USING
FROM Customer c
|> EXTEND c_name AS n_name
|> {{|LEFT}} JOIN c.Nation USING(n_name)
|> SELECT c_name, n_name
--
ALTERNATION GROUP: <empty>
--
QueryStmt
+-output_column_list=
| +-Customer.C_NAME#2 AS c_name [STRING]
| +-Customer.C_NAME#2 AS n_name [STRING]
+-query=
  +-ProjectScan
    +-column_list=Customer.[C_NAME#2, C_NAME#2]
    +-input_scan=
      +-ArrayScan
        +-column_list=[Customer.C_NAME#2, Customer.Nation#10, $array.Nation#11]
        +-input_scan=
        | +-TableScan(column_list=Customer.[C_NAME#2, Nation#10], table=Customer, column_index_list=[1, 9], alias="c")
        +-array_expr_list=
        | +-ColumnRef(type=ROW<Nation (join)>, column=Customer.Nation#10)
        +-element_column_list=[$array.Nation#11]
        +-join_expr=
          +-FunctionCall(GoogleSQL:$equal(STRING, STRING) -> BOOL)
            +-ColumnRef(type=STRING, column=Customer.C_NAME#2)
            +-GetRowField
              +-type=STRING
              +-expr=
              | +-ColumnRef(type=ROW<Nation>, column=$array.Nation#11)
              +-column=Nation.N_NAME


[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-Customer.C_NAME#2 AS c_name [STRING]
| +-Customer.C_NAME#2 AS n_name [STRING]
+-query=
  +-ProjectScan
    +-column_list=Customer.[C_NAME#2, C_NAME#2]
    +-input_scan=
      +-JoinScan
        +-column_list=[Customer.C_NAME#2, Customer.$Nation$join_row#13, $array.$Nation$scanrow#15]
        +-left_scan=
        | +-ProjectScan
        |   +-column_list=Customer.[C_NAME#2, $Nation$join_row#13]
        |   +-expr_list=
        |   | +-$Nation$join_row#13 :=
        |   |   +-MakeStruct
        |   |     +-type=STRUCT<N_NATIONKEY UINT64>
        |   |     +-field_list=
        |   |       +-ColumnRef(type=UINT64, column=Customer.C_NATIONKEY#14)
        |   +-input_scan=
        |     +-TableScan(column_list=Customer.[C_NAME#2, C_NATIONKEY#14], table=Customer, alias="c", table_column_list=[Customer.C_NAME,Customer.C_NATIONKEY])
        +-right_scan=
        | +-ProjectScan
        |   +-column_list=[Nation.N_NATIONKEY#16, $array.$Nation$scanrow#15]
        |   +-expr_list=
        |   | +-$Nation$scanrow#15 :=
        |   |   +-MakeStruct
        |   |     +-type=STRUCT<N_NAME STRING>
        |   |     +-field_list=
        |   |       +-ColumnRef(type=STRING, column=Nation.N_NAME#17)
        |   +-input_scan=
        |     +-TableScan(column_list=Nation.[N_NATIONKEY#16, N_NAME#17], table=Nation, table_column_list=[Nation.N_NATIONKEY,Nation.N_NAME])
        +-join_expr=
          +-FunctionCall(GoogleSQL:$and(BOOL, repeated(1) BOOL) -> BOOL)
            +-FunctionCall(GoogleSQL:$equal(STRUCT<N_NATIONKEY UINT64>, STRUCT<N_NATIONKEY UINT64>) -> BOOL)
            | +-MakeStruct
            | | +-type=STRUCT<N_NATIONKEY UINT64>
            | | +-field_list=
            | |   +-ColumnRef(type=UINT64, column=Nation.N_NATIONKEY#16)
            | +-ColumnRef(type=STRUCT<N_NATIONKEY UINT64>, column=Customer.$Nation$join_row#13)
            +-FunctionCall(GoogleSQL:$equal(STRING, STRING) -> BOOL)
              +-ColumnRef(type=STRING, column=Customer.C_NAME#2)
              +-GetStructField
                +-type=STRING
                +-expr=
                | +-ColumnRef(type=STRUCT<N_NAME STRING>, column=$array.$Nation$scanrow#15)
                +-field_idx=0
--
ALTERNATION GROUP: LEFT
--
QueryStmt
+-output_column_list=
| +-Customer.C_NAME#2 AS c_name [STRING]
| +-Customer.C_NAME#2 AS n_name [STRING]
+-query=
  +-ProjectScan
    +-column_list=Customer.[C_NAME#2, C_NAME#2]
    +-input_scan=
      +-ArrayScan
        +-column_list=[Customer.C_NAME#2, Customer.Nation#10, $array.Nation#11]
        +-input_scan=
        | +-TableScan(column_list=Customer.[C_NAME#2, Nation#10], table=Customer, column_index_list=[1, 9], alias="c")
        +-array_expr_list=
        | +-ColumnRef(type=ROW<Nation (join)>, column=Customer.Nation#10)
        +-element_column_list=[$array.Nation#11]
        +-join_expr=
        | +-FunctionCall(GoogleSQL:$equal(STRING, STRING) -> BOOL)
        |   +-ColumnRef(type=STRING, column=Customer.C_NAME#2)
        |   +-GetRowField
        |     +-type=STRING
        |     +-expr=
        |     | +-ColumnRef(type=ROW<Nation>, column=$array.Nation#11)
        |     +-column=Nation.N_NAME
        +-is_outer=TRUE


[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-Customer.C_NAME#2 AS c_name [STRING]
| +-Customer.C_NAME#2 AS n_name [STRING]
+-query=
  +-ProjectScan
    +-column_list=Customer.[C_NAME#2, C_NAME#2]
    +-input_scan=
      +-JoinScan
        +-column_list=[Customer.C_NAME#2, Customer.$Nation$join_row#13, $array.$Nation$scanrow#15]
        +-join_type=LEFT
        +-left_scan=
        | +-ProjectScan
        |   +-column_list=Customer.[C_NAME#2, $Nation$join_row#13]
        |   +-expr_list=
        |   | +-$Nation$join_row#13 :=
        |   |   +-MakeStruct
        |   |     +-type=STRUCT<N_NATIONKEY UINT64>
        |   |     +-field_list=
        |   |       +-ColumnRef(type=UINT64, column=Customer.C_NATIONKEY#14)
        |   +-input_scan=
        |     +-TableScan(column_list=Customer.[C_NAME#2, C_NATIONKEY#14], table=Customer, alias="c", table_column_list=[Customer.C_NAME,Customer.C_NATIONKEY])
        +-right_scan=
        | +-ProjectScan
        |   +-column_list=[Nation.N_NATIONKEY#16, $array.$Nation$scanrow#15]
        |   +-expr_list=
        |   | +-$Nation$scanrow#15 :=
        |   |   +-MakeStruct
        |   |     +-type=STRUCT<N_NAME STRING>
        |   |     +-field_list=
        |   |       +-ColumnRef(type=STRING, column=Nation.N_NAME#17)
        |   +-input_scan=
        |     +-TableScan(column_list=Nation.[N_NATIONKEY#16, N_NAME#17], table=Nation, table_column_list=[Nation.N_NATIONKEY,Nation.N_NAME])
        +-join_expr=
          +-FunctionCall(GoogleSQL:$and(BOOL, repeated(1) BOOL) -> BOOL)
            +-FunctionCall(GoogleSQL:$equal(STRUCT<N_NATIONKEY UINT64>, STRUCT<N_NATIONKEY UINT64>) -> BOOL)
            | +-MakeStruct
            | | +-type=STRUCT<N_NATIONKEY UINT64>
            | | +-field_list=
            | |   +-ColumnRef(type=UINT64, column=Nation.N_NATIONKEY#16)
            | +-ColumnRef(type=STRUCT<N_NATIONKEY UINT64>, column=Customer.$Nation$join_row#13)
            +-FunctionCall(GoogleSQL:$equal(STRING, STRING) -> BOOL)
              +-ColumnRef(type=STRING, column=Customer.C_NAME#2)
              +-GetStructField
                +-type=STRING
                +-expr=
                | +-ColumnRef(type=STRUCT<N_NAME STRING>, column=$array.$Nation$scanrow#15)
                +-field_idx=0
==

# Join USING where we match a column under a join column on both sides.
# A ProjectScan with GetRowField gets added on both sides.
# The join rhs is an implicitly unnested `table.join_column` here.
FROM Customer c
|> JOIN c.Orders o1
|> JOIN Lineitem.Order_ o2 USING (o_orderkey)
|> SELECT c_name, o1.o_orderdate, o2.o_orderdate
--
QueryStmt
+-output_column_list=
| +-Customer.C_NAME#2 AS c_name [STRING]
| +-$pipe_select.o_orderdate#36 AS o_orderdate [DATE]
| +-$pipe_select.o_orderdate#37 AS o_orderdate [DATE]
+-query=
  +-ProjectScan
    +-column_list=[Customer.C_NAME#2, $pipe_select.o_orderdate#36, $pipe_select.o_orderdate#37]
    +-expr_list=
    | +-o_orderdate#36 :=
    | | +-GetRowField
    | |   +-type=DATE
    | |   +-expr=
    | |   | +-ColumnRef(type=ROW<Orders>, column=$array.o1#11)
    | |   +-column=Orders.O_ORDERDATE
    | +-o_orderdate#37 :=
    |   +-GetRowField
    |     +-type=DATE
    |     +-expr=
    |     | +-ColumnRef(type=ROW<Orders>, column=$array.o2#33)
    |     +-column=Orders.O_ORDERDATE
    +-input_scan=
      +-JoinScan
        +-column_list=[Customer.C_NAME#2, Customer.Orders#9, $array.o1#11, $join_left.o_orderkey#34, $array.o2#33, $join_right.o_orderkey#35]
        +-left_scan=
        | +-ProjectScan
        |   +-column_list=[Customer.C_NAME#2, Customer.Orders#9, $array.o1#11, $join_left.o_orderkey#34]
        |   +-expr_list=
        |   | +-o_orderkey#34 :=
        |   |   +-GetRowField
        |   |     +-type=UINT64
        |   |     +-expr=
        |   |     | +-ColumnRef(type=ROW<Orders>, column=$array.o1#11)
        |   |     +-column=Orders.O_ORDERKEY
        |   +-input_scan=
        |     +-ArrayScan
        |       +-column_list=[Customer.C_NAME#2, Customer.Orders#9, $array.o1#11]
        |       +-input_scan=
        |       | +-TableScan(column_list=Customer.[C_NAME#2, Orders#9], table=Customer, column_index_list=[1, 8], alias="c")
        |       +-array_expr_list=
        |       | +-ColumnRef(type=MULTIROW<Orders (join)>, column=Customer.Orders#9)
        |       +-element_column_list=[$array.o1#11]
        +-right_scan=
        | +-ProjectScan
        |   +-column_list=[$array.o2#33, $join_right.o_orderkey#35]
        |   +-expr_list=
        |   | +-o_orderkey#35 :=
        |   |   +-GetRowField
        |   |     +-type=UINT64
        |   |     +-expr=
        |   |     | +-ColumnRef(type=ROW<Orders>, column=$array.o2#33)
        |   |     +-column=Orders.O_ORDERKEY
        |   +-input_scan=
        |     +-ArrayScan
        |       +-column_list=[$array.o2#33]
        |       +-node_source="single_table_array_name_path"
        |       +-input_scan=
        |       | +-TableScan(column_list=[LineItem.Order_#29], table=LineItem, column_index_list=[17], alias="Lineitem")
        |       +-array_expr_list=
        |       | +-ColumnRef(type=ROW<Orders (join)>, column=LineItem.Order_#29)
        |       +-element_column_list=[$array.o2#33]
        +-join_expr=
        | +-FunctionCall(GoogleSQL:$equal(UINT64, UINT64) -> BOOL)
        |   +-ColumnRef(type=UINT64, column=$join_left.o_orderkey#34)
        |   +-ColumnRef(type=UINT64, column=$join_right.o_orderkey#35)
        +-has_using=TRUE


[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-Customer.C_NAME#2 AS c_name [STRING]
| +-$pipe_select.o_orderdate#36 AS o_orderdate [DATE]
| +-$pipe_select.o_orderdate#37 AS o_orderdate [DATE]
+-query=
  +-ProjectScan
    +-column_list=[Customer.C_NAME#2, $pipe_select.o_orderdate#36, $pipe_select.o_orderdate#37]
    +-expr_list=
    | +-o_orderdate#36 :=
    | | +-GetStructField
    | |   +-type=DATE
    | |   +-expr=
    | |   | +-ColumnRef(type=STRUCT<O_ORDERDATE DATE, O_ORDERKEY UINT64>, column=$array.$o1$scanrow#38)
    | |   +-field_idx=0
    | +-o_orderdate#37 :=
    |   +-GetStructField
    |     +-type=DATE
    |     +-expr=
    |     | +-ColumnRef(type=STRUCT<O_ORDERDATE DATE, O_ORDERKEY UINT64>, column=$array.$o2$scanrow#39)
    |     +-field_idx=0
    +-input_scan=
      +-JoinScan
        +-column_list=[Customer.C_NAME#2, Customer.$Orders$join_multirow#40, $array.$o1$scanrow#38, $join_left.o_orderkey#34, $array.$o2$scanrow#39, $join_right.o_orderkey#35]
        +-left_scan=
        | +-ProjectScan
        |   +-column_list=[Customer.C_NAME#2, Customer.$Orders$join_multirow#40, $array.$o1$scanrow#38, $join_left.o_orderkey#34]
        |   +-expr_list=
        |   | +-o_orderkey#34 :=
        |   |   +-GetStructField
        |   |     +-type=UINT64
        |   |     +-expr=
        |   |     | +-ColumnRef(type=STRUCT<O_ORDERDATE DATE, O_ORDERKEY UINT64>, column=$array.$o1$scanrow#38)
        |   |     +-field_idx=1
        |   +-input_scan=
        |     +-JoinScan
        |       +-column_list=[Customer.C_NAME#2, Customer.$Orders$join_multirow#40, $array.$o1$scanrow#38]
        |       +-left_scan=
        |       | +-ProjectScan
        |       |   +-column_list=Customer.[C_NAME#2, $Orders$join_multirow#40]
        |       |   +-expr_list=
        |       |   | +-$Orders$join_multirow#40 :=
        |       |   |   +-MakeStruct
        |       |   |     +-type=STRUCT<O_CUSTKEY UINT64>
        |       |   |     +-field_list=
        |       |   |       +-ColumnRef(type=UINT64, column=Customer.C_CUSTKEY#41)
        |       |   +-input_scan=
        |       |     +-TableScan(column_list=Customer.[C_NAME#2, C_CUSTKEY#41], table=Customer, alias="c", table_column_list=[Customer.C_NAME,Customer.C_CUSTKEY])
        |       +-right_scan=
        |       | +-ProjectScan
        |       |   +-column_list=[Orders.O_CUSTKEY#42, $array.$o1$scanrow#38]
        |       |   +-expr_list=
        |       |   | +-$o1$scanrow#38 :=
        |       |   |   +-MakeStruct
        |       |   |     +-type=STRUCT<O_ORDERDATE DATE, O_ORDERKEY UINT64>
        |       |   |     +-field_list=
        |       |   |       +-ColumnRef(type=DATE, column=Orders.O_ORDERDATE#43)
        |       |   |       +-ColumnRef(type=UINT64, column=Orders.O_ORDERKEY#44)
        |       |   +-input_scan=
        |       |     +-TableScan(column_list=Orders.[O_CUSTKEY#42, O_ORDERDATE#43, O_ORDERKEY#44], table=Orders, table_column_list=[Orders.O_CUSTKEY,Orders.O_ORDERDATE,Orders.O_ORDERKEY])
        |       +-join_expr=
        |         +-FunctionCall(GoogleSQL:$equal(STRUCT<O_CUSTKEY UINT64>, STRUCT<O_CUSTKEY UINT64>) -> BOOL)
        |           +-MakeStruct
        |           | +-type=STRUCT<O_CUSTKEY UINT64>
        |           | +-field_list=
        |           |   +-ColumnRef(type=UINT64, column=Orders.O_CUSTKEY#42)
        |           +-ColumnRef(type=STRUCT<O_CUSTKEY UINT64>, column=Customer.$Orders$join_multirow#40)
        +-right_scan=
        | +-ProjectScan
        |   +-column_list=[$array.$o2$scanrow#39, $join_right.o_orderkey#35]
        |   +-expr_list=
        |   | +-o_orderkey#35 :=
        |   |   +-GetStructField
        |   |     +-type=UINT64
        |   |     +-expr=
        |   |     | +-ColumnRef(type=STRUCT<O_ORDERDATE DATE, O_ORDERKEY UINT64>, column=$array.$o2$scanrow#39)
        |   |     +-field_idx=1
        |   +-input_scan=
        |     +-JoinScan
        |       +-column_list=[$array.$o2$scanrow#39]
        |       +-left_scan=
        |       | +-ProjectScan
        |       |   +-column_list=[LineItem.$Order_$join_row#45]
        |       |   +-expr_list=
        |       |   | +-$Order_$join_row#45 :=
        |       |   |   +-MakeStruct
        |       |   |     +-type=STRUCT<O_ORDERKEY UINT64>
        |       |   |     +-field_list=
        |       |   |       +-ColumnRef(type=UINT64, column=LineItem.L_ORDERKEY#46)
        |       |   +-input_scan=
        |       |     +-TableScan(column_list=[LineItem.L_ORDERKEY#46], table=LineItem, alias="Lineitem", table_column_list=[LineItem.L_ORDERKEY])
        |       +-right_scan=
        |       | +-ProjectScan
        |       |   +-column_list=[Orders.O_ORDERKEY#47, $array.$o2$scanrow#39]
        |       |   +-expr_list=
        |       |   | +-$o2$scanrow#39 :=
        |       |   |   +-MakeStruct
        |       |   |     +-type=STRUCT<O_ORDERDATE DATE, O_ORDERKEY UINT64>
        |       |   |     +-field_list=
        |       |   |       +-ColumnRef(type=DATE, column=Orders.O_ORDERDATE#48)
        |       |   |       +-ColumnRef(type=UINT64, column=Orders.O_ORDERKEY#47)
        |       |   +-input_scan=
        |       |     +-TableScan(column_list=Orders.[O_ORDERKEY#47, O_ORDERDATE#48], table=Orders, table_column_list=[Orders.O_ORDERKEY,Orders.O_ORDERDATE])
        |       +-join_expr=
        |         +-FunctionCall(GoogleSQL:$equal(STRUCT<O_ORDERKEY UINT64>, STRUCT<O_ORDERKEY UINT64>) -> BOOL)
        |           +-MakeStruct
        |           | +-type=STRUCT<O_ORDERKEY UINT64>
        |           | +-field_list=
        |           |   +-ColumnRef(type=UINT64, column=Orders.O_ORDERKEY#47)
        |           +-ColumnRef(type=STRUCT<O_ORDERKEY UINT64>, column=LineItem.$Order_$join_row#45)
        +-join_expr=
        | +-FunctionCall(GoogleSQL:$equal(UINT64, UINT64) -> BOOL)
        |   +-ColumnRef(type=UINT64, column=$join_left.o_orderkey#34)
        |   +-ColumnRef(type=UINT64, column=$join_right.o_orderkey#35)
        +-has_using=TRUE
==

# JOIN rules make Orders a table name here, not the column from Customer,
# unless we do `c.Orders`.
FROM Customer
|> JOIN Orders
--
ERROR: INNER JOIN must have an immediately following ON or USING clause [at 2:4]
|> JOIN Orders
   ^
==

# JOIN rules require using `c.Orders` here too.
FROM Customer
|> JOIN Orders.Lineitems
--
ERROR: Aliases referenced in the from clause must refer to preceding scans, and cannot refer to columns on those scans. Orders refers to a column and must be qualified with a table name. [at 2:9]
|> JOIN Orders.Lineitems
        ^
==

# PartSupp has a multi-part ROW key.
FROM Lineitem li
|> SELECT li.l_quantity,
          li.PartSupp.ps_comment,
          li.PartSupp.Part.p_name,
          li.PartSupp.Supplier.s_name
--
QueryStmt
+-output_column_list=
| +-LineItem.L_QUANTITY#5 AS l_quantity [DOUBLE]
| +-$pipe_select.ps_comment#22 AS ps_comment [STRING]
| +-$pipe_select.p_name#23 AS p_name [STRING]
| +-$pipe_select.s_name#24 AS s_name [STRING]
+-query=
  +-ProjectScan
    +-column_list=[LineItem.L_QUANTITY#5, $pipe_select.ps_comment#22, $pipe_select.p_name#23, $pipe_select.s_name#24]
    +-expr_list=
    | +-ps_comment#22 :=
    | | +-GetRowField
    | |   +-type=STRING
    | |   +-expr=
    | |   | +-ColumnRef(type=ROW<PartSupp (join)>, column=LineItem.PartSupp#19)
    | |   +-column=PartSupp.PS_COMMENT
    | +-p_name#23 :=
    | | +-GetRowField
    | |   +-type=STRING
    | |   +-expr=
    | |   | +-GetRowField
    | |   |   +-type=ROW<Part (join)>
    | |   |   +-expr=
    | |   |   | +-ColumnRef(type=ROW<PartSupp (join)>, column=LineItem.PartSupp#19)
    | |   |   +-column=PartSupp.Part
    | |   +-column=Part.P_NAME
    | +-s_name#24 :=
    |   +-GetRowField
    |     +-type=STRING
    |     +-expr=
    |     | +-GetRowField
    |     |   +-type=ROW<Supplier (join)>
    |     |   +-expr=
    |     |   | +-ColumnRef(type=ROW<PartSupp (join)>, column=LineItem.PartSupp#19)
    |     |   +-column=PartSupp.Supplier
    |     +-column=Supplier.S_NAME
    +-input_scan=
      +-TableScan(column_list=LineItem.[L_QUANTITY#5, PartSupp#19], table=LineItem, column_index_list=[4, 18], alias="li")


[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-LineItem.L_QUANTITY#5 AS l_quantity [DOUBLE]
| +-$pipe_select.ps_comment#22 AS ps_comment [STRING]
| +-$pipe_select.p_name#23 AS p_name [STRING]
| +-$pipe_select.s_name#24 AS s_name [STRING]
+-query=
  +-ProjectScan
    +-column_list=[LineItem.L_QUANTITY#5, $pipe_select.ps_comment#22, $pipe_select.p_name#23, $pipe_select.s_name#24]
    +-expr_list=
    | +-ps_comment#22 :=
    | | +-SubqueryExpr
    | |   +-type=STRING
    | |   +-subquery_type=SCALAR
    | |   +-parameter_list=
    | |   | +-ColumnRef(type=STRUCT<PS_PARTKEY UINT64, PS_SUPPKEY UINT64>, column=LineItem.$PartSupp$join_row#42)
    | |   +-subquery=
    | |     +-FilterScan
    | |       +-column_list=[PartSupp.PS_COMMENT#27]
    | |       +-input_scan=
    | |       | +-TableScan(column_list=PartSupp.[PS_PARTKEY#25, PS_SUPPKEY#26, PS_COMMENT#27], table=PartSupp, table_column_list=[PartSupp.PS_PARTKEY,PartSupp.PS_SUPPKEY,PartSupp.PS_COMMENT])
    | |       +-filter_expr=
    | |         +-FunctionCall(GoogleSQL:$equal(STRUCT<PS_PARTKEY UINT64, PS_SUPPKEY UINT64>, STRUCT<PS_PARTKEY UINT64, PS_SUPPKEY UINT64>) -> BOOL)
    | |           +-MakeStruct
    | |           | +-type=STRUCT<PS_PARTKEY UINT64, PS_SUPPKEY UINT64>
    | |           | +-field_list=
    | |           |   +-ColumnRef(type=UINT64, column=PartSupp.PS_PARTKEY#25)
    | |           |   +-ColumnRef(type=UINT64, column=PartSupp.PS_SUPPKEY#26)
    | |           +-ColumnRef(type=STRUCT<PS_PARTKEY UINT64, PS_SUPPKEY UINT64>, column=LineItem.$PartSupp$join_row#42, is_correlated=TRUE)
    | +-p_name#23 :=
    | | +-SubqueryExpr
    | |   +-type=STRING
    | |   +-subquery_type=SCALAR
    | |   +-parameter_list=
    | |   | +-ColumnRef(type=STRUCT<PS_PARTKEY UINT64, PS_SUPPKEY UINT64>, column=LineItem.$PartSupp$join_row#42)
    | |   +-subquery=
    | |     +-ProjectScan
    | |       +-column_list=[$with_expr.injected#45]
    | |       +-expr_list=
    | |       | +-injected#45 :=
    | |       |   +-SubqueryExpr
    | |       |     +-type=STRING
    | |       |     +-subquery_type=SCALAR
    | |       |     +-parameter_list=
    | |       |     | +-ColumnRef(type=STRUCT<P_PARTKEY UINT64>, column=$with_expr.$with_col#32)
    | |       |     +-subquery=
    | |       |       +-FilterScan
    | |       |         +-column_list=[Part.P_NAME#34]
    | |       |         +-input_scan=
    | |       |         | +-TableScan(column_list=Part.[P_PARTKEY#33, P_NAME#34], table=Part, table_column_list=[Part.P_PARTKEY,Part.P_NAME])
    | |       |         +-filter_expr=
    | |       |           +-FunctionCall(GoogleSQL:$equal(STRUCT<P_PARTKEY UINT64>, STRUCT<P_PARTKEY UINT64>) -> BOOL)
    | |       |             +-MakeStruct
    | |       |             | +-type=STRUCT<P_PARTKEY UINT64>
    | |       |             | +-field_list=
    | |       |             |   +-ColumnRef(type=UINT64, column=Part.P_PARTKEY#33)
    | |       |             +-ColumnRef(type=STRUCT<P_PARTKEY UINT64>, column=$with_expr.$with_col#32, is_correlated=TRUE)
    | |       +-input_scan=
    | |         +-ProjectScan
    | |           +-column_list=[$with_expr.$with_col#32]
    | |           +-expr_list=
    | |           | +-$with_col#32 :=
    | |           |   +-SubqueryExpr
    | |           |     +-type=STRUCT<P_PARTKEY UINT64>
    | |           |     +-subquery_type=SCALAR
    | |           |     +-parameter_list=
    | |           |     | +-ColumnRef(type=STRUCT<PS_PARTKEY UINT64, PS_SUPPKEY UINT64>, column=LineItem.$PartSupp$join_row#42, is_correlated=TRUE)
    | |           |     +-subquery=
    | |           |       +-FilterScan
    | |           |         +-column_list=[PartSupp.$Part$join_row#31]
    | |           |         +-input_scan=
    | |           |         | +-ProjectScan
    | |           |         |   +-column_list=PartSupp.[PS_PARTKEY#28, PS_SUPPKEY#29, $Part$join_row#31]
    | |           |         |   +-expr_list=
    | |           |         |   | +-$Part$join_row#31 :=
    | |           |         |   |   +-MakeStruct
    | |           |         |   |     +-type=STRUCT<P_PARTKEY UINT64>
    | |           |         |   |     +-field_list=
    | |           |         |   |       +-ColumnRef(type=UINT64, column=PartSupp.PS_PARTKEY#28)
    | |           |         |   +-input_scan=
    | |           |         |     +-TableScan(column_list=PartSupp.[PS_PARTKEY#28, PS_SUPPKEY#29], table=PartSupp, table_column_list=[PartSupp.PS_PARTKEY,PartSupp.PS_SUPPKEY])
    | |           |         +-filter_expr=
    | |           |           +-FunctionCall(GoogleSQL:$equal(STRUCT<PS_PARTKEY UINT64, PS_SUPPKEY UINT64>, STRUCT<PS_PARTKEY UINT64, PS_SUPPKEY UINT64>) -> BOOL)
    | |           |             +-MakeStruct
    | |           |             | +-type=STRUCT<PS_PARTKEY UINT64, PS_SUPPKEY UINT64>
    | |           |             | +-field_list=
    | |           |             |   +-ColumnRef(type=UINT64, column=PartSupp.PS_PARTKEY#28)
    | |           |             |   +-ColumnRef(type=UINT64, column=PartSupp.PS_SUPPKEY#29)
    | |           |             +-ColumnRef(type=STRUCT<PS_PARTKEY UINT64, PS_SUPPKEY UINT64>, column=LineItem.$PartSupp$join_row#42, is_correlated=TRUE)
    | |           +-input_scan=
    | |             +-SingleRowScan
    | +-s_name#24 :=
    |   +-SubqueryExpr
    |     +-type=STRING
    |     +-subquery_type=SCALAR
    |     +-parameter_list=
    |     | +-ColumnRef(type=STRUCT<PS_PARTKEY UINT64, PS_SUPPKEY UINT64>, column=LineItem.$PartSupp$join_row#42)
    |     +-subquery=
    |       +-ProjectScan
    |         +-column_list=[$with_expr.injected#46]
    |         +-expr_list=
    |         | +-injected#46 :=
    |         |   +-SubqueryExpr
    |         |     +-type=STRING
    |         |     +-subquery_type=SCALAR
    |         |     +-parameter_list=
    |         |     | +-ColumnRef(type=STRUCT<S_SUPPKEY UINT64>, column=$with_expr.$with_col#39)
    |         |     +-subquery=
    |         |       +-FilterScan
    |         |         +-column_list=[Supplier.S_NAME#41]
    |         |         +-input_scan=
    |         |         | +-TableScan(column_list=Supplier.[S_SUPPKEY#40, S_NAME#41], table=Supplier, table_column_list=[Supplier.S_SUPPKEY,Supplier.S_NAME])
    |         |         +-filter_expr=
    |         |           +-FunctionCall(GoogleSQL:$equal(STRUCT<S_SUPPKEY UINT64>, STRUCT<S_SUPPKEY UINT64>) -> BOOL)
    |         |             +-MakeStruct
    |         |             | +-type=STRUCT<S_SUPPKEY UINT64>
    |         |             | +-field_list=
    |         |             |   +-ColumnRef(type=UINT64, column=Supplier.S_SUPPKEY#40)
    |         |             +-ColumnRef(type=STRUCT<S_SUPPKEY UINT64>, column=$with_expr.$with_col#39, is_correlated=TRUE)
    |         +-input_scan=
    |           +-ProjectScan
    |             +-column_list=[$with_expr.$with_col#39]
    |             +-expr_list=
    |             | +-$with_col#39 :=
    |             |   +-SubqueryExpr
    |             |     +-type=STRUCT<S_SUPPKEY UINT64>
    |             |     +-subquery_type=SCALAR
    |             |     +-parameter_list=
    |             |     | +-ColumnRef(type=STRUCT<PS_PARTKEY UINT64, PS_SUPPKEY UINT64>, column=LineItem.$PartSupp$join_row#42, is_correlated=TRUE)
    |             |     +-subquery=
    |             |       +-FilterScan
    |             |         +-column_list=[PartSupp.$Supplier$join_row#38]
    |             |         +-input_scan=
    |             |         | +-ProjectScan
    |             |         |   +-column_list=PartSupp.[PS_PARTKEY#35, PS_SUPPKEY#36, $Supplier$join_row#38]
    |             |         |   +-expr_list=
    |             |         |   | +-$Supplier$join_row#38 :=
    |             |         |   |   +-MakeStruct
    |             |         |   |     +-type=STRUCT<S_SUPPKEY UINT64>
    |             |         |   |     +-field_list=
    |             |         |   |       +-ColumnRef(type=UINT64, column=PartSupp.PS_SUPPKEY#36)
    |             |         |   +-input_scan=
    |             |         |     +-TableScan(column_list=PartSupp.[PS_PARTKEY#35, PS_SUPPKEY#36], table=PartSupp, table_column_list=[PartSupp.PS_PARTKEY,PartSupp.PS_SUPPKEY])
    |             |         +-filter_expr=
    |             |           +-FunctionCall(GoogleSQL:$equal(STRUCT<PS_PARTKEY UINT64, PS_SUPPKEY UINT64>, STRUCT<PS_PARTKEY UINT64, PS_SUPPKEY UINT64>) -> BOOL)
    |             |             +-MakeStruct
    |             |             | +-type=STRUCT<PS_PARTKEY UINT64, PS_SUPPKEY UINT64>
    |             |             | +-field_list=
    |             |             |   +-ColumnRef(type=UINT64, column=PartSupp.PS_PARTKEY#35)
    |             |             |   +-ColumnRef(type=UINT64, column=PartSupp.PS_SUPPKEY#36)
    |             |             +-ColumnRef(type=STRUCT<PS_PARTKEY UINT64, PS_SUPPKEY UINT64>, column=LineItem.$PartSupp$join_row#42, is_correlated=TRUE)
    |             +-input_scan=
    |               +-SingleRowScan
    +-input_scan=
      +-ProjectScan
        +-column_list=LineItem.[L_QUANTITY#5, $PartSupp$join_row#42]
        +-expr_list=
        | +-$PartSupp$join_row#42 :=
        |   +-MakeStruct
        |     +-type=STRUCT<PS_PARTKEY UINT64, PS_SUPPKEY UINT64>
        |     +-field_list=
        |       +-ColumnRef(type=UINT64, column=LineItem.L_PARTKEY#43)
        |       +-ColumnRef(type=UINT64, column=LineItem.L_SUPPKEY#44)
        +-input_scan=
          +-TableScan(column_list=LineItem.[L_QUANTITY#5, L_PARTKEY#43, L_SUPPKEY#44], table=LineItem, alias="li", table_column_list=[LineItem.L_QUANTITY,LineItem.L_PARTKEY,LineItem.L_SUPPKEY])
==

# PartSupps has a multi-part MULTIROW key.
# Tests on this table exercise rewrites with multi-part join key.
FROM Part p
|> SELECT p_brand, p.PartSupps.ps_comment
--
ERROR: Cannot access fields on an expression with type MULTIROW<PartSupp>; Fields of MULTIROW columns can be read in JOIN, UNNEST, and FLATTEN [at 2:32]
|> SELECT p_brand, p.PartSupps.ps_comment
                               ^
==

# PartSupps has a multi-part MULTIROW key.
FROM Part p
|> SELECT p_brand, FLATTEN(p.PartSupps.Supplier.s_name)
--
QueryStmt
+-output_column_list=
| +-Part.P_BRAND#4 AS p_brand [STRING]
| +-$pipe_select.$col2#12 AS `$col2` [ARRAY<STRING>]
+-query=
  +-ProjectScan
    +-column_list=[Part.P_BRAND#4, $pipe_select.$col2#12]
    +-expr_list=
    | +-$col2#12 :=
    |   +-Flatten
    |     +-type=ARRAY<STRING>
    |     +-expr=
    |     | +-ColumnRef(type=MULTIROW<PartSupp (join)>, column=Part.PartSupps#10)
    |     +-get_field_list=
    |       +-GetRowField
    |       | +-type=ROW<Supplier (join)>
    |       | +-expr=
    |       | | +-FlattenedArg(type=ROW<PartSupp>)
    |       | +-column=PartSupp.Supplier
    |       +-GetRowField
    |         +-type=STRING
    |         +-expr=
    |         | +-FlattenedArg(type=ROW<Supplier>)
    |         +-column=Supplier.S_NAME
    +-input_scan=
      +-TableScan(column_list=Part.[P_BRAND#4, PartSupps#10], table=Part, column_index_list=[3, 9], alias="p")


[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-Part.P_BRAND#4 AS p_brand [STRING]
| +-$pipe_select.$col2#12 AS `$col2` [ARRAY<STRING>]
+-query=
  +-ProjectScan
    +-column_list=[Part.P_BRAND#4, $pipe_select.$col2#12]
    +-expr_list=
    | +-$col2#12 :=
    |   +-SubqueryExpr
    |     +-type=ARRAY<STRING>
    |     +-subquery_type=SCALAR
    |     +-parameter_list=
    |     | +-ColumnRef(type=STRUCT<PS_PARTKEY UINT64>, column=Part.$PartSupps$join_multirow#23)
    |     +-subquery=
    |       +-ProjectScan
    |         +-column_list=[$with_expr.injected#26]
    |         +-expr_list=
    |         | +-injected#26 :=
    |         |   +-FunctionCall(GoogleSQL:if(BOOL, ARRAY<STRING>, ARRAY<STRING>) -> ARRAY<STRING>)
    |         |     +-FunctionCall(GoogleSQL:$is_null(STRUCT<PS_PARTKEY UINT64>) -> BOOL)
    |         |     | +-ColumnRef(type=STRUCT<PS_PARTKEY UINT64>, column=$flatten_input.$injected$join_multirow#25)
    |         |     +-Literal(type=ARRAY<STRING>, value=NULL)
    |         |     +-SubqueryExpr
    |         |       +-type=ARRAY<STRING>
    |         |       +-subquery_type=ARRAY
    |         |       +-parameter_list=
    |         |       | +-ColumnRef(type=STRUCT<PS_PARTKEY UINT64>, column=$flatten_input.$injected$join_multirow#25)
    |         |       +-subquery=
    |         |         +-ProjectScan
    |         |           +-column_list=[$flatten.injected#16]
    |         |           +-expr_list=
    |         |           | +-injected#16 :=
    |         |           |   +-GetStructField
    |         |           |     +-type=STRING
    |         |           |     +-expr=
    |         |           |     | +-ColumnRef(type=STRUCT<S_NAME STRING>, column=$flatten.$injected$scanrow#17)
    |         |           |     +-field_idx=0
    |         |           +-input_scan=
    |         |             +-JoinScan
    |         |               +-column_list=$flatten.[$injected$scanrow#19, $injected$scanrow#17]
    |         |               +-left_scan=
    |         |               | +-JoinScan
    |         |               |   +-column_list=[$flatten.$injected$scanrow#19]
    |         |               |   +-left_scan=
    |         |               |   | +-SingleRowScan
    |         |               |   +-right_scan=
    |         |               |   | +-ProjectScan
    |         |               |   |   +-column_list=[PartSupp.PS_PARTKEY#18, $flatten.$injected$scanrow#19]
    |         |               |   |   +-expr_list=
    |         |               |   |   | +-$injected$scanrow#19 :=
    |         |               |   |   |   +-MakeStruct
    |         |               |   |   |     +-type=STRUCT<Supplier STRUCT<S_SUPPKEY UINT64>>
    |         |               |   |   |     +-field_list=
    |         |               |   |   |       +-MakeStruct
    |         |               |   |   |         +-type=STRUCT<S_SUPPKEY UINT64>
    |         |               |   |   |         +-field_list=
    |         |               |   |   |           +-ColumnRef(type=UINT64, column=PartSupp.PS_SUPPKEY#20)
    |         |               |   |   +-input_scan=
    |         |               |   |     +-TableScan(column_list=PartSupp.[PS_PARTKEY#18, PS_SUPPKEY#20], table=PartSupp, table_column_list=[PartSupp.PS_PARTKEY,PartSupp.PS_SUPPKEY])
    |         |               |   +-join_expr=
    |         |               |     +-FunctionCall(GoogleSQL:$equal(STRUCT<PS_PARTKEY UINT64>, STRUCT<PS_PARTKEY UINT64>) -> BOOL)
    |         |               |       +-MakeStruct
    |         |               |       | +-type=STRUCT<PS_PARTKEY UINT64>
    |         |               |       | +-field_list=
    |         |               |       |   +-ColumnRef(type=UINT64, column=PartSupp.PS_PARTKEY#18)
    |         |               |       +-ColumnRef(type=STRUCT<PS_PARTKEY UINT64>, column=$flatten_input.$injected$join_multirow#25, is_correlated=TRUE)
    |         |               +-right_scan=
    |         |               | +-ProjectScan
    |         |               |   +-column_list=[Supplier.S_SUPPKEY#21, $flatten.$injected$scanrow#17]
    |         |               |   +-expr_list=
    |         |               |   | +-$injected$scanrow#17 :=
    |         |               |   |   +-MakeStruct
    |         |               |   |     +-type=STRUCT<S_NAME STRING>
    |         |               |   |     +-field_list=
    |         |               |   |       +-ColumnRef(type=STRING, column=Supplier.S_NAME#22)
    |         |               |   +-input_scan=
    |         |               |     +-TableScan(column_list=Supplier.[S_SUPPKEY#21, S_NAME#22], table=Supplier, table_column_list=[Supplier.S_SUPPKEY,Supplier.S_NAME])
    |         |               +-join_expr=
    |         |                 +-FunctionCall(GoogleSQL:$equal(STRUCT<S_SUPPKEY UINT64>, STRUCT<S_SUPPKEY UINT64>) -> BOOL)
    |         |                   +-MakeStruct
    |         |                   | +-type=STRUCT<S_SUPPKEY UINT64>
    |         |                   | +-field_list=
    |         |                   |   +-ColumnRef(type=UINT64, column=Supplier.S_SUPPKEY#21)
    |         |                   +-GetStructField
    |         |                     +-type=STRUCT<S_SUPPKEY UINT64>
    |         |                     +-expr=
    |         |                     | +-ColumnRef(type=STRUCT<Supplier STRUCT<S_SUPPKEY UINT64>>, column=$flatten.$injected$scanrow#19)
    |         |                     +-field_idx=0
    |         +-input_scan=
    |           +-ProjectScan
    |             +-column_list=[$flatten_input.$injected$join_multirow#25]
    |             +-expr_list=
    |             | +-$injected$join_multirow#25 := ColumnRef(type=STRUCT<PS_PARTKEY UINT64>, column=Part.$PartSupps$join_multirow#23, is_correlated=TRUE)
    |             +-input_scan=
    |               +-SingleRowScan
    +-input_scan=
      +-ProjectScan
        +-column_list=Part.[P_BRAND#4, $PartSupps$join_multirow#23]
        +-expr_list=
        | +-$PartSupps$join_multirow#23 :=
        |   +-MakeStruct
        |     +-type=STRUCT<PS_PARTKEY UINT64>
        |     +-field_list=
        |       +-ColumnRef(type=UINT64, column=Part.P_PARTKEY#24)
        +-input_scan=
          +-TableScan(column_list=Part.[P_BRAND#4, P_PARTKEY#24], table=Part, alias="p", table_column_list=[Part.P_BRAND,Part.P_PARTKEY])
==

FROM Part p
|> JOIN p.PartSupps ps
|> SELECT p_name, ps_comment
--
QueryStmt
+-output_column_list=
| +-Part.P_NAME#2 AS p_name [STRING]
| +-$pipe_select.ps_comment#13 AS ps_comment [STRING]
+-query=
  +-ProjectScan
    +-column_list=[Part.P_NAME#2, $pipe_select.ps_comment#13]
    +-expr_list=
    | +-ps_comment#13 :=
    |   +-GetRowField
    |     +-type=STRING
    |     +-expr=
    |     | +-ColumnRef(type=ROW<PartSupp>, column=$array.ps#12)
    |     +-column=PartSupp.PS_COMMENT
    +-input_scan=
      +-ArrayScan
        +-column_list=[Part.P_NAME#2, Part.PartSupps#10, $array.ps#12]
        +-input_scan=
        | +-TableScan(column_list=Part.[P_NAME#2, PartSupps#10], table=Part, column_index_list=[1, 9], alias="p")
        +-array_expr_list=
        | +-ColumnRef(type=MULTIROW<PartSupp (join)>, column=Part.PartSupps#10)
        +-element_column_list=[$array.ps#12]


[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-Part.P_NAME#2 AS p_name [STRING]
| +-$pipe_select.ps_comment#13 AS ps_comment [STRING]
+-query=
  +-ProjectScan
    +-column_list=[Part.P_NAME#2, $pipe_select.ps_comment#13]
    +-expr_list=
    | +-ps_comment#13 :=
    |   +-GetStructField
    |     +-type=STRING
    |     +-expr=
    |     | +-ColumnRef(type=STRUCT<PS_COMMENT STRING>, column=$array.$ps$scanrow#14)
    |     +-field_idx=0
    +-input_scan=
      +-JoinScan
        +-column_list=[Part.P_NAME#2, Part.$PartSupps$join_multirow#15, $array.$ps$scanrow#14]
        +-left_scan=
        | +-ProjectScan
        |   +-column_list=Part.[P_NAME#2, $PartSupps$join_multirow#15]
        |   +-expr_list=
        |   | +-$PartSupps$join_multirow#15 :=
        |   |   +-MakeStruct
        |   |     +-type=STRUCT<PS_PARTKEY UINT64>
        |   |     +-field_list=
        |   |       +-ColumnRef(type=UINT64, column=Part.P_PARTKEY#16)
        |   +-input_scan=
        |     +-TableScan(column_list=Part.[P_NAME#2, P_PARTKEY#16], table=Part, alias="p", table_column_list=[Part.P_NAME,Part.P_PARTKEY])
        +-right_scan=
        | +-ProjectScan
        |   +-column_list=[PartSupp.PS_PARTKEY#17, $array.$ps$scanrow#14]
        |   +-expr_list=
        |   | +-$ps$scanrow#14 :=
        |   |   +-MakeStruct
        |   |     +-type=STRUCT<PS_COMMENT STRING>
        |   |     +-field_list=
        |   |       +-ColumnRef(type=STRING, column=PartSupp.PS_COMMENT#18)
        |   +-input_scan=
        |     +-TableScan(column_list=PartSupp.[PS_PARTKEY#17, PS_COMMENT#18], table=PartSupp, table_column_list=[PartSupp.PS_PARTKEY,PartSupp.PS_COMMENT])
        +-join_expr=
          +-FunctionCall(GoogleSQL:$equal(STRUCT<PS_PARTKEY UINT64>, STRUCT<PS_PARTKEY UINT64>) -> BOOL)
            +-MakeStruct
            | +-type=STRUCT<PS_PARTKEY UINT64>
            | +-field_list=
            |   +-ColumnRef(type=UINT64, column=PartSupp.PS_PARTKEY#17)
            +-ColumnRef(type=STRUCT<PS_PARTKEY UINT64>, column=Part.$PartSupps$join_multirow#15)
==

FROM Part p
|> SELECT p_name, FLATTEN(p.PartSupps.ps_comment)
--
QueryStmt
+-output_column_list=
| +-Part.P_NAME#2 AS p_name [STRING]
| +-$pipe_select.$col2#12 AS `$col2` [ARRAY<STRING>]
+-query=
  +-ProjectScan
    +-column_list=[Part.P_NAME#2, $pipe_select.$col2#12]
    +-expr_list=
    | +-$col2#12 :=
    |   +-Flatten
    |     +-type=ARRAY<STRING>
    |     +-expr=
    |     | +-ColumnRef(type=MULTIROW<PartSupp (join)>, column=Part.PartSupps#10)
    |     +-get_field_list=
    |       +-GetRowField
    |         +-type=STRING
    |         +-expr=
    |         | +-FlattenedArg(type=ROW<PartSupp>)
    |         +-column=PartSupp.PS_COMMENT
    +-input_scan=
      +-TableScan(column_list=Part.[P_NAME#2, PartSupps#10], table=Part, column_index_list=[1, 9], alias="p")


[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-Part.P_NAME#2 AS p_name [STRING]
| +-$pipe_select.$col2#12 AS `$col2` [ARRAY<STRING>]
+-query=
  +-ProjectScan
    +-column_list=[Part.P_NAME#2, $pipe_select.$col2#12]
    +-expr_list=
    | +-$col2#12 :=
    |   +-SubqueryExpr
    |     +-type=ARRAY<STRING>
    |     +-subquery_type=SCALAR
    |     +-parameter_list=
    |     | +-ColumnRef(type=STRUCT<PS_PARTKEY UINT64>, column=Part.$PartSupps$join_multirow#19)
    |     +-subquery=
    |       +-ProjectScan
    |         +-column_list=[$with_expr.injected#22]
    |         +-expr_list=
    |         | +-injected#22 :=
    |         |   +-FunctionCall(GoogleSQL:if(BOOL, ARRAY<STRING>, ARRAY<STRING>) -> ARRAY<STRING>)
    |         |     +-FunctionCall(GoogleSQL:$is_null(STRUCT<PS_PARTKEY UINT64>) -> BOOL)
    |         |     | +-ColumnRef(type=STRUCT<PS_PARTKEY UINT64>, column=$flatten_input.$injected$join_multirow#21)
    |         |     +-Literal(type=ARRAY<STRING>, value=NULL)
    |         |     +-SubqueryExpr
    |         |       +-type=ARRAY<STRING>
    |         |       +-subquery_type=ARRAY
    |         |       +-parameter_list=
    |         |       | +-ColumnRef(type=STRUCT<PS_PARTKEY UINT64>, column=$flatten_input.$injected$join_multirow#21)
    |         |       +-subquery=
    |         |         +-ProjectScan
    |         |           +-column_list=[$flatten.injected#15]
    |         |           +-expr_list=
    |         |           | +-injected#15 :=
    |         |           |   +-GetStructField
    |         |           |     +-type=STRING
    |         |           |     +-expr=
    |         |           |     | +-ColumnRef(type=STRUCT<PS_COMMENT STRING>, column=$flatten.$injected$scanrow#16)
    |         |           |     +-field_idx=0
    |         |           +-input_scan=
    |         |             +-JoinScan
    |         |               +-column_list=[$flatten.$injected$scanrow#16]
    |         |               +-left_scan=
    |         |               | +-SingleRowScan
    |         |               +-right_scan=
    |         |               | +-ProjectScan
    |         |               |   +-column_list=[PartSupp.PS_PARTKEY#17, $flatten.$injected$scanrow#16]
    |         |               |   +-expr_list=
    |         |               |   | +-$injected$scanrow#16 :=
    |         |               |   |   +-MakeStruct
    |         |               |   |     +-type=STRUCT<PS_COMMENT STRING>
    |         |               |   |     +-field_list=
    |         |               |   |       +-ColumnRef(type=STRING, column=PartSupp.PS_COMMENT#18)
    |         |               |   +-input_scan=
    |         |               |     +-TableScan(column_list=PartSupp.[PS_PARTKEY#17, PS_COMMENT#18], table=PartSupp, table_column_list=[PartSupp.PS_PARTKEY,PartSupp.PS_COMMENT])
    |         |               +-join_expr=
    |         |                 +-FunctionCall(GoogleSQL:$equal(STRUCT<PS_PARTKEY UINT64>, STRUCT<PS_PARTKEY UINT64>) -> BOOL)
    |         |                   +-MakeStruct
    |         |                   | +-type=STRUCT<PS_PARTKEY UINT64>
    |         |                   | +-field_list=
    |         |                   |   +-ColumnRef(type=UINT64, column=PartSupp.PS_PARTKEY#17)
    |         |                   +-ColumnRef(type=STRUCT<PS_PARTKEY UINT64>, column=$flatten_input.$injected$join_multirow#21, is_correlated=TRUE)
    |         +-input_scan=
    |           +-ProjectScan
    |             +-column_list=[$flatten_input.$injected$join_multirow#21]
    |             +-expr_list=
    |             | +-$injected$join_multirow#21 := ColumnRef(type=STRUCT<PS_PARTKEY UINT64>, column=Part.$PartSupps$join_multirow#19, is_correlated=TRUE)
    |             +-input_scan=
    |               +-SingleRowScan
    +-input_scan=
      +-ProjectScan
        +-column_list=Part.[P_NAME#2, $PartSupps$join_multirow#19]
        +-expr_list=
        | +-$PartSupps$join_multirow#19 :=
        |   +-MakeStruct
        |     +-type=STRUCT<PS_PARTKEY UINT64>
        |     +-field_list=
        |       +-ColumnRef(type=UINT64, column=Part.P_PARTKEY#20)
        +-input_scan=
          +-TableScan(column_list=Part.[P_NAME#2, P_PARTKEY#20], table=Part, alias="p", table_column_list=[Part.P_NAME,Part.P_PARTKEY])
==

# Test returning ROW and MULTIROW from a CTE.
WITH cte AS (
  FROM Orders o
  |> SELECT o_orderkey, o_orderdate, o_clerk, o.Customer, o.Lineitems
)
FROM cte
|> STATIC_DESCRIBE
|> JOIN cte.Lineitems li
|> SELECT cte.o_orderdate,
          cte.Customer.c_name,
          cte.Customer.Nation.n_name,
          FLATTEN(cte.Lineitems.l_comment),
          li.l_quantity
--
QueryStmt
+-output_column_list=
| +-cte.o_orderdate#13 AS o_orderdate [DATE]
| +-$pipe_select.c_name#18 AS c_name [STRING]
| +-$pipe_select.n_name#19 AS n_name [STRING]
| +-$pipe_select.$col4#20 AS `$col4` [ARRAY<STRING>]
| +-$pipe_select.l_quantity#21 AS l_quantity [DOUBLE]
+-query=
  +-WithScan
    +-column_list=[cte.o_orderdate#13, $pipe_select.c_name#18, $pipe_select.n_name#19, $pipe_select.$col4#20, $pipe_select.l_quantity#21]
    +-with_entry_list=
    | +-WithEntry
    |   +-with_query_name="cte"
    |   +-with_subquery=
    |     +-ProjectScan
    |       +-column_list=Orders.[O_ORDERKEY#1, O_ORDERDATE#5, O_CLERK#7, Customer#10, LineItems#11]
    |       +-input_scan=
    |         +-TableScan(column_list=Orders.[O_ORDERKEY#1, O_ORDERDATE#5, O_CLERK#7, Customer#10, LineItems#11], table=Orders, column_index_list=[0, 4, 6, 9, 10], alias="o")
    +-query=
      +-ProjectScan
        +-column_list=[cte.o_orderdate#13, $pipe_select.c_name#18, $pipe_select.n_name#19, $pipe_select.$col4#20, $pipe_select.l_quantity#21]
        +-expr_list=
        | +-c_name#18 :=
        | | +-GetRowField
        | |   +-type=STRING
        | |   +-expr=
        | |   | +-ColumnRef(type=ROW<Customer (join)>, column=cte.Customer#15)
        | |   +-column=Customer.C_NAME
        | +-n_name#19 :=
        | | +-GetRowField
        | |   +-type=STRING
        | |   +-expr=
        | |   | +-GetRowField
        | |   |   +-type=ROW<Nation (join)>
        | |   |   +-expr=
        | |   |   | +-ColumnRef(type=ROW<Customer (join)>, column=cte.Customer#15)
        | |   |   +-column=Customer.Nation
        | |   +-column=Nation.N_NAME
        | +-$col4#20 :=
        | | +-Flatten
        | |   +-type=ARRAY<STRING>
        | |   +-expr=
        | |   | +-ColumnRef(type=MULTIROW<LineItem (join)>, column=cte.Lineitems#16)
        | |   +-get_field_list=
        | |     +-GetRowField
        | |       +-type=STRING
        | |       +-expr=
        | |       | +-FlattenedArg(type=ROW<LineItem>)
        | |       +-column=LineItem.L_COMMENT
        | +-l_quantity#21 :=
        |   +-GetRowField
        |     +-type=DOUBLE
        |     +-expr=
        |     | +-ColumnRef(type=ROW<LineItem>, column=$array.li#17)
        |     +-column=LineItem.L_QUANTITY
        +-input_scan=
          +-ArrayScan
            +-column_list=[cte.o_orderkey#12, cte.o_orderdate#13, cte.o_clerk#14, cte.Customer#15, cte.Lineitems#16, $array.li#17]
            +-input_scan=
            | +-StaticDescribeScan
            |   +-column_list=cte.[o_orderkey#12, o_orderdate#13, o_clerk#14, Customer#15, Lineitems#16]
            |   +-describe_text=
            |   |   """
            |   |   NameList:
            |   |     o_orderkey UINT64 cte.o_orderkey#12
            |   |     o_orderdate DATE cte.o_orderdate#13
            |   |     o_clerk STRING cte.o_clerk#14
            |   |     Customer ROW<Customer> cte.Customer#15
            |   |     Lineitems MULTIROW<LineItem> cte.Lineitems#16
            |   |   NameScope:
            |   |     Names:
            |   |       Customer -> ROW<Customer> (cte.Customer#15)
            |   |       Lineitems -> MULTIROW<LineItem> (cte.Lineitems#16)
            |   |       o_clerk -> STRING (cte.o_clerk#14)
            |   |       o_orderdate -> DATE (cte.o_orderdate#13)
            |   |       o_orderkey -> UINT64 (cte.o_orderkey#12)
            |   |     Range variables:
            |   |       cte -> RANGE_VARIABLE<o_orderkey#12,o_orderdate#13,o_clerk#14,Customer#15,Lineitems#16>
            |   |
            |   |   **Common table expressions**:
            |   |   Name  Columns
            |   |   ----  -----------------------------------------------------
            |   |   cte   o_orderkey, o_orderdate, o_clerk, Customer, Lineitems
            |   |   """
            |   +-input_scan=
            |     +-WithRefScan(column_list=cte.[o_orderkey#12, o_orderdate#13, o_clerk#14, Customer#15, Lineitems#16], with_query_name="cte")
            +-array_expr_list=
            | +-ColumnRef(type=MULTIROW<LineItem (join)>, column=cte.Lineitems#16)
            +-element_column_list=[$array.li#17]


[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-cte.o_orderdate#13 AS o_orderdate [DATE]
| +-$pipe_select.c_name#18 AS c_name [STRING]
| +-$pipe_select.n_name#19 AS n_name [STRING]
| +-$pipe_select.$col4#20 AS `$col4` [ARRAY<STRING>]
| +-$pipe_select.l_quantity#21 AS l_quantity [DOUBLE]
+-query=
  +-WithScan
    +-column_list=[cte.o_orderdate#13, $pipe_select.c_name#18, $pipe_select.n_name#19, $pipe_select.$col4#20, $pipe_select.l_quantity#21]
    +-with_entry_list=
    | +-WithEntry
    |   +-with_query_name="cte"
    |   +-with_subquery=
    |     +-ProjectScan
    |       +-column_list=Orders.[O_ORDERKEY#1, O_ORDERDATE#5, O_CLERK#7, $Customer$join_row#25, $LineItems$join_multirow#27]
    |       +-input_scan=
    |         +-ProjectScan
    |           +-column_list=Orders.[O_ORDERKEY#1, O_ORDERDATE#5, O_CLERK#7, $Customer$join_row#25, $LineItems$join_multirow#27]
    |           +-expr_list=
    |           | +-$Customer$join_row#25 :=
    |           | | +-MakeStruct
    |           | |   +-type=STRUCT<C_CUSTKEY UINT64>
    |           | |   +-field_list=
    |           | |     +-ColumnRef(type=UINT64, column=Orders.O_CUSTKEY#26)
    |           | +-$LineItems$join_multirow#27 :=
    |           |   +-MakeStruct
    |           |     +-type=STRUCT<L_ORDERKEY UINT64>
    |           |     +-field_list=
    |           |       +-ColumnRef(type=UINT64, column=Orders.O_ORDERKEY#1)
    |           +-input_scan=
    |             +-TableScan(column_list=Orders.[O_ORDERKEY#1, O_ORDERDATE#5, O_CLERK#7, O_CUSTKEY#26], table=Orders, alias="o", table_column_list=[Orders.O_ORDERKEY,Orders.O_ORDERDATE,Orders.O_CLERK,Orders.O_CUSTKEY])
    +-query=
      +-ProjectScan
        +-column_list=[cte.o_orderdate#13, $pipe_select.c_name#18, $pipe_select.n_name#19, $pipe_select.$col4#20, $pipe_select.l_quantity#21]
        +-expr_list=
        | +-c_name#18 :=
        | | +-SubqueryExpr
        | |   +-type=STRING
        | |   +-subquery_type=SCALAR
        | |   +-parameter_list=
        | |   | +-ColumnRef(type=STRUCT<C_CUSTKEY UINT64>, column=cte.$Customer$join_row#45)
        | |   +-subquery=
        | |     +-FilterScan
        | |       +-column_list=[Customer.C_NAME#29]
        | |       +-input_scan=
        | |       | +-TableScan(column_list=Customer.[C_CUSTKEY#28, C_NAME#29], table=Customer, table_column_list=[Customer.C_CUSTKEY,Customer.C_NAME])
        | |       +-filter_expr=
        | |         +-FunctionCall(GoogleSQL:$equal(STRUCT<C_CUSTKEY UINT64>, STRUCT<C_CUSTKEY UINT64>) -> BOOL)
        | |           +-MakeStruct
        | |           | +-type=STRUCT<C_CUSTKEY UINT64>
        | |           | +-field_list=
        | |           |   +-ColumnRef(type=UINT64, column=Customer.C_CUSTKEY#28)
        | |           +-ColumnRef(type=STRUCT<C_CUSTKEY UINT64>, column=cte.$Customer$join_row#45, is_correlated=TRUE)
        | +-n_name#19 :=
        | | +-SubqueryExpr
        | |   +-type=STRING
        | |   +-subquery_type=SCALAR
        | |   +-parameter_list=
        | |   | +-ColumnRef(type=STRUCT<C_CUSTKEY UINT64>, column=cte.$Customer$join_row#45)
        | |   +-subquery=
        | |     +-ProjectScan
        | |       +-column_list=[$with_expr.injected#48]
        | |       +-expr_list=
        | |       | +-injected#48 :=
        | |       |   +-SubqueryExpr
        | |       |     +-type=STRING
        | |       |     +-subquery_type=SCALAR
        | |       |     +-parameter_list=
        | |       |     | +-ColumnRef(type=STRUCT<N_NATIONKEY UINT64>, column=$with_expr.$with_col#34)
        | |       |     +-subquery=
        | |       |       +-FilterScan
        | |       |         +-column_list=[Nation.N_NAME#36]
        | |       |         +-input_scan=
        | |       |         | +-TableScan(column_list=Nation.[N_NATIONKEY#35, N_NAME#36], table=Nation, table_column_list=[Nation.N_NATIONKEY,Nation.N_NAME])
        | |       |         +-filter_expr=
        | |       |           +-FunctionCall(GoogleSQL:$equal(STRUCT<N_NATIONKEY UINT64>, STRUCT<N_NATIONKEY UINT64>) -> BOOL)
        | |       |             +-MakeStruct
        | |       |             | +-type=STRUCT<N_NATIONKEY UINT64>
        | |       |             | +-field_list=
        | |       |             |   +-ColumnRef(type=UINT64, column=Nation.N_NATIONKEY#35)
        | |       |             +-ColumnRef(type=STRUCT<N_NATIONKEY UINT64>, column=$with_expr.$with_col#34, is_correlated=TRUE)
        | |       +-input_scan=
        | |         +-ProjectScan
        | |           +-column_list=[$with_expr.$with_col#34]
        | |           +-expr_list=
        | |           | +-$with_col#34 :=
        | |           |   +-SubqueryExpr
        | |           |     +-type=STRUCT<N_NATIONKEY UINT64>
        | |           |     +-subquery_type=SCALAR
        | |           |     +-parameter_list=
        | |           |     | +-ColumnRef(type=STRUCT<C_CUSTKEY UINT64>, column=cte.$Customer$join_row#45, is_correlated=TRUE)
        | |           |     +-subquery=
        | |           |       +-FilterScan
        | |           |         +-column_list=[Customer.$Nation$join_row#32]
        | |           |         +-input_scan=
        | |           |         | +-ProjectScan
        | |           |         |   +-column_list=Customer.[C_CUSTKEY#30, $Nation$join_row#32]
        | |           |         |   +-expr_list=
        | |           |         |   | +-$Nation$join_row#32 :=
        | |           |         |   |   +-MakeStruct
        | |           |         |   |     +-type=STRUCT<N_NATIONKEY UINT64>
        | |           |         |   |     +-field_list=
        | |           |         |   |       +-ColumnRef(type=UINT64, column=Customer.C_NATIONKEY#33)
        | |           |         |   +-input_scan=
        | |           |         |     +-TableScan(column_list=Customer.[C_CUSTKEY#30, C_NATIONKEY#33], table=Customer, table_column_list=[Customer.C_CUSTKEY,Customer.C_NATIONKEY])
        | |           |         +-filter_expr=
        | |           |           +-FunctionCall(GoogleSQL:$equal(STRUCT<C_CUSTKEY UINT64>, STRUCT<C_CUSTKEY UINT64>) -> BOOL)
        | |           |             +-MakeStruct
        | |           |             | +-type=STRUCT<C_CUSTKEY UINT64>
        | |           |             | +-field_list=
        | |           |             |   +-ColumnRef(type=UINT64, column=Customer.C_CUSTKEY#30)
        | |           |             +-ColumnRef(type=STRUCT<C_CUSTKEY UINT64>, column=cte.$Customer$join_row#45, is_correlated=TRUE)
        | |           +-input_scan=
        | |             +-SingleRowScan
        | +-$col4#20 :=
        | | +-SubqueryExpr
        | |   +-type=ARRAY<STRING>
        | |   +-subquery_type=SCALAR
        | |   +-parameter_list=
        | |   | +-ColumnRef(type=STRUCT<L_ORDERKEY UINT64>, column=cte.$Lineitems$join_multirow#47)
        | |   +-subquery=
        | |     +-ProjectScan
        | |       +-column_list=[$with_expr.injected#49]
        | |       +-expr_list=
        | |       | +-injected#49 :=
        | |       |   +-FunctionCall(GoogleSQL:if(BOOL, ARRAY<STRING>, ARRAY<STRING>) -> ARRAY<STRING>)
        | |       |     +-FunctionCall(GoogleSQL:$is_null(STRUCT<L_ORDERKEY UINT64>) -> BOOL)
        | |       |     | +-ColumnRef(type=STRUCT<L_ORDERKEY UINT64>, column=$flatten_input.$injected$join_multirow#46)
        | |       |     +-Literal(type=ARRAY<STRING>, value=NULL)
        | |       |     +-SubqueryExpr
        | |       |       +-type=ARRAY<STRING>
        | |       |       +-subquery_type=ARRAY
        | |       |       +-parameter_list=
        | |       |       | +-ColumnRef(type=STRUCT<L_ORDERKEY UINT64>, column=$flatten_input.$injected$join_multirow#46)
        | |       |       +-subquery=
        | |       |         +-ProjectScan
        | |       |           +-column_list=[$flatten.injected#24]
        | |       |           +-expr_list=
        | |       |           | +-injected#24 :=
        | |       |           |   +-GetStructField
        | |       |           |     +-type=STRING
        | |       |           |     +-expr=
        | |       |           |     | +-ColumnRef(type=STRUCT<L_COMMENT STRING, L_QUANTITY DOUBLE>, column=$flatten.$injected$scanrow#37)
        | |       |           |     +-field_idx=0
        | |       |           +-input_scan=
        | |       |             +-JoinScan
        | |       |               +-column_list=[$flatten.$injected$scanrow#37]
        | |       |               +-left_scan=
        | |       |               | +-SingleRowScan
        | |       |               +-right_scan=
        | |       |               | +-ProjectScan
        | |       |               |   +-column_list=[LineItem.L_ORDERKEY#38, $flatten.$injected$scanrow#37]
        | |       |               |   +-expr_list=
        | |       |               |   | +-$injected$scanrow#37 :=
        | |       |               |   |   +-MakeStruct
        | |       |               |   |     +-type=STRUCT<L_COMMENT STRING, L_QUANTITY DOUBLE>
        | |       |               |   |     +-field_list=
        | |       |               |   |       +-ColumnRef(type=STRING, column=LineItem.L_COMMENT#39)
        | |       |               |   |       +-ColumnRef(type=DOUBLE, column=LineItem.L_QUANTITY#40)
        | |       |               |   +-input_scan=
        | |       |               |     +-TableScan(column_list=LineItem.[L_ORDERKEY#38, L_COMMENT#39, L_QUANTITY#40], table=LineItem, table_column_list=[LineItem.L_ORDERKEY,LineItem.L_COMMENT,LineItem.L_QUANTITY])
        | |       |               +-join_expr=
        | |       |                 +-FunctionCall(GoogleSQL:$equal(STRUCT<L_ORDERKEY UINT64>, STRUCT<L_ORDERKEY UINT64>) -> BOOL)
        | |       |                   +-MakeStruct
        | |       |                   | +-type=STRUCT<L_ORDERKEY UINT64>
        | |       |                   | +-field_list=
        | |       |                   |   +-ColumnRef(type=UINT64, column=LineItem.L_ORDERKEY#38)
        | |       |                   +-ColumnRef(type=STRUCT<L_ORDERKEY UINT64>, column=$flatten_input.$injected$join_multirow#46, is_correlated=TRUE)
        | |       +-input_scan=
        | |         +-ProjectScan
        | |           +-column_list=[$flatten_input.$injected$join_multirow#46]
        | |           +-expr_list=
        | |           | +-$injected$join_multirow#46 := ColumnRef(type=STRUCT<L_ORDERKEY UINT64>, column=cte.$Lineitems$join_multirow#47, is_correlated=TRUE)
        | |           +-input_scan=
        | |             +-SingleRowScan
        | +-l_quantity#21 :=
        |   +-GetStructField
        |     +-type=DOUBLE
        |     +-expr=
        |     | +-ColumnRef(type=STRUCT<L_COMMENT STRING, L_QUANTITY DOUBLE>, column=$array.$li$scanrow#41)
        |     +-field_idx=1
        +-input_scan=
          +-JoinScan
            +-column_list=[cte.o_orderkey#12, cte.o_orderdate#13, cte.o_clerk#14, cte.$Customer$join_row#45, cte.$Lineitems$join_multirow#47, $array.$li$scanrow#41]
            +-left_scan=
            | +-StaticDescribeScan
            |   +-column_list=cte.[o_orderkey#12, o_orderdate#13, o_clerk#14, $Customer$join_row#45, $Lineitems$join_multirow#47]
            |   +-describe_text=
            |   |   """
            |   |   NameList:
            |   |     o_orderkey UINT64 cte.o_orderkey#12
            |   |     o_orderdate DATE cte.o_orderdate#13
            |   |     o_clerk STRING cte.o_clerk#14
            |   |     Customer ROW<Customer> cte.Customer#15
            |   |     Lineitems MULTIROW<LineItem> cte.Lineitems#16
            |   |   NameScope:
            |   |     Names:
            |   |       Customer -> ROW<Customer> (cte.Customer#15)
            |   |       Lineitems -> MULTIROW<LineItem> (cte.Lineitems#16)
            |   |       o_clerk -> STRING (cte.o_clerk#14)
            |   |       o_orderdate -> DATE (cte.o_orderdate#13)
            |   |       o_orderkey -> UINT64 (cte.o_orderkey#12)
            |   |     Range variables:
            |   |       cte -> RANGE_VARIABLE<o_orderkey#12,o_orderdate#13,o_clerk#14,Customer#15,Lineitems#16>
            |   |
            |   |   **Common table expressions**:
            |   |   Name  Columns
            |   |   ----  -----------------------------------------------------
            |   |   cte   o_orderkey, o_orderdate, o_clerk, Customer, Lineitems
            |   |   """
            |   +-input_scan=
            |     +-WithRefScan(column_list=cte.[o_orderkey#12, o_orderdate#13, o_clerk#14, $Customer$join_row#45, $Lineitems$join_multirow#47], with_query_name="cte")
            +-right_scan=
            | +-ProjectScan
            |   +-column_list=[LineItem.L_ORDERKEY#42, $array.$li$scanrow#41]
            |   +-expr_list=
            |   | +-$li$scanrow#41 :=
            |   |   +-MakeStruct
            |   |     +-type=STRUCT<L_COMMENT STRING, L_QUANTITY DOUBLE>
            |   |     +-field_list=
            |   |       +-ColumnRef(type=STRING, column=LineItem.L_COMMENT#43)
            |   |       +-ColumnRef(type=DOUBLE, column=LineItem.L_QUANTITY#44)
            |   +-input_scan=
            |     +-TableScan(column_list=LineItem.[L_ORDERKEY#42, L_COMMENT#43, L_QUANTITY#44], table=LineItem, table_column_list=[LineItem.L_ORDERKEY,LineItem.L_COMMENT,LineItem.L_QUANTITY])
            +-join_expr=
              +-FunctionCall(GoogleSQL:$equal(STRUCT<L_ORDERKEY UINT64>, STRUCT<L_ORDERKEY UINT64>) -> BOOL)
                +-MakeStruct
                | +-type=STRUCT<L_ORDERKEY UINT64>
                | +-field_list=
                |   +-ColumnRef(type=UINT64, column=LineItem.L_ORDERKEY#42)
                +-ColumnRef(type=STRUCT<L_ORDERKEY UINT64>, column=cte.$Lineitems$join_multirow#47)
==

# This triggered a bug when reading through the same path twice.
SELECT l_orderkey, l_linenumber,
       li.Order_.Customer.c_custkey,
       li.Order_.Customer.Nation.Region.r_name
FROM Lineitem li
--
QueryStmt
+-output_column_list=
| +-LineItem.L_ORDERKEY#1 AS l_orderkey [UINT64]
| +-LineItem.L_LINENUMBER#4 AS l_linenumber [UINT64]
| +-$query.c_custkey#22 AS c_custkey [UINT64]
| +-$query.r_name#23 AS r_name [STRING]
+-query=
  +-ProjectScan
    +-column_list=[LineItem.L_ORDERKEY#1, LineItem.L_LINENUMBER#4, $query.c_custkey#22, $query.r_name#23]
    +-expr_list=
    | +-c_custkey#22 :=
    | | +-GetRowField
    | |   +-type=UINT64
    | |   +-expr=
    | |   | +-GetRowField
    | |   |   +-type=ROW<Customer (join)>
    | |   |   +-expr=
    | |   |   | +-ColumnRef(type=ROW<Orders (join)>, column=LineItem.Order_#18)
    | |   |   +-column=Orders.Customer
    | |   +-column=Customer.C_CUSTKEY
    | +-r_name#23 :=
    |   +-GetRowField
    |     +-type=STRING
    |     +-expr=
    |     | +-GetRowField
    |     |   +-type=ROW<Region (join)>
    |     |   +-expr=
    |     |   | +-GetRowField
    |     |   |   +-type=ROW<Nation (join)>
    |     |   |   +-expr=
    |     |   |   | +-GetRowField
    |     |   |   |   +-type=ROW<Customer (join)>
    |     |   |   |   +-expr=
    |     |   |   |   | +-ColumnRef(type=ROW<Orders (join)>, column=LineItem.Order_#18)
    |     |   |   |   +-column=Orders.Customer
    |     |   |   +-column=Customer.Nation
    |     |   +-column=Nation.Region
    |     +-column=Region.R_NAME
    +-input_scan=
      +-TableScan(column_list=LineItem.[L_ORDERKEY#1, L_LINENUMBER#4, Order_#18], table=LineItem, column_index_list=[0, 3, 17], alias="li")


[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-LineItem.L_ORDERKEY#1 AS l_orderkey [UINT64]
| +-LineItem.L_LINENUMBER#4 AS l_linenumber [UINT64]
| +-$query.c_custkey#22 AS c_custkey [UINT64]
| +-$query.r_name#23 AS r_name [STRING]
+-query=
  +-ProjectScan
    +-column_list=[LineItem.L_ORDERKEY#1, LineItem.L_LINENUMBER#4, $query.c_custkey#22, $query.r_name#23]
    +-expr_list=
    | +-c_custkey#22 :=
    | | +-SubqueryExpr
    | |   +-type=UINT64
    | |   +-subquery_type=SCALAR
    | |   +-parameter_list=
    | |   | +-ColumnRef(type=STRUCT<O_ORDERKEY UINT64>, column=LineItem.$Order_$join_row#47)
    | |   +-subquery=
    | |     +-ProjectScan
    | |       +-column_list=[$with_expr.injected#48]
    | |       +-expr_list=
    | |       | +-injected#48 :=
    | |       |   +-SubqueryExpr
    | |       |     +-type=UINT64
    | |       |     +-subquery_type=SCALAR
    | |       |     +-parameter_list=
    | |       |     | +-ColumnRef(type=STRUCT<C_CUSTKEY UINT64>, column=$with_expr.$with_col#28)
    | |       |     +-subquery=
    | |       |       +-FilterScan
    | |       |         +-column_list=[Customer.C_CUSTKEY#29]
    | |       |         +-input_scan=
    | |       |         | +-TableScan(column_list=[Customer.C_CUSTKEY#29], table=Customer, table_column_list=[Customer.C_CUSTKEY])
    | |       |         +-filter_expr=
    | |       |           +-FunctionCall(GoogleSQL:$equal(STRUCT<C_CUSTKEY UINT64>, STRUCT<C_CUSTKEY UINT64>) -> BOOL)
    | |       |             +-MakeStruct
    | |       |             | +-type=STRUCT<C_CUSTKEY UINT64>
    | |       |             | +-field_list=
    | |       |             |   +-ColumnRef(type=UINT64, column=Customer.C_CUSTKEY#29)
    | |       |             +-ColumnRef(type=STRUCT<C_CUSTKEY UINT64>, column=$with_expr.$with_col#28, is_correlated=TRUE)
    | |       +-input_scan=
    | |         +-ProjectScan
    | |           +-column_list=[$with_expr.$with_col#28]
    | |           +-expr_list=
    | |           | +-$with_col#28 :=
    | |           |   +-SubqueryExpr
    | |           |     +-type=STRUCT<C_CUSTKEY UINT64>
    | |           |     +-subquery_type=SCALAR
    | |           |     +-parameter_list=
    | |           |     | +-ColumnRef(type=STRUCT<O_ORDERKEY UINT64>, column=LineItem.$Order_$join_row#47, is_correlated=TRUE)
    | |           |     +-subquery=
    | |           |       +-FilterScan
    | |           |         +-column_list=[Orders.$Customer$join_row#26]
    | |           |         +-input_scan=
    | |           |         | +-ProjectScan
    | |           |         |   +-column_list=Orders.[O_ORDERKEY#24, $Customer$join_row#26]
    | |           |         |   +-expr_list=
    | |           |         |   | +-$Customer$join_row#26 :=
    | |           |         |   |   +-MakeStruct
    | |           |         |   |     +-type=STRUCT<C_CUSTKEY UINT64>
    | |           |         |   |     +-field_list=
    | |           |         |   |       +-ColumnRef(type=UINT64, column=Orders.O_CUSTKEY#27)
    | |           |         |   +-input_scan=
    | |           |         |     +-TableScan(column_list=Orders.[O_ORDERKEY#24, O_CUSTKEY#27], table=Orders, table_column_list=[Orders.O_ORDERKEY,Orders.O_CUSTKEY])
    | |           |         +-filter_expr=
    | |           |           +-FunctionCall(GoogleSQL:$equal(STRUCT<O_ORDERKEY UINT64>, STRUCT<O_ORDERKEY UINT64>) -> BOOL)
    | |           |             +-MakeStruct
    | |           |             | +-type=STRUCT<O_ORDERKEY UINT64>
    | |           |             | +-field_list=
    | |           |             |   +-ColumnRef(type=UINT64, column=Orders.O_ORDERKEY#24)
    | |           |             +-ColumnRef(type=STRUCT<O_ORDERKEY UINT64>, column=LineItem.$Order_$join_row#47, is_correlated=TRUE)
    | |           +-input_scan=
    | |             +-SingleRowScan
    | +-r_name#23 :=
    |   +-SubqueryExpr
    |     +-type=STRING
    |     +-subquery_type=SCALAR
    |     +-parameter_list=
    |     | +-ColumnRef(type=STRUCT<O_ORDERKEY UINT64>, column=LineItem.$Order_$join_row#47)
    |     +-subquery=
    |       +-ProjectScan
    |         +-column_list=[$with_expr.injected#51]
    |         +-expr_list=
    |         | +-injected#51 :=
    |         |   +-SubqueryExpr
    |         |     +-type=STRING
    |         |     +-subquery_type=SCALAR
    |         |     +-parameter_list=
    |         |     | +-ColumnRef(type=STRUCT<R_REGIONKEY UINT64>, column=$with_expr.$with_col#44)
    |         |     +-subquery=
    |         |       +-FilterScan
    |         |         +-column_list=[Region.R_NAME#46]
    |         |         +-input_scan=
    |         |         | +-TableScan(column_list=Region.[R_REGIONKEY#45, R_NAME#46], table=Region, table_column_list=[Region.R_REGIONKEY,Region.R_NAME])
    |         |         +-filter_expr=
    |         |           +-FunctionCall(GoogleSQL:$equal(STRUCT<R_REGIONKEY UINT64>, STRUCT<R_REGIONKEY UINT64>) -> BOOL)
    |         |             +-MakeStruct
    |         |             | +-type=STRUCT<R_REGIONKEY UINT64>
    |         |             | +-field_list=
    |         |             |   +-ColumnRef(type=UINT64, column=Region.R_REGIONKEY#45)
    |         |             +-ColumnRef(type=STRUCT<R_REGIONKEY UINT64>, column=$with_expr.$with_col#44, is_correlated=TRUE)
    |         +-input_scan=
    |           +-ProjectScan
    |             +-column_list=[$with_expr.$with_col#44]
    |             +-expr_list=
    |             | +-$with_col#44 :=
    |             |   +-SubqueryExpr
    |             |     +-type=STRUCT<R_REGIONKEY UINT64>
    |             |     +-subquery_type=SCALAR
    |             |     +-parameter_list=
    |             |     | +-ColumnRef(type=STRUCT<O_ORDERKEY UINT64>, column=LineItem.$Order_$join_row#47, is_correlated=TRUE)
    |             |     +-subquery=
    |             |       +-ProjectScan
    |             |         +-column_list=[$with_expr.injected#50]
    |             |         +-expr_list=
    |             |         | +-injected#50 :=
    |             |         |   +-SubqueryExpr
    |             |         |     +-type=STRUCT<R_REGIONKEY UINT64>
    |             |         |     +-subquery_type=SCALAR
    |             |         |     +-parameter_list=
    |             |         |     | +-ColumnRef(type=STRUCT<N_NATIONKEY UINT64>, column=$with_expr.$with_col#39)
    |             |         |     +-subquery=
    |             |         |       +-FilterScan
    |             |         |         +-column_list=[Nation.$Region$join_row#42]
    |             |         |         +-input_scan=
    |             |         |         | +-ProjectScan
    |             |         |         |   +-column_list=Nation.[N_NATIONKEY#40, $Region$join_row#42]
    |             |         |         |   +-expr_list=
    |             |         |         |   | +-$Region$join_row#42 :=
    |             |         |         |   |   +-MakeStruct
    |             |         |         |   |     +-type=STRUCT<R_REGIONKEY UINT64>
    |             |         |         |   |     +-field_list=
    |             |         |         |   |       +-ColumnRef(type=UINT64, column=Nation.N_REGIONKEY#43)
    |             |         |         |   +-input_scan=
    |             |         |         |     +-TableScan(column_list=Nation.[N_NATIONKEY#40, N_REGIONKEY#43], table=Nation, table_column_list=[Nation.N_NATIONKEY,Nation.N_REGIONKEY])
    |             |         |         +-filter_expr=
    |             |         |           +-FunctionCall(GoogleSQL:$equal(STRUCT<N_NATIONKEY UINT64>, STRUCT<N_NATIONKEY UINT64>) -> BOOL)
    |             |         |             +-MakeStruct
    |             |         |             | +-type=STRUCT<N_NATIONKEY UINT64>
    |             |         |             | +-field_list=
    |             |         |             |   +-ColumnRef(type=UINT64, column=Nation.N_NATIONKEY#40)
    |             |         |             +-ColumnRef(type=STRUCT<N_NATIONKEY UINT64>, column=$with_expr.$with_col#39, is_correlated=TRUE)
    |             |         +-input_scan=
    |             |           +-ProjectScan
    |             |             +-column_list=[$with_expr.$with_col#39]
    |             |             +-expr_list=
    |             |             | +-$with_col#39 :=
    |             |             |   +-SubqueryExpr
    |             |             |     +-type=STRUCT<N_NATIONKEY UINT64>
    |             |             |     +-subquery_type=SCALAR
    |             |             |     +-parameter_list=
    |             |             |     | +-ColumnRef(type=STRUCT<O_ORDERKEY UINT64>, column=LineItem.$Order_$join_row#47, is_correlated=TRUE)
    |             |             |     +-subquery=
    |             |             |       +-ProjectScan
    |             |             |         +-column_list=[$with_expr.injected#49]
    |             |             |         +-expr_list=
    |             |             |         | +-injected#49 :=
    |             |             |         |   +-SubqueryExpr
    |             |             |         |     +-type=STRUCT<N_NATIONKEY UINT64>
    |             |             |         |     +-subquery_type=SCALAR
    |             |             |         |     +-parameter_list=
    |             |             |         |     | +-ColumnRef(type=STRUCT<C_CUSTKEY UINT64>, column=$with_expr.$with_col#34)
    |             |             |         |     +-subquery=
    |             |             |         |       +-FilterScan
    |             |             |         |         +-column_list=[Customer.$Nation$join_row#37]
    |             |             |         |         +-input_scan=
    |             |             |         |         | +-ProjectScan
    |             |             |         |         |   +-column_list=Customer.[C_CUSTKEY#35, $Nation$join_row#37]
    |             |             |         |         |   +-expr_list=
    |             |             |         |         |   | +-$Nation$join_row#37 :=
    |             |             |         |         |   |   +-MakeStruct
    |             |             |         |         |   |     +-type=STRUCT<N_NATIONKEY UINT64>
    |             |             |         |         |   |     +-field_list=
    |             |             |         |         |   |       +-ColumnRef(type=UINT64, column=Customer.C_NATIONKEY#38)
    |             |             |         |         |   +-input_scan=
    |             |             |         |         |     +-TableScan(column_list=Customer.[C_CUSTKEY#35, C_NATIONKEY#38], table=Customer, table_column_list=[Customer.C_CUSTKEY,Customer.C_NATIONKEY])
    |             |             |         |         +-filter_expr=
    |             |             |         |           +-FunctionCall(GoogleSQL:$equal(STRUCT<C_CUSTKEY UINT64>, STRUCT<C_CUSTKEY UINT64>) -> BOOL)
    |             |             |         |             +-MakeStruct
    |             |             |         |             | +-type=STRUCT<C_CUSTKEY UINT64>
    |             |             |         |             | +-field_list=
    |             |             |         |             |   +-ColumnRef(type=UINT64, column=Customer.C_CUSTKEY#35)
    |             |             |         |             +-ColumnRef(type=STRUCT<C_CUSTKEY UINT64>, column=$with_expr.$with_col#34, is_correlated=TRUE)
    |             |             |         +-input_scan=
    |             |             |           +-ProjectScan
    |             |             |             +-column_list=[$with_expr.$with_col#34]
    |             |             |             +-expr_list=
    |             |             |             | +-$with_col#34 :=
    |             |             |             |   +-SubqueryExpr
    |             |             |             |     +-type=STRUCT<C_CUSTKEY UINT64>
    |             |             |             |     +-subquery_type=SCALAR
    |             |             |             |     +-parameter_list=
    |             |             |             |     | +-ColumnRef(type=STRUCT<O_ORDERKEY UINT64>, column=LineItem.$Order_$join_row#47, is_correlated=TRUE)
    |             |             |             |     +-subquery=
    |             |             |             |       +-FilterScan
    |             |             |             |         +-column_list=[Orders.$Customer$join_row#32]
    |             |             |             |         +-input_scan=
    |             |             |             |         | +-ProjectScan
    |             |             |             |         |   +-column_list=Orders.[O_ORDERKEY#30, $Customer$join_row#32]
    |             |             |             |         |   +-expr_list=
    |             |             |             |         |   | +-$Customer$join_row#32 :=
    |             |             |             |         |   |   +-MakeStruct
    |             |             |             |         |   |     +-type=STRUCT<C_CUSTKEY UINT64>
    |             |             |             |         |   |     +-field_list=
    |             |             |             |         |   |       +-ColumnRef(type=UINT64, column=Orders.O_CUSTKEY#33)
    |             |             |             |         |   +-input_scan=
    |             |             |             |         |     +-TableScan(column_list=Orders.[O_ORDERKEY#30, O_CUSTKEY#33], table=Orders, table_column_list=[Orders.O_ORDERKEY,Orders.O_CUSTKEY])
    |             |             |             |         +-filter_expr=
    |             |             |             |           +-FunctionCall(GoogleSQL:$equal(STRUCT<O_ORDERKEY UINT64>, STRUCT<O_ORDERKEY UINT64>) -> BOOL)
    |             |             |             |             +-MakeStruct
    |             |             |             |             | +-type=STRUCT<O_ORDERKEY UINT64>
    |             |             |             |             | +-field_list=
    |             |             |             |             |   +-ColumnRef(type=UINT64, column=Orders.O_ORDERKEY#30)
    |             |             |             |             +-ColumnRef(type=STRUCT<O_ORDERKEY UINT64>, column=LineItem.$Order_$join_row#47, is_correlated=TRUE)
    |             |             |             +-input_scan=
    |             |             |               +-SingleRowScan
    |             |             +-input_scan=
    |             |               +-SingleRowScan
    |             +-input_scan=
    |               +-SingleRowScan
    +-input_scan=
      +-ProjectScan
        +-column_list=LineItem.[L_ORDERKEY#1, L_LINENUMBER#4, $Order_$join_row#47]
        +-expr_list=
        | +-$Order_$join_row#47 :=
        |   +-MakeStruct
        |     +-type=STRUCT<O_ORDERKEY UINT64>
        |     +-field_list=
        |       +-ColumnRef(type=UINT64, column=LineItem.L_ORDERKEY#1)
        +-input_scan=
          +-TableScan(column_list=LineItem.[L_ORDERKEY#1, L_LINENUMBER#4], table=LineItem, alias="li", table_column_list=[LineItem.L_ORDERKEY,LineItem.L_LINENUMBER])
==

# TPCH 5, as a large example query with join columns.
SELECT
  supplier.nation.n_name,
  sum(l_extendedprice * (1 - l_discount)) AS revenue
FROM lineitem
WHERE order_.customer.c_nationkey = supplier.s_nationkey
  AND supplier.nation.region.r_name = 'AFRICA'
  AND order_.o_orderdate >= date '1994-01-01'
  AND order_.o_orderdate < date_add(date '1994-01-01', INTERVAL 1 year)
GROUP BY n_name
ORDER BY revenue DESC;
--
QueryStmt
+-output_column_list=
| +-$groupby.n_name#24 AS n_name [STRING]
| +-$aggregate.revenue#22 AS revenue [DOUBLE]
+-query=
  +-OrderByScan
    +-column_list=[$groupby.n_name#24, $aggregate.revenue#22]
    +-is_ordered=TRUE
    +-input_scan=
    | +-AggregateScan
    |   +-column_list=[$groupby.n_name#24, $aggregate.revenue#22]
    |   +-input_scan=
    |   | +-ProjectScan
    |   |   +-column_list=[LineItem.L_EXTENDEDPRICE#6, LineItem.L_DISCOUNT#7, LineItem.Order_#18, LineItem.Supplier#21, $pre_groupby.n_name#23]
    |   |   +-expr_list=
    |   |   | +-n_name#23 :=
    |   |   |   +-GetRowField
    |   |   |     +-type=STRING
    |   |   |     +-expr=
    |   |   |     | +-GetRowField
    |   |   |     |   +-type=ROW<Nation (join)>
    |   |   |     |   +-expr=
    |   |   |     |   | +-ColumnRef(type=ROW<Supplier (join)>, column=LineItem.Supplier#21)
    |   |   |     |   +-column=Supplier.Nation
    |   |   |     +-column=Nation.N_NAME
    |   |   +-input_scan=
    |   |     +-FilterScan
    |   |       +-column_list=LineItem.[L_EXTENDEDPRICE#6, L_DISCOUNT#7, Order_#18, Supplier#21]
    |   |       +-input_scan=
    |   |       | +-TableScan(column_list=LineItem.[L_EXTENDEDPRICE#6, L_DISCOUNT#7, Order_#18, Supplier#21], table=LineItem, column_index_list=[5, 6, 17, 20])
    |   |       +-filter_expr=
    |   |         +-FunctionCall(GoogleSQL:$and(BOOL, repeated(3) BOOL) -> BOOL)
    |   |           +-FunctionCall(GoogleSQL:$equal(UINT64, UINT64) -> BOOL)
    |   |           | +-GetRowField
    |   |           | | +-type=UINT64
    |   |           | | +-expr=
    |   |           | | | +-GetRowField
    |   |           | | |   +-type=ROW<Customer (join)>
    |   |           | | |   +-expr=
    |   |           | | |   | +-ColumnRef(type=ROW<Orders (join)>, column=LineItem.Order_#18)
    |   |           | | |   +-column=Orders.Customer
    |   |           | | +-column=Customer.C_NATIONKEY
    |   |           | +-GetRowField
    |   |           |   +-type=UINT64
    |   |           |   +-expr=
    |   |           |   | +-ColumnRef(type=ROW<Supplier (join)>, column=LineItem.Supplier#21)
    |   |           |   +-column=Supplier.S_NATIONKEY
    |   |           +-FunctionCall(GoogleSQL:$equal(STRING, STRING) -> BOOL)
    |   |           | +-GetRowField
    |   |           | | +-type=STRING
    |   |           | | +-expr=
    |   |           | | | +-GetRowField
    |   |           | | |   +-type=ROW<Region (join)>
    |   |           | | |   +-expr=
    |   |           | | |   | +-GetRowField
    |   |           | | |   |   +-type=ROW<Nation (join)>
    |   |           | | |   |   +-expr=
    |   |           | | |   |   | +-ColumnRef(type=ROW<Supplier (join)>, column=LineItem.Supplier#21)
    |   |           | | |   |   +-column=Supplier.Nation
    |   |           | | |   +-column=Nation.Region
    |   |           | | +-column=Region.R_NAME
    |   |           | +-Literal(type=STRING, value="AFRICA")
    |   |           +-FunctionCall(GoogleSQL:$greater_or_equal(DATE, DATE) -> BOOL)
    |   |           | +-GetRowField
    |   |           | | +-type=DATE
    |   |           | | +-expr=
    |   |           | | | +-ColumnRef(type=ROW<Orders (join)>, column=LineItem.Order_#18)
    |   |           | | +-column=Orders.O_ORDERDATE
    |   |           | +-Literal(type=DATE, value=1994-01-01, has_explicit_type=TRUE)
    |   |           +-FunctionCall(GoogleSQL:$less(DATE, DATE) -> BOOL)
    |   |             +-GetRowField
    |   |             | +-type=DATE
    |   |             | +-expr=
    |   |             | | +-ColumnRef(type=ROW<Orders (join)>, column=LineItem.Order_#18)
    |   |             | +-column=Orders.O_ORDERDATE
    |   |             +-FunctionCall(GoogleSQL:date_add(DATE, INT64, ENUM<googlesql.functions.DateTimestampPart>) -> DATE)
    |   |               +-Literal(type=DATE, value=1994-01-01, has_explicit_type=TRUE)
    |   |               +-Literal(type=INT64, value=1)
    |   |               +-Literal(type=ENUM<googlesql.functions.DateTimestampPart>, value=YEAR)
    |   +-group_by_list=
    |   | +-n_name#24 := ColumnRef(type=STRING, column=$pre_groupby.n_name#23)
    |   +-aggregate_list=
    |     +-revenue#22 :=
    |       +-AggregateFunctionCall(GoogleSQL:sum(DOUBLE) -> DOUBLE)
    |         +-FunctionCall(GoogleSQL:$multiply(DOUBLE, DOUBLE) -> DOUBLE)
    |           +-ColumnRef(type=DOUBLE, column=LineItem.L_EXTENDEDPRICE#6)
    |           +-FunctionCall(GoogleSQL:$subtract(DOUBLE, DOUBLE) -> DOUBLE)
    |             +-Literal(type=DOUBLE, value=1)
    |             +-ColumnRef(type=DOUBLE, column=LineItem.L_DISCOUNT#7)
    +-order_by_item_list=
      +-OrderByItem
        +-column_ref=
        | +-ColumnRef(type=DOUBLE, column=$aggregate.revenue#22)
        +-is_descending=TRUE


[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-$groupby.n_name#24 AS n_name [STRING]
| +-$aggregate.revenue#22 AS revenue [DOUBLE]
+-query=
  +-OrderByScan
    +-column_list=[$groupby.n_name#24, $aggregate.revenue#22]
    +-is_ordered=TRUE
    +-input_scan=
    | +-AggregateScan
    |   +-column_list=[$groupby.n_name#24, $aggregate.revenue#22]
    |   +-input_scan=
    |   | +-ProjectScan
    |   |   +-column_list=[LineItem.L_EXTENDEDPRICE#6, LineItem.L_DISCOUNT#7, LineItem.$Order_$join_row#32, LineItem.$Supplier$join_row#34, $pre_groupby.n_name#23]
    |   |   +-expr_list=
    |   |   | +-n_name#23 :=
    |   |   |   +-SubqueryExpr
    |   |   |     +-type=STRING
    |   |   |     +-subquery_type=SCALAR
    |   |   |     +-parameter_list=
    |   |   |     | +-ColumnRef(type=STRUCT<S_SUPPKEY UINT64>, column=LineItem.$Supplier$join_row#34)
    |   |   |     +-subquery=
    |   |   |       +-ProjectScan
    |   |   |         +-column_list=[$with_expr.injected#61]
    |   |   |         +-expr_list=
    |   |   |         | +-injected#61 :=
    |   |   |         |   +-SubqueryExpr
    |   |   |         |     +-type=STRING
    |   |   |         |     +-subquery_type=SCALAR
    |   |   |         |     +-parameter_list=
    |   |   |         |     | +-ColumnRef(type=STRUCT<N_NATIONKEY UINT64>, column=$with_expr.$with_col#29)
    |   |   |         |     +-subquery=
    |   |   |         |       +-FilterScan
    |   |   |         |         +-column_list=[Nation.N_NAME#31]
    |   |   |         |         +-input_scan=
    |   |   |         |         | +-TableScan(column_list=Nation.[N_NATIONKEY#30, N_NAME#31], table=Nation, table_column_list=[Nation.N_NATIONKEY,Nation.N_NAME])
    |   |   |         |         +-filter_expr=
    |   |   |         |           +-FunctionCall(GoogleSQL:$equal(STRUCT<N_NATIONKEY UINT64>, STRUCT<N_NATIONKEY UINT64>) -> BOOL)
    |   |   |         |             +-MakeStruct
    |   |   |         |             | +-type=STRUCT<N_NATIONKEY UINT64>
    |   |   |         |             | +-field_list=
    |   |   |         |             |   +-ColumnRef(type=UINT64, column=Nation.N_NATIONKEY#30)
    |   |   |         |             +-ColumnRef(type=STRUCT<N_NATIONKEY UINT64>, column=$with_expr.$with_col#29, is_correlated=TRUE)
    |   |   |         +-input_scan=
    |   |   |           +-ProjectScan
    |   |   |             +-column_list=[$with_expr.$with_col#29]
    |   |   |             +-expr_list=
    |   |   |             | +-$with_col#29 :=
    |   |   |             |   +-SubqueryExpr
    |   |   |             |     +-type=STRUCT<N_NATIONKEY UINT64>
    |   |   |             |     +-subquery_type=SCALAR
    |   |   |             |     +-parameter_list=
    |   |   |             |     | +-ColumnRef(type=STRUCT<S_SUPPKEY UINT64>, column=LineItem.$Supplier$join_row#34, is_correlated=TRUE)
    |   |   |             |     +-subquery=
    |   |   |             |       +-FilterScan
    |   |   |             |         +-column_list=[Supplier.$Nation$join_row#27]
    |   |   |             |         +-input_scan=
    |   |   |             |         | +-ProjectScan
    |   |   |             |         |   +-column_list=Supplier.[S_SUPPKEY#25, $Nation$join_row#27]
    |   |   |             |         |   +-expr_list=
    |   |   |             |         |   | +-$Nation$join_row#27 :=
    |   |   |             |         |   |   +-MakeStruct
    |   |   |             |         |   |     +-type=STRUCT<N_NATIONKEY UINT64>
    |   |   |             |         |   |     +-field_list=
    |   |   |             |         |   |       +-ColumnRef(type=UINT64, column=Supplier.S_NATIONKEY#28)
    |   |   |             |         |   +-input_scan=
    |   |   |             |         |     +-TableScan(column_list=Supplier.[S_SUPPKEY#25, S_NATIONKEY#28], table=Supplier, table_column_list=[Supplier.S_SUPPKEY,Supplier.S_NATIONKEY])
    |   |   |             |         +-filter_expr=
    |   |   |             |           +-FunctionCall(GoogleSQL:$equal(STRUCT<S_SUPPKEY UINT64>, STRUCT<S_SUPPKEY UINT64>) -> BOOL)
    |   |   |             |             +-MakeStruct
    |   |   |             |             | +-type=STRUCT<S_SUPPKEY UINT64>
    |   |   |             |             | +-field_list=
    |   |   |             |             |   +-ColumnRef(type=UINT64, column=Supplier.S_SUPPKEY#25)
    |   |   |             |             +-ColumnRef(type=STRUCT<S_SUPPKEY UINT64>, column=LineItem.$Supplier$join_row#34, is_correlated=TRUE)
    |   |   |             +-input_scan=
    |   |   |               +-SingleRowScan
    |   |   +-input_scan=
    |   |     +-FilterScan
    |   |       +-column_list=LineItem.[L_EXTENDEDPRICE#6, L_DISCOUNT#7, $Order_$join_row#32, $Supplier$join_row#34]
    |   |       +-input_scan=
    |   |       | +-ProjectScan
    |   |       |   +-column_list=LineItem.[L_EXTENDEDPRICE#6, L_DISCOUNT#7, $Order_$join_row#32, $Supplier$join_row#34]
    |   |       |   +-expr_list=
    |   |       |   | +-$Order_$join_row#32 :=
    |   |       |   | | +-MakeStruct
    |   |       |   | |   +-type=STRUCT<O_ORDERKEY UINT64>
    |   |       |   | |   +-field_list=
    |   |       |   | |     +-ColumnRef(type=UINT64, column=LineItem.L_ORDERKEY#33)
    |   |       |   | +-$Supplier$join_row#34 :=
    |   |       |   |   +-MakeStruct
    |   |       |   |     +-type=STRUCT<S_SUPPKEY UINT64>
    |   |       |   |     +-field_list=
    |   |       |   |       +-ColumnRef(type=UINT64, column=LineItem.L_SUPPKEY#35)
    |   |       |   +-input_scan=
    |   |       |     +-TableScan(column_list=LineItem.[L_EXTENDEDPRICE#6, L_DISCOUNT#7, L_ORDERKEY#33, L_SUPPKEY#35], table=LineItem, table_column_list=[LineItem.L_EXTENDEDPRICE,LineItem.L_DISCOUNT,LineItem.L_ORDERKEY,LineItem.L_SUPPKEY])
    |   |       +-filter_expr=
    |   |         +-FunctionCall(GoogleSQL:$and(BOOL, repeated(3) BOOL) -> BOOL)
    |   |           +-FunctionCall(GoogleSQL:$equal(UINT64, UINT64) -> BOOL)
    |   |           | +-SubqueryExpr
    |   |           | | +-type=UINT64
    |   |           | | +-subquery_type=SCALAR
    |   |           | | +-parameter_list=
    |   |           | | | +-ColumnRef(type=STRUCT<O_ORDERKEY UINT64>, column=LineItem.$Order_$join_row#32)
    |   |           | | +-subquery=
    |   |           | |   +-ProjectScan
    |   |           | |     +-column_list=[$with_expr.injected#62]
    |   |           | |     +-expr_list=
    |   |           | |     | +-injected#62 :=
    |   |           | |     |   +-SubqueryExpr
    |   |           | |     |     +-type=UINT64
    |   |           | |     |     +-subquery_type=SCALAR
    |   |           | |     |     +-parameter_list=
    |   |           | |     |     | +-ColumnRef(type=STRUCT<C_CUSTKEY UINT64>, column=$with_expr.$with_col#40)
    |   |           | |     |     +-subquery=
    |   |           | |     |       +-FilterScan
    |   |           | |     |         +-column_list=[Customer.C_NATIONKEY#42]
    |   |           | |     |         +-input_scan=
    |   |           | |     |         | +-TableScan(column_list=Customer.[C_CUSTKEY#41, C_NATIONKEY#42], table=Customer, table_column_list=[Customer.C_CUSTKEY,Customer.C_NATIONKEY])
    |   |           | |     |         +-filter_expr=
    |   |           | |     |           +-FunctionCall(GoogleSQL:$equal(STRUCT<C_CUSTKEY UINT64>, STRUCT<C_CUSTKEY UINT64>) -> BOOL)
    |   |           | |     |             +-MakeStruct
    |   |           | |     |             | +-type=STRUCT<C_CUSTKEY UINT64>
    |   |           | |     |             | +-field_list=
    |   |           | |     |             |   +-ColumnRef(type=UINT64, column=Customer.C_CUSTKEY#41)
    |   |           | |     |             +-ColumnRef(type=STRUCT<C_CUSTKEY UINT64>, column=$with_expr.$with_col#40, is_correlated=TRUE)
    |   |           | |     +-input_scan=
    |   |           | |       +-ProjectScan
    |   |           | |         +-column_list=[$with_expr.$with_col#40]
    |   |           | |         +-expr_list=
    |   |           | |         | +-$with_col#40 :=
    |   |           | |         |   +-SubqueryExpr
    |   |           | |         |     +-type=STRUCT<C_CUSTKEY UINT64>
    |   |           | |         |     +-subquery_type=SCALAR
    |   |           | |         |     +-parameter_list=
    |   |           | |         |     | +-ColumnRef(type=STRUCT<O_ORDERKEY UINT64>, column=LineItem.$Order_$join_row#32, is_correlated=TRUE)
    |   |           | |         |     +-subquery=
    |   |           | |         |       +-FilterScan
    |   |           | |         |         +-column_list=[Orders.$Customer$join_row#38]
    |   |           | |         |         +-input_scan=
    |   |           | |         |         | +-ProjectScan
    |   |           | |         |         |   +-column_list=Orders.[O_ORDERKEY#36, $Customer$join_row#38]
    |   |           | |         |         |   +-expr_list=
    |   |           | |         |         |   | +-$Customer$join_row#38 :=
    |   |           | |         |         |   |   +-MakeStruct
    |   |           | |         |         |   |     +-type=STRUCT<C_CUSTKEY UINT64>
    |   |           | |         |         |   |     +-field_list=
    |   |           | |         |         |   |       +-ColumnRef(type=UINT64, column=Orders.O_CUSTKEY#39)
    |   |           | |         |         |   +-input_scan=
    |   |           | |         |         |     +-TableScan(column_list=Orders.[O_ORDERKEY#36, O_CUSTKEY#39], table=Orders, table_column_list=[Orders.O_ORDERKEY,Orders.O_CUSTKEY])
    |   |           | |         |         +-filter_expr=
    |   |           | |         |           +-FunctionCall(GoogleSQL:$equal(STRUCT<O_ORDERKEY UINT64>, STRUCT<O_ORDERKEY UINT64>) -> BOOL)
    |   |           | |         |             +-MakeStruct
    |   |           | |         |             | +-type=STRUCT<O_ORDERKEY UINT64>
    |   |           | |         |             | +-field_list=
    |   |           | |         |             |   +-ColumnRef(type=UINT64, column=Orders.O_ORDERKEY#36)
    |   |           | |         |             +-ColumnRef(type=STRUCT<O_ORDERKEY UINT64>, column=LineItem.$Order_$join_row#32, is_correlated=TRUE)
    |   |           | |         +-input_scan=
    |   |           | |           +-SingleRowScan
    |   |           | +-SubqueryExpr
    |   |           |   +-type=UINT64
    |   |           |   +-subquery_type=SCALAR
    |   |           |   +-parameter_list=
    |   |           |   | +-ColumnRef(type=STRUCT<S_SUPPKEY UINT64>, column=LineItem.$Supplier$join_row#34)
    |   |           |   +-subquery=
    |   |           |     +-FilterScan
    |   |           |       +-column_list=[Supplier.S_NATIONKEY#44]
    |   |           |       +-input_scan=
    |   |           |       | +-TableScan(column_list=Supplier.[S_SUPPKEY#43, S_NATIONKEY#44], table=Supplier, table_column_list=[Supplier.S_SUPPKEY,Supplier.S_NATIONKEY])
    |   |           |       +-filter_expr=
    |   |           |         +-FunctionCall(GoogleSQL:$equal(STRUCT<S_SUPPKEY UINT64>, STRUCT<S_SUPPKEY UINT64>) -> BOOL)
    |   |           |           +-MakeStruct
    |   |           |           | +-type=STRUCT<S_SUPPKEY UINT64>
    |   |           |           | +-field_list=
    |   |           |           |   +-ColumnRef(type=UINT64, column=Supplier.S_SUPPKEY#43)
    |   |           |           +-ColumnRef(type=STRUCT<S_SUPPKEY UINT64>, column=LineItem.$Supplier$join_row#34, is_correlated=TRUE)
    |   |           +-FunctionCall(GoogleSQL:$equal(STRING, STRING) -> BOOL)
    |   |           | +-SubqueryExpr
    |   |           | | +-type=STRING
    |   |           | | +-subquery_type=SCALAR
    |   |           | | +-parameter_list=
    |   |           | | | +-ColumnRef(type=STRUCT<S_SUPPKEY UINT64>, column=LineItem.$Supplier$join_row#34)
    |   |           | | +-subquery=
    |   |           | |   +-ProjectScan
    |   |           | |     +-column_list=[$with_expr.injected#64]
    |   |           | |     +-expr_list=
    |   |           | |     | +-injected#64 :=
    |   |           | |     |   +-SubqueryExpr
    |   |           | |     |     +-type=STRING
    |   |           | |     |     +-subquery_type=SCALAR
    |   |           | |     |     +-parameter_list=
    |   |           | |     |     | +-ColumnRef(type=STRUCT<R_REGIONKEY UINT64>, column=$with_expr.$with_col#54)
    |   |           | |     |     +-subquery=
    |   |           | |     |       +-FilterScan
    |   |           | |     |         +-column_list=[Region.R_NAME#56]
    |   |           | |     |         +-input_scan=
    |   |           | |     |         | +-TableScan(column_list=Region.[R_REGIONKEY#55, R_NAME#56], table=Region, table_column_list=[Region.R_REGIONKEY,Region.R_NAME])
    |   |           | |     |         +-filter_expr=
    |   |           | |     |           +-FunctionCall(GoogleSQL:$equal(STRUCT<R_REGIONKEY UINT64>, STRUCT<R_REGIONKEY UINT64>) -> BOOL)
    |   |           | |     |             +-MakeStruct
    |   |           | |     |             | +-type=STRUCT<R_REGIONKEY UINT64>
    |   |           | |     |             | +-field_list=
    |   |           | |     |             |   +-ColumnRef(type=UINT64, column=Region.R_REGIONKEY#55)
    |   |           | |     |             +-ColumnRef(type=STRUCT<R_REGIONKEY UINT64>, column=$with_expr.$with_col#54, is_correlated=TRUE)
    |   |           | |     +-input_scan=
    |   |           | |       +-ProjectScan
    |   |           | |         +-column_list=[$with_expr.$with_col#54]
    |   |           | |         +-expr_list=
    |   |           | |         | +-$with_col#54 :=
    |   |           | |         |   +-SubqueryExpr
    |   |           | |         |     +-type=STRUCT<R_REGIONKEY UINT64>
    |   |           | |         |     +-subquery_type=SCALAR
    |   |           | |         |     +-parameter_list=
    |   |           | |         |     | +-ColumnRef(type=STRUCT<S_SUPPKEY UINT64>, column=LineItem.$Supplier$join_row#34, is_correlated=TRUE)
    |   |           | |         |     +-subquery=
    |   |           | |         |       +-ProjectScan
    |   |           | |         |         +-column_list=[$with_expr.injected#63]
    |   |           | |         |         +-expr_list=
    |   |           | |         |         | +-injected#63 :=
    |   |           | |         |         |   +-SubqueryExpr
    |   |           | |         |         |     +-type=STRUCT<R_REGIONKEY UINT64>
    |   |           | |         |         |     +-subquery_type=SCALAR
    |   |           | |         |         |     +-parameter_list=
    |   |           | |         |         |     | +-ColumnRef(type=STRUCT<N_NATIONKEY UINT64>, column=$with_expr.$with_col#49)
    |   |           | |         |         |     +-subquery=
    |   |           | |         |         |       +-FilterScan
    |   |           | |         |         |         +-column_list=[Nation.$Region$join_row#52]
    |   |           | |         |         |         +-input_scan=
    |   |           | |         |         |         | +-ProjectScan
    |   |           | |         |         |         |   +-column_list=Nation.[N_NATIONKEY#50, $Region$join_row#52]
    |   |           | |         |         |         |   +-expr_list=
    |   |           | |         |         |         |   | +-$Region$join_row#52 :=
    |   |           | |         |         |         |   |   +-MakeStruct
    |   |           | |         |         |         |   |     +-type=STRUCT<R_REGIONKEY UINT64>
    |   |           | |         |         |         |   |     +-field_list=
    |   |           | |         |         |         |   |       +-ColumnRef(type=UINT64, column=Nation.N_REGIONKEY#53)
    |   |           | |         |         |         |   +-input_scan=
    |   |           | |         |         |         |     +-TableScan(column_list=Nation.[N_NATIONKEY#50, N_REGIONKEY#53], table=Nation, table_column_list=[Nation.N_NATIONKEY,Nation.N_REGIONKEY])
    |   |           | |         |         |         +-filter_expr=
    |   |           | |         |         |           +-FunctionCall(GoogleSQL:$equal(STRUCT<N_NATIONKEY UINT64>, STRUCT<N_NATIONKEY UINT64>) -> BOOL)
    |   |           | |         |         |             +-MakeStruct
    |   |           | |         |         |             | +-type=STRUCT<N_NATIONKEY UINT64>
    |   |           | |         |         |             | +-field_list=
    |   |           | |         |         |             |   +-ColumnRef(type=UINT64, column=Nation.N_NATIONKEY#50)
    |   |           | |         |         |             +-ColumnRef(type=STRUCT<N_NATIONKEY UINT64>, column=$with_expr.$with_col#49, is_correlated=TRUE)
    |   |           | |         |         +-input_scan=
    |   |           | |         |           +-ProjectScan
    |   |           | |         |             +-column_list=[$with_expr.$with_col#49]
    |   |           | |         |             +-expr_list=
    |   |           | |         |             | +-$with_col#49 :=
    |   |           | |         |             |   +-SubqueryExpr
    |   |           | |         |             |     +-type=STRUCT<N_NATIONKEY UINT64>
    |   |           | |         |             |     +-subquery_type=SCALAR
    |   |           | |         |             |     +-parameter_list=
    |   |           | |         |             |     | +-ColumnRef(type=STRUCT<S_SUPPKEY UINT64>, column=LineItem.$Supplier$join_row#34, is_correlated=TRUE)
    |   |           | |         |             |     +-subquery=
    |   |           | |         |             |       +-FilterScan
    |   |           | |         |             |         +-column_list=[Supplier.$Nation$join_row#47]
    |   |           | |         |             |         +-input_scan=
    |   |           | |         |             |         | +-ProjectScan
    |   |           | |         |             |         |   +-column_list=Supplier.[S_SUPPKEY#45, $Nation$join_row#47]
    |   |           | |         |             |         |   +-expr_list=
    |   |           | |         |             |         |   | +-$Nation$join_row#47 :=
    |   |           | |         |             |         |   |   +-MakeStruct
    |   |           | |         |             |         |   |     +-type=STRUCT<N_NATIONKEY UINT64>
    |   |           | |         |             |         |   |     +-field_list=
    |   |           | |         |             |         |   |       +-ColumnRef(type=UINT64, column=Supplier.S_NATIONKEY#48)
    |   |           | |         |             |         |   +-input_scan=
    |   |           | |         |             |         |     +-TableScan(column_list=Supplier.[S_SUPPKEY#45, S_NATIONKEY#48], table=Supplier, table_column_list=[Supplier.S_SUPPKEY,Supplier.S_NATIONKEY])
    |   |           | |         |             |         +-filter_expr=
    |   |           | |         |             |           +-FunctionCall(GoogleSQL:$equal(STRUCT<S_SUPPKEY UINT64>, STRUCT<S_SUPPKEY UINT64>) -> BOOL)
    |   |           | |         |             |             +-MakeStruct
    |   |           | |         |             |             | +-type=STRUCT<S_SUPPKEY UINT64>
    |   |           | |         |             |             | +-field_list=
    |   |           | |         |             |             |   +-ColumnRef(type=UINT64, column=Supplier.S_SUPPKEY#45)
    |   |           | |         |             |             +-ColumnRef(type=STRUCT<S_SUPPKEY UINT64>, column=LineItem.$Supplier$join_row#34, is_correlated=TRUE)
    |   |           | |         |             +-input_scan=
    |   |           | |         |               +-SingleRowScan
    |   |           | |         +-input_scan=
    |   |           | |           +-SingleRowScan
    |   |           | +-Literal(type=STRING, value="AFRICA")
    |   |           +-FunctionCall(GoogleSQL:$greater_or_equal(DATE, DATE) -> BOOL)
    |   |           | +-SubqueryExpr
    |   |           | | +-type=DATE
    |   |           | | +-subquery_type=SCALAR
    |   |           | | +-parameter_list=
    |   |           | | | +-ColumnRef(type=STRUCT<O_ORDERKEY UINT64>, column=LineItem.$Order_$join_row#32)
    |   |           | | +-subquery=
    |   |           | |   +-FilterScan
    |   |           | |     +-column_list=[Orders.O_ORDERDATE#58]
    |   |           | |     +-input_scan=
    |   |           | |     | +-TableScan(column_list=Orders.[O_ORDERKEY#57, O_ORDERDATE#58], table=Orders, table_column_list=[Orders.O_ORDERKEY,Orders.O_ORDERDATE])
    |   |           | |     +-filter_expr=
    |   |           | |       +-FunctionCall(GoogleSQL:$equal(STRUCT<O_ORDERKEY UINT64>, STRUCT<O_ORDERKEY UINT64>) -> BOOL)
    |   |           | |         +-MakeStruct
    |   |           | |         | +-type=STRUCT<O_ORDERKEY UINT64>
    |   |           | |         | +-field_list=
    |   |           | |         |   +-ColumnRef(type=UINT64, column=Orders.O_ORDERKEY#57)
    |   |           | |         +-ColumnRef(type=STRUCT<O_ORDERKEY UINT64>, column=LineItem.$Order_$join_row#32, is_correlated=TRUE)
    |   |           | +-Literal(type=DATE, value=1994-01-01, has_explicit_type=TRUE)
    |   |           +-FunctionCall(GoogleSQL:$less(DATE, DATE) -> BOOL)
    |   |             +-SubqueryExpr
    |   |             | +-type=DATE
    |   |             | +-subquery_type=SCALAR
    |   |             | +-parameter_list=
    |   |             | | +-ColumnRef(type=STRUCT<O_ORDERKEY UINT64>, column=LineItem.$Order_$join_row#32)
    |   |             | +-subquery=
    |   |             |   +-FilterScan
    |   |             |     +-column_list=[Orders.O_ORDERDATE#60]
    |   |             |     +-input_scan=
    |   |             |     | +-TableScan(column_list=Orders.[O_ORDERKEY#59, O_ORDERDATE#60], table=Orders, table_column_list=[Orders.O_ORDERKEY,Orders.O_ORDERDATE])
    |   |             |     +-filter_expr=
    |   |             |       +-FunctionCall(GoogleSQL:$equal(STRUCT<O_ORDERKEY UINT64>, STRUCT<O_ORDERKEY UINT64>) -> BOOL)
    |   |             |         +-MakeStruct
    |   |             |         | +-type=STRUCT<O_ORDERKEY UINT64>
    |   |             |         | +-field_list=
    |   |             |         |   +-ColumnRef(type=UINT64, column=Orders.O_ORDERKEY#59)
    |   |             |         +-ColumnRef(type=STRUCT<O_ORDERKEY UINT64>, column=LineItem.$Order_$join_row#32, is_correlated=TRUE)
    |   |             +-FunctionCall(GoogleSQL:date_add(DATE, INT64, ENUM<googlesql.functions.DateTimestampPart>) -> DATE)
    |   |               +-Literal(type=DATE, value=1994-01-01, has_explicit_type=TRUE)
    |   |               +-Literal(type=INT64, value=1)
    |   |               +-Literal(type=ENUM<googlesql.functions.DateTimestampPart>, value=YEAR)
    |   +-group_by_list=
    |   | +-n_name#24 := ColumnRef(type=STRING, column=$pre_groupby.n_name#23)
    |   +-aggregate_list=
    |     +-revenue#22 :=
    |       +-AggregateFunctionCall(GoogleSQL:sum(DOUBLE) -> DOUBLE)
    |         +-FunctionCall(GoogleSQL:$multiply(DOUBLE, DOUBLE) -> DOUBLE)
    |           +-ColumnRef(type=DOUBLE, column=LineItem.L_EXTENDEDPRICE#6)
    |           +-FunctionCall(GoogleSQL:$subtract(DOUBLE, DOUBLE) -> DOUBLE)
    |             +-Literal(type=DOUBLE, value=1)
    |             +-ColumnRef(type=DOUBLE, column=LineItem.L_DISCOUNT#7)
    +-order_by_item_list=
      +-OrderByItem
        +-column_ref=
        | +-ColumnRef(type=DOUBLE, column=$aggregate.revenue#22)
        +-is_descending=TRUE
