# Tests MAP_INSERT with the minumum valid number of variadic arguments.
[default show_sqlbuilder_output]
[default sql_builder_target_syntax_mode=standard]
[default language_features=NONE,+MAP_TYPE,+ORDER_BY_IN_AGGREGATE,+HAVING_IN_AGGREGATE,+INLINE_LAMBDA_ARGUMENT]
[enabled_ast_rewrites=NONE,+VARIADIC_FUNCTION_SIGNATURE_EXPANDER{{|,+BUILTIN_FUNCTION_INLINER}}]
SELECT MAP_INSERT(MAP_FROM_ARRAY(CAST([] AS ARRAY<STRUCT<INT64, STRING>>)), 1, 'a', 2, 'b')
--
ALTERNATION GROUP: <empty>
--
QueryStmt
+-output_column_list=
| +-$query.$col1#1 AS `$col1` [MAP<INT64, STRING>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#1]
    +-expr_list=
    | +-$col1#1 :=
    |   +-FunctionCall(GoogleSQL:map_insert(MAP<INT64, STRING> input_map, INT64 key, STRING value, repeated(1) INT64 repeated_key, repeated(1) STRING repeated_value) -> MAP<INT64, STRING>)
    |     +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<INT64, STRING>>) -> MAP<INT64, STRING>)
    |     | +-Literal(type=ARRAY<STRUCT<INT64, STRING>>, value=[], has_explicit_type=TRUE)
    |     +-Literal(type=INT64, value=1)
    |     +-Literal(type=STRING, value="a")
    |     +-Literal(type=INT64, value=2)
    |     +-Literal(type=STRING, value="b")
    +-input_scan=
      +-SingleRowScan

[SQLBUILDER_OUTPUT]
SELECT
  MAP_INSERT(MAP_FROM_ARRAY(ARRAY< STRUCT< INT64, STRING > >[]), 1, "a", 2, "b") AS a_1;

[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-$query.$col1#1 AS `$col1` [MAP<INT64, STRING>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#1]
    +-expr_list=
    | +-$col1#1 :=
    |   +-FunctionCall(GoogleSQL:map_insert(MAP<INT64, STRING> input_map, INT64 key, STRING value, INT64 repeated_key_1, STRING repeated_value_1) -> MAP<INT64, STRING>)
    |     +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<INT64, STRING>>) -> MAP<INT64, STRING>)
    |     | +-Literal(type=ARRAY<STRUCT<INT64, STRING>>, value=[], has_explicit_type=TRUE)
    |     +-Literal(type=INT64, value=1)
    |     +-Literal(type=STRING, value="a")
    |     +-Literal(type=INT64, value=2)
    |     +-Literal(type=STRING, value="b")
    +-input_scan=
      +-SingleRowScan
[SQLBUILDER_OUTPUT]
SELECT
  MAP_INSERT(MAP_FROM_ARRAY(ARRAY< STRUCT< INT64, STRING > >[]), 1, "a", 2, "b") AS a_1;
--
ALTERNATION GROUP: ,+BUILTIN_FUNCTION_INLINER
--
QueryStmt
+-output_column_list=
| +-$query.$col1#1 AS `$col1` [MAP<INT64, STRING>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#1]
    +-expr_list=
    | +-$col1#1 :=
    |   +-FunctionCall(GoogleSQL:map_insert(MAP<INT64, STRING> input_map, INT64 key, STRING value, repeated(1) INT64 repeated_key, repeated(1) STRING repeated_value) -> MAP<INT64, STRING>)
    |     +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<INT64, STRING>>) -> MAP<INT64, STRING>)
    |     | +-Literal(type=ARRAY<STRUCT<INT64, STRING>>, value=[], has_explicit_type=TRUE)
    |     +-Literal(type=INT64, value=1)
    |     +-Literal(type=STRING, value="a")
    |     +-Literal(type=INT64, value=2)
    |     +-Literal(type=STRING, value="b")
    +-input_scan=
      +-SingleRowScan

[SQLBUILDER_OUTPUT]
SELECT
  MAP_INSERT(MAP_FROM_ARRAY(ARRAY< STRUCT< INT64, STRING > >[]), 1, "a", 2, "b") AS a_1;

[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-$query.$col1#1 AS `$col1` [MAP<INT64, STRING>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#1]
    +-expr_list=
    | +-$col1#1 :=
    |   +-SubqueryExpr
    |     +-type=MAP<INT64, STRING>
    |     +-subquery_type=SCALAR
    |     +-subquery=
    |       +-ProjectScan
    |         +-column_list=[$expr_subquery.$col1#27]
    |         +-expr_list=
    |         | +-$col1#27 :=
    |         |   +-FunctionCall(GoogleSQL:if(BOOL, MAP<INT64, STRING>, MAP<INT64, STRING>) -> MAP<INT64, STRING>)
    |         |     +-FunctionCall(GoogleSQL:$is_null(MAP<INT64, STRING>) -> BOOL)
    |         |     | +-ColumnRef(type=MAP<INT64, STRING>, column=$subquery1.input_map#2)
    |         |     +-Literal(type=MAP<INT64, STRING>, value=NULL)
    |         |     +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<key INT64, STRING>>) -> MAP<INT64, STRING>)
    |         |       +-SubqueryExpr
    |         |         +-type=ARRAY<STRUCT<key INT64, STRING>>
    |         |         +-subquery_type=ARRAY
    |         |         +-parameter_list=
    |         |         | +-ColumnRef(type=MAP<INT64, STRING>, column=$subquery1.input_map#2)
    |         |         | +-ColumnRef(type=INT64, column=$subquery1.key#3)
    |         |         | +-ColumnRef(type=INT64, column=$subquery1.repeated_key_1#4)
    |         |         | +-ColumnRef(type=STRING, column=$subquery1.repeated_value_1#5)
    |         |         | +-ColumnRef(type=STRING, column=$subquery1.value#6)
    |         |         +-subquery=
    |         |           +-ProjectScan
    |         |             +-column_list=[$expr_subquery.$col1#26]
    |         |             +-expr_list=
    |         |             | +-$col1#26 :=
    |         |             |   +-FunctionCall(GoogleSQL:$case_no_value(repeated(2) BOOL, repeated(2) STRUCT<key INT64, STRING>, STRUCT<key INT64, STRING>) -> STRUCT<key INT64, STRING>)
    |         |             |     +-FunctionCall(GoogleSQL:$greater(INT64, INT64) -> BOOL)
    |         |             |     | +-ColumnRef(type=INT64, column=$aggregate.$agg1#21)
    |         |             |     | +-Literal(type=INT64, value=1)
    |         |             |     +-Cast(STRUCT<key INT64, STRING> -> STRUCT<key INT64, STRING>)
    |         |             |     | +-FunctionCall(GoogleSQL:error(STRING) -> STRUCT<key INT64, STRING>)
    |         |             |     |   +-FunctionCall(GoogleSQL:format(STRING, repeated(1) INT64) -> STRING)
    |         |             |     |     +-Literal(type=STRING, value="Key provided more than once as argument: %T")
    |         |             |     |     +-ColumnRef(type=INT64, column=$groupby.key#25)
    |         |             |     +-FunctionCall(GoogleSQL:$and(BOOL, repeated(1) BOOL) -> BOOL)
    |         |             |     | +-FunctionCall(GoogleSQL:$equal(INT64, INT64) -> BOOL)
    |         |             |     | | +-ColumnRef(type=INT64, column=$aggregate.$agg2#22)
    |         |             |     | | +-Literal(type=INT64, value=1)
    |         |             |     | +-FunctionCall(GoogleSQL:$greater(INT64, INT64) -> BOOL)
    |         |             |     |   +-ColumnRef(type=INT64, column=$aggregate.$agg3#23)
    |         |             |     |   +-Literal(type=INT64, value=1)
    |         |             |     +-Cast(STRUCT<key INT64, STRING> -> STRUCT<key INT64, STRING>)
    |         |             |     | +-FunctionCall(GoogleSQL:error(STRING) -> STRUCT<key INT64, STRING>)
    |         |             |     |   +-FunctionCall(GoogleSQL:format(STRING, repeated(1) INT64) -> STRING)
    |         |             |     |     +-Literal(type=STRING, value="Key already exists in map: %T")
    |         |             |     |     +-ColumnRef(type=INT64, column=$groupby.key#25)
    |         |             |     +-MakeStruct
    |         |             |       +-type=STRUCT<key INT64, STRING>
    |         |             |       +-field_list=
    |         |             |         +-ColumnRef(type=INT64, column=$groupby.key#25)
    |         |             |         +-ColumnRef(type=STRING, column=$aggregate.$agg4#24)
    |         |             +-input_scan=
    |         |               +-AggregateScan
    |         |                 +-column_list=[$groupby.key#25, $aggregate.$agg1#21, $aggregate.$agg2#22, $aggregate.$agg3#23, $aggregate.$agg4#24]
    |         |                 +-input_scan=
    |         |                 | +-SetOperationScan
    |         |                 |   +-column_list=$union_all.[key#18, value#19, is_new#20]
    |         |                 |   +-op_type=UNION_ALL
    |         |                 |   +-input_item_list=
    |         |                 |     +-SetOperationItem
    |         |                 |     | +-scan=
    |         |                 |     | | +-ProjectScan
    |         |                 |     | |   +-column_list=$union_all1.[key#8, value#9, is_new#10]
    |         |                 |     | |   +-expr_list=
    |         |                 |     | |   | +-key#8 :=
    |         |                 |     | |   | | +-GetStructField
    |         |                 |     | |   | |   +-type=INT64
    |         |                 |     | |   | |   +-expr=
    |         |                 |     | |   | |   | +-ColumnRef(type=STRUCT<key INT64, value STRING>, column=$array.t#7)
    |         |                 |     | |   | |   +-field_idx=0
    |         |                 |     | |   | +-value#9 :=
    |         |                 |     | |   | | +-GetStructField
    |         |                 |     | |   | |   +-type=STRING
    |         |                 |     | |   | |   +-expr=
    |         |                 |     | |   | |   | +-ColumnRef(type=STRUCT<key INT64, value STRING>, column=$array.t#7)
    |         |                 |     | |   | |   +-field_idx=1
    |         |                 |     | |   | +-is_new#10 := Literal(type=INT64, value=0)
    |         |                 |     | |   +-input_scan=
    |         |                 |     | |     +-ArrayScan
    |         |                 |     | |       +-column_list=[$array.t#7]
    |         |                 |     | |       +-array_expr_list=
    |         |                 |     | |       | +-FunctionCall(GoogleSQL:map_entries_unsorted(MAP<INT64, STRING>) -> ARRAY<STRUCT<key INT64, value STRING>>)
    |         |                 |     | |       |   +-ColumnRef(type=MAP<INT64, STRING>, column=$subquery1.input_map#2, is_correlated=TRUE)
    |         |                 |     | |       +-element_column_list=[$array.t#7]
    |         |                 |     | +-output_column_list=$union_all1.[key#8, value#9, is_new#10]
    |         |                 |     +-SetOperationItem
    |         |                 |       +-scan=
    |         |                 |       | +-ProjectScan
    |         |                 |       |   +-column_list=[$union_all.key#15, $union_all.value#16, $union_all2.is_new#17]
    |         |                 |       |   +-expr_list=
    |         |                 |       |   | +-is_new#17 := Literal(type=INT64, value=1)
    |         |                 |       |   +-input_scan=
    |         |                 |       |     +-SetOperationScan
    |         |                 |       |       +-column_list=$union_all.[key#15, value#16]
    |         |                 |       |       +-op_type=UNION_ALL
    |         |                 |       |       +-input_item_list=
    |         |                 |       |         +-SetOperationItem
    |         |                 |       |         | +-scan=
    |         |                 |       |         | | +-ProjectScan
    |         |                 |       |         | |   +-column_list=$union_all1.[key#11, value#12]
    |         |                 |       |         | |   +-expr_list=
    |         |                 |       |         | |   | +-key#11 := ColumnRef(type=INT64, column=$subquery1.key#3, is_correlated=TRUE)
    |         |                 |       |         | |   | +-value#12 := ColumnRef(type=STRING, column=$subquery1.value#6, is_correlated=TRUE)
    |         |                 |       |         | |   +-input_scan=
    |         |                 |       |         | |     +-SingleRowScan
    |         |                 |       |         | +-output_column_list=$union_all1.[key#11, value#12]
    |         |                 |       |         +-SetOperationItem
    |         |                 |       |           +-scan=
    |         |                 |       |           | +-ProjectScan
    |         |                 |       |           |   +-column_list=$union_all2.[key#13, value#14]
    |         |                 |       |           |   +-expr_list=
    |         |                 |       |           |   | +-key#13 := ColumnRef(type=INT64, column=$subquery1.repeated_key_1#4, is_correlated=TRUE)
    |         |                 |       |           |   | +-value#14 := ColumnRef(type=STRING, column=$subquery1.repeated_value_1#5, is_correlated=TRUE)
    |         |                 |       |           |   +-input_scan=
    |         |                 |       |           |     +-SingleRowScan
    |         |                 |       |           +-output_column_list=$union_all2.[key#13, value#14]
    |         |                 |       +-output_column_list=[$union_all.key#15, $union_all.value#16, $union_all2.is_new#17]
    |         |                 +-group_by_list=
    |         |                 | +-key#25 := ColumnRef(type=INT64, column=$union_all.key#18)
    |         |                 +-aggregate_list=
    |         |                   +-$agg1#21 :=
    |         |                   | +-AggregateFunctionCall(GoogleSQL:sum(INT64) -> INT64)
    |         |                   |   +-ColumnRef(type=INT64, column=$union_all.is_new#20)
    |         |                   +-$agg2#22 :=
    |         |                   | +-AggregateFunctionCall(GoogleSQL:sum(INT64) -> INT64)
    |         |                   |   +-ColumnRef(type=INT64, column=$union_all.is_new#20)
    |         |                   +-$agg3#23 := AggregateFunctionCall(GoogleSQL:$count_star() -> INT64)
    |         |                   +-$agg4#24 :=
    |         |                     +-AggregateFunctionCall(GoogleSQL:any_value(STRING) -> STRING)
    |         |                       +-ColumnRef(type=STRING, column=$union_all.value#19)
    |         |                       +-having_modifier=
    |         |                         +-AggregateHavingModifier
    |         |                           +-kind=MAX
    |         |                           +-having_expr=
    |         |                             +-ColumnRef(type=INT64, column=$union_all.is_new#20)
    |         +-input_scan=
    |           +-ProjectScan
    |             +-column_list=$subquery1.[input_map#2, key#3, repeated_key_1#4, repeated_value_1#5, value#6]
    |             +-expr_list=
    |             | +-input_map#2 :=
    |             | | +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<INT64, STRING>>) -> MAP<INT64, STRING>)
    |             | |   +-Literal(type=ARRAY<STRUCT<INT64, STRING>>, value=[], has_explicit_type=TRUE)
    |             | +-key#3 := Literal(type=INT64, value=1)
    |             | +-repeated_key_1#4 := Literal(type=INT64, value=2)
    |             | +-repeated_value_1#5 := Literal(type=STRING, value="b")
    |             | +-value#6 := Literal(type=STRING, value="a")
    |             +-input_scan=
    |               +-SingleRowScan
    +-input_scan=
      +-SingleRowScan
[SQLBUILDER_OUTPUT]
SELECT
  (
    SELECT
      `IF`((projectscan_7.a_2) IS NULL, CAST(NULL AS MAP< INT64, STRING >), MAP_FROM_ARRAY(ARRAY(
            SELECT
              CASE
                WHEN((aggregatescan_25.a_21) > 1) THEN CAST(ERROR(FORMAT("Key provided more than once as argument: %T",
                    aggregatescan_25.a_20)) AS STRUCT< key INT64, STRING >)
                WHEN(((aggregatescan_25.a_22) = 1) AND ((aggregatescan_25.a_23) > 1)) THEN CAST(ERROR(FORMAT("Key already exists in map: %T",
                    aggregatescan_25.a_20)) AS STRUCT< key INT64, STRING >)
                ELSE STRUCT< key INT64, STRING > (aggregatescan_25.a_20, aggregatescan_25.a_24)
              END AS a_26
            FROM
              (
                SELECT
                  setoperationscan_19.a_10 AS a_20,
                  SUM(setoperationscan_19.a_12) AS a_21,
                  SUM(setoperationscan_19.a_12) AS a_22,
                  COUNT(*) AS a_23,
                  ANY_VALUE(setoperationscan_19.a_11
                    HAVING MAX setoperationscan_19.a_12) AS a_24
                FROM
                  ((
                    SELECT
                      a_9.key AS a_10,
                      a_9.value AS a_11,
                      0 AS a_12
                    FROM
                      UNNEST(MAP_ENTRIES_UNSORTED(projectscan_7.a_2)) AS a_9
                    ) UNION ALL(
                    SELECT
                      setoperationscan_17.a_13 AS a_13,
                      setoperationscan_17.a_14 AS a_14,
                      1 AS a_18
                    FROM
                      ((
                        SELECT
                          projectscan_7.a_3 AS a_13,
                          projectscan_7.a_6 AS a_14
                        ) UNION ALL(
                        SELECT
                          projectscan_7.a_4 AS a_15,
                          projectscan_7.a_5 AS a_16
                        )
                      ) AS setoperationscan_17
                    )
                  ) AS setoperationscan_19
                GROUP BY 1
              ) AS aggregatescan_25
          ))) AS a_8
    FROM
      (
        SELECT
          MAP_FROM_ARRAY(ARRAY< STRUCT< INT64, STRING > >[]) AS a_2,
          1 AS a_3,
          2 AS a_4,
          "b" AS a_5,
          "a" AS a_6
      ) AS projectscan_7
  ) AS a_1;
==

# Tests MAP_INSERT with more than the minumum number of variadic arguments.
[default language_features=NONE,+MAP_TYPE,+ORDER_BY_IN_AGGREGATE,+HAVING_IN_AGGREGATE,+INLINE_LAMBDA_ARGUMENT]
[enabled_ast_rewrites=NONE,+VARIADIC_FUNCTION_SIGNATURE_EXPANDER{{|,+BUILTIN_FUNCTION_INLINER}}]
SELECT MAP_INSERT(MAP_FROM_ARRAY(CAST([] AS ARRAY<STRUCT<INT64, STRING>>)), 1, 'a', 2, 'b', 3, 'c', 4, 'd')
--
ALTERNATION GROUP: <empty>
--
QueryStmt
+-output_column_list=
| +-$query.$col1#1 AS `$col1` [MAP<INT64, STRING>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#1]
    +-expr_list=
    | +-$col1#1 :=
    |   +-FunctionCall(GoogleSQL:map_insert(MAP<INT64, STRING> input_map, INT64 key, STRING value, repeated(3) INT64 repeated_key, repeated(3) STRING repeated_value) -> MAP<INT64, STRING>)
    |     +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<INT64, STRING>>) -> MAP<INT64, STRING>)
    |     | +-Literal(type=ARRAY<STRUCT<INT64, STRING>>, value=[], has_explicit_type=TRUE)
    |     +-Literal(type=INT64, value=1)
    |     +-Literal(type=STRING, value="a")
    |     +-Literal(type=INT64, value=2)
    |     +-Literal(type=STRING, value="b")
    |     +-Literal(type=INT64, value=3)
    |     +-Literal(type=STRING, value="c")
    |     +-Literal(type=INT64, value=4)
    |     +-Literal(type=STRING, value="d")
    +-input_scan=
      +-SingleRowScan

[SQLBUILDER_OUTPUT]
SELECT
  MAP_INSERT(MAP_FROM_ARRAY(ARRAY< STRUCT< INT64, STRING > >[]), 1, "a", 2, "b", 3, "c", 4, "d") AS a_1;

[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-$query.$col1#1 AS `$col1` [MAP<INT64, STRING>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#1]
    +-expr_list=
    | +-$col1#1 :=
    |   +-FunctionCall(GoogleSQL:map_insert(MAP<INT64, STRING> input_map, INT64 key, STRING value, INT64 repeated_key_1, STRING repeated_value_1, INT64 repeated_key_2, STRING repeated_value_2, INT64 repeated_key_3, STRING repeated_value_3) -> MAP<INT64, STRING>)
    |     +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<INT64, STRING>>) -> MAP<INT64, STRING>)
    |     | +-Literal(type=ARRAY<STRUCT<INT64, STRING>>, value=[], has_explicit_type=TRUE)
    |     +-Literal(type=INT64, value=1)
    |     +-Literal(type=STRING, value="a")
    |     +-Literal(type=INT64, value=2)
    |     +-Literal(type=STRING, value="b")
    |     +-Literal(type=INT64, value=3)
    |     +-Literal(type=STRING, value="c")
    |     +-Literal(type=INT64, value=4)
    |     +-Literal(type=STRING, value="d")
    +-input_scan=
      +-SingleRowScan
[SQLBUILDER_OUTPUT]
SELECT
  MAP_INSERT(MAP_FROM_ARRAY(ARRAY< STRUCT< INT64, STRING > >[]), 1, "a", 2, "b", 3, "c", 4, "d") AS a_1;
--
ALTERNATION GROUP: ,+BUILTIN_FUNCTION_INLINER
--
QueryStmt
+-output_column_list=
| +-$query.$col1#1 AS `$col1` [MAP<INT64, STRING>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#1]
    +-expr_list=
    | +-$col1#1 :=
    |   +-FunctionCall(GoogleSQL:map_insert(MAP<INT64, STRING> input_map, INT64 key, STRING value, repeated(3) INT64 repeated_key, repeated(3) STRING repeated_value) -> MAP<INT64, STRING>)
    |     +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<INT64, STRING>>) -> MAP<INT64, STRING>)
    |     | +-Literal(type=ARRAY<STRUCT<INT64, STRING>>, value=[], has_explicit_type=TRUE)
    |     +-Literal(type=INT64, value=1)
    |     +-Literal(type=STRING, value="a")
    |     +-Literal(type=INT64, value=2)
    |     +-Literal(type=STRING, value="b")
    |     +-Literal(type=INT64, value=3)
    |     +-Literal(type=STRING, value="c")
    |     +-Literal(type=INT64, value=4)
    |     +-Literal(type=STRING, value="d")
    +-input_scan=
      +-SingleRowScan

[SQLBUILDER_OUTPUT]
SELECT
  MAP_INSERT(MAP_FROM_ARRAY(ARRAY< STRUCT< INT64, STRING > >[]), 1, "a", 2, "b", 3, "c", 4, "d") AS a_1;

[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-$query.$col1#1 AS `$col1` [MAP<INT64, STRING>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#1]
    +-expr_list=
    | +-$col1#1 :=
    |   +-SubqueryExpr
    |     +-type=MAP<INT64, STRING>
    |     +-subquery_type=SCALAR
    |     +-subquery=
    |       +-ProjectScan
    |         +-column_list=[$expr_subquery.$col1#35]
    |         +-expr_list=
    |         | +-$col1#35 :=
    |         |   +-FunctionCall(GoogleSQL:if(BOOL, MAP<INT64, STRING>, MAP<INT64, STRING>) -> MAP<INT64, STRING>)
    |         |     +-FunctionCall(GoogleSQL:$is_null(MAP<INT64, STRING>) -> BOOL)
    |         |     | +-ColumnRef(type=MAP<INT64, STRING>, column=$subquery1.input_map#2)
    |         |     +-Literal(type=MAP<INT64, STRING>, value=NULL)
    |         |     +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<key INT64, STRING>>) -> MAP<INT64, STRING>)
    |         |       +-SubqueryExpr
    |         |         +-type=ARRAY<STRUCT<key INT64, STRING>>
    |         |         +-subquery_type=ARRAY
    |         |         +-parameter_list=
    |         |         | +-ColumnRef(type=MAP<INT64, STRING>, column=$subquery1.input_map#2)
    |         |         | +-ColumnRef(type=INT64, column=$subquery1.key#3)
    |         |         | +-ColumnRef(type=INT64, column=$subquery1.repeated_key_1#4)
    |         |         | +-ColumnRef(type=INT64, column=$subquery1.repeated_key_2#5)
    |         |         | +-ColumnRef(type=INT64, column=$subquery1.repeated_key_3#6)
    |         |         | +-ColumnRef(type=STRING, column=$subquery1.repeated_value_1#7)
    |         |         | +-ColumnRef(type=STRING, column=$subquery1.repeated_value_2#8)
    |         |         | +-ColumnRef(type=STRING, column=$subquery1.repeated_value_3#9)
    |         |         | +-ColumnRef(type=STRING, column=$subquery1.value#10)
    |         |         +-subquery=
    |         |           +-ProjectScan
    |         |             +-column_list=[$expr_subquery.$col1#34]
    |         |             +-expr_list=
    |         |             | +-$col1#34 :=
    |         |             |   +-FunctionCall(GoogleSQL:$case_no_value(repeated(2) BOOL, repeated(2) STRUCT<key INT64, STRING>, STRUCT<key INT64, STRING>) -> STRUCT<key INT64, STRING>)
    |         |             |     +-FunctionCall(GoogleSQL:$greater(INT64, INT64) -> BOOL)
    |         |             |     | +-ColumnRef(type=INT64, column=$aggregate.$agg1#29)
    |         |             |     | +-Literal(type=INT64, value=1)
    |         |             |     +-Cast(STRUCT<key INT64, STRING> -> STRUCT<key INT64, STRING>)
    |         |             |     | +-FunctionCall(GoogleSQL:error(STRING) -> STRUCT<key INT64, STRING>)
    |         |             |     |   +-FunctionCall(GoogleSQL:format(STRING, repeated(1) INT64) -> STRING)
    |         |             |     |     +-Literal(type=STRING, value="Key provided more than once as argument: %T")
    |         |             |     |     +-ColumnRef(type=INT64, column=$groupby.key#33)
    |         |             |     +-FunctionCall(GoogleSQL:$and(BOOL, repeated(1) BOOL) -> BOOL)
    |         |             |     | +-FunctionCall(GoogleSQL:$equal(INT64, INT64) -> BOOL)
    |         |             |     | | +-ColumnRef(type=INT64, column=$aggregate.$agg2#30)
    |         |             |     | | +-Literal(type=INT64, value=1)
    |         |             |     | +-FunctionCall(GoogleSQL:$greater(INT64, INT64) -> BOOL)
    |         |             |     |   +-ColumnRef(type=INT64, column=$aggregate.$agg3#31)
    |         |             |     |   +-Literal(type=INT64, value=1)
    |         |             |     +-Cast(STRUCT<key INT64, STRING> -> STRUCT<key INT64, STRING>)
    |         |             |     | +-FunctionCall(GoogleSQL:error(STRING) -> STRUCT<key INT64, STRING>)
    |         |             |     |   +-FunctionCall(GoogleSQL:format(STRING, repeated(1) INT64) -> STRING)
    |         |             |     |     +-Literal(type=STRING, value="Key already exists in map: %T")
    |         |             |     |     +-ColumnRef(type=INT64, column=$groupby.key#33)
    |         |             |     +-MakeStruct
    |         |             |       +-type=STRUCT<key INT64, STRING>
    |         |             |       +-field_list=
    |         |             |         +-ColumnRef(type=INT64, column=$groupby.key#33)
    |         |             |         +-ColumnRef(type=STRING, column=$aggregate.$agg4#32)
    |         |             +-input_scan=
    |         |               +-AggregateScan
    |         |                 +-column_list=[$groupby.key#33, $aggregate.$agg1#29, $aggregate.$agg2#30, $aggregate.$agg3#31, $aggregate.$agg4#32]
    |         |                 +-input_scan=
    |         |                 | +-SetOperationScan
    |         |                 |   +-column_list=$union_all.[key#26, value#27, is_new#28]
    |         |                 |   +-op_type=UNION_ALL
    |         |                 |   +-input_item_list=
    |         |                 |     +-SetOperationItem
    |         |                 |     | +-scan=
    |         |                 |     | | +-ProjectScan
    |         |                 |     | |   +-column_list=$union_all1.[key#12, value#13, is_new#14]
    |         |                 |     | |   +-expr_list=
    |         |                 |     | |   | +-key#12 :=
    |         |                 |     | |   | | +-GetStructField
    |         |                 |     | |   | |   +-type=INT64
    |         |                 |     | |   | |   +-expr=
    |         |                 |     | |   | |   | +-ColumnRef(type=STRUCT<key INT64, value STRING>, column=$array.t#11)
    |         |                 |     | |   | |   +-field_idx=0
    |         |                 |     | |   | +-value#13 :=
    |         |                 |     | |   | | +-GetStructField
    |         |                 |     | |   | |   +-type=STRING
    |         |                 |     | |   | |   +-expr=
    |         |                 |     | |   | |   | +-ColumnRef(type=STRUCT<key INT64, value STRING>, column=$array.t#11)
    |         |                 |     | |   | |   +-field_idx=1
    |         |                 |     | |   | +-is_new#14 := Literal(type=INT64, value=0)
    |         |                 |     | |   +-input_scan=
    |         |                 |     | |     +-ArrayScan
    |         |                 |     | |       +-column_list=[$array.t#11]
    |         |                 |     | |       +-array_expr_list=
    |         |                 |     | |       | +-FunctionCall(GoogleSQL:map_entries_unsorted(MAP<INT64, STRING>) -> ARRAY<STRUCT<key INT64, value STRING>>)
    |         |                 |     | |       |   +-ColumnRef(type=MAP<INT64, STRING>, column=$subquery1.input_map#2, is_correlated=TRUE)
    |         |                 |     | |       +-element_column_list=[$array.t#11]
    |         |                 |     | +-output_column_list=$union_all1.[key#12, value#13, is_new#14]
    |         |                 |     +-SetOperationItem
    |         |                 |       +-scan=
    |         |                 |       | +-ProjectScan
    |         |                 |       |   +-column_list=[$union_all.key#23, $union_all.value#24, $union_all2.is_new#25]
    |         |                 |       |   +-expr_list=
    |         |                 |       |   | +-is_new#25 := Literal(type=INT64, value=1)
    |         |                 |       |   +-input_scan=
    |         |                 |       |     +-SetOperationScan
    |         |                 |       |       +-column_list=$union_all.[key#23, value#24]
    |         |                 |       |       +-op_type=UNION_ALL
    |         |                 |       |       +-input_item_list=
    |         |                 |       |         +-SetOperationItem
    |         |                 |       |         | +-scan=
    |         |                 |       |         | | +-ProjectScan
    |         |                 |       |         | |   +-column_list=$union_all1.[key#15, value#16]
    |         |                 |       |         | |   +-expr_list=
    |         |                 |       |         | |   | +-key#15 := ColumnRef(type=INT64, column=$subquery1.key#3, is_correlated=TRUE)
    |         |                 |       |         | |   | +-value#16 := ColumnRef(type=STRING, column=$subquery1.value#10, is_correlated=TRUE)
    |         |                 |       |         | |   +-input_scan=
    |         |                 |       |         | |     +-SingleRowScan
    |         |                 |       |         | +-output_column_list=$union_all1.[key#15, value#16]
    |         |                 |       |         +-SetOperationItem
    |         |                 |       |         | +-scan=
    |         |                 |       |         | | +-ProjectScan
    |         |                 |       |         | |   +-column_list=$union_all2.[key#17, value#18]
    |         |                 |       |         | |   +-expr_list=
    |         |                 |       |         | |   | +-key#17 := ColumnRef(type=INT64, column=$subquery1.repeated_key_1#4, is_correlated=TRUE)
    |         |                 |       |         | |   | +-value#18 := ColumnRef(type=STRING, column=$subquery1.repeated_value_1#7, is_correlated=TRUE)
    |         |                 |       |         | |   +-input_scan=
    |         |                 |       |         | |     +-SingleRowScan
    |         |                 |       |         | +-output_column_list=$union_all2.[key#17, value#18]
    |         |                 |       |         +-SetOperationItem
    |         |                 |       |         | +-scan=
    |         |                 |       |         | | +-ProjectScan
    |         |                 |       |         | |   +-column_list=$union_all3.[key#19, value#20]
    |         |                 |       |         | |   +-expr_list=
    |         |                 |       |         | |   | +-key#19 := ColumnRef(type=INT64, column=$subquery1.repeated_key_2#5, is_correlated=TRUE)
    |         |                 |       |         | |   | +-value#20 := ColumnRef(type=STRING, column=$subquery1.repeated_value_2#8, is_correlated=TRUE)
    |         |                 |       |         | |   +-input_scan=
    |         |                 |       |         | |     +-SingleRowScan
    |         |                 |       |         | +-output_column_list=$union_all3.[key#19, value#20]
    |         |                 |       |         +-SetOperationItem
    |         |                 |       |           +-scan=
    |         |                 |       |           | +-ProjectScan
    |         |                 |       |           |   +-column_list=$union_all4.[key#21, value#22]
    |         |                 |       |           |   +-expr_list=
    |         |                 |       |           |   | +-key#21 := ColumnRef(type=INT64, column=$subquery1.repeated_key_3#6, is_correlated=TRUE)
    |         |                 |       |           |   | +-value#22 := ColumnRef(type=STRING, column=$subquery1.repeated_value_3#9, is_correlated=TRUE)
    |         |                 |       |           |   +-input_scan=
    |         |                 |       |           |     +-SingleRowScan
    |         |                 |       |           +-output_column_list=$union_all4.[key#21, value#22]
    |         |                 |       +-output_column_list=[$union_all.key#23, $union_all.value#24, $union_all2.is_new#25]
    |         |                 +-group_by_list=
    |         |                 | +-key#33 := ColumnRef(type=INT64, column=$union_all.key#26)
    |         |                 +-aggregate_list=
    |         |                   +-$agg1#29 :=
    |         |                   | +-AggregateFunctionCall(GoogleSQL:sum(INT64) -> INT64)
    |         |                   |   +-ColumnRef(type=INT64, column=$union_all.is_new#28)
    |         |                   +-$agg2#30 :=
    |         |                   | +-AggregateFunctionCall(GoogleSQL:sum(INT64) -> INT64)
    |         |                   |   +-ColumnRef(type=INT64, column=$union_all.is_new#28)
    |         |                   +-$agg3#31 := AggregateFunctionCall(GoogleSQL:$count_star() -> INT64)
    |         |                   +-$agg4#32 :=
    |         |                     +-AggregateFunctionCall(GoogleSQL:any_value(STRING) -> STRING)
    |         |                       +-ColumnRef(type=STRING, column=$union_all.value#27)
    |         |                       +-having_modifier=
    |         |                         +-AggregateHavingModifier
    |         |                           +-kind=MAX
    |         |                           +-having_expr=
    |         |                             +-ColumnRef(type=INT64, column=$union_all.is_new#28)
    |         +-input_scan=
    |           +-ProjectScan
    |             +-column_list=$subquery1.[input_map#2, key#3, repeated_key_1#4, repeated_key_2#5, repeated_key_3#6, repeated_value_1#7, repeated_value_2#8, repeated_value_3#9, value#10]
    |             +-expr_list=
    |             | +-input_map#2 :=
    |             | | +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<INT64, STRING>>) -> MAP<INT64, STRING>)
    |             | |   +-Literal(type=ARRAY<STRUCT<INT64, STRING>>, value=[], has_explicit_type=TRUE)
    |             | +-key#3 := Literal(type=INT64, value=1)
    |             | +-repeated_key_1#4 := Literal(type=INT64, value=2)
    |             | +-repeated_key_2#5 := Literal(type=INT64, value=3)
    |             | +-repeated_key_3#6 := Literal(type=INT64, value=4)
    |             | +-repeated_value_1#7 := Literal(type=STRING, value="b")
    |             | +-repeated_value_2#8 := Literal(type=STRING, value="c")
    |             | +-repeated_value_3#9 := Literal(type=STRING, value="d")
    |             | +-value#10 := Literal(type=STRING, value="a")
    |             +-input_scan=
    |               +-SingleRowScan
    +-input_scan=
      +-SingleRowScan
[SQLBUILDER_OUTPUT]
SELECT
  (
    SELECT
      `IF`((projectscan_11.a_2) IS NULL, CAST(NULL AS MAP< INT64, STRING >), MAP_FROM_ARRAY(ARRAY(
            SELECT
              CASE
                WHEN((aggregatescan_33.a_29) > 1) THEN CAST(ERROR(FORMAT("Key provided more than once as argument: %T",
                    aggregatescan_33.a_28)) AS STRUCT< key INT64, STRING >)
                WHEN(((aggregatescan_33.a_30) = 1) AND ((aggregatescan_33.a_31) > 1)) THEN CAST(ERROR(FORMAT("Key already exists in map: %T",
                    aggregatescan_33.a_28)) AS STRUCT< key INT64, STRING >)
                ELSE STRUCT< key INT64, STRING > (aggregatescan_33.a_28, aggregatescan_33.a_32)
              END AS a_34
            FROM
              (
                SELECT
                  setoperationscan_27.a_14 AS a_28,
                  SUM(setoperationscan_27.a_16) AS a_29,
                  SUM(setoperationscan_27.a_16) AS a_30,
                  COUNT(*) AS a_31,
                  ANY_VALUE(setoperationscan_27.a_15
                    HAVING MAX setoperationscan_27.a_16) AS a_32
                FROM
                  ((
                    SELECT
                      a_13.key AS a_14,
                      a_13.value AS a_15,
                      0 AS a_16
                    FROM
                      UNNEST(MAP_ENTRIES_UNSORTED(projectscan_11.a_2)) AS a_13
                    ) UNION ALL(
                    SELECT
                      setoperationscan_25.a_17 AS a_17,
                      setoperationscan_25.a_18 AS a_18,
                      1 AS a_26
                    FROM
                      ((
                        SELECT
                          projectscan_11.a_3 AS a_17,
                          projectscan_11.a_10 AS a_18
                        ) UNION ALL(
                        SELECT
                          projectscan_11.a_4 AS a_19,
                          projectscan_11.a_7 AS a_20
                        ) UNION ALL(
                        SELECT
                          projectscan_11.a_5 AS a_21,
                          projectscan_11.a_8 AS a_22
                        ) UNION ALL(
                        SELECT
                          projectscan_11.a_6 AS a_23,
                          projectscan_11.a_9 AS a_24
                        )
                      ) AS setoperationscan_25
                    )
                  ) AS setoperationscan_27
                GROUP BY 1
              ) AS aggregatescan_33
          ))) AS a_12
    FROM
      (
        SELECT
          MAP_FROM_ARRAY(ARRAY< STRUCT< INT64, STRING > >[]) AS a_2,
          1 AS a_3,
          2 AS a_4,
          3 AS a_5,
          4 AS a_6,
          "b" AS a_7,
          "c" AS a_8,
          "d" AS a_9,
          "a" AS a_10
      ) AS projectscan_11
  ) AS a_1;
==

# Tests MAP_INSERT_OR_REPLACE with the minumum valid number of variadic arguments.
[enabled_ast_rewrites=NONE,+VARIADIC_FUNCTION_SIGNATURE_EXPANDER{{|,+BUILTIN_FUNCTION_INLINER}}]
SELECT MAP_INSERT_OR_REPLACE(MAP_FROM_ARRAY([(1, "x")]), 1, 'a', 2, 'b')
--
ALTERNATION GROUP: <empty>
--
QueryStmt
+-output_column_list=
| +-$query.$col1#1 AS `$col1` [MAP<INT64, STRING>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#1]
    +-expr_list=
    | +-$col1#1 :=
    |   +-FunctionCall(GoogleSQL:map_insert_or_replace(MAP<INT64, STRING> input_map, INT64 key, STRING value, repeated(1) INT64 repeated_key, repeated(1) STRING repeated_value) -> MAP<INT64, STRING>)
    |     +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<INT64, STRING>>) -> MAP<INT64, STRING>)
    |     | +-Literal(type=ARRAY<STRUCT<INT64, STRING>>, value=[{1, "x"}])
    |     +-Literal(type=INT64, value=1)
    |     +-Literal(type=STRING, value="a")
    |     +-Literal(type=INT64, value=2)
    |     +-Literal(type=STRING, value="b")
    +-input_scan=
      +-SingleRowScan

[SQLBUILDER_OUTPUT]
SELECT
  MAP_INSERT_OR_REPLACE(MAP_FROM_ARRAY(ARRAY< STRUCT< INT64, STRING > >[STRUCT< INT64, STRING > (1, "x")]),
    1, "a", 2, "b") AS a_1;

[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-$query.$col1#1 AS `$col1` [MAP<INT64, STRING>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#1]
    +-expr_list=
    | +-$col1#1 :=
    |   +-FunctionCall(GoogleSQL:map_insert_or_replace(MAP<INT64, STRING> input_map, INT64 key, STRING value, INT64 repeated_key_1, STRING repeated_value_1) -> MAP<INT64, STRING>)
    |     +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<INT64, STRING>>) -> MAP<INT64, STRING>)
    |     | +-Literal(type=ARRAY<STRUCT<INT64, STRING>>, value=[{1, "x"}])
    |     +-Literal(type=INT64, value=1)
    |     +-Literal(type=STRING, value="a")
    |     +-Literal(type=INT64, value=2)
    |     +-Literal(type=STRING, value="b")
    +-input_scan=
      +-SingleRowScan
[SQLBUILDER_OUTPUT]
SELECT
  MAP_INSERT_OR_REPLACE(MAP_FROM_ARRAY(ARRAY< STRUCT< INT64, STRING > >[STRUCT< INT64, STRING > (1, "x")]),
    1, "a", 2, "b") AS a_1;
--
ALTERNATION GROUP: ,+BUILTIN_FUNCTION_INLINER
--
QueryStmt
+-output_column_list=
| +-$query.$col1#1 AS `$col1` [MAP<INT64, STRING>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#1]
    +-expr_list=
    | +-$col1#1 :=
    |   +-FunctionCall(GoogleSQL:map_insert_or_replace(MAP<INT64, STRING> input_map, INT64 key, STRING value, repeated(1) INT64 repeated_key, repeated(1) STRING repeated_value) -> MAP<INT64, STRING>)
    |     +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<INT64, STRING>>) -> MAP<INT64, STRING>)
    |     | +-Literal(type=ARRAY<STRUCT<INT64, STRING>>, value=[{1, "x"}])
    |     +-Literal(type=INT64, value=1)
    |     +-Literal(type=STRING, value="a")
    |     +-Literal(type=INT64, value=2)
    |     +-Literal(type=STRING, value="b")
    +-input_scan=
      +-SingleRowScan

[SQLBUILDER_OUTPUT]
SELECT
  MAP_INSERT_OR_REPLACE(MAP_FROM_ARRAY(ARRAY< STRUCT< INT64, STRING > >[STRUCT< INT64, STRING > (1, "x")]),
    1, "a", 2, "b") AS a_1;

[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-$query.$col1#1 AS `$col1` [MAP<INT64, STRING>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#1]
    +-expr_list=
    | +-$col1#1 :=
    |   +-SubqueryExpr
    |     +-type=MAP<INT64, STRING>
    |     +-subquery_type=SCALAR
    |     +-subquery=
    |       +-ProjectScan
    |         +-column_list=[$expr_subquery.$col1#25]
    |         +-expr_list=
    |         | +-$col1#25 :=
    |         |   +-FunctionCall(GoogleSQL:if(BOOL, MAP<INT64, STRING>, MAP<INT64, STRING>) -> MAP<INT64, STRING>)
    |         |     +-FunctionCall(GoogleSQL:$is_null(MAP<INT64, STRING>) -> BOOL)
    |         |     | +-ColumnRef(type=MAP<INT64, STRING>, column=$subquery1.input_map#2)
    |         |     +-Literal(type=MAP<INT64, STRING>, value=NULL)
    |         |     +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<key INT64, STRING>>) -> MAP<INT64, STRING>)
    |         |       +-SubqueryExpr
    |         |         +-type=ARRAY<STRUCT<key INT64, STRING>>
    |         |         +-subquery_type=ARRAY
    |         |         +-parameter_list=
    |         |         | +-ColumnRef(type=MAP<INT64, STRING>, column=$subquery1.input_map#2)
    |         |         | +-ColumnRef(type=INT64, column=$subquery1.key#3)
    |         |         | +-ColumnRef(type=INT64, column=$subquery1.repeated_key_1#4)
    |         |         | +-ColumnRef(type=STRING, column=$subquery1.repeated_value_1#5)
    |         |         | +-ColumnRef(type=STRING, column=$subquery1.value#6)
    |         |         +-subquery=
    |         |           +-ProjectScan
    |         |             +-column_list=[$expr_subquery.$col1#24]
    |         |             +-expr_list=
    |         |             | +-$col1#24 :=
    |         |             |   +-FunctionCall(GoogleSQL:$case_no_value(repeated(1) BOOL, repeated(1) STRUCT<key INT64, STRING>, STRUCT<key INT64, STRING>) -> STRUCT<key INT64, STRING>)
    |         |             |     +-FunctionCall(GoogleSQL:$greater(INT64, INT64) -> BOOL)
    |         |             |     | +-ColumnRef(type=INT64, column=$aggregate.$agg1#21)
    |         |             |     | +-Literal(type=INT64, value=1)
    |         |             |     +-Cast(STRUCT<key INT64, STRING> -> STRUCT<key INT64, STRING>)
    |         |             |     | +-FunctionCall(GoogleSQL:error(STRING) -> STRUCT<key INT64, STRING>)
    |         |             |     |   +-FunctionCall(GoogleSQL:format(STRING, repeated(1) INT64) -> STRING)
    |         |             |     |     +-Literal(type=STRING, value="Key provided more than once as argument: %T")
    |         |             |     |     +-ColumnRef(type=INT64, column=$groupby.key#23)
    |         |             |     +-MakeStruct
    |         |             |       +-type=STRUCT<key INT64, STRING>
    |         |             |       +-field_list=
    |         |             |         +-ColumnRef(type=INT64, column=$groupby.key#23)
    |         |             |         +-ColumnRef(type=STRING, column=$aggregate.$agg2#22)
    |         |             +-input_scan=
    |         |               +-AggregateScan
    |         |                 +-column_list=[$groupby.key#23, $aggregate.$agg1#21, $aggregate.$agg2#22]
    |         |                 +-input_scan=
    |         |                 | +-SetOperationScan
    |         |                 |   +-column_list=$union_all.[key#18, value#19, is_new#20]
    |         |                 |   +-op_type=UNION_ALL
    |         |                 |   +-input_item_list=
    |         |                 |     +-SetOperationItem
    |         |                 |     | +-scan=
    |         |                 |     | | +-ProjectScan
    |         |                 |     | |   +-column_list=$union_all1.[key#8, value#9, is_new#10]
    |         |                 |     | |   +-expr_list=
    |         |                 |     | |   | +-key#8 :=
    |         |                 |     | |   | | +-GetStructField
    |         |                 |     | |   | |   +-type=INT64
    |         |                 |     | |   | |   +-expr=
    |         |                 |     | |   | |   | +-ColumnRef(type=STRUCT<key INT64, value STRING>, column=$array.t#7)
    |         |                 |     | |   | |   +-field_idx=0
    |         |                 |     | |   | +-value#9 :=
    |         |                 |     | |   | | +-GetStructField
    |         |                 |     | |   | |   +-type=STRING
    |         |                 |     | |   | |   +-expr=
    |         |                 |     | |   | |   | +-ColumnRef(type=STRUCT<key INT64, value STRING>, column=$array.t#7)
    |         |                 |     | |   | |   +-field_idx=1
    |         |                 |     | |   | +-is_new#10 := Literal(type=INT64, value=0)
    |         |                 |     | |   +-input_scan=
    |         |                 |     | |     +-ArrayScan
    |         |                 |     | |       +-column_list=[$array.t#7]
    |         |                 |     | |       +-array_expr_list=
    |         |                 |     | |       | +-FunctionCall(GoogleSQL:map_entries_unsorted(MAP<INT64, STRING>) -> ARRAY<STRUCT<key INT64, value STRING>>)
    |         |                 |     | |       |   +-ColumnRef(type=MAP<INT64, STRING>, column=$subquery1.input_map#2, is_correlated=TRUE)
    |         |                 |     | |       +-element_column_list=[$array.t#7]
    |         |                 |     | +-output_column_list=$union_all1.[key#8, value#9, is_new#10]
    |         |                 |     +-SetOperationItem
    |         |                 |       +-scan=
    |         |                 |       | +-ProjectScan
    |         |                 |       |   +-column_list=[$union_all.key#15, $union_all.value#16, $union_all2.is_new#17]
    |         |                 |       |   +-expr_list=
    |         |                 |       |   | +-is_new#17 := Literal(type=INT64, value=1)
    |         |                 |       |   +-input_scan=
    |         |                 |       |     +-SetOperationScan
    |         |                 |       |       +-column_list=$union_all.[key#15, value#16]
    |         |                 |       |       +-op_type=UNION_ALL
    |         |                 |       |       +-input_item_list=
    |         |                 |       |         +-SetOperationItem
    |         |                 |       |         | +-scan=
    |         |                 |       |         | | +-ProjectScan
    |         |                 |       |         | |   +-column_list=$union_all1.[key#11, value#12]
    |         |                 |       |         | |   +-expr_list=
    |         |                 |       |         | |   | +-key#11 := ColumnRef(type=INT64, column=$subquery1.key#3, is_correlated=TRUE)
    |         |                 |       |         | |   | +-value#12 := ColumnRef(type=STRING, column=$subquery1.value#6, is_correlated=TRUE)
    |         |                 |       |         | |   +-input_scan=
    |         |                 |       |         | |     +-SingleRowScan
    |         |                 |       |         | +-output_column_list=$union_all1.[key#11, value#12]
    |         |                 |       |         +-SetOperationItem
    |         |                 |       |           +-scan=
    |         |                 |       |           | +-ProjectScan
    |         |                 |       |           |   +-column_list=$union_all2.[key#13, value#14]
    |         |                 |       |           |   +-expr_list=
    |         |                 |       |           |   | +-key#13 := ColumnRef(type=INT64, column=$subquery1.repeated_key_1#4, is_correlated=TRUE)
    |         |                 |       |           |   | +-value#14 := ColumnRef(type=STRING, column=$subquery1.repeated_value_1#5, is_correlated=TRUE)
    |         |                 |       |           |   +-input_scan=
    |         |                 |       |           |     +-SingleRowScan
    |         |                 |       |           +-output_column_list=$union_all2.[key#13, value#14]
    |         |                 |       +-output_column_list=[$union_all.key#15, $union_all.value#16, $union_all2.is_new#17]
    |         |                 +-group_by_list=
    |         |                 | +-key#23 := ColumnRef(type=INT64, column=$union_all.key#18)
    |         |                 +-aggregate_list=
    |         |                   +-$agg1#21 :=
    |         |                   | +-AggregateFunctionCall(GoogleSQL:sum(INT64) -> INT64)
    |         |                   |   +-ColumnRef(type=INT64, column=$union_all.is_new#20)
    |         |                   +-$agg2#22 :=
    |         |                     +-AggregateFunctionCall(GoogleSQL:any_value(STRING) -> STRING)
    |         |                       +-ColumnRef(type=STRING, column=$union_all.value#19)
    |         |                       +-having_modifier=
    |         |                         +-AggregateHavingModifier
    |         |                           +-kind=MAX
    |         |                           +-having_expr=
    |         |                             +-ColumnRef(type=INT64, column=$union_all.is_new#20)
    |         +-input_scan=
    |           +-ProjectScan
    |             +-column_list=$subquery1.[input_map#2, key#3, repeated_key_1#4, repeated_value_1#5, value#6]
    |             +-expr_list=
    |             | +-input_map#2 :=
    |             | | +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<INT64, STRING>>) -> MAP<INT64, STRING>)
    |             | |   +-Literal(type=ARRAY<STRUCT<INT64, STRING>>, value=[{1, "x"}])
    |             | +-key#3 := Literal(type=INT64, value=1)
    |             | +-repeated_key_1#4 := Literal(type=INT64, value=2)
    |             | +-repeated_value_1#5 := Literal(type=STRING, value="b")
    |             | +-value#6 := Literal(type=STRING, value="a")
    |             +-input_scan=
    |               +-SingleRowScan
    +-input_scan=
      +-SingleRowScan
[SQLBUILDER_OUTPUT]
SELECT
  (
    SELECT
      `IF`((projectscan_7.a_2) IS NULL, CAST(NULL AS MAP< INT64, STRING >), MAP_FROM_ARRAY(ARRAY(
            SELECT
              CASE
                WHEN((aggregatescan_23.a_21) > 1) THEN CAST(ERROR(FORMAT("Key provided more than once as argument: %T",
                    aggregatescan_23.a_20)) AS STRUCT< key INT64, STRING >)
                ELSE STRUCT< key INT64, STRING > (aggregatescan_23.a_20, aggregatescan_23.a_22)
              END AS a_24
            FROM
              (
                SELECT
                  setoperationscan_19.a_10 AS a_20,
                  SUM(setoperationscan_19.a_12) AS a_21,
                  ANY_VALUE(setoperationscan_19.a_11
                    HAVING MAX setoperationscan_19.a_12) AS a_22
                FROM
                  ((
                    SELECT
                      a_9.key AS a_10,
                      a_9.value AS a_11,
                      0 AS a_12
                    FROM
                      UNNEST(MAP_ENTRIES_UNSORTED(projectscan_7.a_2)) AS a_9
                    ) UNION ALL(
                    SELECT
                      setoperationscan_17.a_13 AS a_13,
                      setoperationscan_17.a_14 AS a_14,
                      1 AS a_18
                    FROM
                      ((
                        SELECT
                          projectscan_7.a_3 AS a_13,
                          projectscan_7.a_6 AS a_14
                        ) UNION ALL(
                        SELECT
                          projectscan_7.a_4 AS a_15,
                          projectscan_7.a_5 AS a_16
                        )
                      ) AS setoperationscan_17
                    )
                  ) AS setoperationscan_19
                GROUP BY 1
              ) AS aggregatescan_23
          ))) AS a_8
    FROM
      (
        SELECT
          MAP_FROM_ARRAY(ARRAY< STRUCT< INT64, STRING > >[STRUCT< INT64, STRING > (1, "x")]) AS a_2,
          1 AS a_3,
          2 AS a_4,
          "b" AS a_5,
          "a" AS a_6
      ) AS projectscan_7
  ) AS a_1;
==

# Tests MAP_INSERT_OR_REPLACE with more than the minumum variadic arguments.
[enabled_ast_rewrites=NONE,+VARIADIC_FUNCTION_SIGNATURE_EXPANDER{{|,+BUILTIN_FUNCTION_INLINER}}]
SELECT MAP_INSERT_OR_REPLACE(MAP_FROM_ARRAY([(1, "x"), (3, "y")]), 1, 'a', 2, 'b', 3, 'c', 4, 'd')
--
ALTERNATION GROUP: <empty>
--
QueryStmt
+-output_column_list=
| +-$query.$col1#1 AS `$col1` [MAP<INT64, STRING>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#1]
    +-expr_list=
    | +-$col1#1 :=
    |   +-FunctionCall(GoogleSQL:map_insert_or_replace(MAP<INT64, STRING> input_map, INT64 key, STRING value, repeated(3) INT64 repeated_key, repeated(3) STRING repeated_value) -> MAP<INT64, STRING>)
    |     +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<INT64, STRING>>) -> MAP<INT64, STRING>)
    |     | +-Literal(type=ARRAY<STRUCT<INT64, STRING>>, value=[{1, "x"}, {3, "y"}])
    |     +-Literal(type=INT64, value=1)
    |     +-Literal(type=STRING, value="a")
    |     +-Literal(type=INT64, value=2)
    |     +-Literal(type=STRING, value="b")
    |     +-Literal(type=INT64, value=3)
    |     +-Literal(type=STRING, value="c")
    |     +-Literal(type=INT64, value=4)
    |     +-Literal(type=STRING, value="d")
    +-input_scan=
      +-SingleRowScan

[SQLBUILDER_OUTPUT]
SELECT
  MAP_INSERT_OR_REPLACE(MAP_FROM_ARRAY(ARRAY< STRUCT< INT64, STRING > >[STRUCT< INT64, STRING > (1, "x"),
      STRUCT< INT64, STRING > (3, "y")]), 1, "a", 2, "b", 3, "c", 4, "d") AS a_1;

[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-$query.$col1#1 AS `$col1` [MAP<INT64, STRING>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#1]
    +-expr_list=
    | +-$col1#1 :=
    |   +-FunctionCall(GoogleSQL:map_insert_or_replace(MAP<INT64, STRING> input_map, INT64 key, STRING value, INT64 repeated_key_1, STRING repeated_value_1, INT64 repeated_key_2, STRING repeated_value_2, INT64 repeated_key_3, STRING repeated_value_3) -> MAP<INT64, STRING>)
    |     +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<INT64, STRING>>) -> MAP<INT64, STRING>)
    |     | +-Literal(type=ARRAY<STRUCT<INT64, STRING>>, value=[{1, "x"}, {3, "y"}])
    |     +-Literal(type=INT64, value=1)
    |     +-Literal(type=STRING, value="a")
    |     +-Literal(type=INT64, value=2)
    |     +-Literal(type=STRING, value="b")
    |     +-Literal(type=INT64, value=3)
    |     +-Literal(type=STRING, value="c")
    |     +-Literal(type=INT64, value=4)
    |     +-Literal(type=STRING, value="d")
    +-input_scan=
      +-SingleRowScan
[SQLBUILDER_OUTPUT]
SELECT
  MAP_INSERT_OR_REPLACE(MAP_FROM_ARRAY(ARRAY< STRUCT< INT64, STRING > >[STRUCT< INT64, STRING > (1, "x"),
      STRUCT< INT64, STRING > (3, "y")]), 1, "a", 2, "b", 3, "c", 4, "d") AS a_1;
--
ALTERNATION GROUP: ,+BUILTIN_FUNCTION_INLINER
--
QueryStmt
+-output_column_list=
| +-$query.$col1#1 AS `$col1` [MAP<INT64, STRING>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#1]
    +-expr_list=
    | +-$col1#1 :=
    |   +-FunctionCall(GoogleSQL:map_insert_or_replace(MAP<INT64, STRING> input_map, INT64 key, STRING value, repeated(3) INT64 repeated_key, repeated(3) STRING repeated_value) -> MAP<INT64, STRING>)
    |     +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<INT64, STRING>>) -> MAP<INT64, STRING>)
    |     | +-Literal(type=ARRAY<STRUCT<INT64, STRING>>, value=[{1, "x"}, {3, "y"}])
    |     +-Literal(type=INT64, value=1)
    |     +-Literal(type=STRING, value="a")
    |     +-Literal(type=INT64, value=2)
    |     +-Literal(type=STRING, value="b")
    |     +-Literal(type=INT64, value=3)
    |     +-Literal(type=STRING, value="c")
    |     +-Literal(type=INT64, value=4)
    |     +-Literal(type=STRING, value="d")
    +-input_scan=
      +-SingleRowScan

[SQLBUILDER_OUTPUT]
SELECT
  MAP_INSERT_OR_REPLACE(MAP_FROM_ARRAY(ARRAY< STRUCT< INT64, STRING > >[STRUCT< INT64, STRING > (1, "x"),
      STRUCT< INT64, STRING > (3, "y")]), 1, "a", 2, "b", 3, "c", 4, "d") AS a_1;

[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-$query.$col1#1 AS `$col1` [MAP<INT64, STRING>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#1]
    +-expr_list=
    | +-$col1#1 :=
    |   +-SubqueryExpr
    |     +-type=MAP<INT64, STRING>
    |     +-subquery_type=SCALAR
    |     +-subquery=
    |       +-ProjectScan
    |         +-column_list=[$expr_subquery.$col1#33]
    |         +-expr_list=
    |         | +-$col1#33 :=
    |         |   +-FunctionCall(GoogleSQL:if(BOOL, MAP<INT64, STRING>, MAP<INT64, STRING>) -> MAP<INT64, STRING>)
    |         |     +-FunctionCall(GoogleSQL:$is_null(MAP<INT64, STRING>) -> BOOL)
    |         |     | +-ColumnRef(type=MAP<INT64, STRING>, column=$subquery1.input_map#2)
    |         |     +-Literal(type=MAP<INT64, STRING>, value=NULL)
    |         |     +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<key INT64, STRING>>) -> MAP<INT64, STRING>)
    |         |       +-SubqueryExpr
    |         |         +-type=ARRAY<STRUCT<key INT64, STRING>>
    |         |         +-subquery_type=ARRAY
    |         |         +-parameter_list=
    |         |         | +-ColumnRef(type=MAP<INT64, STRING>, column=$subquery1.input_map#2)
    |         |         | +-ColumnRef(type=INT64, column=$subquery1.key#3)
    |         |         | +-ColumnRef(type=INT64, column=$subquery1.repeated_key_1#4)
    |         |         | +-ColumnRef(type=INT64, column=$subquery1.repeated_key_2#5)
    |         |         | +-ColumnRef(type=INT64, column=$subquery1.repeated_key_3#6)
    |         |         | +-ColumnRef(type=STRING, column=$subquery1.repeated_value_1#7)
    |         |         | +-ColumnRef(type=STRING, column=$subquery1.repeated_value_2#8)
    |         |         | +-ColumnRef(type=STRING, column=$subquery1.repeated_value_3#9)
    |         |         | +-ColumnRef(type=STRING, column=$subquery1.value#10)
    |         |         +-subquery=
    |         |           +-ProjectScan
    |         |             +-column_list=[$expr_subquery.$col1#32]
    |         |             +-expr_list=
    |         |             | +-$col1#32 :=
    |         |             |   +-FunctionCall(GoogleSQL:$case_no_value(repeated(1) BOOL, repeated(1) STRUCT<key INT64, STRING>, STRUCT<key INT64, STRING>) -> STRUCT<key INT64, STRING>)
    |         |             |     +-FunctionCall(GoogleSQL:$greater(INT64, INT64) -> BOOL)
    |         |             |     | +-ColumnRef(type=INT64, column=$aggregate.$agg1#29)
    |         |             |     | +-Literal(type=INT64, value=1)
    |         |             |     +-Cast(STRUCT<key INT64, STRING> -> STRUCT<key INT64, STRING>)
    |         |             |     | +-FunctionCall(GoogleSQL:error(STRING) -> STRUCT<key INT64, STRING>)
    |         |             |     |   +-FunctionCall(GoogleSQL:format(STRING, repeated(1) INT64) -> STRING)
    |         |             |     |     +-Literal(type=STRING, value="Key provided more than once as argument: %T")
    |         |             |     |     +-ColumnRef(type=INT64, column=$groupby.key#31)
    |         |             |     +-MakeStruct
    |         |             |       +-type=STRUCT<key INT64, STRING>
    |         |             |       +-field_list=
    |         |             |         +-ColumnRef(type=INT64, column=$groupby.key#31)
    |         |             |         +-ColumnRef(type=STRING, column=$aggregate.$agg2#30)
    |         |             +-input_scan=
    |         |               +-AggregateScan
    |         |                 +-column_list=[$groupby.key#31, $aggregate.$agg1#29, $aggregate.$agg2#30]
    |         |                 +-input_scan=
    |         |                 | +-SetOperationScan
    |         |                 |   +-column_list=$union_all.[key#26, value#27, is_new#28]
    |         |                 |   +-op_type=UNION_ALL
    |         |                 |   +-input_item_list=
    |         |                 |     +-SetOperationItem
    |         |                 |     | +-scan=
    |         |                 |     | | +-ProjectScan
    |         |                 |     | |   +-column_list=$union_all1.[key#12, value#13, is_new#14]
    |         |                 |     | |   +-expr_list=
    |         |                 |     | |   | +-key#12 :=
    |         |                 |     | |   | | +-GetStructField
    |         |                 |     | |   | |   +-type=INT64
    |         |                 |     | |   | |   +-expr=
    |         |                 |     | |   | |   | +-ColumnRef(type=STRUCT<key INT64, value STRING>, column=$array.t#11)
    |         |                 |     | |   | |   +-field_idx=0
    |         |                 |     | |   | +-value#13 :=
    |         |                 |     | |   | | +-GetStructField
    |         |                 |     | |   | |   +-type=STRING
    |         |                 |     | |   | |   +-expr=
    |         |                 |     | |   | |   | +-ColumnRef(type=STRUCT<key INT64, value STRING>, column=$array.t#11)
    |         |                 |     | |   | |   +-field_idx=1
    |         |                 |     | |   | +-is_new#14 := Literal(type=INT64, value=0)
    |         |                 |     | |   +-input_scan=
    |         |                 |     | |     +-ArrayScan
    |         |                 |     | |       +-column_list=[$array.t#11]
    |         |                 |     | |       +-array_expr_list=
    |         |                 |     | |       | +-FunctionCall(GoogleSQL:map_entries_unsorted(MAP<INT64, STRING>) -> ARRAY<STRUCT<key INT64, value STRING>>)
    |         |                 |     | |       |   +-ColumnRef(type=MAP<INT64, STRING>, column=$subquery1.input_map#2, is_correlated=TRUE)
    |         |                 |     | |       +-element_column_list=[$array.t#11]
    |         |                 |     | +-output_column_list=$union_all1.[key#12, value#13, is_new#14]
    |         |                 |     +-SetOperationItem
    |         |                 |       +-scan=
    |         |                 |       | +-ProjectScan
    |         |                 |       |   +-column_list=[$union_all.key#23, $union_all.value#24, $union_all2.is_new#25]
    |         |                 |       |   +-expr_list=
    |         |                 |       |   | +-is_new#25 := Literal(type=INT64, value=1)
    |         |                 |       |   +-input_scan=
    |         |                 |       |     +-SetOperationScan
    |         |                 |       |       +-column_list=$union_all.[key#23, value#24]
    |         |                 |       |       +-op_type=UNION_ALL
    |         |                 |       |       +-input_item_list=
    |         |                 |       |         +-SetOperationItem
    |         |                 |       |         | +-scan=
    |         |                 |       |         | | +-ProjectScan
    |         |                 |       |         | |   +-column_list=$union_all1.[key#15, value#16]
    |         |                 |       |         | |   +-expr_list=
    |         |                 |       |         | |   | +-key#15 := ColumnRef(type=INT64, column=$subquery1.key#3, is_correlated=TRUE)
    |         |                 |       |         | |   | +-value#16 := ColumnRef(type=STRING, column=$subquery1.value#10, is_correlated=TRUE)
    |         |                 |       |         | |   +-input_scan=
    |         |                 |       |         | |     +-SingleRowScan
    |         |                 |       |         | +-output_column_list=$union_all1.[key#15, value#16]
    |         |                 |       |         +-SetOperationItem
    |         |                 |       |         | +-scan=
    |         |                 |       |         | | +-ProjectScan
    |         |                 |       |         | |   +-column_list=$union_all2.[key#17, value#18]
    |         |                 |       |         | |   +-expr_list=
    |         |                 |       |         | |   | +-key#17 := ColumnRef(type=INT64, column=$subquery1.repeated_key_1#4, is_correlated=TRUE)
    |         |                 |       |         | |   | +-value#18 := ColumnRef(type=STRING, column=$subquery1.repeated_value_1#7, is_correlated=TRUE)
    |         |                 |       |         | |   +-input_scan=
    |         |                 |       |         | |     +-SingleRowScan
    |         |                 |       |         | +-output_column_list=$union_all2.[key#17, value#18]
    |         |                 |       |         +-SetOperationItem
    |         |                 |       |         | +-scan=
    |         |                 |       |         | | +-ProjectScan
    |         |                 |       |         | |   +-column_list=$union_all3.[key#19, value#20]
    |         |                 |       |         | |   +-expr_list=
    |         |                 |       |         | |   | +-key#19 := ColumnRef(type=INT64, column=$subquery1.repeated_key_2#5, is_correlated=TRUE)
    |         |                 |       |         | |   | +-value#20 := ColumnRef(type=STRING, column=$subquery1.repeated_value_2#8, is_correlated=TRUE)
    |         |                 |       |         | |   +-input_scan=
    |         |                 |       |         | |     +-SingleRowScan
    |         |                 |       |         | +-output_column_list=$union_all3.[key#19, value#20]
    |         |                 |       |         +-SetOperationItem
    |         |                 |       |           +-scan=
    |         |                 |       |           | +-ProjectScan
    |         |                 |       |           |   +-column_list=$union_all4.[key#21, value#22]
    |         |                 |       |           |   +-expr_list=
    |         |                 |       |           |   | +-key#21 := ColumnRef(type=INT64, column=$subquery1.repeated_key_3#6, is_correlated=TRUE)
    |         |                 |       |           |   | +-value#22 := ColumnRef(type=STRING, column=$subquery1.repeated_value_3#9, is_correlated=TRUE)
    |         |                 |       |           |   +-input_scan=
    |         |                 |       |           |     +-SingleRowScan
    |         |                 |       |           +-output_column_list=$union_all4.[key#21, value#22]
    |         |                 |       +-output_column_list=[$union_all.key#23, $union_all.value#24, $union_all2.is_new#25]
    |         |                 +-group_by_list=
    |         |                 | +-key#31 := ColumnRef(type=INT64, column=$union_all.key#26)
    |         |                 +-aggregate_list=
    |         |                   +-$agg1#29 :=
    |         |                   | +-AggregateFunctionCall(GoogleSQL:sum(INT64) -> INT64)
    |         |                   |   +-ColumnRef(type=INT64, column=$union_all.is_new#28)
    |         |                   +-$agg2#30 :=
    |         |                     +-AggregateFunctionCall(GoogleSQL:any_value(STRING) -> STRING)
    |         |                       +-ColumnRef(type=STRING, column=$union_all.value#27)
    |         |                       +-having_modifier=
    |         |                         +-AggregateHavingModifier
    |         |                           +-kind=MAX
    |         |                           +-having_expr=
    |         |                             +-ColumnRef(type=INT64, column=$union_all.is_new#28)
    |         +-input_scan=
    |           +-ProjectScan
    |             +-column_list=$subquery1.[input_map#2, key#3, repeated_key_1#4, repeated_key_2#5, repeated_key_3#6, repeated_value_1#7, repeated_value_2#8, repeated_value_3#9, value#10]
    |             +-expr_list=
    |             | +-input_map#2 :=
    |             | | +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<INT64, STRING>>) -> MAP<INT64, STRING>)
    |             | |   +-Literal(type=ARRAY<STRUCT<INT64, STRING>>, value=[{1, "x"}, {3, "y"}])
    |             | +-key#3 := Literal(type=INT64, value=1)
    |             | +-repeated_key_1#4 := Literal(type=INT64, value=2)
    |             | +-repeated_key_2#5 := Literal(type=INT64, value=3)
    |             | +-repeated_key_3#6 := Literal(type=INT64, value=4)
    |             | +-repeated_value_1#7 := Literal(type=STRING, value="b")
    |             | +-repeated_value_2#8 := Literal(type=STRING, value="c")
    |             | +-repeated_value_3#9 := Literal(type=STRING, value="d")
    |             | +-value#10 := Literal(type=STRING, value="a")
    |             +-input_scan=
    |               +-SingleRowScan
    +-input_scan=
      +-SingleRowScan
[SQLBUILDER_OUTPUT]
SELECT
  (
    SELECT
      `IF`((projectscan_11.a_2) IS NULL, CAST(NULL AS MAP< INT64, STRING >), MAP_FROM_ARRAY(ARRAY(
            SELECT
              CASE
                WHEN((aggregatescan_31.a_29) > 1) THEN CAST(ERROR(FORMAT("Key provided more than once as argument: %T",
                    aggregatescan_31.a_28)) AS STRUCT< key INT64, STRING >)
                ELSE STRUCT< key INT64, STRING > (aggregatescan_31.a_28, aggregatescan_31.a_30)
              END AS a_32
            FROM
              (
                SELECT
                  setoperationscan_27.a_14 AS a_28,
                  SUM(setoperationscan_27.a_16) AS a_29,
                  ANY_VALUE(setoperationscan_27.a_15
                    HAVING MAX setoperationscan_27.a_16) AS a_30
                FROM
                  ((
                    SELECT
                      a_13.key AS a_14,
                      a_13.value AS a_15,
                      0 AS a_16
                    FROM
                      UNNEST(MAP_ENTRIES_UNSORTED(projectscan_11.a_2)) AS a_13
                    ) UNION ALL(
                    SELECT
                      setoperationscan_25.a_17 AS a_17,
                      setoperationscan_25.a_18 AS a_18,
                      1 AS a_26
                    FROM
                      ((
                        SELECT
                          projectscan_11.a_3 AS a_17,
                          projectscan_11.a_10 AS a_18
                        ) UNION ALL(
                        SELECT
                          projectscan_11.a_4 AS a_19,
                          projectscan_11.a_7 AS a_20
                        ) UNION ALL(
                        SELECT
                          projectscan_11.a_5 AS a_21,
                          projectscan_11.a_8 AS a_22
                        ) UNION ALL(
                        SELECT
                          projectscan_11.a_6 AS a_23,
                          projectscan_11.a_9 AS a_24
                        )
                      ) AS setoperationscan_25
                    )
                  ) AS setoperationscan_27
                GROUP BY 1
              ) AS aggregatescan_31
          ))) AS a_12
    FROM
      (
        SELECT
          MAP_FROM_ARRAY(ARRAY< STRUCT< INT64, STRING > >[STRUCT< INT64, STRING > (1, "x"), STRUCT< INT64, STRING >
            (3, "y")]) AS a_2,
          1 AS a_3,
          2 AS a_4,
          3 AS a_5,
          4 AS a_6,
          "b" AS a_7,
          "c" AS a_8,
          "d" AS a_9,
          "a" AS a_10
      ) AS projectscan_11
  ) AS a_1;
==

# Tests MAP_REPLACE with the minumum valid number of variadic key-value args.
[enabled_ast_rewrites=NONE,+VARIADIC_FUNCTION_SIGNATURE_EXPANDER{{|,+BUILTIN_FUNCTION_INLINER}}]
SELECT MAP_REPLACE(MAP_FROM_ARRAY([(1, "x"), (3, "y")]), 1, 'a', 3, 'b')
--
ALTERNATION GROUP: <empty>
--
QueryStmt
+-output_column_list=
| +-$query.$col1#1 AS `$col1` [MAP<INT64, STRING>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#1]
    +-expr_list=
    | +-$col1#1 :=
    |   +-FunctionCall(GoogleSQL:map_replace(MAP<INT64, STRING> input_map, INT64 key, STRING value, repeated(1) INT64 repeated_key, repeated(1) STRING repeated_value) -> MAP<INT64, STRING>)
    |     +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<INT64, STRING>>) -> MAP<INT64, STRING>)
    |     | +-Literal(type=ARRAY<STRUCT<INT64, STRING>>, value=[{1, "x"}, {3, "y"}])
    |     +-Literal(type=INT64, value=1)
    |     +-Literal(type=STRING, value="a")
    |     +-Literal(type=INT64, value=3)
    |     +-Literal(type=STRING, value="b")
    +-input_scan=
      +-SingleRowScan

[SQLBUILDER_OUTPUT]
SELECT
  MAP_REPLACE(MAP_FROM_ARRAY(ARRAY< STRUCT< INT64, STRING > >[STRUCT< INT64, STRING > (1, "x"), STRUCT<
      INT64, STRING > (3, "y")]), 1, "a", 3, "b") AS a_1;

[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-$query.$col1#1 AS `$col1` [MAP<INT64, STRING>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#1]
    +-expr_list=
    | +-$col1#1 :=
    |   +-FunctionCall(GoogleSQL:map_replace(MAP<INT64, STRING> input_map, INT64 key, STRING value, INT64 repeated_key_1, STRING repeated_value_1) -> MAP<INT64, STRING>)
    |     +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<INT64, STRING>>) -> MAP<INT64, STRING>)
    |     | +-Literal(type=ARRAY<STRUCT<INT64, STRING>>, value=[{1, "x"}, {3, "y"}])
    |     +-Literal(type=INT64, value=1)
    |     +-Literal(type=STRING, value="a")
    |     +-Literal(type=INT64, value=3)
    |     +-Literal(type=STRING, value="b")
    +-input_scan=
      +-SingleRowScan
[SQLBUILDER_OUTPUT]
SELECT
  MAP_REPLACE(MAP_FROM_ARRAY(ARRAY< STRUCT< INT64, STRING > >[STRUCT< INT64, STRING > (1, "x"), STRUCT<
      INT64, STRING > (3, "y")]), 1, "a", 3, "b") AS a_1;
--
ALTERNATION GROUP: ,+BUILTIN_FUNCTION_INLINER
--
QueryStmt
+-output_column_list=
| +-$query.$col1#1 AS `$col1` [MAP<INT64, STRING>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#1]
    +-expr_list=
    | +-$col1#1 :=
    |   +-FunctionCall(GoogleSQL:map_replace(MAP<INT64, STRING> input_map, INT64 key, STRING value, repeated(1) INT64 repeated_key, repeated(1) STRING repeated_value) -> MAP<INT64, STRING>)
    |     +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<INT64, STRING>>) -> MAP<INT64, STRING>)
    |     | +-Literal(type=ARRAY<STRUCT<INT64, STRING>>, value=[{1, "x"}, {3, "y"}])
    |     +-Literal(type=INT64, value=1)
    |     +-Literal(type=STRING, value="a")
    |     +-Literal(type=INT64, value=3)
    |     +-Literal(type=STRING, value="b")
    +-input_scan=
      +-SingleRowScan

[SQLBUILDER_OUTPUT]
SELECT
  MAP_REPLACE(MAP_FROM_ARRAY(ARRAY< STRUCT< INT64, STRING > >[STRUCT< INT64, STRING > (1, "x"), STRUCT<
      INT64, STRING > (3, "y")]), 1, "a", 3, "b") AS a_1;

[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-$query.$col1#1 AS `$col1` [MAP<INT64, STRING>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#1]
    +-expr_list=
    | +-$col1#1 :=
    |   +-SubqueryExpr
    |     +-type=MAP<INT64, STRING>
    |     +-subquery_type=SCALAR
    |     +-subquery=
    |       +-ProjectScan
    |         +-column_list=[$expr_subquery.$col1#26]
    |         +-expr_list=
    |         | +-$col1#26 :=
    |         |   +-FunctionCall(GoogleSQL:if(BOOL, MAP<INT64, STRING>, MAP<INT64, STRING>) -> MAP<INT64, STRING>)
    |         |     +-FunctionCall(GoogleSQL:$is_null(MAP<INT64, STRING>) -> BOOL)
    |         |     | +-ColumnRef(type=MAP<INT64, STRING>, column=$subquery1.input_map#2)
    |         |     +-Literal(type=MAP<INT64, STRING>, value=NULL)
    |         |     +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<key INT64, STRING>>) -> MAP<INT64, STRING>)
    |         |       +-SubqueryExpr
    |         |         +-type=ARRAY<STRUCT<key INT64, STRING>>
    |         |         +-subquery_type=ARRAY
    |         |         +-parameter_list=
    |         |         | +-ColumnRef(type=MAP<INT64, STRING>, column=$subquery1.input_map#2)
    |         |         | +-ColumnRef(type=INT64, column=$subquery1.key#3)
    |         |         | +-ColumnRef(type=INT64, column=$subquery1.repeated_key_1#4)
    |         |         | +-ColumnRef(type=STRING, column=$subquery1.repeated_value_1#5)
    |         |         | +-ColumnRef(type=STRING, column=$subquery1.value#6)
    |         |         +-subquery=
    |         |           +-ProjectScan
    |         |             +-column_list=[$expr_subquery.$col1#25]
    |         |             +-expr_list=
    |         |             | +-$col1#25 :=
    |         |             |   +-FunctionCall(GoogleSQL:$case_no_value(repeated(2) BOOL, repeated(2) STRUCT<key INT64, STRING>, STRUCT<key INT64, STRING>) -> STRUCT<key INT64, STRING>)
    |         |             |     +-FunctionCall(GoogleSQL:$greater(INT64, INT64) -> BOOL)
    |         |             |     | +-ColumnRef(type=INT64, column=$aggregate.$agg1#21)
    |         |             |     | +-Literal(type=INT64, value=1)
    |         |             |     +-Cast(STRUCT<key INT64, STRING> -> STRUCT<key INT64, STRING>)
    |         |             |     | +-FunctionCall(GoogleSQL:error(STRING) -> STRUCT<key INT64, STRING>)
    |         |             |     |   +-FunctionCall(GoogleSQL:format(STRING, repeated(1) INT64) -> STRING)
    |         |             |     |     +-Literal(type=STRING, value="Key provided more than once as argument: %T")
    |         |             |     |     +-ColumnRef(type=INT64, column=$groupby.key#24)
    |         |             |     +-FunctionCall(GoogleSQL:$equal(INT64, INT64) -> BOOL)
    |         |             |     | +-ColumnRef(type=INT64, column=$aggregate.$agg2#22)
    |         |             |     | +-Literal(type=INT64, value=1)
    |         |             |     +-Cast(STRUCT<key INT64, STRING> -> STRUCT<key INT64, STRING>)
    |         |             |     | +-FunctionCall(GoogleSQL:error(STRING) -> STRUCT<key INT64, STRING>)
    |         |             |     |   +-FunctionCall(GoogleSQL:format(STRING, repeated(1) INT64) -> STRING)
    |         |             |     |     +-Literal(type=STRING, value="Key does not exist in map: %T")
    |         |             |     |     +-ColumnRef(type=INT64, column=$groupby.key#24)
    |         |             |     +-MakeStruct
    |         |             |       +-type=STRUCT<key INT64, STRING>
    |         |             |       +-field_list=
    |         |             |         +-ColumnRef(type=INT64, column=$groupby.key#24)
    |         |             |         +-ColumnRef(type=STRING, column=$aggregate.$agg3#23)
    |         |             +-input_scan=
    |         |               +-AggregateScan
    |         |                 +-column_list=[$groupby.key#24, $aggregate.$agg1#21, $aggregate.$agg2#22, $aggregate.$agg3#23]
    |         |                 +-input_scan=
    |         |                 | +-SetOperationScan
    |         |                 |   +-column_list=$union_all.[key#18, value#19, is_new#20]
    |         |                 |   +-op_type=UNION_ALL
    |         |                 |   +-input_item_list=
    |         |                 |     +-SetOperationItem
    |         |                 |     | +-scan=
    |         |                 |     | | +-ProjectScan
    |         |                 |     | |   +-column_list=$union_all1.[key#8, value#9, is_new#10]
    |         |                 |     | |   +-expr_list=
    |         |                 |     | |   | +-key#8 :=
    |         |                 |     | |   | | +-GetStructField
    |         |                 |     | |   | |   +-type=INT64
    |         |                 |     | |   | |   +-expr=
    |         |                 |     | |   | |   | +-ColumnRef(type=STRUCT<key INT64, value STRING>, column=$array.t#7)
    |         |                 |     | |   | |   +-field_idx=0
    |         |                 |     | |   | +-value#9 :=
    |         |                 |     | |   | | +-GetStructField
    |         |                 |     | |   | |   +-type=STRING
    |         |                 |     | |   | |   +-expr=
    |         |                 |     | |   | |   | +-ColumnRef(type=STRUCT<key INT64, value STRING>, column=$array.t#7)
    |         |                 |     | |   | |   +-field_idx=1
    |         |                 |     | |   | +-is_new#10 := Literal(type=INT64, value=0)
    |         |                 |     | |   +-input_scan=
    |         |                 |     | |     +-ArrayScan
    |         |                 |     | |       +-column_list=[$array.t#7]
    |         |                 |     | |       +-array_expr_list=
    |         |                 |     | |       | +-FunctionCall(GoogleSQL:map_entries_unsorted(MAP<INT64, STRING>) -> ARRAY<STRUCT<key INT64, value STRING>>)
    |         |                 |     | |       |   +-ColumnRef(type=MAP<INT64, STRING>, column=$subquery1.input_map#2, is_correlated=TRUE)
    |         |                 |     | |       +-element_column_list=[$array.t#7]
    |         |                 |     | +-output_column_list=$union_all1.[key#8, value#9, is_new#10]
    |         |                 |     +-SetOperationItem
    |         |                 |       +-scan=
    |         |                 |       | +-ProjectScan
    |         |                 |       |   +-column_list=[$union_all.key#15, $union_all.value#16, $union_all2.is_new#17]
    |         |                 |       |   +-expr_list=
    |         |                 |       |   | +-is_new#17 := Literal(type=INT64, value=1)
    |         |                 |       |   +-input_scan=
    |         |                 |       |     +-SetOperationScan
    |         |                 |       |       +-column_list=$union_all.[key#15, value#16]
    |         |                 |       |       +-op_type=UNION_ALL
    |         |                 |       |       +-input_item_list=
    |         |                 |       |         +-SetOperationItem
    |         |                 |       |         | +-scan=
    |         |                 |       |         | | +-ProjectScan
    |         |                 |       |         | |   +-column_list=$union_all1.[key#11, value#12]
    |         |                 |       |         | |   +-expr_list=
    |         |                 |       |         | |   | +-key#11 := ColumnRef(type=INT64, column=$subquery1.key#3, is_correlated=TRUE)
    |         |                 |       |         | |   | +-value#12 := ColumnRef(type=STRING, column=$subquery1.value#6, is_correlated=TRUE)
    |         |                 |       |         | |   +-input_scan=
    |         |                 |       |         | |     +-SingleRowScan
    |         |                 |       |         | +-output_column_list=$union_all1.[key#11, value#12]
    |         |                 |       |         +-SetOperationItem
    |         |                 |       |           +-scan=
    |         |                 |       |           | +-ProjectScan
    |         |                 |       |           |   +-column_list=$union_all2.[key#13, value#14]
    |         |                 |       |           |   +-expr_list=
    |         |                 |       |           |   | +-key#13 := ColumnRef(type=INT64, column=$subquery1.repeated_key_1#4, is_correlated=TRUE)
    |         |                 |       |           |   | +-value#14 := ColumnRef(type=STRING, column=$subquery1.repeated_value_1#5, is_correlated=TRUE)
    |         |                 |       |           |   +-input_scan=
    |         |                 |       |           |     +-SingleRowScan
    |         |                 |       |           +-output_column_list=$union_all2.[key#13, value#14]
    |         |                 |       +-output_column_list=[$union_all.key#15, $union_all.value#16, $union_all2.is_new#17]
    |         |                 +-group_by_list=
    |         |                 | +-key#24 := ColumnRef(type=INT64, column=$union_all.key#18)
    |         |                 +-aggregate_list=
    |         |                   +-$agg1#21 :=
    |         |                   | +-AggregateFunctionCall(GoogleSQL:sum(INT64) -> INT64)
    |         |                   |   +-ColumnRef(type=INT64, column=$union_all.is_new#20)
    |         |                   +-$agg2#22 :=
    |         |                   | +-AggregateFunctionCall(GoogleSQL:min(INT64) -> INT64)
    |         |                   |   +-ColumnRef(type=INT64, column=$union_all.is_new#20)
    |         |                   +-$agg3#23 :=
    |         |                     +-AggregateFunctionCall(GoogleSQL:any_value(STRING) -> STRING)
    |         |                       +-ColumnRef(type=STRING, column=$union_all.value#19)
    |         |                       +-having_modifier=
    |         |                         +-AggregateHavingModifier
    |         |                           +-kind=MAX
    |         |                           +-having_expr=
    |         |                             +-ColumnRef(type=INT64, column=$union_all.is_new#20)
    |         +-input_scan=
    |           +-ProjectScan
    |             +-column_list=$subquery1.[input_map#2, key#3, repeated_key_1#4, repeated_value_1#5, value#6]
    |             +-expr_list=
    |             | +-input_map#2 :=
    |             | | +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<INT64, STRING>>) -> MAP<INT64, STRING>)
    |             | |   +-Literal(type=ARRAY<STRUCT<INT64, STRING>>, value=[{1, "x"}, {3, "y"}])
    |             | +-key#3 := Literal(type=INT64, value=1)
    |             | +-repeated_key_1#4 := Literal(type=INT64, value=3)
    |             | +-repeated_value_1#5 := Literal(type=STRING, value="b")
    |             | +-value#6 := Literal(type=STRING, value="a")
    |             +-input_scan=
    |               +-SingleRowScan
    +-input_scan=
      +-SingleRowScan
[SQLBUILDER_OUTPUT]
SELECT
  (
    SELECT
      `IF`((projectscan_7.a_2) IS NULL, CAST(NULL AS MAP< INT64, STRING >), MAP_FROM_ARRAY(ARRAY(
            SELECT
              CASE
                WHEN((aggregatescan_24.a_21) > 1) THEN CAST(ERROR(FORMAT("Key provided more than once as argument: %T",
                    aggregatescan_24.a_20)) AS STRUCT< key INT64, STRING >)
                WHEN((aggregatescan_24.a_22) = 1) THEN CAST(ERROR(FORMAT("Key does not exist in map: %T", aggregatescan_24.a_20)) AS STRUCT<
                key INT64, STRING >)
                ELSE STRUCT< key INT64, STRING > (aggregatescan_24.a_20, aggregatescan_24.a_23)
              END AS a_25
            FROM
              (
                SELECT
                  setoperationscan_19.a_10 AS a_20,
                  SUM(setoperationscan_19.a_12) AS a_21,
                  MIN(setoperationscan_19.a_12) AS a_22,
                  ANY_VALUE(setoperationscan_19.a_11
                    HAVING MAX setoperationscan_19.a_12) AS a_23
                FROM
                  ((
                    SELECT
                      a_9.key AS a_10,
                      a_9.value AS a_11,
                      0 AS a_12
                    FROM
                      UNNEST(MAP_ENTRIES_UNSORTED(projectscan_7.a_2)) AS a_9
                    ) UNION ALL(
                    SELECT
                      setoperationscan_17.a_13 AS a_13,
                      setoperationscan_17.a_14 AS a_14,
                      1 AS a_18
                    FROM
                      ((
                        SELECT
                          projectscan_7.a_3 AS a_13,
                          projectscan_7.a_6 AS a_14
                        ) UNION ALL(
                        SELECT
                          projectscan_7.a_4 AS a_15,
                          projectscan_7.a_5 AS a_16
                        )
                      ) AS setoperationscan_17
                    )
                  ) AS setoperationscan_19
                GROUP BY 1
              ) AS aggregatescan_24
          ))) AS a_8
    FROM
      (
        SELECT
          MAP_FROM_ARRAY(ARRAY< STRUCT< INT64, STRING > >[STRUCT< INT64, STRING > (1, "x"), STRUCT< INT64, STRING >
            (3, "y")]) AS a_2,
          1 AS a_3,
          3 AS a_4,
          "b" AS a_5,
          "a" AS a_6
      ) AS projectscan_7
  ) AS a_1;
==

# Tests MAP_REPLACE with more than the minumum variadic key-value args.
[enabled_ast_rewrites=NONE,+VARIADIC_FUNCTION_SIGNATURE_EXPANDER{{|,+BUILTIN_FUNCTION_INLINER}}]
SELECT MAP_REPLACE(MAP_FROM_ARRAY([(1, "x"), (2, "y"), (3, "z"), (4, "w"), (5, "v")]), 1, 'a', 3, 'c', 5, 'e')
--
ALTERNATION GROUP: <empty>
--
QueryStmt
+-output_column_list=
| +-$query.$col1#1 AS `$col1` [MAP<INT64, STRING>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#1]
    +-expr_list=
    | +-$col1#1 :=
    |   +-FunctionCall(GoogleSQL:map_replace(MAP<INT64, STRING> input_map, INT64 key, STRING value, repeated(2) INT64 repeated_key, repeated(2) STRING repeated_value) -> MAP<INT64, STRING>)
    |     +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<INT64, STRING>>) -> MAP<INT64, STRING>)
    |     | +-Literal(type=ARRAY<STRUCT<INT64, STRING>>, value=[{1, "x"}, {2, "y"}, {3, "z"}, {4, "w"}, {5, "v"}])
    |     +-Literal(type=INT64, value=1)
    |     +-Literal(type=STRING, value="a")
    |     +-Literal(type=INT64, value=3)
    |     +-Literal(type=STRING, value="c")
    |     +-Literal(type=INT64, value=5)
    |     +-Literal(type=STRING, value="e")
    +-input_scan=
      +-SingleRowScan

[SQLBUILDER_OUTPUT]
SELECT
  MAP_REPLACE(MAP_FROM_ARRAY(ARRAY< STRUCT< INT64, STRING > >[STRUCT< INT64, STRING > (1, "x"), STRUCT<
      INT64, STRING > (2, "y"), STRUCT< INT64, STRING > (3, "z"), STRUCT< INT64, STRING > (4, "w"), STRUCT<
      INT64, STRING > (5, "v")]), 1, "a", 3, "c", 5, "e") AS a_1;

[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-$query.$col1#1 AS `$col1` [MAP<INT64, STRING>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#1]
    +-expr_list=
    | +-$col1#1 :=
    |   +-FunctionCall(GoogleSQL:map_replace(MAP<INT64, STRING> input_map, INT64 key, STRING value, INT64 repeated_key_1, STRING repeated_value_1, INT64 repeated_key_2, STRING repeated_value_2) -> MAP<INT64, STRING>)
    |     +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<INT64, STRING>>) -> MAP<INT64, STRING>)
    |     | +-Literal(type=ARRAY<STRUCT<INT64, STRING>>, value=[{1, "x"}, {2, "y"}, {3, "z"}, {4, "w"}, {5, "v"}])
    |     +-Literal(type=INT64, value=1)
    |     +-Literal(type=STRING, value="a")
    |     +-Literal(type=INT64, value=3)
    |     +-Literal(type=STRING, value="c")
    |     +-Literal(type=INT64, value=5)
    |     +-Literal(type=STRING, value="e")
    +-input_scan=
      +-SingleRowScan
[SQLBUILDER_OUTPUT]
SELECT
  MAP_REPLACE(MAP_FROM_ARRAY(ARRAY< STRUCT< INT64, STRING > >[STRUCT< INT64, STRING > (1, "x"), STRUCT<
      INT64, STRING > (2, "y"), STRUCT< INT64, STRING > (3, "z"), STRUCT< INT64, STRING > (4, "w"), STRUCT<
      INT64, STRING > (5, "v")]), 1, "a", 3, "c", 5, "e") AS a_1;
--
ALTERNATION GROUP: ,+BUILTIN_FUNCTION_INLINER
--
QueryStmt
+-output_column_list=
| +-$query.$col1#1 AS `$col1` [MAP<INT64, STRING>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#1]
    +-expr_list=
    | +-$col1#1 :=
    |   +-FunctionCall(GoogleSQL:map_replace(MAP<INT64, STRING> input_map, INT64 key, STRING value, repeated(2) INT64 repeated_key, repeated(2) STRING repeated_value) -> MAP<INT64, STRING>)
    |     +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<INT64, STRING>>) -> MAP<INT64, STRING>)
    |     | +-Literal(type=ARRAY<STRUCT<INT64, STRING>>, value=[{1, "x"}, {2, "y"}, {3, "z"}, {4, "w"}, {5, "v"}])
    |     +-Literal(type=INT64, value=1)
    |     +-Literal(type=STRING, value="a")
    |     +-Literal(type=INT64, value=3)
    |     +-Literal(type=STRING, value="c")
    |     +-Literal(type=INT64, value=5)
    |     +-Literal(type=STRING, value="e")
    +-input_scan=
      +-SingleRowScan

[SQLBUILDER_OUTPUT]
SELECT
  MAP_REPLACE(MAP_FROM_ARRAY(ARRAY< STRUCT< INT64, STRING > >[STRUCT< INT64, STRING > (1, "x"), STRUCT<
      INT64, STRING > (2, "y"), STRUCT< INT64, STRING > (3, "z"), STRUCT< INT64, STRING > (4, "w"), STRUCT<
      INT64, STRING > (5, "v")]), 1, "a", 3, "c", 5, "e") AS a_1;

[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-$query.$col1#1 AS `$col1` [MAP<INT64, STRING>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#1]
    +-expr_list=
    | +-$col1#1 :=
    |   +-SubqueryExpr
    |     +-type=MAP<INT64, STRING>
    |     +-subquery_type=SCALAR
    |     +-subquery=
    |       +-ProjectScan
    |         +-column_list=[$expr_subquery.$col1#30]
    |         +-expr_list=
    |         | +-$col1#30 :=
    |         |   +-FunctionCall(GoogleSQL:if(BOOL, MAP<INT64, STRING>, MAP<INT64, STRING>) -> MAP<INT64, STRING>)
    |         |     +-FunctionCall(GoogleSQL:$is_null(MAP<INT64, STRING>) -> BOOL)
    |         |     | +-ColumnRef(type=MAP<INT64, STRING>, column=$subquery1.input_map#2)
    |         |     +-Literal(type=MAP<INT64, STRING>, value=NULL)
    |         |     +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<key INT64, STRING>>) -> MAP<INT64, STRING>)
    |         |       +-SubqueryExpr
    |         |         +-type=ARRAY<STRUCT<key INT64, STRING>>
    |         |         +-subquery_type=ARRAY
    |         |         +-parameter_list=
    |         |         | +-ColumnRef(type=MAP<INT64, STRING>, column=$subquery1.input_map#2)
    |         |         | +-ColumnRef(type=INT64, column=$subquery1.key#3)
    |         |         | +-ColumnRef(type=INT64, column=$subquery1.repeated_key_1#4)
    |         |         | +-ColumnRef(type=INT64, column=$subquery1.repeated_key_2#5)
    |         |         | +-ColumnRef(type=STRING, column=$subquery1.repeated_value_1#6)
    |         |         | +-ColumnRef(type=STRING, column=$subquery1.repeated_value_2#7)
    |         |         | +-ColumnRef(type=STRING, column=$subquery1.value#8)
    |         |         +-subquery=
    |         |           +-ProjectScan
    |         |             +-column_list=[$expr_subquery.$col1#29]
    |         |             +-expr_list=
    |         |             | +-$col1#29 :=
    |         |             |   +-FunctionCall(GoogleSQL:$case_no_value(repeated(2) BOOL, repeated(2) STRUCT<key INT64, STRING>, STRUCT<key INT64, STRING>) -> STRUCT<key INT64, STRING>)
    |         |             |     +-FunctionCall(GoogleSQL:$greater(INT64, INT64) -> BOOL)
    |         |             |     | +-ColumnRef(type=INT64, column=$aggregate.$agg1#25)
    |         |             |     | +-Literal(type=INT64, value=1)
    |         |             |     +-Cast(STRUCT<key INT64, STRING> -> STRUCT<key INT64, STRING>)
    |         |             |     | +-FunctionCall(GoogleSQL:error(STRING) -> STRUCT<key INT64, STRING>)
    |         |             |     |   +-FunctionCall(GoogleSQL:format(STRING, repeated(1) INT64) -> STRING)
    |         |             |     |     +-Literal(type=STRING, value="Key provided more than once as argument: %T")
    |         |             |     |     +-ColumnRef(type=INT64, column=$groupby.key#28)
    |         |             |     +-FunctionCall(GoogleSQL:$equal(INT64, INT64) -> BOOL)
    |         |             |     | +-ColumnRef(type=INT64, column=$aggregate.$agg2#26)
    |         |             |     | +-Literal(type=INT64, value=1)
    |         |             |     +-Cast(STRUCT<key INT64, STRING> -> STRUCT<key INT64, STRING>)
    |         |             |     | +-FunctionCall(GoogleSQL:error(STRING) -> STRUCT<key INT64, STRING>)
    |         |             |     |   +-FunctionCall(GoogleSQL:format(STRING, repeated(1) INT64) -> STRING)
    |         |             |     |     +-Literal(type=STRING, value="Key does not exist in map: %T")
    |         |             |     |     +-ColumnRef(type=INT64, column=$groupby.key#28)
    |         |             |     +-MakeStruct
    |         |             |       +-type=STRUCT<key INT64, STRING>
    |         |             |       +-field_list=
    |         |             |         +-ColumnRef(type=INT64, column=$groupby.key#28)
    |         |             |         +-ColumnRef(type=STRING, column=$aggregate.$agg3#27)
    |         |             +-input_scan=
    |         |               +-AggregateScan
    |         |                 +-column_list=[$groupby.key#28, $aggregate.$agg1#25, $aggregate.$agg2#26, $aggregate.$agg3#27]
    |         |                 +-input_scan=
    |         |                 | +-SetOperationScan
    |         |                 |   +-column_list=$union_all.[key#22, value#23, is_new#24]
    |         |                 |   +-op_type=UNION_ALL
    |         |                 |   +-input_item_list=
    |         |                 |     +-SetOperationItem
    |         |                 |     | +-scan=
    |         |                 |     | | +-ProjectScan
    |         |                 |     | |   +-column_list=$union_all1.[key#10, value#11, is_new#12]
    |         |                 |     | |   +-expr_list=
    |         |                 |     | |   | +-key#10 :=
    |         |                 |     | |   | | +-GetStructField
    |         |                 |     | |   | |   +-type=INT64
    |         |                 |     | |   | |   +-expr=
    |         |                 |     | |   | |   | +-ColumnRef(type=STRUCT<key INT64, value STRING>, column=$array.t#9)
    |         |                 |     | |   | |   +-field_idx=0
    |         |                 |     | |   | +-value#11 :=
    |         |                 |     | |   | | +-GetStructField
    |         |                 |     | |   | |   +-type=STRING
    |         |                 |     | |   | |   +-expr=
    |         |                 |     | |   | |   | +-ColumnRef(type=STRUCT<key INT64, value STRING>, column=$array.t#9)
    |         |                 |     | |   | |   +-field_idx=1
    |         |                 |     | |   | +-is_new#12 := Literal(type=INT64, value=0)
    |         |                 |     | |   +-input_scan=
    |         |                 |     | |     +-ArrayScan
    |         |                 |     | |       +-column_list=[$array.t#9]
    |         |                 |     | |       +-array_expr_list=
    |         |                 |     | |       | +-FunctionCall(GoogleSQL:map_entries_unsorted(MAP<INT64, STRING>) -> ARRAY<STRUCT<key INT64, value STRING>>)
    |         |                 |     | |       |   +-ColumnRef(type=MAP<INT64, STRING>, column=$subquery1.input_map#2, is_correlated=TRUE)
    |         |                 |     | |       +-element_column_list=[$array.t#9]
    |         |                 |     | +-output_column_list=$union_all1.[key#10, value#11, is_new#12]
    |         |                 |     +-SetOperationItem
    |         |                 |       +-scan=
    |         |                 |       | +-ProjectScan
    |         |                 |       |   +-column_list=[$union_all.key#19, $union_all.value#20, $union_all2.is_new#21]
    |         |                 |       |   +-expr_list=
    |         |                 |       |   | +-is_new#21 := Literal(type=INT64, value=1)
    |         |                 |       |   +-input_scan=
    |         |                 |       |     +-SetOperationScan
    |         |                 |       |       +-column_list=$union_all.[key#19, value#20]
    |         |                 |       |       +-op_type=UNION_ALL
    |         |                 |       |       +-input_item_list=
    |         |                 |       |         +-SetOperationItem
    |         |                 |       |         | +-scan=
    |         |                 |       |         | | +-ProjectScan
    |         |                 |       |         | |   +-column_list=$union_all1.[key#13, value#14]
    |         |                 |       |         | |   +-expr_list=
    |         |                 |       |         | |   | +-key#13 := ColumnRef(type=INT64, column=$subquery1.key#3, is_correlated=TRUE)
    |         |                 |       |         | |   | +-value#14 := ColumnRef(type=STRING, column=$subquery1.value#8, is_correlated=TRUE)
    |         |                 |       |         | |   +-input_scan=
    |         |                 |       |         | |     +-SingleRowScan
    |         |                 |       |         | +-output_column_list=$union_all1.[key#13, value#14]
    |         |                 |       |         +-SetOperationItem
    |         |                 |       |         | +-scan=
    |         |                 |       |         | | +-ProjectScan
    |         |                 |       |         | |   +-column_list=$union_all2.[key#15, value#16]
    |         |                 |       |         | |   +-expr_list=
    |         |                 |       |         | |   | +-key#15 := ColumnRef(type=INT64, column=$subquery1.repeated_key_1#4, is_correlated=TRUE)
    |         |                 |       |         | |   | +-value#16 := ColumnRef(type=STRING, column=$subquery1.repeated_value_1#6, is_correlated=TRUE)
    |         |                 |       |         | |   +-input_scan=
    |         |                 |       |         | |     +-SingleRowScan
    |         |                 |       |         | +-output_column_list=$union_all2.[key#15, value#16]
    |         |                 |       |         +-SetOperationItem
    |         |                 |       |           +-scan=
    |         |                 |       |           | +-ProjectScan
    |         |                 |       |           |   +-column_list=$union_all3.[key#17, value#18]
    |         |                 |       |           |   +-expr_list=
    |         |                 |       |           |   | +-key#17 := ColumnRef(type=INT64, column=$subquery1.repeated_key_2#5, is_correlated=TRUE)
    |         |                 |       |           |   | +-value#18 := ColumnRef(type=STRING, column=$subquery1.repeated_value_2#7, is_correlated=TRUE)
    |         |                 |       |           |   +-input_scan=
    |         |                 |       |           |     +-SingleRowScan
    |         |                 |       |           +-output_column_list=$union_all3.[key#17, value#18]
    |         |                 |       +-output_column_list=[$union_all.key#19, $union_all.value#20, $union_all2.is_new#21]
    |         |                 +-group_by_list=
    |         |                 | +-key#28 := ColumnRef(type=INT64, column=$union_all.key#22)
    |         |                 +-aggregate_list=
    |         |                   +-$agg1#25 :=
    |         |                   | +-AggregateFunctionCall(GoogleSQL:sum(INT64) -> INT64)
    |         |                   |   +-ColumnRef(type=INT64, column=$union_all.is_new#24)
    |         |                   +-$agg2#26 :=
    |         |                   | +-AggregateFunctionCall(GoogleSQL:min(INT64) -> INT64)
    |         |                   |   +-ColumnRef(type=INT64, column=$union_all.is_new#24)
    |         |                   +-$agg3#27 :=
    |         |                     +-AggregateFunctionCall(GoogleSQL:any_value(STRING) -> STRING)
    |         |                       +-ColumnRef(type=STRING, column=$union_all.value#23)
    |         |                       +-having_modifier=
    |         |                         +-AggregateHavingModifier
    |         |                           +-kind=MAX
    |         |                           +-having_expr=
    |         |                             +-ColumnRef(type=INT64, column=$union_all.is_new#24)
    |         +-input_scan=
    |           +-ProjectScan
    |             +-column_list=$subquery1.[input_map#2, key#3, repeated_key_1#4, repeated_key_2#5, repeated_value_1#6, repeated_value_2#7, value#8]
    |             +-expr_list=
    |             | +-input_map#2 :=
    |             | | +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<INT64, STRING>>) -> MAP<INT64, STRING>)
    |             | |   +-Literal(type=ARRAY<STRUCT<INT64, STRING>>, value=[{1, "x"}, {2, "y"}, {3, "z"}, {4, "w"}, {5, "v"}])
    |             | +-key#3 := Literal(type=INT64, value=1)
    |             | +-repeated_key_1#4 := Literal(type=INT64, value=3)
    |             | +-repeated_key_2#5 := Literal(type=INT64, value=5)
    |             | +-repeated_value_1#6 := Literal(type=STRING, value="c")
    |             | +-repeated_value_2#7 := Literal(type=STRING, value="e")
    |             | +-value#8 := Literal(type=STRING, value="a")
    |             +-input_scan=
    |               +-SingleRowScan
    +-input_scan=
      +-SingleRowScan
[SQLBUILDER_OUTPUT]
SELECT
  (
    SELECT
      `IF`((projectscan_9.a_2) IS NULL, CAST(NULL AS MAP< INT64, STRING >), MAP_FROM_ARRAY(ARRAY(
            SELECT
              CASE
                WHEN((aggregatescan_28.a_25) > 1) THEN CAST(ERROR(FORMAT("Key provided more than once as argument: %T",
                    aggregatescan_28.a_24)) AS STRUCT< key INT64, STRING >)
                WHEN((aggregatescan_28.a_26) = 1) THEN CAST(ERROR(FORMAT("Key does not exist in map: %T", aggregatescan_28.a_24)) AS STRUCT<
                key INT64, STRING >)
                ELSE STRUCT< key INT64, STRING > (aggregatescan_28.a_24, aggregatescan_28.a_27)
              END AS a_29
            FROM
              (
                SELECT
                  setoperationscan_23.a_12 AS a_24,
                  SUM(setoperationscan_23.a_14) AS a_25,
                  MIN(setoperationscan_23.a_14) AS a_26,
                  ANY_VALUE(setoperationscan_23.a_13
                    HAVING MAX setoperationscan_23.a_14) AS a_27
                FROM
                  ((
                    SELECT
                      a_11.key AS a_12,
                      a_11.value AS a_13,
                      0 AS a_14
                    FROM
                      UNNEST(MAP_ENTRIES_UNSORTED(projectscan_9.a_2)) AS a_11
                    ) UNION ALL(
                    SELECT
                      setoperationscan_21.a_15 AS a_15,
                      setoperationscan_21.a_16 AS a_16,
                      1 AS a_22
                    FROM
                      ((
                        SELECT
                          projectscan_9.a_3 AS a_15,
                          projectscan_9.a_8 AS a_16
                        ) UNION ALL(
                        SELECT
                          projectscan_9.a_4 AS a_17,
                          projectscan_9.a_6 AS a_18
                        ) UNION ALL(
                        SELECT
                          projectscan_9.a_5 AS a_19,
                          projectscan_9.a_7 AS a_20
                        )
                      ) AS setoperationscan_21
                    )
                  ) AS setoperationscan_23
                GROUP BY 1
              ) AS aggregatescan_28
          ))) AS a_10
    FROM
      (
        SELECT
          MAP_FROM_ARRAY(ARRAY< STRUCT< INT64, STRING > >[STRUCT< INT64, STRING > (1, "x"), STRUCT< INT64, STRING >
            (2, "y"), STRUCT< INT64, STRING > (3, "z"), STRUCT< INT64, STRING > (4, "w"), STRUCT< INT64, STRING >
            (5, "v")]) AS a_2,
          1 AS a_3,
          3 AS a_4,
          5 AS a_5,
          "c" AS a_6,
          "e" AS a_7,
          "a" AS a_8
      ) AS projectscan_9
  ) AS a_1;
==

# Tests MAP_REPLACE (with lambda) with the minumum number of variadic key args.
[enabled_ast_rewrites=NONE,+VARIADIC_FUNCTION_SIGNATURE_EXPANDER{{|,+BUILTIN_FUNCTION_INLINER}}]
SELECT MAP_REPLACE(MAP_FROM_ARRAY([(1, "x"), (2, "y"), (3, "z")]), 1, 3, v -> UPPER(v))
--
ALTERNATION GROUP: <empty>
--
QueryStmt
+-output_column_list=
| +-$query.$col1#2 AS `$col1` [MAP<INT64, STRING>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#2]
    +-expr_list=
    | +-$col1#2 :=
    |   +-FunctionCall(GoogleSQL:map_replace(MAP<INT64, STRING> input_map, INT64 key, repeated(1) INT64 repeated_key, FUNCTION<STRING->STRING> updater_lambda) -> MAP<INT64, STRING>)
    |     +-FunctionArgument
    |     | +-expr=
    |     |   +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<INT64, STRING>>) -> MAP<INT64, STRING>)
    |     |     +-Literal(type=ARRAY<STRUCT<INT64, STRING>>, value=[{1, "x"}, {2, "y"}, {3, "z"}])
    |     +-FunctionArgument
    |     | +-expr=
    |     |   +-Literal(type=INT64, value=1)
    |     +-FunctionArgument
    |     | +-expr=
    |     |   +-Literal(type=INT64, value=3)
    |     +-FunctionArgument
    |       +-inline_lambda=
    |         +-InlineLambda
    |           +-argument_list=[$lambda_arg.v#1]
    |           +-body=
    |             +-FunctionCall(GoogleSQL:upper(STRING) -> STRING)
    |               +-ColumnRef(type=STRING, column=$lambda_arg.v#1)
    +-input_scan=
      +-SingleRowScan

[SQLBUILDER_OUTPUT]
SELECT
  MAP_REPLACE(MAP_FROM_ARRAY(ARRAY< STRUCT< INT64, STRING > >[STRUCT< INT64, STRING > (1, "x"), STRUCT<
      INT64, STRING > (2, "y"), STRUCT< INT64, STRING > (3, "z")]), 1, 3, (a_2) -> UPPER(a_2)) AS a_1;

[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-$query.$col1#2 AS `$col1` [MAP<INT64, STRING>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#2]
    +-expr_list=
    | +-$col1#2 :=
    |   +-FunctionCall(GoogleSQL:map_replace(MAP<INT64, STRING> input_map, INT64 key, INT64 repeated_key_1, FUNCTION<STRING->STRING> updater_lambda) -> MAP<INT64, STRING>)
    |     +-FunctionArgument
    |     | +-expr=
    |     |   +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<INT64, STRING>>) -> MAP<INT64, STRING>)
    |     |     +-Literal(type=ARRAY<STRUCT<INT64, STRING>>, value=[{1, "x"}, {2, "y"}, {3, "z"}])
    |     +-FunctionArgument
    |     | +-expr=
    |     |   +-Literal(type=INT64, value=1)
    |     +-FunctionArgument
    |     | +-expr=
    |     |   +-Literal(type=INT64, value=3)
    |     +-FunctionArgument
    |       +-inline_lambda=
    |         +-InlineLambda
    |           +-argument_list=[$lambda_arg.v#1]
    |           +-body=
    |             +-FunctionCall(GoogleSQL:upper(STRING) -> STRING)
    |               +-ColumnRef(type=STRING, column=$lambda_arg.v#1)
    +-input_scan=
      +-SingleRowScan
[SQLBUILDER_OUTPUT]
SELECT
  MAP_REPLACE(MAP_FROM_ARRAY(ARRAY< STRUCT< INT64, STRING > >[STRUCT< INT64, STRING > (1, "x"), STRUCT<
      INT64, STRING > (2, "y"), STRUCT< INT64, STRING > (3, "z")]), 1, 3, (a_2) -> UPPER(a_2)) AS a_1;
--
ALTERNATION GROUP: ,+BUILTIN_FUNCTION_INLINER
--
QueryStmt
+-output_column_list=
| +-$query.$col1#2 AS `$col1` [MAP<INT64, STRING>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#2]
    +-expr_list=
    | +-$col1#2 :=
    |   +-FunctionCall(GoogleSQL:map_replace(MAP<INT64, STRING> input_map, INT64 key, repeated(1) INT64 repeated_key, FUNCTION<STRING->STRING> updater_lambda) -> MAP<INT64, STRING>)
    |     +-FunctionArgument
    |     | +-expr=
    |     |   +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<INT64, STRING>>) -> MAP<INT64, STRING>)
    |     |     +-Literal(type=ARRAY<STRUCT<INT64, STRING>>, value=[{1, "x"}, {2, "y"}, {3, "z"}])
    |     +-FunctionArgument
    |     | +-expr=
    |     |   +-Literal(type=INT64, value=1)
    |     +-FunctionArgument
    |     | +-expr=
    |     |   +-Literal(type=INT64, value=3)
    |     +-FunctionArgument
    |       +-inline_lambda=
    |         +-InlineLambda
    |           +-argument_list=[$lambda_arg.v#1]
    |           +-body=
    |             +-FunctionCall(GoogleSQL:upper(STRING) -> STRING)
    |               +-ColumnRef(type=STRING, column=$lambda_arg.v#1)
    +-input_scan=
      +-SingleRowScan

[SQLBUILDER_OUTPUT]
SELECT
  MAP_REPLACE(MAP_FROM_ARRAY(ARRAY< STRUCT< INT64, STRING > >[STRUCT< INT64, STRING > (1, "x"), STRUCT<
      INT64, STRING > (2, "y"), STRUCT< INT64, STRING > (3, "z")]), 1, 3, (a_2) -> UPPER(a_2)) AS a_1;

[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-$query.$col1#2 AS `$col1` [MAP<INT64, STRING>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#2]
    +-expr_list=
    | +-$col1#2 :=
    |   +-SubqueryExpr
    |     +-type=MAP<INT64, STRING>
    |     +-subquery_type=SCALAR
    |     +-subquery=
    |       +-ProjectScan
    |         +-column_list=[$expr_subquery.$col1#26]
    |         +-expr_list=
    |         | +-$col1#26 :=
    |         |   +-FunctionCall(GoogleSQL:if(BOOL, MAP<INT64, STRING>, MAP<INT64, STRING>) -> MAP<INT64, STRING>)
    |         |     +-FunctionCall(GoogleSQL:$is_null(MAP<INT64, STRING>) -> BOOL)
    |         |     | +-ColumnRef(type=MAP<INT64, STRING>, column=$subquery1.input_map#3)
    |         |     +-Literal(type=MAP<INT64, STRING>, value=NULL)
    |         |     +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<key INT64, STRING>>) -> MAP<INT64, STRING>)
    |         |       +-SubqueryExpr
    |         |         +-type=ARRAY<STRUCT<key INT64, STRING>>
    |         |         +-subquery_type=ARRAY
    |         |         +-parameter_list=
    |         |         | +-ColumnRef(type=MAP<INT64, STRING>, column=$subquery1.input_map#3)
    |         |         | +-ColumnRef(type=INT64, column=$subquery1.key#4)
    |         |         | +-ColumnRef(type=INT64, column=$subquery1.repeated_key_1#5)
    |         |         +-subquery=
    |         |           +-ProjectScan
    |         |             +-column_list=[$expr_subquery.$col1#25]
    |         |             +-expr_list=
    |         |             | +-$col1#25 :=
    |         |             |   +-FunctionCall(GoogleSQL:$case_no_value(repeated(2) BOOL, repeated(2) STRUCT<key INT64, STRING>, STRUCT<key INT64, STRING>) -> STRUCT<key INT64, STRING>)
    |         |             |     +-FunctionCall(GoogleSQL:$greater(INT64, INT64) -> BOOL)
    |         |             |     | +-ColumnRef(type=INT64, column=$aggregate.$agg1#19)
    |         |             |     | +-Literal(type=INT64, value=1)
    |         |             |     +-Cast(STRUCT<key INT64, STRING> -> STRUCT<key INT64, STRING>)
    |         |             |     | +-FunctionCall(GoogleSQL:error(STRING) -> STRUCT<key INT64, STRING>)
    |         |             |     |   +-FunctionCall(GoogleSQL:format(STRING, repeated(1) INT64) -> STRING)
    |         |             |     |     +-Literal(type=STRING, value="Key provided more than once as argument: %T")
    |         |             |     |     +-ColumnRef(type=INT64, column=$groupby.key#24)
    |         |             |     +-FunctionCall(GoogleSQL:$equal(INT64, INT64) -> BOOL)
    |         |             |     | +-ColumnRef(type=INT64, column=$aggregate.$agg2#20)
    |         |             |     | +-Literal(type=INT64, value=1)
    |         |             |     +-Cast(STRUCT<key INT64, STRING> -> STRUCT<key INT64, STRING>)
    |         |             |     | +-FunctionCall(GoogleSQL:error(STRING) -> STRUCT<key INT64, STRING>)
    |         |             |     |   +-FunctionCall(GoogleSQL:format(STRING, repeated(1) INT64) -> STRING)
    |         |             |     |     +-Literal(type=STRING, value="Key does not exist in map: %T")
    |         |             |     |     +-ColumnRef(type=INT64, column=$groupby.key#24)
    |         |             |     +-MakeStruct
    |         |             |       +-type=STRUCT<key INT64, STRING>
    |         |             |       +-field_list=
    |         |             |         +-ColumnRef(type=INT64, column=$groupby.key#24)
    |         |             |         +-FunctionCall(GoogleSQL:if(BOOL, STRING, STRING) -> STRING)
    |         |             |           +-FunctionCall(GoogleSQL:$equal(INT64, INT64) -> BOOL)
    |         |             |           | +-ColumnRef(type=INT64, column=$aggregate.$agg3#21)
    |         |             |           | +-Literal(type=INT64, value=1)
    |         |             |           +-FunctionCall(GoogleSQL:upper(STRING) -> STRING)
    |         |             |           | +-ColumnRef(type=STRING, column=$aggregate.$agg4#22)
    |         |             |           +-ColumnRef(type=STRING, column=$aggregate.$agg5#23)
    |         |             +-input_scan=
    |         |               +-AggregateScan
    |         |                 +-column_list=[$groupby.key#24, $aggregate.$agg1#19, $aggregate.$agg2#20, $aggregate.$agg3#21, $aggregate.$agg4#22, $aggregate.$agg5#23]
    |         |                 +-input_scan=
    |         |                 | +-SetOperationScan
    |         |                 |   +-column_list=$union_all.[key#15, value#16, is_new#17]
    |         |                 |   +-op_type=UNION_ALL
    |         |                 |   +-input_item_list=
    |         |                 |     +-SetOperationItem
    |         |                 |     | +-scan=
    |         |                 |     | | +-ProjectScan
    |         |                 |     | |   +-column_list=$union_all1.[key#7, value#8, is_new#9]
    |         |                 |     | |   +-expr_list=
    |         |                 |     | |   | +-key#7 :=
    |         |                 |     | |   | | +-GetStructField
    |         |                 |     | |   | |   +-type=INT64
    |         |                 |     | |   | |   +-expr=
    |         |                 |     | |   | |   | +-ColumnRef(type=STRUCT<key INT64, value STRING>, column=$array.t#6)
    |         |                 |     | |   | |   +-field_idx=0
    |         |                 |     | |   | +-value#8 :=
    |         |                 |     | |   | | +-GetStructField
    |         |                 |     | |   | |   +-type=STRING
    |         |                 |     | |   | |   +-expr=
    |         |                 |     | |   | |   | +-ColumnRef(type=STRUCT<key INT64, value STRING>, column=$array.t#6)
    |         |                 |     | |   | |   +-field_idx=1
    |         |                 |     | |   | +-is_new#9 := Literal(type=INT64, value=0)
    |         |                 |     | |   +-input_scan=
    |         |                 |     | |     +-ArrayScan
    |         |                 |     | |       +-column_list=[$array.t#6]
    |         |                 |     | |       +-array_expr_list=
    |         |                 |     | |       | +-FunctionCall(GoogleSQL:map_entries_unsorted(MAP<INT64, STRING>) -> ARRAY<STRUCT<key INT64, value STRING>>)
    |         |                 |     | |       |   +-ColumnRef(type=MAP<INT64, STRING>, column=$subquery1.input_map#3, is_correlated=TRUE)
    |         |                 |     | |       +-element_column_list=[$array.t#6]
    |         |                 |     | +-output_column_list=$union_all1.[key#7, value#8, is_new#9]
    |         |                 |     +-SetOperationItem
    |         |                 |       +-scan=
    |         |                 |       | +-ProjectScan
    |         |                 |       |   +-column_list=[$union_all.key#12, $union_all2_cast.value#18, $union_all2.is_new#14]
    |         |                 |       |   +-expr_list=
    |         |                 |       |   | +-value#18 := Literal(type=STRING, value=NULL)
    |         |                 |       |   +-input_scan=
    |         |                 |       |     +-ProjectScan
    |         |                 |       |       +-column_list=[$union_all.key#12, $union_all2.value#13, $union_all2.is_new#14]
    |         |                 |       |       +-expr_list=
    |         |                 |       |       | +-value#13 := Literal(type=INT64, value=NULL)
    |         |                 |       |       | +-is_new#14 := Literal(type=INT64, value=1)
    |         |                 |       |       +-input_scan=
    |         |                 |       |         +-SetOperationScan
    |         |                 |       |           +-column_list=[$union_all.key#12]
    |         |                 |       |           +-op_type=UNION_ALL
    |         |                 |       |           +-input_item_list=
    |         |                 |       |             +-SetOperationItem
    |         |                 |       |             | +-scan=
    |         |                 |       |             | | +-ProjectScan
    |         |                 |       |             | |   +-column_list=[$union_all1.key#10]
    |         |                 |       |             | |   +-expr_list=
    |         |                 |       |             | |   | +-key#10 := ColumnRef(type=INT64, column=$subquery1.key#4, is_correlated=TRUE)
    |         |                 |       |             | |   +-input_scan=
    |         |                 |       |             | |     +-SingleRowScan
    |         |                 |       |             | +-output_column_list=[$union_all1.key#10]
    |         |                 |       |             +-SetOperationItem
    |         |                 |       |               +-scan=
    |         |                 |       |               | +-ProjectScan
    |         |                 |       |               |   +-column_list=[$union_all2.key#11]
    |         |                 |       |               |   +-expr_list=
    |         |                 |       |               |   | +-key#11 := ColumnRef(type=INT64, column=$subquery1.repeated_key_1#5, is_correlated=TRUE)
    |         |                 |       |               |   +-input_scan=
    |         |                 |       |               |     +-SingleRowScan
    |         |                 |       |               +-output_column_list=[$union_all2.key#11]
    |         |                 |       +-output_column_list=[$union_all.key#12, $union_all2_cast.value#18, $union_all2.is_new#14]
    |         |                 +-group_by_list=
    |         |                 | +-key#24 := ColumnRef(type=INT64, column=$union_all.key#15)
    |         |                 +-aggregate_list=
    |         |                   +-$agg1#19 :=
    |         |                   | +-AggregateFunctionCall(GoogleSQL:sum(INT64) -> INT64)
    |         |                   |   +-ColumnRef(type=INT64, column=$union_all.is_new#17)
    |         |                   +-$agg2#20 :=
    |         |                   | +-AggregateFunctionCall(GoogleSQL:min(INT64) -> INT64)
    |         |                   |   +-ColumnRef(type=INT64, column=$union_all.is_new#17)
    |         |                   +-$agg3#21 :=
    |         |                   | +-AggregateFunctionCall(GoogleSQL:max(INT64) -> INT64)
    |         |                   |   +-ColumnRef(type=INT64, column=$union_all.is_new#17)
    |         |                   +-$agg4#22 :=
    |         |                   | +-AggregateFunctionCall(GoogleSQL:any_value(STRING) -> STRING)
    |         |                   |   +-ColumnRef(type=STRING, column=$union_all.value#16)
    |         |                   |   +-having_modifier=
    |         |                   |     +-AggregateHavingModifier
    |         |                   |       +-kind=MIN
    |         |                   |       +-having_expr=
    |         |                   |         +-ColumnRef(type=INT64, column=$union_all.is_new#17)
    |         |                   +-$agg5#23 :=
    |         |                     +-AggregateFunctionCall(GoogleSQL:any_value(STRING) -> STRING)
    |         |                       +-ColumnRef(type=STRING, column=$union_all.value#16)
    |         +-input_scan=
    |           +-ProjectScan
    |             +-column_list=$subquery1.[input_map#3, key#4, repeated_key_1#5]
    |             +-expr_list=
    |             | +-input_map#3 :=
    |             | | +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<INT64, STRING>>) -> MAP<INT64, STRING>)
    |             | |   +-Literal(type=ARRAY<STRUCT<INT64, STRING>>, value=[{1, "x"}, {2, "y"}, {3, "z"}])
    |             | +-key#4 := Literal(type=INT64, value=1)
    |             | +-repeated_key_1#5 := Literal(type=INT64, value=3)
    |             +-input_scan=
    |               +-SingleRowScan
    +-input_scan=
      +-SingleRowScan
[SQLBUILDER_OUTPUT]
SELECT
  (
    SELECT
      `IF`((projectscan_5.a_2) IS NULL, CAST(NULL AS MAP< INT64, STRING >), MAP_FROM_ARRAY(ARRAY(
            SELECT
              CASE
                WHEN((aggregatescan_25.a_20) > 1) THEN CAST(ERROR(FORMAT("Key provided more than once as argument: %T",
                    aggregatescan_25.a_19)) AS STRUCT< key INT64, STRING >)
                WHEN((aggregatescan_25.a_21) = 1) THEN CAST(ERROR(FORMAT("Key does not exist in map: %T", aggregatescan_25.a_19)) AS STRUCT<
                key INT64, STRING >)
                ELSE STRUCT< key INT64, STRING > (aggregatescan_25.a_19, `IF`((aggregatescan_25.a_22) = 1, UPPER(aggregatescan_25.a_23),
                    aggregatescan_25.a_24))
              END AS a_26
            FROM
              (
                SELECT
                  setoperationscan_18.a_8 AS a_19,
                  SUM(setoperationscan_18.a_10) AS a_20,
                  MIN(setoperationscan_18.a_10) AS a_21,
                  MAX(setoperationscan_18.a_10) AS a_22,
                  ANY_VALUE(setoperationscan_18.a_9
                    HAVING MIN setoperationscan_18.a_10) AS a_23,
                  ANY_VALUE(setoperationscan_18.a_9) AS a_24
                FROM
                  ((
                    SELECT
                      a_7.key AS a_8,
                      a_7.value AS a_9,
                      0 AS a_10
                    FROM
                      UNNEST(MAP_ENTRIES_UNSORTED(projectscan_5.a_2)) AS a_7
                    ) UNION ALL(
                    SELECT
                      projectscan_16.a_11 AS a_11,
                      CAST(NULL AS STRING) AS a_17,
                      projectscan_16.a_15 AS a_15
                    FROM
                      (
                        SELECT
                          setoperationscan_13.a_11 AS a_11,
                          CAST(NULL AS INT64) AS a_14,
                          1 AS a_15
                        FROM
                          ((
                            SELECT
                              projectscan_5.a_3 AS a_11
                            ) UNION ALL(
                            SELECT
                              projectscan_5.a_4 AS a_12
                            )
                          ) AS setoperationscan_13
                      ) AS projectscan_16
                    )
                  ) AS setoperationscan_18
                GROUP BY 1
              ) AS aggregatescan_25
          ))) AS a_6
    FROM
      (
        SELECT
          MAP_FROM_ARRAY(ARRAY< STRUCT< INT64, STRING > >[STRUCT< INT64, STRING > (1, "x"), STRUCT< INT64, STRING >
            (2, "y"), STRUCT< INT64, STRING > (3, "z")]) AS a_2,
          1 AS a_3,
          3 AS a_4
      ) AS projectscan_5
  ) AS a_1;
==

# Tests MAP_REPLACE (with lambda) with more than the minumum number of variadic key args.
[enabled_ast_rewrites=NONE,+VARIADIC_FUNCTION_SIGNATURE_EXPANDER{{|,+BUILTIN_FUNCTION_INLINER}}]
SELECT MAP_REPLACE(MAP_FROM_ARRAY([(1, "x"), (2, "y"), (3, "z"), (4, "w"), (5, "v")]), 1, 3, 5, v -> UPPER(v))
--
ALTERNATION GROUP: <empty>
--
QueryStmt
+-output_column_list=
| +-$query.$col1#2 AS `$col1` [MAP<INT64, STRING>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#2]
    +-expr_list=
    | +-$col1#2 :=
    |   +-FunctionCall(GoogleSQL:map_replace(MAP<INT64, STRING> input_map, INT64 key, repeated(2) INT64 repeated_key, FUNCTION<STRING->STRING> updater_lambda) -> MAP<INT64, STRING>)
    |     +-FunctionArgument
    |     | +-expr=
    |     |   +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<INT64, STRING>>) -> MAP<INT64, STRING>)
    |     |     +-Literal(type=ARRAY<STRUCT<INT64, STRING>>, value=[{1, "x"}, {2, "y"}, {3, "z"}, {4, "w"}, {5, "v"}])
    |     +-FunctionArgument
    |     | +-expr=
    |     |   +-Literal(type=INT64, value=1)
    |     +-FunctionArgument
    |     | +-expr=
    |     |   +-Literal(type=INT64, value=3)
    |     +-FunctionArgument
    |     | +-expr=
    |     |   +-Literal(type=INT64, value=5)
    |     +-FunctionArgument
    |       +-inline_lambda=
    |         +-InlineLambda
    |           +-argument_list=[$lambda_arg.v#1]
    |           +-body=
    |             +-FunctionCall(GoogleSQL:upper(STRING) -> STRING)
    |               +-ColumnRef(type=STRING, column=$lambda_arg.v#1)
    +-input_scan=
      +-SingleRowScan

[SQLBUILDER_OUTPUT]
SELECT
  MAP_REPLACE(MAP_FROM_ARRAY(ARRAY< STRUCT< INT64, STRING > >[STRUCT< INT64, STRING > (1, "x"), STRUCT<
      INT64, STRING > (2, "y"), STRUCT< INT64, STRING > (3, "z"), STRUCT< INT64, STRING > (4, "w"), STRUCT<
      INT64, STRING > (5, "v")]), 1, 3, 5, (a_2) -> UPPER(a_2)) AS a_1;

[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-$query.$col1#2 AS `$col1` [MAP<INT64, STRING>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#2]
    +-expr_list=
    | +-$col1#2 :=
    |   +-FunctionCall(GoogleSQL:map_replace(MAP<INT64, STRING> input_map, INT64 key, INT64 repeated_key_1, INT64 repeated_key_2, FUNCTION<STRING->STRING> updater_lambda) -> MAP<INT64, STRING>)
    |     +-FunctionArgument
    |     | +-expr=
    |     |   +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<INT64, STRING>>) -> MAP<INT64, STRING>)
    |     |     +-Literal(type=ARRAY<STRUCT<INT64, STRING>>, value=[{1, "x"}, {2, "y"}, {3, "z"}, {4, "w"}, {5, "v"}])
    |     +-FunctionArgument
    |     | +-expr=
    |     |   +-Literal(type=INT64, value=1)
    |     +-FunctionArgument
    |     | +-expr=
    |     |   +-Literal(type=INT64, value=3)
    |     +-FunctionArgument
    |     | +-expr=
    |     |   +-Literal(type=INT64, value=5)
    |     +-FunctionArgument
    |       +-inline_lambda=
    |         +-InlineLambda
    |           +-argument_list=[$lambda_arg.v#1]
    |           +-body=
    |             +-FunctionCall(GoogleSQL:upper(STRING) -> STRING)
    |               +-ColumnRef(type=STRING, column=$lambda_arg.v#1)
    +-input_scan=
      +-SingleRowScan
[SQLBUILDER_OUTPUT]
SELECT
  MAP_REPLACE(MAP_FROM_ARRAY(ARRAY< STRUCT< INT64, STRING > >[STRUCT< INT64, STRING > (1, "x"), STRUCT<
      INT64, STRING > (2, "y"), STRUCT< INT64, STRING > (3, "z"), STRUCT< INT64, STRING > (4, "w"), STRUCT<
      INT64, STRING > (5, "v")]), 1, 3, 5, (a_2) -> UPPER(a_2)) AS a_1;
--
ALTERNATION GROUP: ,+BUILTIN_FUNCTION_INLINER
--
QueryStmt
+-output_column_list=
| +-$query.$col1#2 AS `$col1` [MAP<INT64, STRING>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#2]
    +-expr_list=
    | +-$col1#2 :=
    |   +-FunctionCall(GoogleSQL:map_replace(MAP<INT64, STRING> input_map, INT64 key, repeated(2) INT64 repeated_key, FUNCTION<STRING->STRING> updater_lambda) -> MAP<INT64, STRING>)
    |     +-FunctionArgument
    |     | +-expr=
    |     |   +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<INT64, STRING>>) -> MAP<INT64, STRING>)
    |     |     +-Literal(type=ARRAY<STRUCT<INT64, STRING>>, value=[{1, "x"}, {2, "y"}, {3, "z"}, {4, "w"}, {5, "v"}])
    |     +-FunctionArgument
    |     | +-expr=
    |     |   +-Literal(type=INT64, value=1)
    |     +-FunctionArgument
    |     | +-expr=
    |     |   +-Literal(type=INT64, value=3)
    |     +-FunctionArgument
    |     | +-expr=
    |     |   +-Literal(type=INT64, value=5)
    |     +-FunctionArgument
    |       +-inline_lambda=
    |         +-InlineLambda
    |           +-argument_list=[$lambda_arg.v#1]
    |           +-body=
    |             +-FunctionCall(GoogleSQL:upper(STRING) -> STRING)
    |               +-ColumnRef(type=STRING, column=$lambda_arg.v#1)
    +-input_scan=
      +-SingleRowScan

[SQLBUILDER_OUTPUT]
SELECT
  MAP_REPLACE(MAP_FROM_ARRAY(ARRAY< STRUCT< INT64, STRING > >[STRUCT< INT64, STRING > (1, "x"), STRUCT<
      INT64, STRING > (2, "y"), STRUCT< INT64, STRING > (3, "z"), STRUCT< INT64, STRING > (4, "w"), STRUCT<
      INT64, STRING > (5, "v")]), 1, 3, 5, (a_2) -> UPPER(a_2)) AS a_1;

[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-$query.$col1#2 AS `$col1` [MAP<INT64, STRING>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#2]
    +-expr_list=
    | +-$col1#2 :=
    |   +-SubqueryExpr
    |     +-type=MAP<INT64, STRING>
    |     +-subquery_type=SCALAR
    |     +-subquery=
    |       +-ProjectScan
    |         +-column_list=[$expr_subquery.$col1#28]
    |         +-expr_list=
    |         | +-$col1#28 :=
    |         |   +-FunctionCall(GoogleSQL:if(BOOL, MAP<INT64, STRING>, MAP<INT64, STRING>) -> MAP<INT64, STRING>)
    |         |     +-FunctionCall(GoogleSQL:$is_null(MAP<INT64, STRING>) -> BOOL)
    |         |     | +-ColumnRef(type=MAP<INT64, STRING>, column=$subquery1.input_map#3)
    |         |     +-Literal(type=MAP<INT64, STRING>, value=NULL)
    |         |     +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<key INT64, STRING>>) -> MAP<INT64, STRING>)
    |         |       +-SubqueryExpr
    |         |         +-type=ARRAY<STRUCT<key INT64, STRING>>
    |         |         +-subquery_type=ARRAY
    |         |         +-parameter_list=
    |         |         | +-ColumnRef(type=MAP<INT64, STRING>, column=$subquery1.input_map#3)
    |         |         | +-ColumnRef(type=INT64, column=$subquery1.key#4)
    |         |         | +-ColumnRef(type=INT64, column=$subquery1.repeated_key_1#5)
    |         |         | +-ColumnRef(type=INT64, column=$subquery1.repeated_key_2#6)
    |         |         +-subquery=
    |         |           +-ProjectScan
    |         |             +-column_list=[$expr_subquery.$col1#27]
    |         |             +-expr_list=
    |         |             | +-$col1#27 :=
    |         |             |   +-FunctionCall(GoogleSQL:$case_no_value(repeated(2) BOOL, repeated(2) STRUCT<key INT64, STRING>, STRUCT<key INT64, STRING>) -> STRUCT<key INT64, STRING>)
    |         |             |     +-FunctionCall(GoogleSQL:$greater(INT64, INT64) -> BOOL)
    |         |             |     | +-ColumnRef(type=INT64, column=$aggregate.$agg1#21)
    |         |             |     | +-Literal(type=INT64, value=1)
    |         |             |     +-Cast(STRUCT<key INT64, STRING> -> STRUCT<key INT64, STRING>)
    |         |             |     | +-FunctionCall(GoogleSQL:error(STRING) -> STRUCT<key INT64, STRING>)
    |         |             |     |   +-FunctionCall(GoogleSQL:format(STRING, repeated(1) INT64) -> STRING)
    |         |             |     |     +-Literal(type=STRING, value="Key provided more than once as argument: %T")
    |         |             |     |     +-ColumnRef(type=INT64, column=$groupby.key#26)
    |         |             |     +-FunctionCall(GoogleSQL:$equal(INT64, INT64) -> BOOL)
    |         |             |     | +-ColumnRef(type=INT64, column=$aggregate.$agg2#22)
    |         |             |     | +-Literal(type=INT64, value=1)
    |         |             |     +-Cast(STRUCT<key INT64, STRING> -> STRUCT<key INT64, STRING>)
    |         |             |     | +-FunctionCall(GoogleSQL:error(STRING) -> STRUCT<key INT64, STRING>)
    |         |             |     |   +-FunctionCall(GoogleSQL:format(STRING, repeated(1) INT64) -> STRING)
    |         |             |     |     +-Literal(type=STRING, value="Key does not exist in map: %T")
    |         |             |     |     +-ColumnRef(type=INT64, column=$groupby.key#26)
    |         |             |     +-MakeStruct
    |         |             |       +-type=STRUCT<key INT64, STRING>
    |         |             |       +-field_list=
    |         |             |         +-ColumnRef(type=INT64, column=$groupby.key#26)
    |         |             |         +-FunctionCall(GoogleSQL:if(BOOL, STRING, STRING) -> STRING)
    |         |             |           +-FunctionCall(GoogleSQL:$equal(INT64, INT64) -> BOOL)
    |         |             |           | +-ColumnRef(type=INT64, column=$aggregate.$agg3#23)
    |         |             |           | +-Literal(type=INT64, value=1)
    |         |             |           +-FunctionCall(GoogleSQL:upper(STRING) -> STRING)
    |         |             |           | +-ColumnRef(type=STRING, column=$aggregate.$agg4#24)
    |         |             |           +-ColumnRef(type=STRING, column=$aggregate.$agg5#25)
    |         |             +-input_scan=
    |         |               +-AggregateScan
    |         |                 +-column_list=[$groupby.key#26, $aggregate.$agg1#21, $aggregate.$agg2#22, $aggregate.$agg3#23, $aggregate.$agg4#24, $aggregate.$agg5#25]
    |         |                 +-input_scan=
    |         |                 | +-SetOperationScan
    |         |                 |   +-column_list=$union_all.[key#17, value#18, is_new#19]
    |         |                 |   +-op_type=UNION_ALL
    |         |                 |   +-input_item_list=
    |         |                 |     +-SetOperationItem
    |         |                 |     | +-scan=
    |         |                 |     | | +-ProjectScan
    |         |                 |     | |   +-column_list=$union_all1.[key#8, value#9, is_new#10]
    |         |                 |     | |   +-expr_list=
    |         |                 |     | |   | +-key#8 :=
    |         |                 |     | |   | | +-GetStructField
    |         |                 |     | |   | |   +-type=INT64
    |         |                 |     | |   | |   +-expr=
    |         |                 |     | |   | |   | +-ColumnRef(type=STRUCT<key INT64, value STRING>, column=$array.t#7)
    |         |                 |     | |   | |   +-field_idx=0
    |         |                 |     | |   | +-value#9 :=
    |         |                 |     | |   | | +-GetStructField
    |         |                 |     | |   | |   +-type=STRING
    |         |                 |     | |   | |   +-expr=
    |         |                 |     | |   | |   | +-ColumnRef(type=STRUCT<key INT64, value STRING>, column=$array.t#7)
    |         |                 |     | |   | |   +-field_idx=1
    |         |                 |     | |   | +-is_new#10 := Literal(type=INT64, value=0)
    |         |                 |     | |   +-input_scan=
    |         |                 |     | |     +-ArrayScan
    |         |                 |     | |       +-column_list=[$array.t#7]
    |         |                 |     | |       +-array_expr_list=
    |         |                 |     | |       | +-FunctionCall(GoogleSQL:map_entries_unsorted(MAP<INT64, STRING>) -> ARRAY<STRUCT<key INT64, value STRING>>)
    |         |                 |     | |       |   +-ColumnRef(type=MAP<INT64, STRING>, column=$subquery1.input_map#3, is_correlated=TRUE)
    |         |                 |     | |       +-element_column_list=[$array.t#7]
    |         |                 |     | +-output_column_list=$union_all1.[key#8, value#9, is_new#10]
    |         |                 |     +-SetOperationItem
    |         |                 |       +-scan=
    |         |                 |       | +-ProjectScan
    |         |                 |       |   +-column_list=[$union_all.key#14, $union_all2_cast.value#20, $union_all2.is_new#16]
    |         |                 |       |   +-expr_list=
    |         |                 |       |   | +-value#20 := Literal(type=STRING, value=NULL)
    |         |                 |       |   +-input_scan=
    |         |                 |       |     +-ProjectScan
    |         |                 |       |       +-column_list=[$union_all.key#14, $union_all2.value#15, $union_all2.is_new#16]
    |         |                 |       |       +-expr_list=
    |         |                 |       |       | +-value#15 := Literal(type=INT64, value=NULL)
    |         |                 |       |       | +-is_new#16 := Literal(type=INT64, value=1)
    |         |                 |       |       +-input_scan=
    |         |                 |       |         +-SetOperationScan
    |         |                 |       |           +-column_list=[$union_all.key#14]
    |         |                 |       |           +-op_type=UNION_ALL
    |         |                 |       |           +-input_item_list=
    |         |                 |       |             +-SetOperationItem
    |         |                 |       |             | +-scan=
    |         |                 |       |             | | +-ProjectScan
    |         |                 |       |             | |   +-column_list=[$union_all1.key#11]
    |         |                 |       |             | |   +-expr_list=
    |         |                 |       |             | |   | +-key#11 := ColumnRef(type=INT64, column=$subquery1.key#4, is_correlated=TRUE)
    |         |                 |       |             | |   +-input_scan=
    |         |                 |       |             | |     +-SingleRowScan
    |         |                 |       |             | +-output_column_list=[$union_all1.key#11]
    |         |                 |       |             +-SetOperationItem
    |         |                 |       |             | +-scan=
    |         |                 |       |             | | +-ProjectScan
    |         |                 |       |             | |   +-column_list=[$union_all2.key#12]
    |         |                 |       |             | |   +-expr_list=
    |         |                 |       |             | |   | +-key#12 := ColumnRef(type=INT64, column=$subquery1.repeated_key_1#5, is_correlated=TRUE)
    |         |                 |       |             | |   +-input_scan=
    |         |                 |       |             | |     +-SingleRowScan
    |         |                 |       |             | +-output_column_list=[$union_all2.key#12]
    |         |                 |       |             +-SetOperationItem
    |         |                 |       |               +-scan=
    |         |                 |       |               | +-ProjectScan
    |         |                 |       |               |   +-column_list=[$union_all3.key#13]
    |         |                 |       |               |   +-expr_list=
    |         |                 |       |               |   | +-key#13 := ColumnRef(type=INT64, column=$subquery1.repeated_key_2#6, is_correlated=TRUE)
    |         |                 |       |               |   +-input_scan=
    |         |                 |       |               |     +-SingleRowScan
    |         |                 |       |               +-output_column_list=[$union_all3.key#13]
    |         |                 |       +-output_column_list=[$union_all.key#14, $union_all2_cast.value#20, $union_all2.is_new#16]
    |         |                 +-group_by_list=
    |         |                 | +-key#26 := ColumnRef(type=INT64, column=$union_all.key#17)
    |         |                 +-aggregate_list=
    |         |                   +-$agg1#21 :=
    |         |                   | +-AggregateFunctionCall(GoogleSQL:sum(INT64) -> INT64)
    |         |                   |   +-ColumnRef(type=INT64, column=$union_all.is_new#19)
    |         |                   +-$agg2#22 :=
    |         |                   | +-AggregateFunctionCall(GoogleSQL:min(INT64) -> INT64)
    |         |                   |   +-ColumnRef(type=INT64, column=$union_all.is_new#19)
    |         |                   +-$agg3#23 :=
    |         |                   | +-AggregateFunctionCall(GoogleSQL:max(INT64) -> INT64)
    |         |                   |   +-ColumnRef(type=INT64, column=$union_all.is_new#19)
    |         |                   +-$agg4#24 :=
    |         |                   | +-AggregateFunctionCall(GoogleSQL:any_value(STRING) -> STRING)
    |         |                   |   +-ColumnRef(type=STRING, column=$union_all.value#18)
    |         |                   |   +-having_modifier=
    |         |                   |     +-AggregateHavingModifier
    |         |                   |       +-kind=MIN
    |         |                   |       +-having_expr=
    |         |                   |         +-ColumnRef(type=INT64, column=$union_all.is_new#19)
    |         |                   +-$agg5#25 :=
    |         |                     +-AggregateFunctionCall(GoogleSQL:any_value(STRING) -> STRING)
    |         |                       +-ColumnRef(type=STRING, column=$union_all.value#18)
    |         +-input_scan=
    |           +-ProjectScan
    |             +-column_list=$subquery1.[input_map#3, key#4, repeated_key_1#5, repeated_key_2#6]
    |             +-expr_list=
    |             | +-input_map#3 :=
    |             | | +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<INT64, STRING>>) -> MAP<INT64, STRING>)
    |             | |   +-Literal(type=ARRAY<STRUCT<INT64, STRING>>, value=[{1, "x"}, {2, "y"}, {3, "z"}, {4, "w"}, {5, "v"}])
    |             | +-key#4 := Literal(type=INT64, value=1)
    |             | +-repeated_key_1#5 := Literal(type=INT64, value=3)
    |             | +-repeated_key_2#6 := Literal(type=INT64, value=5)
    |             +-input_scan=
    |               +-SingleRowScan
    +-input_scan=
      +-SingleRowScan
[SQLBUILDER_OUTPUT]
SELECT
  (
    SELECT
      `IF`((projectscan_6.a_2) IS NULL, CAST(NULL AS MAP< INT64, STRING >), MAP_FROM_ARRAY(ARRAY(
            SELECT
              CASE
                WHEN((aggregatescan_27.a_22) > 1) THEN CAST(ERROR(FORMAT("Key provided more than once as argument: %T",
                    aggregatescan_27.a_21)) AS STRUCT< key INT64, STRING >)
                WHEN((aggregatescan_27.a_23) = 1) THEN CAST(ERROR(FORMAT("Key does not exist in map: %T", aggregatescan_27.a_21)) AS STRUCT<
                key INT64, STRING >)
                ELSE STRUCT< key INT64, STRING > (aggregatescan_27.a_21, `IF`((aggregatescan_27.a_24) = 1, UPPER(aggregatescan_27.a_25),
                    aggregatescan_27.a_26))
              END AS a_28
            FROM
              (
                SELECT
                  setoperationscan_20.a_9 AS a_21,
                  SUM(setoperationscan_20.a_11) AS a_22,
                  MIN(setoperationscan_20.a_11) AS a_23,
                  MAX(setoperationscan_20.a_11) AS a_24,
                  ANY_VALUE(setoperationscan_20.a_10
                    HAVING MIN setoperationscan_20.a_11) AS a_25,
                  ANY_VALUE(setoperationscan_20.a_10) AS a_26
                FROM
                  ((
                    SELECT
                      a_8.key AS a_9,
                      a_8.value AS a_10,
                      0 AS a_11
                    FROM
                      UNNEST(MAP_ENTRIES_UNSORTED(projectscan_6.a_2)) AS a_8
                    ) UNION ALL(
                    SELECT
                      projectscan_18.a_12 AS a_12,
                      CAST(NULL AS STRING) AS a_19,
                      projectscan_18.a_17 AS a_17
                    FROM
                      (
                        SELECT
                          setoperationscan_15.a_12 AS a_12,
                          CAST(NULL AS INT64) AS a_16,
                          1 AS a_17
                        FROM
                          ((
                            SELECT
                              projectscan_6.a_3 AS a_12
                            ) UNION ALL(
                            SELECT
                              projectscan_6.a_4 AS a_13
                            ) UNION ALL(
                            SELECT
                              projectscan_6.a_5 AS a_14
                            )
                          ) AS setoperationscan_15
                      ) AS projectscan_18
                    )
                  ) AS setoperationscan_20
                GROUP BY 1
              ) AS aggregatescan_27
          ))) AS a_7
    FROM
      (
        SELECT
          MAP_FROM_ARRAY(ARRAY< STRUCT< INT64, STRING > >[STRUCT< INT64, STRING > (1, "x"), STRUCT< INT64, STRING >
            (2, "y"), STRUCT< INT64, STRING > (3, "z"), STRUCT< INT64, STRING > (4, "w"), STRUCT< INT64, STRING >
            (5, "v")]) AS a_2,
          1 AS a_3,
          3 AS a_4,
          5 AS a_5
      ) AS projectscan_6
  ) AS a_1;
==

# Tests MAP_DELETE with the minumum valid number of variadic arguments.
[enabled_ast_rewrites=NONE,+VARIADIC_FUNCTION_SIGNATURE_EXPANDER{{|,+BUILTIN_FUNCTION_INLINER}}]
SELECT MAP_DELETE(MAP_FROM_ARRAY([(1, 'a'), (2, 'b'), (3, 'c')]), 1, 3)
--
ALTERNATION GROUP: <empty>
--
QueryStmt
+-output_column_list=
| +-$query.$col1#1 AS `$col1` [MAP<INT64, STRING>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#1]
    +-expr_list=
    | +-$col1#1 :=
    |   +-FunctionCall(GoogleSQL:map_delete(MAP<INT64, STRING> input_map, INT64 key, repeated(1) INT64 repeated_key) -> MAP<INT64, STRING>)
    |     +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<INT64, STRING>>) -> MAP<INT64, STRING>)
    |     | +-Literal(type=ARRAY<STRUCT<INT64, STRING>>, value=[{1, "a"}, {2, "b"}, {3, "c"}])
    |     +-Literal(type=INT64, value=1)
    |     +-Literal(type=INT64, value=3)
    +-input_scan=
      +-SingleRowScan

[SQLBUILDER_OUTPUT]
SELECT
  MAP_DELETE(MAP_FROM_ARRAY(ARRAY< STRUCT< INT64, STRING > >[STRUCT< INT64, STRING > (1, "a"), STRUCT<
      INT64, STRING > (2, "b"), STRUCT< INT64, STRING > (3, "c")]), 1, 3) AS a_1;

[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-$query.$col1#1 AS `$col1` [MAP<INT64, STRING>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#1]
    +-expr_list=
    | +-$col1#1 :=
    |   +-FunctionCall(GoogleSQL:map_delete(MAP<INT64, STRING> input_map, INT64 key, INT64 repeated_key_1) -> MAP<INT64, STRING>)
    |     +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<INT64, STRING>>) -> MAP<INT64, STRING>)
    |     | +-Literal(type=ARRAY<STRUCT<INT64, STRING>>, value=[{1, "a"}, {2, "b"}, {3, "c"}])
    |     +-Literal(type=INT64, value=1)
    |     +-Literal(type=INT64, value=3)
    +-input_scan=
      +-SingleRowScan
[SQLBUILDER_OUTPUT]
SELECT
  MAP_DELETE(MAP_FROM_ARRAY(ARRAY< STRUCT< INT64, STRING > >[STRUCT< INT64, STRING > (1, "a"), STRUCT<
      INT64, STRING > (2, "b"), STRUCT< INT64, STRING > (3, "c")]), 1, 3) AS a_1;
--
ALTERNATION GROUP: ,+BUILTIN_FUNCTION_INLINER
--
QueryStmt
+-output_column_list=
| +-$query.$col1#1 AS `$col1` [MAP<INT64, STRING>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#1]
    +-expr_list=
    | +-$col1#1 :=
    |   +-FunctionCall(GoogleSQL:map_delete(MAP<INT64, STRING> input_map, INT64 key, repeated(1) INT64 repeated_key) -> MAP<INT64, STRING>)
    |     +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<INT64, STRING>>) -> MAP<INT64, STRING>)
    |     | +-Literal(type=ARRAY<STRUCT<INT64, STRING>>, value=[{1, "a"}, {2, "b"}, {3, "c"}])
    |     +-Literal(type=INT64, value=1)
    |     +-Literal(type=INT64, value=3)
    +-input_scan=
      +-SingleRowScan

[SQLBUILDER_OUTPUT]
SELECT
  MAP_DELETE(MAP_FROM_ARRAY(ARRAY< STRUCT< INT64, STRING > >[STRUCT< INT64, STRING > (1, "a"), STRUCT<
      INT64, STRING > (2, "b"), STRUCT< INT64, STRING > (3, "c")]), 1, 3) AS a_1;

[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-$query.$col1#1 AS `$col1` [MAP<INT64, STRING>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#1]
    +-expr_list=
    | +-$col1#1 :=
    |   +-SubqueryExpr
    |     +-type=MAP<INT64, STRING>
    |     +-subquery_type=SCALAR
    |     +-subquery=
    |       +-ProjectScan
    |         +-column_list=[$expr_subquery.$col1#22]
    |         +-expr_list=
    |         | +-$col1#22 :=
    |         |   +-FunctionCall(GoogleSQL:if(BOOL, MAP<INT64, STRING>, MAP<INT64, STRING>) -> MAP<INT64, STRING>)
    |         |     +-FunctionCall(GoogleSQL:$is_null(MAP<INT64, STRING>) -> BOOL)
    |         |     | +-ColumnRef(type=MAP<INT64, STRING>, column=$subquery1.input_map#2)
    |         |     +-Literal(type=MAP<INT64, STRING>, value=NULL)
    |         |     +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<key INT64, STRING>>) -> MAP<INT64, STRING>)
    |         |       +-SubqueryExpr
    |         |         +-type=ARRAY<STRUCT<key INT64, STRING>>
    |         |         +-subquery_type=ARRAY
    |         |         +-parameter_list=
    |         |         | +-ColumnRef(type=MAP<INT64, STRING>, column=$subquery1.input_map#2)
    |         |         | +-ColumnRef(type=INT64, column=$subquery1.key#3)
    |         |         | +-ColumnRef(type=INT64, column=$subquery1.repeated_key_1#4)
    |         |         +-subquery=
    |         |           +-ProjectScan
    |         |             +-column_list=[$expr_subquery.$col1#20]
    |         |             +-input_scan=
    |         |               +-FilterScan
    |         |                 +-column_list=[$aggregate.$agg1#18, $groupby.key#19, $expr_subquery.$col1#20, $aggregate.$agg2#21]
    |         |                 +-input_scan=
    |         |                 | +-ProjectScan
    |         |                 |   +-column_list=[$aggregate.$agg1#18, $groupby.key#19, $expr_subquery.$col1#20, $aggregate.$agg2#21]
    |         |                 |   +-expr_list=
    |         |                 |   | +-$col1#20 :=
    |         |                 |   |   +-MakeStruct
    |         |                 |   |     +-type=STRUCT<key INT64, STRING>
    |         |                 |   |     +-field_list=
    |         |                 |   |       +-ColumnRef(type=INT64, column=$groupby.key#19)
    |         |                 |   |       +-ColumnRef(type=STRING, column=$aggregate.$agg1#18)
    |         |                 |   +-input_scan=
    |         |                 |     +-AggregateScan
    |         |                 |       +-column_list=[$groupby.key#19, $aggregate.$agg1#18, $aggregate.$agg2#21]
    |         |                 |       +-input_scan=
    |         |                 |       | +-SetOperationScan
    |         |                 |       |   +-column_list=$union_all.[key#14, value#15, is_delete_key#16]
    |         |                 |       |   +-op_type=UNION_ALL
    |         |                 |       |   +-input_item_list=
    |         |                 |       |     +-SetOperationItem
    |         |                 |       |     | +-scan=
    |         |                 |       |     | | +-ProjectScan
    |         |                 |       |     | |   +-column_list=$union_all1.[key#6, value#7, is_delete_key#8]
    |         |                 |       |     | |   +-expr_list=
    |         |                 |       |     | |   | +-key#6 :=
    |         |                 |       |     | |   | | +-GetStructField
    |         |                 |       |     | |   | |   +-type=INT64
    |         |                 |       |     | |   | |   +-expr=
    |         |                 |       |     | |   | |   | +-ColumnRef(type=STRUCT<key INT64, value STRING>, column=$array.t#5)
    |         |                 |       |     | |   | |   +-field_idx=0
    |         |                 |       |     | |   | +-value#7 :=
    |         |                 |       |     | |   | | +-GetStructField
    |         |                 |       |     | |   | |   +-type=STRING
    |         |                 |       |     | |   | |   +-expr=
    |         |                 |       |     | |   | |   | +-ColumnRef(type=STRUCT<key INT64, value STRING>, column=$array.t#5)
    |         |                 |       |     | |   | |   +-field_idx=1
    |         |                 |       |     | |   | +-is_delete_key#8 := Literal(type=INT64, value=0)
    |         |                 |       |     | |   +-input_scan=
    |         |                 |       |     | |     +-ArrayScan
    |         |                 |       |     | |       +-column_list=[$array.t#5]
    |         |                 |       |     | |       +-array_expr_list=
    |         |                 |       |     | |       | +-FunctionCall(GoogleSQL:map_entries_unsorted(MAP<INT64, STRING>) -> ARRAY<STRUCT<key INT64, value STRING>>)
    |         |                 |       |     | |       |   +-ColumnRef(type=MAP<INT64, STRING>, column=$subquery1.input_map#2, is_correlated=TRUE)
    |         |                 |       |     | |       +-element_column_list=[$array.t#5]
    |         |                 |       |     | +-output_column_list=$union_all1.[key#6, value#7, is_delete_key#8]
    |         |                 |       |     +-SetOperationItem
    |         |                 |       |       +-scan=
    |         |                 |       |       | +-ProjectScan
    |         |                 |       |       |   +-column_list=[$union_all.key#11, $union_all2_cast.value#17, $union_all2.is_delete_key#13]
    |         |                 |       |       |   +-expr_list=
    |         |                 |       |       |   | +-value#17 := Literal(type=STRING, value=NULL)
    |         |                 |       |       |   +-input_scan=
    |         |                 |       |       |     +-ProjectScan
    |         |                 |       |       |       +-column_list=[$union_all.key#11, $union_all2.value#12, $union_all2.is_delete_key#13]
    |         |                 |       |       |       +-expr_list=
    |         |                 |       |       |       | +-value#12 := Literal(type=INT64, value=NULL)
    |         |                 |       |       |       | +-is_delete_key#13 := Literal(type=INT64, value=1)
    |         |                 |       |       |       +-input_scan=
    |         |                 |       |       |         +-SetOperationScan
    |         |                 |       |       |           +-column_list=[$union_all.key#11]
    |         |                 |       |       |           +-op_type=UNION_ALL
    |         |                 |       |       |           +-input_item_list=
    |         |                 |       |       |             +-SetOperationItem
    |         |                 |       |       |             | +-scan=
    |         |                 |       |       |             | | +-ProjectScan
    |         |                 |       |       |             | |   +-column_list=[$union_all1.key#9]
    |         |                 |       |       |             | |   +-expr_list=
    |         |                 |       |       |             | |   | +-key#9 := ColumnRef(type=INT64, column=$subquery1.key#3, is_correlated=TRUE)
    |         |                 |       |       |             | |   +-input_scan=
    |         |                 |       |       |             | |     +-SingleRowScan
    |         |                 |       |       |             | +-output_column_list=[$union_all1.key#9]
    |         |                 |       |       |             +-SetOperationItem
    |         |                 |       |       |               +-scan=
    |         |                 |       |       |               | +-ProjectScan
    |         |                 |       |       |               |   +-column_list=[$union_all2.key#10]
    |         |                 |       |       |               |   +-expr_list=
    |         |                 |       |       |               |   | +-key#10 := ColumnRef(type=INT64, column=$subquery1.repeated_key_1#4, is_correlated=TRUE)
    |         |                 |       |       |               |   +-input_scan=
    |         |                 |       |       |               |     +-SingleRowScan
    |         |                 |       |       |               +-output_column_list=[$union_all2.key#10]
    |         |                 |       |       +-output_column_list=[$union_all.key#11, $union_all2_cast.value#17, $union_all2.is_delete_key#13]
    |         |                 |       +-group_by_list=
    |         |                 |       | +-key#19 := ColumnRef(type=INT64, column=$union_all.key#14)
    |         |                 |       +-aggregate_list=
    |         |                 |         +-$agg1#18 :=
    |         |                 |         | +-AggregateFunctionCall(GoogleSQL:any_value(STRING) -> STRING)
    |         |                 |         |   +-ColumnRef(type=STRING, column=$union_all.value#15)
    |         |                 |         +-$agg2#21 :=
    |         |                 |           +-AggregateFunctionCall(GoogleSQL:max(INT64) -> INT64)
    |         |                 |             +-ColumnRef(type=INT64, column=$union_all.is_delete_key#16)
    |         |                 +-filter_expr=
    |         |                   +-FunctionCall(GoogleSQL:$equal(INT64, INT64) -> BOOL)
    |         |                     +-ColumnRef(type=INT64, column=$aggregate.$agg2#21)
    |         |                     +-Literal(type=INT64, value=0)
    |         +-input_scan=
    |           +-ProjectScan
    |             +-column_list=$subquery1.[input_map#2, key#3, repeated_key_1#4]
    |             +-expr_list=
    |             | +-input_map#2 :=
    |             | | +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<INT64, STRING>>) -> MAP<INT64, STRING>)
    |             | |   +-Literal(type=ARRAY<STRUCT<INT64, STRING>>, value=[{1, "a"}, {2, "b"}, {3, "c"}])
    |             | +-key#3 := Literal(type=INT64, value=1)
    |             | +-repeated_key_1#4 := Literal(type=INT64, value=3)
    |             +-input_scan=
    |               +-SingleRowScan
    +-input_scan=
      +-SingleRowScan
[SQLBUILDER_OUTPUT]
SELECT
  (
    SELECT
      `IF`((projectscan_5.a_2) IS NULL, CAST(NULL AS MAP< INT64, STRING >), MAP_FROM_ARRAY(ARRAY(
            SELECT
              projectscan_24.a_23 AS a_23
            FROM
              (
                SELECT
                  aggregatescan_22.a_20 AS a_20,
                  aggregatescan_22.a_19 AS a_19,
                  STRUCT< key INT64, STRING > (aggregatescan_22.a_19, aggregatescan_22.a_20) AS a_23,
                  aggregatescan_22.a_21 AS a_21
                FROM
                  (
                    SELECT
                      setoperationscan_18.a_8 AS a_19,
                      ANY_VALUE(setoperationscan_18.a_9) AS a_20,
                      MAX(setoperationscan_18.a_10) AS a_21
                    FROM
                      ((
                        SELECT
                          a_7.key AS a_8,
                          a_7.value AS a_9,
                          0 AS a_10
                        FROM
                          UNNEST(MAP_ENTRIES_UNSORTED(projectscan_5.a_2)) AS a_7
                        ) UNION ALL(
                        SELECT
                          projectscan_16.a_11 AS a_11,
                          CAST(NULL AS STRING) AS a_17,
                          projectscan_16.a_15 AS a_15
                        FROM
                          (
                            SELECT
                              setoperationscan_13.a_11 AS a_11,
                              CAST(NULL AS INT64) AS a_14,
                              1 AS a_15
                            FROM
                              ((
                                SELECT
                                  projectscan_5.a_3 AS a_11
                                ) UNION ALL(
                                SELECT
                                  projectscan_5.a_4 AS a_12
                                )
                              ) AS setoperationscan_13
                          ) AS projectscan_16
                        )
                      ) AS setoperationscan_18
                    GROUP BY 1
                  ) AS aggregatescan_22
              ) AS projectscan_24
            WHERE
              (projectscan_24.a_21) = 0
          ))) AS a_6
    FROM
      (
        SELECT
          MAP_FROM_ARRAY(ARRAY< STRUCT< INT64, STRING > >[STRUCT< INT64, STRING > (1, "a"), STRUCT< INT64, STRING >
            (2, "b"), STRUCT< INT64, STRING > (3, "c")]) AS a_2,
          1 AS a_3,
          3 AS a_4
      ) AS projectscan_5
  ) AS a_1;
==

# Tests MAP_DELETE with more than the minumum number of variadic arguments.
[enabled_ast_rewrites=NONE,+VARIADIC_FUNCTION_SIGNATURE_EXPANDER{{|,+BUILTIN_FUNCTION_INLINER}}]
SELECT MAP_DELETE(MAP_FROM_ARRAY([(1, 'a'), (2, 'b'), (3, 'c'), (4, 'd'), (5, 'e')]), 1, 3, 5, 4)
--
ALTERNATION GROUP: <empty>
--
QueryStmt
+-output_column_list=
| +-$query.$col1#1 AS `$col1` [MAP<INT64, STRING>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#1]
    +-expr_list=
    | +-$col1#1 :=
    |   +-FunctionCall(GoogleSQL:map_delete(MAP<INT64, STRING> input_map, INT64 key, repeated(3) INT64 repeated_key) -> MAP<INT64, STRING>)
    |     +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<INT64, STRING>>) -> MAP<INT64, STRING>)
    |     | +-Literal(type=ARRAY<STRUCT<INT64, STRING>>, value=[{1, "a"}, {2, "b"}, {3, "c"}, {4, "d"}, {5, "e"}])
    |     +-Literal(type=INT64, value=1)
    |     +-Literal(type=INT64, value=3)
    |     +-Literal(type=INT64, value=5)
    |     +-Literal(type=INT64, value=4)
    +-input_scan=
      +-SingleRowScan

[SQLBUILDER_OUTPUT]
SELECT
  MAP_DELETE(MAP_FROM_ARRAY(ARRAY< STRUCT< INT64, STRING > >[STRUCT< INT64, STRING > (1, "a"), STRUCT<
      INT64, STRING > (2, "b"), STRUCT< INT64, STRING > (3, "c"), STRUCT< INT64, STRING > (4, "d"), STRUCT<
      INT64, STRING > (5, "e")]), 1, 3, 5, 4) AS a_1;

[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-$query.$col1#1 AS `$col1` [MAP<INT64, STRING>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#1]
    +-expr_list=
    | +-$col1#1 :=
    |   +-FunctionCall(GoogleSQL:map_delete(MAP<INT64, STRING> input_map, INT64 key, INT64 repeated_key_1, INT64 repeated_key_2, INT64 repeated_key_3) -> MAP<INT64, STRING>)
    |     +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<INT64, STRING>>) -> MAP<INT64, STRING>)
    |     | +-Literal(type=ARRAY<STRUCT<INT64, STRING>>, value=[{1, "a"}, {2, "b"}, {3, "c"}, {4, "d"}, {5, "e"}])
    |     +-Literal(type=INT64, value=1)
    |     +-Literal(type=INT64, value=3)
    |     +-Literal(type=INT64, value=5)
    |     +-Literal(type=INT64, value=4)
    +-input_scan=
      +-SingleRowScan
[SQLBUILDER_OUTPUT]
SELECT
  MAP_DELETE(MAP_FROM_ARRAY(ARRAY< STRUCT< INT64, STRING > >[STRUCT< INT64, STRING > (1, "a"), STRUCT<
      INT64, STRING > (2, "b"), STRUCT< INT64, STRING > (3, "c"), STRUCT< INT64, STRING > (4, "d"), STRUCT<
      INT64, STRING > (5, "e")]), 1, 3, 5, 4) AS a_1;
--
ALTERNATION GROUP: ,+BUILTIN_FUNCTION_INLINER
--
QueryStmt
+-output_column_list=
| +-$query.$col1#1 AS `$col1` [MAP<INT64, STRING>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#1]
    +-expr_list=
    | +-$col1#1 :=
    |   +-FunctionCall(GoogleSQL:map_delete(MAP<INT64, STRING> input_map, INT64 key, repeated(3) INT64 repeated_key) -> MAP<INT64, STRING>)
    |     +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<INT64, STRING>>) -> MAP<INT64, STRING>)
    |     | +-Literal(type=ARRAY<STRUCT<INT64, STRING>>, value=[{1, "a"}, {2, "b"}, {3, "c"}, {4, "d"}, {5, "e"}])
    |     +-Literal(type=INT64, value=1)
    |     +-Literal(type=INT64, value=3)
    |     +-Literal(type=INT64, value=5)
    |     +-Literal(type=INT64, value=4)
    +-input_scan=
      +-SingleRowScan

[SQLBUILDER_OUTPUT]
SELECT
  MAP_DELETE(MAP_FROM_ARRAY(ARRAY< STRUCT< INT64, STRING > >[STRUCT< INT64, STRING > (1, "a"), STRUCT<
      INT64, STRING > (2, "b"), STRUCT< INT64, STRING > (3, "c"), STRUCT< INT64, STRING > (4, "d"), STRUCT<
      INT64, STRING > (5, "e")]), 1, 3, 5, 4) AS a_1;

[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-$query.$col1#1 AS `$col1` [MAP<INT64, STRING>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#1]
    +-expr_list=
    | +-$col1#1 :=
    |   +-SubqueryExpr
    |     +-type=MAP<INT64, STRING>
    |     +-subquery_type=SCALAR
    |     +-subquery=
    |       +-ProjectScan
    |         +-column_list=[$expr_subquery.$col1#26]
    |         +-expr_list=
    |         | +-$col1#26 :=
    |         |   +-FunctionCall(GoogleSQL:if(BOOL, MAP<INT64, STRING>, MAP<INT64, STRING>) -> MAP<INT64, STRING>)
    |         |     +-FunctionCall(GoogleSQL:$is_null(MAP<INT64, STRING>) -> BOOL)
    |         |     | +-ColumnRef(type=MAP<INT64, STRING>, column=$subquery1.input_map#2)
    |         |     +-Literal(type=MAP<INT64, STRING>, value=NULL)
    |         |     +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<key INT64, STRING>>) -> MAP<INT64, STRING>)
    |         |       +-SubqueryExpr
    |         |         +-type=ARRAY<STRUCT<key INT64, STRING>>
    |         |         +-subquery_type=ARRAY
    |         |         +-parameter_list=
    |         |         | +-ColumnRef(type=MAP<INT64, STRING>, column=$subquery1.input_map#2)
    |         |         | +-ColumnRef(type=INT64, column=$subquery1.key#3)
    |         |         | +-ColumnRef(type=INT64, column=$subquery1.repeated_key_1#4)
    |         |         | +-ColumnRef(type=INT64, column=$subquery1.repeated_key_2#5)
    |         |         | +-ColumnRef(type=INT64, column=$subquery1.repeated_key_3#6)
    |         |         +-subquery=
    |         |           +-ProjectScan
    |         |             +-column_list=[$expr_subquery.$col1#24]
    |         |             +-input_scan=
    |         |               +-FilterScan
    |         |                 +-column_list=[$aggregate.$agg1#22, $groupby.key#23, $expr_subquery.$col1#24, $aggregate.$agg2#25]
    |         |                 +-input_scan=
    |         |                 | +-ProjectScan
    |         |                 |   +-column_list=[$aggregate.$agg1#22, $groupby.key#23, $expr_subquery.$col1#24, $aggregate.$agg2#25]
    |         |                 |   +-expr_list=
    |         |                 |   | +-$col1#24 :=
    |         |                 |   |   +-MakeStruct
    |         |                 |   |     +-type=STRUCT<key INT64, STRING>
    |         |                 |   |     +-field_list=
    |         |                 |   |       +-ColumnRef(type=INT64, column=$groupby.key#23)
    |         |                 |   |       +-ColumnRef(type=STRING, column=$aggregate.$agg1#22)
    |         |                 |   +-input_scan=
    |         |                 |     +-AggregateScan
    |         |                 |       +-column_list=[$groupby.key#23, $aggregate.$agg1#22, $aggregate.$agg2#25]
    |         |                 |       +-input_scan=
    |         |                 |       | +-SetOperationScan
    |         |                 |       |   +-column_list=$union_all.[key#18, value#19, is_delete_key#20]
    |         |                 |       |   +-op_type=UNION_ALL
    |         |                 |       |   +-input_item_list=
    |         |                 |       |     +-SetOperationItem
    |         |                 |       |     | +-scan=
    |         |                 |       |     | | +-ProjectScan
    |         |                 |       |     | |   +-column_list=$union_all1.[key#8, value#9, is_delete_key#10]
    |         |                 |       |     | |   +-expr_list=
    |         |                 |       |     | |   | +-key#8 :=
    |         |                 |       |     | |   | | +-GetStructField
    |         |                 |       |     | |   | |   +-type=INT64
    |         |                 |       |     | |   | |   +-expr=
    |         |                 |       |     | |   | |   | +-ColumnRef(type=STRUCT<key INT64, value STRING>, column=$array.t#7)
    |         |                 |       |     | |   | |   +-field_idx=0
    |         |                 |       |     | |   | +-value#9 :=
    |         |                 |       |     | |   | | +-GetStructField
    |         |                 |       |     | |   | |   +-type=STRING
    |         |                 |       |     | |   | |   +-expr=
    |         |                 |       |     | |   | |   | +-ColumnRef(type=STRUCT<key INT64, value STRING>, column=$array.t#7)
    |         |                 |       |     | |   | |   +-field_idx=1
    |         |                 |       |     | |   | +-is_delete_key#10 := Literal(type=INT64, value=0)
    |         |                 |       |     | |   +-input_scan=
    |         |                 |       |     | |     +-ArrayScan
    |         |                 |       |     | |       +-column_list=[$array.t#7]
    |         |                 |       |     | |       +-array_expr_list=
    |         |                 |       |     | |       | +-FunctionCall(GoogleSQL:map_entries_unsorted(MAP<INT64, STRING>) -> ARRAY<STRUCT<key INT64, value STRING>>)
    |         |                 |       |     | |       |   +-ColumnRef(type=MAP<INT64, STRING>, column=$subquery1.input_map#2, is_correlated=TRUE)
    |         |                 |       |     | |       +-element_column_list=[$array.t#7]
    |         |                 |       |     | +-output_column_list=$union_all1.[key#8, value#9, is_delete_key#10]
    |         |                 |       |     +-SetOperationItem
    |         |                 |       |       +-scan=
    |         |                 |       |       | +-ProjectScan
    |         |                 |       |       |   +-column_list=[$union_all.key#15, $union_all2_cast.value#21, $union_all2.is_delete_key#17]
    |         |                 |       |       |   +-expr_list=
    |         |                 |       |       |   | +-value#21 := Literal(type=STRING, value=NULL)
    |         |                 |       |       |   +-input_scan=
    |         |                 |       |       |     +-ProjectScan
    |         |                 |       |       |       +-column_list=[$union_all.key#15, $union_all2.value#16, $union_all2.is_delete_key#17]
    |         |                 |       |       |       +-expr_list=
    |         |                 |       |       |       | +-value#16 := Literal(type=INT64, value=NULL)
    |         |                 |       |       |       | +-is_delete_key#17 := Literal(type=INT64, value=1)
    |         |                 |       |       |       +-input_scan=
    |         |                 |       |       |         +-SetOperationScan
    |         |                 |       |       |           +-column_list=[$union_all.key#15]
    |         |                 |       |       |           +-op_type=UNION_ALL
    |         |                 |       |       |           +-input_item_list=
    |         |                 |       |       |             +-SetOperationItem
    |         |                 |       |       |             | +-scan=
    |         |                 |       |       |             | | +-ProjectScan
    |         |                 |       |       |             | |   +-column_list=[$union_all1.key#11]
    |         |                 |       |       |             | |   +-expr_list=
    |         |                 |       |       |             | |   | +-key#11 := ColumnRef(type=INT64, column=$subquery1.key#3, is_correlated=TRUE)
    |         |                 |       |       |             | |   +-input_scan=
    |         |                 |       |       |             | |     +-SingleRowScan
    |         |                 |       |       |             | +-output_column_list=[$union_all1.key#11]
    |         |                 |       |       |             +-SetOperationItem
    |         |                 |       |       |             | +-scan=
    |         |                 |       |       |             | | +-ProjectScan
    |         |                 |       |       |             | |   +-column_list=[$union_all2.key#12]
    |         |                 |       |       |             | |   +-expr_list=
    |         |                 |       |       |             | |   | +-key#12 := ColumnRef(type=INT64, column=$subquery1.repeated_key_1#4, is_correlated=TRUE)
    |         |                 |       |       |             | |   +-input_scan=
    |         |                 |       |       |             | |     +-SingleRowScan
    |         |                 |       |       |             | +-output_column_list=[$union_all2.key#12]
    |         |                 |       |       |             +-SetOperationItem
    |         |                 |       |       |             | +-scan=
    |         |                 |       |       |             | | +-ProjectScan
    |         |                 |       |       |             | |   +-column_list=[$union_all3.key#13]
    |         |                 |       |       |             | |   +-expr_list=
    |         |                 |       |       |             | |   | +-key#13 := ColumnRef(type=INT64, column=$subquery1.repeated_key_2#5, is_correlated=TRUE)
    |         |                 |       |       |             | |   +-input_scan=
    |         |                 |       |       |             | |     +-SingleRowScan
    |         |                 |       |       |             | +-output_column_list=[$union_all3.key#13]
    |         |                 |       |       |             +-SetOperationItem
    |         |                 |       |       |               +-scan=
    |         |                 |       |       |               | +-ProjectScan
    |         |                 |       |       |               |   +-column_list=[$union_all4.key#14]
    |         |                 |       |       |               |   +-expr_list=
    |         |                 |       |       |               |   | +-key#14 := ColumnRef(type=INT64, column=$subquery1.repeated_key_3#6, is_correlated=TRUE)
    |         |                 |       |       |               |   +-input_scan=
    |         |                 |       |       |               |     +-SingleRowScan
    |         |                 |       |       |               +-output_column_list=[$union_all4.key#14]
    |         |                 |       |       +-output_column_list=[$union_all.key#15, $union_all2_cast.value#21, $union_all2.is_delete_key#17]
    |         |                 |       +-group_by_list=
    |         |                 |       | +-key#23 := ColumnRef(type=INT64, column=$union_all.key#18)
    |         |                 |       +-aggregate_list=
    |         |                 |         +-$agg1#22 :=
    |         |                 |         | +-AggregateFunctionCall(GoogleSQL:any_value(STRING) -> STRING)
    |         |                 |         |   +-ColumnRef(type=STRING, column=$union_all.value#19)
    |         |                 |         +-$agg2#25 :=
    |         |                 |           +-AggregateFunctionCall(GoogleSQL:max(INT64) -> INT64)
    |         |                 |             +-ColumnRef(type=INT64, column=$union_all.is_delete_key#20)
    |         |                 +-filter_expr=
    |         |                   +-FunctionCall(GoogleSQL:$equal(INT64, INT64) -> BOOL)
    |         |                     +-ColumnRef(type=INT64, column=$aggregate.$agg2#25)
    |         |                     +-Literal(type=INT64, value=0)
    |         +-input_scan=
    |           +-ProjectScan
    |             +-column_list=$subquery1.[input_map#2, key#3, repeated_key_1#4, repeated_key_2#5, repeated_key_3#6]
    |             +-expr_list=
    |             | +-input_map#2 :=
    |             | | +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<INT64, STRING>>) -> MAP<INT64, STRING>)
    |             | |   +-Literal(type=ARRAY<STRUCT<INT64, STRING>>, value=[{1, "a"}, {2, "b"}, {3, "c"}, {4, "d"}, {5, "e"}])
    |             | +-key#3 := Literal(type=INT64, value=1)
    |             | +-repeated_key_1#4 := Literal(type=INT64, value=3)
    |             | +-repeated_key_2#5 := Literal(type=INT64, value=5)
    |             | +-repeated_key_3#6 := Literal(type=INT64, value=4)
    |             +-input_scan=
    |               +-SingleRowScan
    +-input_scan=
      +-SingleRowScan
[SQLBUILDER_OUTPUT]
SELECT
  (
    SELECT
      `IF`((projectscan_7.a_2) IS NULL, CAST(NULL AS MAP< INT64, STRING >), MAP_FROM_ARRAY(ARRAY(
            SELECT
              projectscan_28.a_27 AS a_27
            FROM
              (
                SELECT
                  aggregatescan_26.a_24 AS a_24,
                  aggregatescan_26.a_23 AS a_23,
                  STRUCT< key INT64, STRING > (aggregatescan_26.a_23, aggregatescan_26.a_24) AS a_27,
                  aggregatescan_26.a_25 AS a_25
                FROM
                  (
                    SELECT
                      setoperationscan_22.a_10 AS a_23,
                      ANY_VALUE(setoperationscan_22.a_11) AS a_24,
                      MAX(setoperationscan_22.a_12) AS a_25
                    FROM
                      ((
                        SELECT
                          a_9.key AS a_10,
                          a_9.value AS a_11,
                          0 AS a_12
                        FROM
                          UNNEST(MAP_ENTRIES_UNSORTED(projectscan_7.a_2)) AS a_9
                        ) UNION ALL(
                        SELECT
                          projectscan_20.a_13 AS a_13,
                          CAST(NULL AS STRING) AS a_21,
                          projectscan_20.a_19 AS a_19
                        FROM
                          (
                            SELECT
                              setoperationscan_17.a_13 AS a_13,
                              CAST(NULL AS INT64) AS a_18,
                              1 AS a_19
                            FROM
                              ((
                                SELECT
                                  projectscan_7.a_3 AS a_13
                                ) UNION ALL(
                                SELECT
                                  projectscan_7.a_4 AS a_14
                                ) UNION ALL(
                                SELECT
                                  projectscan_7.a_5 AS a_15
                                ) UNION ALL(
                                SELECT
                                  projectscan_7.a_6 AS a_16
                                )
                              ) AS setoperationscan_17
                          ) AS projectscan_20
                        )
                      ) AS setoperationscan_22
                    GROUP BY 1
                  ) AS aggregatescan_26
              ) AS projectscan_28
            WHERE
              (projectscan_28.a_25) = 0
          ))) AS a_8
    FROM
      (
        SELECT
          MAP_FROM_ARRAY(ARRAY< STRUCT< INT64, STRING > >[STRUCT< INT64, STRING > (1, "a"), STRUCT< INT64, STRING >
            (2, "b"), STRUCT< INT64, STRING > (3, "c"), STRUCT< INT64, STRING > (4, "d"), STRUCT< INT64, STRING >
            (5, "e")]) AS a_2,
          1 AS a_3,
          3 AS a_4,
          5 AS a_5,
          4 AS a_6
      ) AS projectscan_7
  ) AS a_1;
