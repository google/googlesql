[default language_features=NONE,+MAP_TYPE,+ORDER_BY_IN_AGGREGATE,+HAVING_IN_AGGREGATE,+INLINE_LAMBDA_ARGUMENT]
[enabled_ast_rewrites=NONE,+VARIADIC_FUNCTION_SIGNATURE_EXPANDER,+BUILTIN_FUNCTION_INLINER]
# Test that other variadic functions are not affected by the rewriter.
SELECT
  MAP_INSERT(MAP_FROM_ARRAY([STRUCT(0 AS k, 0 AS v)]), 1, 1, 2, 2),
  COALESCE(NULL, 1, 2),
  FORMAT('%d-%d', 1, 2)
--
QueryStmt
+-output_column_list=
| +-$query.$col1#1 AS `$col1` [MAP<INT64, INT64>]
| +-$query.$col2#2 AS `$col2` [INT64]
| +-$query.$col3#3 AS `$col3` [STRING]
+-query=
  +-ProjectScan
    +-column_list=$query.[$col1#1, $col2#2, $col3#3]
    +-expr_list=
    | +-$col1#1 :=
    | | +-FunctionCall(GoogleSQL:map_insert(MAP<INT64, INT64> input_map, INT64 key, INT64 value, repeated(1) INT64 repeated_key, repeated(1) INT64 repeated_value) -> MAP<INT64, INT64>)
    | |   +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<k INT64, v INT64>>) -> MAP<INT64, INT64>)
    | |   | +-Literal(type=ARRAY<STRUCT<k INT64, v INT64>>, value=[{k:0, v:0}])
    | |   +-Literal(type=INT64, value=1)
    | |   +-Literal(type=INT64, value=1)
    | |   +-Literal(type=INT64, value=2)
    | |   +-Literal(type=INT64, value=2)
    | +-$col2#2 :=
    | | +-FunctionCall(GoogleSQL:coalesce(repeated(3) INT64) -> INT64)
    | |   +-Literal(type=INT64, value=NULL)
    | |   +-Literal(type=INT64, value=1)
    | |   +-Literal(type=INT64, value=2)
    | +-$col3#3 :=
    |   +-FunctionCall(GoogleSQL:format(STRING, repeated(1) INT64, repeated(1) INT64) -> STRING)
    |     +-Literal(type=STRING, value="%d-%d")
    |     +-Literal(type=INT64, value=1)
    |     +-Literal(type=INT64, value=2)
    +-input_scan=
      +-SingleRowScan

[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-$query.$col1#1 AS `$col1` [MAP<INT64, INT64>]
| +-$query.$col2#2 AS `$col2` [INT64]
| +-$query.$col3#3 AS `$col3` [STRING]
+-query=
  +-ProjectScan
    +-column_list=$query.[$col1#1, $col2#2, $col3#3]
    +-expr_list=
    | +-$col1#1 :=
    | | +-SubqueryExpr
    | |   +-type=MAP<INT64, INT64>
    | |   +-subquery_type=SCALAR
    | |   +-subquery=
    | |     +-ProjectScan
    | |       +-column_list=[$expr_subquery.$col1#29]
    | |       +-expr_list=
    | |       | +-$col1#29 :=
    | |       |   +-FunctionCall(GoogleSQL:if(BOOL, MAP<INT64, INT64>, MAP<INT64, INT64>) -> MAP<INT64, INT64>)
    | |       |     +-FunctionCall(GoogleSQL:$is_null(MAP<INT64, INT64>) -> BOOL)
    | |       |     | +-ColumnRef(type=MAP<INT64, INT64>, column=$subquery1.input_map#4)
    | |       |     +-Literal(type=MAP<INT64, INT64>, value=NULL)
    | |       |     +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<key INT64, INT64>>) -> MAP<INT64, INT64>)
    | |       |       +-SubqueryExpr
    | |       |         +-type=ARRAY<STRUCT<key INT64, INT64>>
    | |       |         +-subquery_type=ARRAY
    | |       |         +-parameter_list=
    | |       |         | +-ColumnRef(type=MAP<INT64, INT64>, column=$subquery1.input_map#4)
    | |       |         | +-ColumnRef(type=INT64, column=$subquery1.key#5)
    | |       |         | +-ColumnRef(type=INT64, column=$subquery1.repeated_key_1#6)
    | |       |         | +-ColumnRef(type=INT64, column=$subquery1.repeated_value_1#7)
    | |       |         | +-ColumnRef(type=INT64, column=$subquery1.value#8)
    | |       |         +-subquery=
    | |       |           +-ProjectScan
    | |       |             +-column_list=[$expr_subquery.$col1#28]
    | |       |             +-expr_list=
    | |       |             | +-$col1#28 :=
    | |       |             |   +-FunctionCall(GoogleSQL:$case_no_value(repeated(2) BOOL, repeated(2) STRUCT<key INT64, INT64>, STRUCT<key INT64, INT64>) -> STRUCT<key INT64, INT64>)
    | |       |             |     +-FunctionCall(GoogleSQL:$greater(INT64, INT64) -> BOOL)
    | |       |             |     | +-ColumnRef(type=INT64, column=$aggregate.$agg1#23)
    | |       |             |     | +-Literal(type=INT64, value=1)
    | |       |             |     +-Cast(STRUCT<key INT64, INT64> -> STRUCT<key INT64, INT64>)
    | |       |             |     | +-FunctionCall(GoogleSQL:error(STRING) -> STRUCT<key INT64, INT64>)
    | |       |             |     |   +-FunctionCall(GoogleSQL:format(STRING, repeated(1) INT64) -> STRING)
    | |       |             |     |     +-Literal(type=STRING, value="Key provided more than once as argument: %T")
    | |       |             |     |     +-ColumnRef(type=INT64, column=$groupby.key#27)
    | |       |             |     +-FunctionCall(GoogleSQL:$and(BOOL, repeated(1) BOOL) -> BOOL)
    | |       |             |     | +-FunctionCall(GoogleSQL:$equal(INT64, INT64) -> BOOL)
    | |       |             |     | | +-ColumnRef(type=INT64, column=$aggregate.$agg2#24)
    | |       |             |     | | +-Literal(type=INT64, value=1)
    | |       |             |     | +-FunctionCall(GoogleSQL:$greater(INT64, INT64) -> BOOL)
    | |       |             |     |   +-ColumnRef(type=INT64, column=$aggregate.$agg3#25)
    | |       |             |     |   +-Literal(type=INT64, value=1)
    | |       |             |     +-Cast(STRUCT<key INT64, INT64> -> STRUCT<key INT64, INT64>)
    | |       |             |     | +-FunctionCall(GoogleSQL:error(STRING) -> STRUCT<key INT64, INT64>)
    | |       |             |     |   +-FunctionCall(GoogleSQL:format(STRING, repeated(1) INT64) -> STRING)
    | |       |             |     |     +-Literal(type=STRING, value="Key already exists in map: %T")
    | |       |             |     |     +-ColumnRef(type=INT64, column=$groupby.key#27)
    | |       |             |     +-MakeStruct
    | |       |             |       +-type=STRUCT<key INT64, INT64>
    | |       |             |       +-field_list=
    | |       |             |         +-ColumnRef(type=INT64, column=$groupby.key#27)
    | |       |             |         +-ColumnRef(type=INT64, column=$aggregate.$agg4#26)
    | |       |             +-input_scan=
    | |       |               +-AggregateScan
    | |       |                 +-column_list=[$groupby.key#27, $aggregate.$agg1#23, $aggregate.$agg2#24, $aggregate.$agg3#25, $aggregate.$agg4#26]
    | |       |                 +-input_scan=
    | |       |                 | +-SetOperationScan
    | |       |                 |   +-column_list=$union_all.[key#20, value#21, is_new#22]
    | |       |                 |   +-op_type=UNION_ALL
    | |       |                 |   +-input_item_list=
    | |       |                 |     +-SetOperationItem
    | |       |                 |     | +-scan=
    | |       |                 |     | | +-ProjectScan
    | |       |                 |     | |   +-column_list=$union_all1.[key#10, value#11, is_new#12]
    | |       |                 |     | |   +-expr_list=
    | |       |                 |     | |   | +-key#10 :=
    | |       |                 |     | |   | | +-GetStructField
    | |       |                 |     | |   | |   +-type=INT64
    | |       |                 |     | |   | |   +-expr=
    | |       |                 |     | |   | |   | +-ColumnRef(type=STRUCT<key INT64, value INT64>, column=$array.t#9)
    | |       |                 |     | |   | |   +-field_idx=0
    | |       |                 |     | |   | +-value#11 :=
    | |       |                 |     | |   | | +-GetStructField
    | |       |                 |     | |   | |   +-type=INT64
    | |       |                 |     | |   | |   +-expr=
    | |       |                 |     | |   | |   | +-ColumnRef(type=STRUCT<key INT64, value INT64>, column=$array.t#9)
    | |       |                 |     | |   | |   +-field_idx=1
    | |       |                 |     | |   | +-is_new#12 := Literal(type=INT64, value=0)
    | |       |                 |     | |   +-input_scan=
    | |       |                 |     | |     +-ArrayScan
    | |       |                 |     | |       +-column_list=[$array.t#9]
    | |       |                 |     | |       +-array_expr_list=
    | |       |                 |     | |       | +-FunctionCall(GoogleSQL:map_entries_unsorted(MAP<INT64, INT64>) -> ARRAY<STRUCT<key INT64, value INT64>>)
    | |       |                 |     | |       |   +-ColumnRef(type=MAP<INT64, INT64>, column=$subquery1.input_map#4, is_correlated=TRUE)
    | |       |                 |     | |       +-element_column_list=[$array.t#9]
    | |       |                 |     | +-output_column_list=$union_all1.[key#10, value#11, is_new#12]
    | |       |                 |     +-SetOperationItem
    | |       |                 |       +-scan=
    | |       |                 |       | +-ProjectScan
    | |       |                 |       |   +-column_list=[$union_all.key#17, $union_all.value#18, $union_all2.is_new#19]
    | |       |                 |       |   +-expr_list=
    | |       |                 |       |   | +-is_new#19 := Literal(type=INT64, value=1)
    | |       |                 |       |   +-input_scan=
    | |       |                 |       |     +-SetOperationScan
    | |       |                 |       |       +-column_list=$union_all.[key#17, value#18]
    | |       |                 |       |       +-op_type=UNION_ALL
    | |       |                 |       |       +-input_item_list=
    | |       |                 |       |         +-SetOperationItem
    | |       |                 |       |         | +-scan=
    | |       |                 |       |         | | +-ProjectScan
    | |       |                 |       |         | |   +-column_list=$union_all1.[key#13, value#14]
    | |       |                 |       |         | |   +-expr_list=
    | |       |                 |       |         | |   | +-key#13 := ColumnRef(type=INT64, column=$subquery1.key#5, is_correlated=TRUE)
    | |       |                 |       |         | |   | +-value#14 := ColumnRef(type=INT64, column=$subquery1.value#8, is_correlated=TRUE)
    | |       |                 |       |         | |   +-input_scan=
    | |       |                 |       |         | |     +-SingleRowScan
    | |       |                 |       |         | +-output_column_list=$union_all1.[key#13, value#14]
    | |       |                 |       |         +-SetOperationItem
    | |       |                 |       |           +-scan=
    | |       |                 |       |           | +-ProjectScan
    | |       |                 |       |           |   +-column_list=$union_all2.[key#15, value#16]
    | |       |                 |       |           |   +-expr_list=
    | |       |                 |       |           |   | +-key#15 := ColumnRef(type=INT64, column=$subquery1.repeated_key_1#6, is_correlated=TRUE)
    | |       |                 |       |           |   | +-value#16 := ColumnRef(type=INT64, column=$subquery1.repeated_value_1#7, is_correlated=TRUE)
    | |       |                 |       |           |   +-input_scan=
    | |       |                 |       |           |     +-SingleRowScan
    | |       |                 |       |           +-output_column_list=$union_all2.[key#15, value#16]
    | |       |                 |       +-output_column_list=[$union_all.key#17, $union_all.value#18, $union_all2.is_new#19]
    | |       |                 +-group_by_list=
    | |       |                 | +-key#27 := ColumnRef(type=INT64, column=$union_all.key#20)
    | |       |                 +-aggregate_list=
    | |       |                   +-$agg1#23 :=
    | |       |                   | +-AggregateFunctionCall(GoogleSQL:sum(INT64) -> INT64)
    | |       |                   |   +-ColumnRef(type=INT64, column=$union_all.is_new#22)
    | |       |                   +-$agg2#24 :=
    | |       |                   | +-AggregateFunctionCall(GoogleSQL:sum(INT64) -> INT64)
    | |       |                   |   +-ColumnRef(type=INT64, column=$union_all.is_new#22)
    | |       |                   +-$agg3#25 := AggregateFunctionCall(GoogleSQL:$count_star() -> INT64)
    | |       |                   +-$agg4#26 :=
    | |       |                     +-AggregateFunctionCall(GoogleSQL:any_value(INT64) -> INT64)
    | |       |                       +-ColumnRef(type=INT64, column=$union_all.value#21)
    | |       |                       +-having_modifier=
    | |       |                         +-AggregateHavingModifier
    | |       |                           +-kind=MAX
    | |       |                           +-having_expr=
    | |       |                             +-ColumnRef(type=INT64, column=$union_all.is_new#22)
    | |       +-input_scan=
    | |         +-ProjectScan
    | |           +-column_list=$subquery1.[input_map#4, key#5, repeated_key_1#6, repeated_value_1#7, value#8]
    | |           +-expr_list=
    | |           | +-input_map#4 :=
    | |           | | +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<k INT64, v INT64>>) -> MAP<INT64, INT64>)
    | |           | |   +-Literal(type=ARRAY<STRUCT<k INT64, v INT64>>, value=[{k:0, v:0}])
    | |           | +-key#5 := Literal(type=INT64, value=1)
    | |           | +-repeated_key_1#6 := Literal(type=INT64, value=2)
    | |           | +-repeated_value_1#7 := Literal(type=INT64, value=2)
    | |           | +-value#8 := Literal(type=INT64, value=1)
    | |           +-input_scan=
    | |             +-SingleRowScan
    | +-$col2#2 :=
    | | +-FunctionCall(GoogleSQL:coalesce(repeated(3) INT64) -> INT64)
    | |   +-Literal(type=INT64, value=NULL)
    | |   +-Literal(type=INT64, value=1)
    | |   +-Literal(type=INT64, value=2)
    | +-$col3#3 :=
    |   +-FunctionCall(GoogleSQL:format(STRING, repeated(1) INT64, repeated(1) INT64) -> STRING)
    |     +-Literal(type=STRING, value="%d-%d")
    |     +-Literal(type=INT64, value=1)
    |     +-Literal(type=INT64, value=2)
    +-input_scan=
      +-SingleRowScan
==

# Test with struct value arguments
[enabled_ast_rewrites=NONE,+VARIADIC_FUNCTION_SIGNATURE_EXPANDER,+BUILTIN_FUNCTION_INLINER]
SELECT
  MAP_INSERT_OR_REPLACE(
    MAP_FROM_ARRAY([STRUCT(1 AS key, STRUCT(1 AS a) AS value)]),
    1,
    STRUCT(2 AS a),
    3,
    STRUCT(3 AS a))
--
QueryStmt
+-output_column_list=
| +-$query.$col1#1 AS `$col1` [MAP<INT64, STRUCT<a INT64>>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#1]
    +-expr_list=
    | +-$col1#1 :=
    |   +-FunctionCall(GoogleSQL:map_insert_or_replace(MAP<INT64, STRUCT<a INT64>> input_map, INT64 key, STRUCT<a INT64> value, repeated(1) INT64 repeated_key, repeated(1) STRUCT<a INT64> repeated_value) -> MAP<INT64, STRUCT<a INT64>>)
    |     +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<key INT64, value STRUCT<a INT64>>>) -> MAP<INT64, STRUCT<a INT64>>)
    |     | +-Literal(type=ARRAY<STRUCT<key INT64, value STRUCT<a INT64>>>, value=[{key:1, value:{a:1}}])
    |     +-Literal(type=INT64, value=1)
    |     +-Literal(type=STRUCT<a INT64>, value={a:2})
    |     +-Literal(type=INT64, value=3)
    |     +-Literal(type=STRUCT<a INT64>, value={a:3})
    +-input_scan=
      +-SingleRowScan

[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-$query.$col1#1 AS `$col1` [MAP<INT64, STRUCT<a INT64>>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#1]
    +-expr_list=
    | +-$col1#1 :=
    |   +-SubqueryExpr
    |     +-type=MAP<INT64, STRUCT<a INT64>>
    |     +-subquery_type=SCALAR
    |     +-subquery=
    |       +-ProjectScan
    |         +-column_list=[$expr_subquery.$col1#25]
    |         +-expr_list=
    |         | +-$col1#25 :=
    |         |   +-FunctionCall(GoogleSQL:if(BOOL, MAP<INT64, STRUCT<a INT64>>, MAP<INT64, STRUCT<a INT64>>) -> MAP<INT64, STRUCT<a INT64>>)
    |         |     +-FunctionCall(GoogleSQL:$is_null(MAP<INT64, STRUCT<a INT64>>) -> BOOL)
    |         |     | +-ColumnRef(type=MAP<INT64, STRUCT<a INT64>>, column=$subquery1.input_map#2)
    |         |     +-Literal(type=MAP<INT64, STRUCT<a INT64>>, value=NULL)
    |         |     +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<key INT64, STRUCT<a INT64>>>) -> MAP<INT64, STRUCT<a INT64>>)
    |         |       +-SubqueryExpr
    |         |         +-type=ARRAY<STRUCT<key INT64, STRUCT<a INT64>>>
    |         |         +-subquery_type=ARRAY
    |         |         +-parameter_list=
    |         |         | +-ColumnRef(type=MAP<INT64, STRUCT<a INT64>>, column=$subquery1.input_map#2)
    |         |         | +-ColumnRef(type=INT64, column=$subquery1.key#3)
    |         |         | +-ColumnRef(type=INT64, column=$subquery1.repeated_key_1#4)
    |         |         | +-ColumnRef(type=STRUCT<a INT64>, column=$subquery1.repeated_value_1#5)
    |         |         | +-ColumnRef(type=STRUCT<a INT64>, column=$subquery1.value#6)
    |         |         +-subquery=
    |         |           +-ProjectScan
    |         |             +-column_list=[$expr_subquery.$col1#24]
    |         |             +-expr_list=
    |         |             | +-$col1#24 :=
    |         |             |   +-FunctionCall(GoogleSQL:$case_no_value(repeated(1) BOOL, repeated(1) STRUCT<key INT64, STRUCT<a INT64>>, STRUCT<key INT64, STRUCT<a INT64>>) -> STRUCT<key INT64, STRUCT<a INT64>>)
    |         |             |     +-FunctionCall(GoogleSQL:$greater(INT64, INT64) -> BOOL)
    |         |             |     | +-ColumnRef(type=INT64, column=$aggregate.$agg1#21)
    |         |             |     | +-Literal(type=INT64, value=1)
    |         |             |     +-Cast(STRUCT<key INT64, STRUCT<a INT64>> -> STRUCT<key INT64, STRUCT<a INT64>>)
    |         |             |     | +-FunctionCall(GoogleSQL:error(STRING) -> STRUCT<key INT64, STRUCT<a INT64>>)
    |         |             |     |   +-FunctionCall(GoogleSQL:format(STRING, repeated(1) INT64) -> STRING)
    |         |             |     |     +-Literal(type=STRING, value="Key provided more than once as argument: %T")
    |         |             |     |     +-ColumnRef(type=INT64, column=$groupby.key#23)
    |         |             |     +-MakeStruct
    |         |             |       +-type=STRUCT<key INT64, STRUCT<a INT64>>
    |         |             |       +-field_list=
    |         |             |         +-ColumnRef(type=INT64, column=$groupby.key#23)
    |         |             |         +-ColumnRef(type=STRUCT<a INT64>, column=$aggregate.$agg2#22)
    |         |             +-input_scan=
    |         |               +-AggregateScan
    |         |                 +-column_list=[$groupby.key#23, $aggregate.$agg1#21, $aggregate.$agg2#22]
    |         |                 +-input_scan=
    |         |                 | +-SetOperationScan
    |         |                 |   +-column_list=$union_all.[key#18, value#19, is_new#20]
    |         |                 |   +-op_type=UNION_ALL
    |         |                 |   +-input_item_list=
    |         |                 |     +-SetOperationItem
    |         |                 |     | +-scan=
    |         |                 |     | | +-ProjectScan
    |         |                 |     | |   +-column_list=$union_all1.[key#8, value#9, is_new#10]
    |         |                 |     | |   +-expr_list=
    |         |                 |     | |   | +-key#8 :=
    |         |                 |     | |   | | +-GetStructField
    |         |                 |     | |   | |   +-type=INT64
    |         |                 |     | |   | |   +-expr=
    |         |                 |     | |   | |   | +-ColumnRef(type=STRUCT<key INT64, value STRUCT<a INT64>>, column=$array.t#7)
    |         |                 |     | |   | |   +-field_idx=0
    |         |                 |     | |   | +-value#9 :=
    |         |                 |     | |   | | +-GetStructField
    |         |                 |     | |   | |   +-type=STRUCT<a INT64>
    |         |                 |     | |   | |   +-expr=
    |         |                 |     | |   | |   | +-ColumnRef(type=STRUCT<key INT64, value STRUCT<a INT64>>, column=$array.t#7)
    |         |                 |     | |   | |   +-field_idx=1
    |         |                 |     | |   | +-is_new#10 := Literal(type=INT64, value=0)
    |         |                 |     | |   +-input_scan=
    |         |                 |     | |     +-ArrayScan
    |         |                 |     | |       +-column_list=[$array.t#7]
    |         |                 |     | |       +-array_expr_list=
    |         |                 |     | |       | +-FunctionCall(GoogleSQL:map_entries_unsorted(MAP<INT64, STRUCT<a INT64>>) -> ARRAY<STRUCT<key INT64, value STRUCT<a INT64>>>)
    |         |                 |     | |       |   +-ColumnRef(type=MAP<INT64, STRUCT<a INT64>>, column=$subquery1.input_map#2, is_correlated=TRUE)
    |         |                 |     | |       +-element_column_list=[$array.t#7]
    |         |                 |     | +-output_column_list=$union_all1.[key#8, value#9, is_new#10]
    |         |                 |     +-SetOperationItem
    |         |                 |       +-scan=
    |         |                 |       | +-ProjectScan
    |         |                 |       |   +-column_list=[$union_all.key#15, $union_all.value#16, $union_all2.is_new#17]
    |         |                 |       |   +-expr_list=
    |         |                 |       |   | +-is_new#17 := Literal(type=INT64, value=1)
    |         |                 |       |   +-input_scan=
    |         |                 |       |     +-SetOperationScan
    |         |                 |       |       +-column_list=$union_all.[key#15, value#16]
    |         |                 |       |       +-op_type=UNION_ALL
    |         |                 |       |       +-input_item_list=
    |         |                 |       |         +-SetOperationItem
    |         |                 |       |         | +-scan=
    |         |                 |       |         | | +-ProjectScan
    |         |                 |       |         | |   +-column_list=$union_all1.[key#11, value#12]
    |         |                 |       |         | |   +-expr_list=
    |         |                 |       |         | |   | +-key#11 := ColumnRef(type=INT64, column=$subquery1.key#3, is_correlated=TRUE)
    |         |                 |       |         | |   | +-value#12 := ColumnRef(type=STRUCT<a INT64>, column=$subquery1.value#6, is_correlated=TRUE)
    |         |                 |       |         | |   +-input_scan=
    |         |                 |       |         | |     +-SingleRowScan
    |         |                 |       |         | +-output_column_list=$union_all1.[key#11, value#12]
    |         |                 |       |         +-SetOperationItem
    |         |                 |       |           +-scan=
    |         |                 |       |           | +-ProjectScan
    |         |                 |       |           |   +-column_list=$union_all2.[key#13, value#14]
    |         |                 |       |           |   +-expr_list=
    |         |                 |       |           |   | +-key#13 := ColumnRef(type=INT64, column=$subquery1.repeated_key_1#4, is_correlated=TRUE)
    |         |                 |       |           |   | +-value#14 := ColumnRef(type=STRUCT<a INT64>, column=$subquery1.repeated_value_1#5, is_correlated=TRUE)
    |         |                 |       |           |   +-input_scan=
    |         |                 |       |           |     +-SingleRowScan
    |         |                 |       |           +-output_column_list=$union_all2.[key#13, value#14]
    |         |                 |       +-output_column_list=[$union_all.key#15, $union_all.value#16, $union_all2.is_new#17]
    |         |                 +-group_by_list=
    |         |                 | +-key#23 := ColumnRef(type=INT64, column=$union_all.key#18)
    |         |                 +-aggregate_list=
    |         |                   +-$agg1#21 :=
    |         |                   | +-AggregateFunctionCall(GoogleSQL:sum(INT64) -> INT64)
    |         |                   |   +-ColumnRef(type=INT64, column=$union_all.is_new#20)
    |         |                   +-$agg2#22 :=
    |         |                     +-AggregateFunctionCall(GoogleSQL:any_value(STRUCT<a INT64>) -> STRUCT<a INT64>)
    |         |                       +-ColumnRef(type=STRUCT<a INT64>, column=$union_all.value#19)
    |         |                       +-having_modifier=
    |         |                         +-AggregateHavingModifier
    |         |                           +-kind=MAX
    |         |                           +-having_expr=
    |         |                             +-ColumnRef(type=INT64, column=$union_all.is_new#20)
    |         +-input_scan=
    |           +-ProjectScan
    |             +-column_list=$subquery1.[input_map#2, key#3, repeated_key_1#4, repeated_value_1#5, value#6]
    |             +-expr_list=
    |             | +-input_map#2 :=
    |             | | +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<key INT64, value STRUCT<a INT64>>>) -> MAP<INT64, STRUCT<a INT64>>)
    |             | |   +-Literal(type=ARRAY<STRUCT<key INT64, value STRUCT<a INT64>>>, value=[{key:1, value:{a:1}}])
    |             | +-key#3 := Literal(type=INT64, value=1)
    |             | +-repeated_key_1#4 := Literal(type=INT64, value=3)
    |             | +-repeated_value_1#5 := Literal(type=STRUCT<a INT64>, value={a:3})
    |             | +-value#6 := Literal(type=STRUCT<a INT64>, value={a:2})
    |             +-input_scan=
    |               +-SingleRowScan
    +-input_scan=
      +-SingleRowScan
==

# Test with array value arguments.
[enabled_ast_rewrites=NONE,+VARIADIC_FUNCTION_SIGNATURE_EXPANDER,+BUILTIN_FUNCTION_INLINER]
SELECT
  MAP_REPLACE(
    MAP_FROM_ARRAY([STRUCT(1 AS key, [1] AS value), STRUCT(2 AS key, [2, 2] AS value)]),
    1, [2,2],
    2, [4, 4, 4, 4])
--
QueryStmt
+-output_column_list=
| +-$query.$col1#1 AS `$col1` [MAP<INT64, ARRAY<INT64>>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#1]
    +-expr_list=
    | +-$col1#1 :=
    |   +-FunctionCall(GoogleSQL:map_replace(MAP<INT64, ARRAY<INT64>> input_map, INT64 key, ARRAY<INT64> value, repeated(1) INT64 repeated_key, repeated(1) ARRAY<INT64> repeated_value) -> MAP<INT64, ARRAY<INT64>>)
    |     +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<key INT64, value ARRAY<INT64>>>) -> MAP<INT64, ARRAY<INT64>>)
    |     | +-Literal(type=ARRAY<STRUCT<key INT64, value ARRAY<INT64>>>, value=[{key:1, value:[1]}, {key:2, value:[2, 2]}])
    |     +-Literal(type=INT64, value=1)
    |     +-Literal(type=ARRAY<INT64>, value=[2, 2])
    |     +-Literal(type=INT64, value=2)
    |     +-Literal(type=ARRAY<INT64>, value=[4, 4, 4, 4])
    +-input_scan=
      +-SingleRowScan

[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-$query.$col1#1 AS `$col1` [MAP<INT64, ARRAY<INT64>>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#1]
    +-expr_list=
    | +-$col1#1 :=
    |   +-SubqueryExpr
    |     +-type=MAP<INT64, ARRAY<INT64>>
    |     +-subquery_type=SCALAR
    |     +-subquery=
    |       +-ProjectScan
    |         +-column_list=[$expr_subquery.$col1#26]
    |         +-expr_list=
    |         | +-$col1#26 :=
    |         |   +-FunctionCall(GoogleSQL:if(BOOL, MAP<INT64, ARRAY<INT64>>, MAP<INT64, ARRAY<INT64>>) -> MAP<INT64, ARRAY<INT64>>)
    |         |     +-FunctionCall(GoogleSQL:$is_null(MAP<INT64, ARRAY<INT64>>) -> BOOL)
    |         |     | +-ColumnRef(type=MAP<INT64, ARRAY<INT64>>, column=$subquery1.input_map#2)
    |         |     +-Literal(type=MAP<INT64, ARRAY<INT64>>, value=NULL)
    |         |     +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<key INT64, ARRAY<INT64>>>) -> MAP<INT64, ARRAY<INT64>>)
    |         |       +-SubqueryExpr
    |         |         +-type=ARRAY<STRUCT<key INT64, ARRAY<INT64>>>
    |         |         +-subquery_type=ARRAY
    |         |         +-parameter_list=
    |         |         | +-ColumnRef(type=MAP<INT64, ARRAY<INT64>>, column=$subquery1.input_map#2)
    |         |         | +-ColumnRef(type=INT64, column=$subquery1.key#3)
    |         |         | +-ColumnRef(type=INT64, column=$subquery1.repeated_key_1#4)
    |         |         | +-ColumnRef(type=ARRAY<INT64>, column=$subquery1.repeated_value_1#5)
    |         |         | +-ColumnRef(type=ARRAY<INT64>, column=$subquery1.value#6)
    |         |         +-subquery=
    |         |           +-ProjectScan
    |         |             +-column_list=[$expr_subquery.$col1#25]
    |         |             +-expr_list=
    |         |             | +-$col1#25 :=
    |         |             |   +-FunctionCall(GoogleSQL:$case_no_value(repeated(2) BOOL, repeated(2) STRUCT<key INT64, ARRAY<INT64>>, STRUCT<key INT64, ARRAY<INT64>>) -> STRUCT<key INT64, ARRAY<INT64>>)
    |         |             |     +-FunctionCall(GoogleSQL:$greater(INT64, INT64) -> BOOL)
    |         |             |     | +-ColumnRef(type=INT64, column=$aggregate.$agg1#21)
    |         |             |     | +-Literal(type=INT64, value=1)
    |         |             |     +-Cast(STRUCT<key INT64, ARRAY<INT64>> -> STRUCT<key INT64, ARRAY<INT64>>)
    |         |             |     | +-FunctionCall(GoogleSQL:error(STRING) -> STRUCT<key INT64, ARRAY<INT64>>)
    |         |             |     |   +-FunctionCall(GoogleSQL:format(STRING, repeated(1) INT64) -> STRING)
    |         |             |     |     +-Literal(type=STRING, value="Key provided more than once as argument: %T")
    |         |             |     |     +-ColumnRef(type=INT64, column=$groupby.key#24)
    |         |             |     +-FunctionCall(GoogleSQL:$equal(INT64, INT64) -> BOOL)
    |         |             |     | +-ColumnRef(type=INT64, column=$aggregate.$agg2#22)
    |         |             |     | +-Literal(type=INT64, value=1)
    |         |             |     +-Cast(STRUCT<key INT64, ARRAY<INT64>> -> STRUCT<key INT64, ARRAY<INT64>>)
    |         |             |     | +-FunctionCall(GoogleSQL:error(STRING) -> STRUCT<key INT64, ARRAY<INT64>>)
    |         |             |     |   +-FunctionCall(GoogleSQL:format(STRING, repeated(1) INT64) -> STRING)
    |         |             |     |     +-Literal(type=STRING, value="Key does not exist in map: %T")
    |         |             |     |     +-ColumnRef(type=INT64, column=$groupby.key#24)
    |         |             |     +-MakeStruct
    |         |             |       +-type=STRUCT<key INT64, ARRAY<INT64>>
    |         |             |       +-field_list=
    |         |             |         +-ColumnRef(type=INT64, column=$groupby.key#24)
    |         |             |         +-ColumnRef(type=ARRAY<INT64>, column=$aggregate.$agg3#23)
    |         |             +-input_scan=
    |         |               +-AggregateScan
    |         |                 +-column_list=[$groupby.key#24, $aggregate.$agg1#21, $aggregate.$agg2#22, $aggregate.$agg3#23]
    |         |                 +-input_scan=
    |         |                 | +-SetOperationScan
    |         |                 |   +-column_list=$union_all.[key#18, value#19, is_new#20]
    |         |                 |   +-op_type=UNION_ALL
    |         |                 |   +-input_item_list=
    |         |                 |     +-SetOperationItem
    |         |                 |     | +-scan=
    |         |                 |     | | +-ProjectScan
    |         |                 |     | |   +-column_list=$union_all1.[key#8, value#9, is_new#10]
    |         |                 |     | |   +-expr_list=
    |         |                 |     | |   | +-key#8 :=
    |         |                 |     | |   | | +-GetStructField
    |         |                 |     | |   | |   +-type=INT64
    |         |                 |     | |   | |   +-expr=
    |         |                 |     | |   | |   | +-ColumnRef(type=STRUCT<key INT64, value ARRAY<INT64>>, column=$array.t#7)
    |         |                 |     | |   | |   +-field_idx=0
    |         |                 |     | |   | +-value#9 :=
    |         |                 |     | |   | | +-GetStructField
    |         |                 |     | |   | |   +-type=ARRAY<INT64>
    |         |                 |     | |   | |   +-expr=
    |         |                 |     | |   | |   | +-ColumnRef(type=STRUCT<key INT64, value ARRAY<INT64>>, column=$array.t#7)
    |         |                 |     | |   | |   +-field_idx=1
    |         |                 |     | |   | +-is_new#10 := Literal(type=INT64, value=0)
    |         |                 |     | |   +-input_scan=
    |         |                 |     | |     +-ArrayScan
    |         |                 |     | |       +-column_list=[$array.t#7]
    |         |                 |     | |       +-array_expr_list=
    |         |                 |     | |       | +-FunctionCall(GoogleSQL:map_entries_unsorted(MAP<INT64, ARRAY<INT64>>) -> ARRAY<STRUCT<key INT64, value ARRAY<INT64>>>)
    |         |                 |     | |       |   +-ColumnRef(type=MAP<INT64, ARRAY<INT64>>, column=$subquery1.input_map#2, is_correlated=TRUE)
    |         |                 |     | |       +-element_column_list=[$array.t#7]
    |         |                 |     | +-output_column_list=$union_all1.[key#8, value#9, is_new#10]
    |         |                 |     +-SetOperationItem
    |         |                 |       +-scan=
    |         |                 |       | +-ProjectScan
    |         |                 |       |   +-column_list=[$union_all.key#15, $union_all.value#16, $union_all2.is_new#17]
    |         |                 |       |   +-expr_list=
    |         |                 |       |   | +-is_new#17 := Literal(type=INT64, value=1)
    |         |                 |       |   +-input_scan=
    |         |                 |       |     +-SetOperationScan
    |         |                 |       |       +-column_list=$union_all.[key#15, value#16]
    |         |                 |       |       +-op_type=UNION_ALL
    |         |                 |       |       +-input_item_list=
    |         |                 |       |         +-SetOperationItem
    |         |                 |       |         | +-scan=
    |         |                 |       |         | | +-ProjectScan
    |         |                 |       |         | |   +-column_list=$union_all1.[key#11, value#12]
    |         |                 |       |         | |   +-expr_list=
    |         |                 |       |         | |   | +-key#11 := ColumnRef(type=INT64, column=$subquery1.key#3, is_correlated=TRUE)
    |         |                 |       |         | |   | +-value#12 := ColumnRef(type=ARRAY<INT64>, column=$subquery1.value#6, is_correlated=TRUE)
    |         |                 |       |         | |   +-input_scan=
    |         |                 |       |         | |     +-SingleRowScan
    |         |                 |       |         | +-output_column_list=$union_all1.[key#11, value#12]
    |         |                 |       |         +-SetOperationItem
    |         |                 |       |           +-scan=
    |         |                 |       |           | +-ProjectScan
    |         |                 |       |           |   +-column_list=$union_all2.[key#13, value#14]
    |         |                 |       |           |   +-expr_list=
    |         |                 |       |           |   | +-key#13 := ColumnRef(type=INT64, column=$subquery1.repeated_key_1#4, is_correlated=TRUE)
    |         |                 |       |           |   | +-value#14 := ColumnRef(type=ARRAY<INT64>, column=$subquery1.repeated_value_1#5, is_correlated=TRUE)
    |         |                 |       |           |   +-input_scan=
    |         |                 |       |           |     +-SingleRowScan
    |         |                 |       |           +-output_column_list=$union_all2.[key#13, value#14]
    |         |                 |       +-output_column_list=[$union_all.key#15, $union_all.value#16, $union_all2.is_new#17]
    |         |                 +-group_by_list=
    |         |                 | +-key#24 := ColumnRef(type=INT64, column=$union_all.key#18)
    |         |                 +-aggregate_list=
    |         |                   +-$agg1#21 :=
    |         |                   | +-AggregateFunctionCall(GoogleSQL:sum(INT64) -> INT64)
    |         |                   |   +-ColumnRef(type=INT64, column=$union_all.is_new#20)
    |         |                   +-$agg2#22 :=
    |         |                   | +-AggregateFunctionCall(GoogleSQL:min(INT64) -> INT64)
    |         |                   |   +-ColumnRef(type=INT64, column=$union_all.is_new#20)
    |         |                   +-$agg3#23 :=
    |         |                     +-AggregateFunctionCall(GoogleSQL:any_value(ARRAY<INT64>) -> ARRAY<INT64>)
    |         |                       +-ColumnRef(type=ARRAY<INT64>, column=$union_all.value#19)
    |         |                       +-having_modifier=
    |         |                         +-AggregateHavingModifier
    |         |                           +-kind=MAX
    |         |                           +-having_expr=
    |         |                             +-ColumnRef(type=INT64, column=$union_all.is_new#20)
    |         +-input_scan=
    |           +-ProjectScan
    |             +-column_list=$subquery1.[input_map#2, key#3, repeated_key_1#4, repeated_value_1#5, value#6]
    |             +-expr_list=
    |             | +-input_map#2 :=
    |             | | +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<key INT64, value ARRAY<INT64>>>) -> MAP<INT64, ARRAY<INT64>>)
    |             | |   +-Literal(type=ARRAY<STRUCT<key INT64, value ARRAY<INT64>>>, value=[{key:1, value:[1]}, {key:2, value:[2, 2]}])
    |             | +-key#3 := Literal(type=INT64, value=1)
    |             | +-repeated_key_1#4 := Literal(type=INT64, value=2)
    |             | +-repeated_value_1#5 := Literal(type=ARRAY<INT64>, value=[4, 4, 4, 4])
    |             | +-value#6 := Literal(type=ARRAY<INT64>, value=[2, 2])
    |             +-input_scan=
    |               +-SingleRowScan
    +-input_scan=
      +-SingleRowScan
==

# Test that control flow functions aren't affected by the rewriter.
[enabled_ast_rewrites=NONE,+VARIADIC_FUNCTION_SIGNATURE_EXPANDER,+BUILTIN_FUNCTION_INLINER]
SELECT
  MAP_REPLACE(
    MAP_FROM_ARRAY([STRUCT("a" AS k, 1 AS v), STRUCT("b" AS k, 2 AS v), STRUCT("c" AS k, 3 AS v)]),
    "a",
    "c",
    v ->
      IF(v > 0, COALESCE(v, 0), 1)
      + (CASE WHEN v = 1 THEN 1 ELSE 2 END))
--
QueryStmt
+-output_column_list=
| +-$query.$col1#2 AS `$col1` [MAP<STRING, INT64>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#2]
    +-expr_list=
    | +-$col1#2 :=
    |   +-FunctionCall(GoogleSQL:map_replace(MAP<STRING, INT64> input_map, STRING key, repeated(1) STRING repeated_key, FUNCTION<INT64->INT64> updater_lambda) -> MAP<STRING, INT64>)
    |     +-FunctionArgument
    |     | +-expr=
    |     |   +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<k STRING, v INT64>>) -> MAP<STRING, INT64>)
    |     |     +-Literal(type=ARRAY<STRUCT<k STRING, v INT64>>, value=[{k:"a", v:1}, {k:"b", v:2}, {k:"c", v:3}])
    |     +-FunctionArgument
    |     | +-expr=
    |     |   +-Literal(type=STRING, value="a")
    |     +-FunctionArgument
    |     | +-expr=
    |     |   +-Literal(type=STRING, value="c")
    |     +-FunctionArgument
    |       +-inline_lambda=
    |         +-InlineLambda
    |           +-argument_list=[$lambda_arg.v#1]
    |           +-body=
    |             +-FunctionCall(GoogleSQL:$add(INT64, INT64) -> INT64)
    |               +-FunctionCall(GoogleSQL:if(BOOL, INT64, INT64) -> INT64)
    |               | +-FunctionCall(GoogleSQL:$greater(INT64, INT64) -> BOOL)
    |               | | +-ColumnRef(type=INT64, column=$lambda_arg.v#1)
    |               | | +-Literal(type=INT64, value=0)
    |               | +-FunctionCall(GoogleSQL:coalesce(repeated(2) INT64) -> INT64)
    |               | | +-ColumnRef(type=INT64, column=$lambda_arg.v#1)
    |               | | +-Literal(type=INT64, value=0)
    |               | +-Literal(type=INT64, value=1)
    |               +-FunctionCall(GoogleSQL:$case_no_value(repeated(1) BOOL, repeated(1) INT64, INT64) -> INT64)
    |                 +-FunctionCall(GoogleSQL:$equal(INT64, INT64) -> BOOL)
    |                 | +-ColumnRef(type=INT64, column=$lambda_arg.v#1)
    |                 | +-Literal(type=INT64, value=1)
    |                 +-Literal(type=INT64, value=1)
    |                 +-Literal(type=INT64, value=2)
    +-input_scan=
      +-SingleRowScan

[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-$query.$col1#2 AS `$col1` [MAP<STRING, INT64>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#2]
    +-expr_list=
    | +-$col1#2 :=
    |   +-SubqueryExpr
    |     +-type=MAP<STRING, INT64>
    |     +-subquery_type=SCALAR
    |     +-subquery=
    |       +-ProjectScan
    |         +-column_list=[$expr_subquery.$col1#25]
    |         +-expr_list=
    |         | +-$col1#25 :=
    |         |   +-FunctionCall(GoogleSQL:if(BOOL, MAP<STRING, INT64>, MAP<STRING, INT64>) -> MAP<STRING, INT64>)
    |         |     +-FunctionCall(GoogleSQL:$is_null(MAP<STRING, INT64>) -> BOOL)
    |         |     | +-ColumnRef(type=MAP<STRING, INT64>, column=$subquery1.input_map#3)
    |         |     +-Literal(type=MAP<STRING, INT64>, value=NULL)
    |         |     +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<key STRING, INT64>>) -> MAP<STRING, INT64>)
    |         |       +-SubqueryExpr
    |         |         +-type=ARRAY<STRUCT<key STRING, INT64>>
    |         |         +-subquery_type=ARRAY
    |         |         +-parameter_list=
    |         |         | +-ColumnRef(type=MAP<STRING, INT64>, column=$subquery1.input_map#3)
    |         |         | +-ColumnRef(type=STRING, column=$subquery1.key#4)
    |         |         | +-ColumnRef(type=STRING, column=$subquery1.repeated_key_1#5)
    |         |         +-subquery=
    |         |           +-ProjectScan
    |         |             +-column_list=[$expr_subquery.$col1#24]
    |         |             +-expr_list=
    |         |             | +-$col1#24 :=
    |         |             |   +-FunctionCall(GoogleSQL:$case_no_value(repeated(2) BOOL, repeated(2) STRUCT<key STRING, INT64>, STRUCT<key STRING, INT64>) -> STRUCT<key STRING, INT64>)
    |         |             |     +-FunctionCall(GoogleSQL:$greater(INT64, INT64) -> BOOL)
    |         |             |     | +-ColumnRef(type=INT64, column=$aggregate.$agg1#18)
    |         |             |     | +-Literal(type=INT64, value=1)
    |         |             |     +-Cast(STRUCT<key STRING, INT64> -> STRUCT<key STRING, INT64>)
    |         |             |     | +-FunctionCall(GoogleSQL:error(STRING) -> STRUCT<key STRING, INT64>)
    |         |             |     |   +-FunctionCall(GoogleSQL:format(STRING, repeated(1) STRING) -> STRING)
    |         |             |     |     +-Literal(type=STRING, value="Key provided more than once as argument: %T")
    |         |             |     |     +-ColumnRef(type=STRING, column=$groupby.key#23)
    |         |             |     +-FunctionCall(GoogleSQL:$equal(INT64, INT64) -> BOOL)
    |         |             |     | +-ColumnRef(type=INT64, column=$aggregate.$agg2#19)
    |         |             |     | +-Literal(type=INT64, value=1)
    |         |             |     +-Cast(STRUCT<key STRING, INT64> -> STRUCT<key STRING, INT64>)
    |         |             |     | +-FunctionCall(GoogleSQL:error(STRING) -> STRUCT<key STRING, INT64>)
    |         |             |     |   +-FunctionCall(GoogleSQL:format(STRING, repeated(1) STRING) -> STRING)
    |         |             |     |     +-Literal(type=STRING, value="Key does not exist in map: %T")
    |         |             |     |     +-ColumnRef(type=STRING, column=$groupby.key#23)
    |         |             |     +-MakeStruct
    |         |             |       +-type=STRUCT<key STRING, INT64>
    |         |             |       +-field_list=
    |         |             |         +-ColumnRef(type=STRING, column=$groupby.key#23)
    |         |             |         +-FunctionCall(GoogleSQL:if(BOOL, INT64, INT64) -> INT64)
    |         |             |           +-FunctionCall(GoogleSQL:$equal(INT64, INT64) -> BOOL)
    |         |             |           | +-ColumnRef(type=INT64, column=$aggregate.$agg3#20)
    |         |             |           | +-Literal(type=INT64, value=1)
    |         |             |           +-FunctionCall(GoogleSQL:$add(INT64, INT64) -> INT64)
    |         |             |           | +-FunctionCall(GoogleSQL:if(BOOL, INT64, INT64) -> INT64)
    |         |             |           | | +-FunctionCall(GoogleSQL:$greater(INT64, INT64) -> BOOL)
    |         |             |           | | | +-ColumnRef(type=INT64, column=$aggregate.$agg4#21)
    |         |             |           | | | +-Literal(type=INT64, value=0)
    |         |             |           | | +-FunctionCall(GoogleSQL:coalesce(repeated(2) INT64) -> INT64)
    |         |             |           | | | +-ColumnRef(type=INT64, column=$aggregate.$agg4#21)
    |         |             |           | | | +-Literal(type=INT64, value=0)
    |         |             |           | | +-Literal(type=INT64, value=1)
    |         |             |           | +-FunctionCall(GoogleSQL:$case_no_value(repeated(1) BOOL, repeated(1) INT64, INT64) -> INT64)
    |         |             |           |   +-FunctionCall(GoogleSQL:$equal(INT64, INT64) -> BOOL)
    |         |             |           |   | +-ColumnRef(type=INT64, column=$aggregate.$agg4#21)
    |         |             |           |   | +-Literal(type=INT64, value=1)
    |         |             |           |   +-Literal(type=INT64, value=1)
    |         |             |           |   +-Literal(type=INT64, value=2)
    |         |             |           +-ColumnRef(type=INT64, column=$aggregate.$agg5#22)
    |         |             +-input_scan=
    |         |               +-AggregateScan
    |         |                 +-column_list=[$groupby.key#23, $aggregate.$agg1#18, $aggregate.$agg2#19, $aggregate.$agg3#20, $aggregate.$agg4#21, $aggregate.$agg5#22]
    |         |                 +-input_scan=
    |         |                 | +-SetOperationScan
    |         |                 |   +-column_list=$union_all.[key#15, value#16, is_new#17]
    |         |                 |   +-op_type=UNION_ALL
    |         |                 |   +-input_item_list=
    |         |                 |     +-SetOperationItem
    |         |                 |     | +-scan=
    |         |                 |     | | +-ProjectScan
    |         |                 |     | |   +-column_list=$union_all1.[key#7, value#8, is_new#9]
    |         |                 |     | |   +-expr_list=
    |         |                 |     | |   | +-key#7 :=
    |         |                 |     | |   | | +-GetStructField
    |         |                 |     | |   | |   +-type=STRING
    |         |                 |     | |   | |   +-expr=
    |         |                 |     | |   | |   | +-ColumnRef(type=STRUCT<key STRING, value INT64>, column=$array.t#6)
    |         |                 |     | |   | |   +-field_idx=0
    |         |                 |     | |   | +-value#8 :=
    |         |                 |     | |   | | +-GetStructField
    |         |                 |     | |   | |   +-type=INT64
    |         |                 |     | |   | |   +-expr=
    |         |                 |     | |   | |   | +-ColumnRef(type=STRUCT<key STRING, value INT64>, column=$array.t#6)
    |         |                 |     | |   | |   +-field_idx=1
    |         |                 |     | |   | +-is_new#9 := Literal(type=INT64, value=0)
    |         |                 |     | |   +-input_scan=
    |         |                 |     | |     +-ArrayScan
    |         |                 |     | |       +-column_list=[$array.t#6]
    |         |                 |     | |       +-array_expr_list=
    |         |                 |     | |       | +-FunctionCall(GoogleSQL:map_entries_unsorted(MAP<STRING, INT64>) -> ARRAY<STRUCT<key STRING, value INT64>>)
    |         |                 |     | |       |   +-ColumnRef(type=MAP<STRING, INT64>, column=$subquery1.input_map#3, is_correlated=TRUE)
    |         |                 |     | |       +-element_column_list=[$array.t#6]
    |         |                 |     | +-output_column_list=$union_all1.[key#7, value#8, is_new#9]
    |         |                 |     +-SetOperationItem
    |         |                 |       +-scan=
    |         |                 |       | +-ProjectScan
    |         |                 |       |   +-column_list=[$union_all.key#12, $union_all2.value#13, $union_all2.is_new#14]
    |         |                 |       |   +-expr_list=
    |         |                 |       |   | +-value#13 := Literal(type=INT64, value=NULL)
    |         |                 |       |   | +-is_new#14 := Literal(type=INT64, value=1)
    |         |                 |       |   +-input_scan=
    |         |                 |       |     +-SetOperationScan
    |         |                 |       |       +-column_list=[$union_all.key#12]
    |         |                 |       |       +-op_type=UNION_ALL
    |         |                 |       |       +-input_item_list=
    |         |                 |       |         +-SetOperationItem
    |         |                 |       |         | +-scan=
    |         |                 |       |         | | +-ProjectScan
    |         |                 |       |         | |   +-column_list=[$union_all1.key#10]
    |         |                 |       |         | |   +-expr_list=
    |         |                 |       |         | |   | +-key#10 := ColumnRef(type=STRING, column=$subquery1.key#4, is_correlated=TRUE)
    |         |                 |       |         | |   +-input_scan=
    |         |                 |       |         | |     +-SingleRowScan
    |         |                 |       |         | +-output_column_list=[$union_all1.key#10]
    |         |                 |       |         +-SetOperationItem
    |         |                 |       |           +-scan=
    |         |                 |       |           | +-ProjectScan
    |         |                 |       |           |   +-column_list=[$union_all2.key#11]
    |         |                 |       |           |   +-expr_list=
    |         |                 |       |           |   | +-key#11 := ColumnRef(type=STRING, column=$subquery1.repeated_key_1#5, is_correlated=TRUE)
    |         |                 |       |           |   +-input_scan=
    |         |                 |       |           |     +-SingleRowScan
    |         |                 |       |           +-output_column_list=[$union_all2.key#11]
    |         |                 |       +-output_column_list=[$union_all.key#12, $union_all2.value#13, $union_all2.is_new#14]
    |         |                 +-group_by_list=
    |         |                 | +-key#23 := ColumnRef(type=STRING, column=$union_all.key#15)
    |         |                 +-aggregate_list=
    |         |                   +-$agg1#18 :=
    |         |                   | +-AggregateFunctionCall(GoogleSQL:sum(INT64) -> INT64)
    |         |                   |   +-ColumnRef(type=INT64, column=$union_all.is_new#17)
    |         |                   +-$agg2#19 :=
    |         |                   | +-AggregateFunctionCall(GoogleSQL:min(INT64) -> INT64)
    |         |                   |   +-ColumnRef(type=INT64, column=$union_all.is_new#17)
    |         |                   +-$agg3#20 :=
    |         |                   | +-AggregateFunctionCall(GoogleSQL:max(INT64) -> INT64)
    |         |                   |   +-ColumnRef(type=INT64, column=$union_all.is_new#17)
    |         |                   +-$agg4#21 :=
    |         |                   | +-AggregateFunctionCall(GoogleSQL:any_value(INT64) -> INT64)
    |         |                   |   +-ColumnRef(type=INT64, column=$union_all.value#16)
    |         |                   |   +-having_modifier=
    |         |                   |     +-AggregateHavingModifier
    |         |                   |       +-kind=MIN
    |         |                   |       +-having_expr=
    |         |                   |         +-ColumnRef(type=INT64, column=$union_all.is_new#17)
    |         |                   +-$agg5#22 :=
    |         |                     +-AggregateFunctionCall(GoogleSQL:any_value(INT64) -> INT64)
    |         |                       +-ColumnRef(type=INT64, column=$union_all.value#16)
    |         +-input_scan=
    |           +-ProjectScan
    |             +-column_list=$subquery1.[input_map#3, key#4, repeated_key_1#5]
    |             +-expr_list=
    |             | +-input_map#3 :=
    |             | | +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<k STRING, v INT64>>) -> MAP<STRING, INT64>)
    |             | |   +-Literal(type=ARRAY<STRUCT<k STRING, v INT64>>, value=[{k:"a", v:1}, {k:"b", v:2}, {k:"c", v:3}])
    |             | +-key#4 := Literal(type=STRING, value="a")
    |             | +-repeated_key_1#5 := Literal(type=STRING, value="c")
    |             +-input_scan=
    |               +-SingleRowScan
    +-input_scan=
      +-SingleRowScan
==

# Test MAP_REPLACE with lambda which contains another variadic map function,
# which should also be expanded by the rewriter.
[enabled_ast_rewrites=NONE,+VARIADIC_FUNCTION_SIGNATURE_EXPANDER,+BUILTIN_FUNCTION_INLINER]
SELECT
  MAP_REPLACE(
    MAP_FROM_ARRAY([
      STRUCT("a" AS k, MAP_FROM_ARRAY([STRUCT(0 AS k, 0 AS v)]) AS v),
      STRUCT("b" AS k, MAP_FROM_ARRAY([STRUCT(0 AS k, 0 AS v)]) AS v)
    ]),
    "a", "b",
    v -> MAP_INSERT(v, 1, 1, 2, 2)
  )
--
QueryStmt
+-output_column_list=
| +-$query.$col1#2 AS `$col1` [MAP<STRING, MAP<INT64, INT64>>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#2]
    +-expr_list=
    | +-$col1#2 :=
    |   +-FunctionCall(GoogleSQL:map_replace(MAP<STRING, MAP<INT64, INT64>> input_map, STRING key, repeated(1) STRING repeated_key, FUNCTION<MAP<INT64, INT64>->MAP<INT64, INT64>> updater_lambda) -> MAP<STRING, MAP<INT64, INT64>>)
    |     +-FunctionArgument
    |     | +-expr=
    |     |   +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<k STRING, v MAP<INT64, INT64>>>) -> MAP<STRING, MAP<INT64, INT64>>)
    |     |     +-FunctionCall(GoogleSQL:$make_array(repeated(2) STRUCT<k STRING, v MAP<INT64, INT64>>) -> ARRAY<STRUCT<k STRING, v MAP<INT64, INT64>>>)
    |     |       +-MakeStruct
    |     |       | +-type=STRUCT<k STRING, v MAP<INT64, INT64>>
    |     |       | +-field_list=
    |     |       |   +-Literal(type=STRING, value="a")
    |     |       |   +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<k INT64, v INT64>>) -> MAP<INT64, INT64>)
    |     |       |     +-Literal(type=ARRAY<STRUCT<k INT64, v INT64>>, value=[{k:0, v:0}])
    |     |       +-MakeStruct
    |     |         +-type=STRUCT<k STRING, v MAP<INT64, INT64>>
    |     |         +-field_list=
    |     |           +-Literal(type=STRING, value="b")
    |     |           +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<k INT64, v INT64>>) -> MAP<INT64, INT64>)
    |     |             +-Literal(type=ARRAY<STRUCT<k INT64, v INT64>>, value=[{k:0, v:0}])
    |     +-FunctionArgument
    |     | +-expr=
    |     |   +-Literal(type=STRING, value="a")
    |     +-FunctionArgument
    |     | +-expr=
    |     |   +-Literal(type=STRING, value="b")
    |     +-FunctionArgument
    |       +-inline_lambda=
    |         +-InlineLambda
    |           +-argument_list=[$lambda_arg.v#1]
    |           +-body=
    |             +-FunctionCall(GoogleSQL:map_insert(MAP<INT64, INT64> input_map, INT64 key, INT64 value, repeated(1) INT64 repeated_key, repeated(1) INT64 repeated_value) -> MAP<INT64, INT64>)
    |               +-ColumnRef(type=MAP<INT64, INT64>, column=$lambda_arg.v#1)
    |               +-Literal(type=INT64, value=1)
    |               +-Literal(type=INT64, value=1)
    |               +-Literal(type=INT64, value=2)
    |               +-Literal(type=INT64, value=2)
    +-input_scan=
      +-SingleRowScan

[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-$query.$col1#2 AS `$col1` [MAP<STRING, MAP<INT64, INT64>>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#2]
    +-expr_list=
    | +-$col1#2 :=
    |   +-SubqueryExpr
    |     +-type=MAP<STRING, MAP<INT64, INT64>>
    |     +-subquery_type=SCALAR
    |     +-subquery=
    |       +-ProjectScan
    |         +-column_list=[$expr_subquery.$col1#52]
    |         +-expr_list=
    |         | +-$col1#52 :=
    |         |   +-FunctionCall(GoogleSQL:if(BOOL, MAP<STRING, MAP<INT64, INT64>>, MAP<STRING, MAP<INT64, INT64>>) -> MAP<STRING, MAP<INT64, INT64>>)
    |         |     +-FunctionCall(GoogleSQL:$is_null(MAP<STRING, MAP<INT64, INT64>>) -> BOOL)
    |         |     | +-ColumnRef(type=MAP<STRING, MAP<INT64, INT64>>, column=$subquery1.input_map#29)
    |         |     +-Literal(type=MAP<STRING, MAP<INT64, INT64>>, value=NULL)
    |         |     +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<key STRING, MAP<INT64, INT64>>>) -> MAP<STRING, MAP<INT64, INT64>>)
    |         |       +-SubqueryExpr
    |         |         +-type=ARRAY<STRUCT<key STRING, MAP<INT64, INT64>>>
    |         |         +-subquery_type=ARRAY
    |         |         +-parameter_list=
    |         |         | +-ColumnRef(type=MAP<STRING, MAP<INT64, INT64>>, column=$subquery1.input_map#29)
    |         |         | +-ColumnRef(type=STRING, column=$subquery1.key#30)
    |         |         | +-ColumnRef(type=STRING, column=$subquery1.repeated_key_1#31)
    |         |         +-subquery=
    |         |           +-ProjectScan
    |         |             +-column_list=[$expr_subquery.$col1#51]
    |         |             +-expr_list=
    |         |             | +-$col1#51 :=
    |         |             |   +-FunctionCall(GoogleSQL:$case_no_value(repeated(2) BOOL, repeated(2) STRUCT<key STRING, MAP<INT64, INT64>>, STRUCT<key STRING, MAP<INT64, INT64>>) -> STRUCT<key STRING, MAP<INT64, INT64>>)
    |         |             |     +-FunctionCall(GoogleSQL:$greater(INT64, INT64) -> BOOL)
    |         |             |     | +-ColumnRef(type=INT64, column=$aggregate.$agg1#45)
    |         |             |     | +-Literal(type=INT64, value=1)
    |         |             |     +-Cast(STRUCT<key STRING, MAP<INT64, INT64>> -> STRUCT<key STRING, MAP<INT64, INT64>>)
    |         |             |     | +-FunctionCall(GoogleSQL:error(STRING) -> STRUCT<key STRING, MAP<INT64, INT64>>)
    |         |             |     |   +-FunctionCall(GoogleSQL:format(STRING, repeated(1) STRING) -> STRING)
    |         |             |     |     +-Literal(type=STRING, value="Key provided more than once as argument: %T")
    |         |             |     |     +-ColumnRef(type=STRING, column=$groupby.key#50)
    |         |             |     +-FunctionCall(GoogleSQL:$equal(INT64, INT64) -> BOOL)
    |         |             |     | +-ColumnRef(type=INT64, column=$aggregate.$agg2#46)
    |         |             |     | +-Literal(type=INT64, value=1)
    |         |             |     +-Cast(STRUCT<key STRING, MAP<INT64, INT64>> -> STRUCT<key STRING, MAP<INT64, INT64>>)
    |         |             |     | +-FunctionCall(GoogleSQL:error(STRING) -> STRUCT<key STRING, MAP<INT64, INT64>>)
    |         |             |     |   +-FunctionCall(GoogleSQL:format(STRING, repeated(1) STRING) -> STRING)
    |         |             |     |     +-Literal(type=STRING, value="Key does not exist in map: %T")
    |         |             |     |     +-ColumnRef(type=STRING, column=$groupby.key#50)
    |         |             |     +-MakeStruct
    |         |             |       +-type=STRUCT<key STRING, MAP<INT64, INT64>>
    |         |             |       +-field_list=
    |         |             |         +-ColumnRef(type=STRING, column=$groupby.key#50)
    |         |             |         +-FunctionCall(GoogleSQL:if(BOOL, MAP<INT64, INT64>, MAP<INT64, INT64>) -> MAP<INT64, INT64>)
    |         |             |           +-FunctionCall(GoogleSQL:$equal(INT64, INT64) -> BOOL)
    |         |             |           | +-ColumnRef(type=INT64, column=$aggregate.$agg3#47)
    |         |             |           | +-Literal(type=INT64, value=1)
    |         |             |           +-SubqueryExpr
    |         |             |           | +-type=MAP<INT64, INT64>
    |         |             |           | +-subquery_type=SCALAR
    |         |             |           | +-parameter_list=
    |         |             |           | | +-ColumnRef(type=MAP<INT64, INT64>, column=$aggregate.$agg4#48)
    |         |             |           | +-subquery=
    |         |             |           |   +-ProjectScan
    |         |             |           |     +-column_list=[$expr_subquery.$col1#53]
    |         |             |           |     +-expr_list=
    |         |             |           |     | +-$col1#53 :=
    |         |             |           |     |   +-FunctionCall(GoogleSQL:if(BOOL, MAP<INT64, INT64>, MAP<INT64, INT64>) -> MAP<INT64, INT64>)
    |         |             |           |     |     +-FunctionCall(GoogleSQL:$is_null(MAP<INT64, INT64>) -> BOOL)
    |         |             |           |     |     | +-ColumnRef(type=MAP<INT64, INT64>, column=$subquery1.input_map#54)
    |         |             |           |     |     +-Literal(type=MAP<INT64, INT64>, value=NULL)
    |         |             |           |     |     +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<key INT64, INT64>>) -> MAP<INT64, INT64>)
    |         |             |           |     |       +-SubqueryExpr
    |         |             |           |     |         +-type=ARRAY<STRUCT<key INT64, INT64>>
    |         |             |           |     |         +-subquery_type=ARRAY
    |         |             |           |     |         +-parameter_list=
    |         |             |           |     |         | +-ColumnRef(type=MAP<INT64, INT64>, column=$subquery1.input_map#54)
    |         |             |           |     |         | +-ColumnRef(type=INT64, column=$subquery1.key#55)
    |         |             |           |     |         | +-ColumnRef(type=INT64, column=$subquery1.repeated_key_1#56)
    |         |             |           |     |         | +-ColumnRef(type=INT64, column=$subquery1.repeated_value_1#57)
    |         |             |           |     |         | +-ColumnRef(type=INT64, column=$subquery1.value#58)
    |         |             |           |     |         +-subquery=
    |         |             |           |     |           +-ProjectScan
    |         |             |           |     |             +-column_list=[$expr_subquery.$col1#59]
    |         |             |           |     |             +-expr_list=
    |         |             |           |     |             | +-$col1#59 :=
    |         |             |           |     |             |   +-FunctionCall(GoogleSQL:$case_no_value(repeated(2) BOOL, repeated(2) STRUCT<key INT64, INT64>, STRUCT<key INT64, INT64>) -> STRUCT<key INT64, INT64>)
    |         |             |           |     |             |     +-FunctionCall(GoogleSQL:$greater(INT64, INT64) -> BOOL)
    |         |             |           |     |             |     | +-ColumnRef(type=INT64, column=$aggregate.$agg1#60)
    |         |             |           |     |             |     | +-Literal(type=INT64, value=1)
    |         |             |           |     |             |     +-Cast(STRUCT<key INT64, INT64> -> STRUCT<key INT64, INT64>)
    |         |             |           |     |             |     | +-FunctionCall(GoogleSQL:error(STRING) -> STRUCT<key INT64, INT64>)
    |         |             |           |     |             |     |   +-FunctionCall(GoogleSQL:format(STRING, repeated(1) INT64) -> STRING)
    |         |             |           |     |             |     |     +-Literal(type=STRING, value="Key provided more than once as argument: %T")
    |         |             |           |     |             |     |     +-ColumnRef(type=INT64, column=$groupby.key#61)
    |         |             |           |     |             |     +-FunctionCall(GoogleSQL:$and(BOOL, repeated(1) BOOL) -> BOOL)
    |         |             |           |     |             |     | +-FunctionCall(GoogleSQL:$equal(INT64, INT64) -> BOOL)
    |         |             |           |     |             |     | | +-ColumnRef(type=INT64, column=$aggregate.$agg2#62)
    |         |             |           |     |             |     | | +-Literal(type=INT64, value=1)
    |         |             |           |     |             |     | +-FunctionCall(GoogleSQL:$greater(INT64, INT64) -> BOOL)
    |         |             |           |     |             |     |   +-ColumnRef(type=INT64, column=$aggregate.$agg3#63)
    |         |             |           |     |             |     |   +-Literal(type=INT64, value=1)
    |         |             |           |     |             |     +-Cast(STRUCT<key INT64, INT64> -> STRUCT<key INT64, INT64>)
    |         |             |           |     |             |     | +-FunctionCall(GoogleSQL:error(STRING) -> STRUCT<key INT64, INT64>)
    |         |             |           |     |             |     |   +-FunctionCall(GoogleSQL:format(STRING, repeated(1) INT64) -> STRING)
    |         |             |           |     |             |     |     +-Literal(type=STRING, value="Key already exists in map: %T")
    |         |             |           |     |             |     |     +-ColumnRef(type=INT64, column=$groupby.key#61)
    |         |             |           |     |             |     +-MakeStruct
    |         |             |           |     |             |       +-type=STRUCT<key INT64, INT64>
    |         |             |           |     |             |       +-field_list=
    |         |             |           |     |             |         +-ColumnRef(type=INT64, column=$groupby.key#61)
    |         |             |           |     |             |         +-ColumnRef(type=INT64, column=$aggregate.$agg4#64)
    |         |             |           |     |             +-input_scan=
    |         |             |           |     |               +-AggregateScan
    |         |             |           |     |                 +-column_list=[$groupby.key#61, $aggregate.$agg1#60, $aggregate.$agg2#62, $aggregate.$agg3#63, $aggregate.$agg4#64]
    |         |             |           |     |                 +-input_scan=
    |         |             |           |     |                 | +-SetOperationScan
    |         |             |           |     |                 |   +-column_list=$union_all.[key#76, value#77, is_new#78]
    |         |             |           |     |                 |   +-op_type=UNION_ALL
    |         |             |           |     |                 |   +-input_item_list=
    |         |             |           |     |                 |     +-SetOperationItem
    |         |             |           |     |                 |     | +-scan=
    |         |             |           |     |                 |     | | +-ProjectScan
    |         |             |           |     |                 |     | |   +-column_list=$union_all1.[key#65, value#67, is_new#68]
    |         |             |           |     |                 |     | |   +-expr_list=
    |         |             |           |     |                 |     | |   | +-key#65 :=
    |         |             |           |     |                 |     | |   | | +-GetStructField
    |         |             |           |     |                 |     | |   | |   +-type=INT64
    |         |             |           |     |                 |     | |   | |   +-expr=
    |         |             |           |     |                 |     | |   | |   | +-ColumnRef(type=STRUCT<key INT64, value INT64>, column=$array.t#66)
    |         |             |           |     |                 |     | |   | |   +-field_idx=0
    |         |             |           |     |                 |     | |   | +-value#67 :=
    |         |             |           |     |                 |     | |   | | +-GetStructField
    |         |             |           |     |                 |     | |   | |   +-type=INT64
    |         |             |           |     |                 |     | |   | |   +-expr=
    |         |             |           |     |                 |     | |   | |   | +-ColumnRef(type=STRUCT<key INT64, value INT64>, column=$array.t#66)
    |         |             |           |     |                 |     | |   | |   +-field_idx=1
    |         |             |           |     |                 |     | |   | +-is_new#68 := Literal(type=INT64, value=0)
    |         |             |           |     |                 |     | |   +-input_scan=
    |         |             |           |     |                 |     | |     +-ArrayScan
    |         |             |           |     |                 |     | |       +-column_list=[$array.t#66]
    |         |             |           |     |                 |     | |       +-array_expr_list=
    |         |             |           |     |                 |     | |       | +-FunctionCall(GoogleSQL:map_entries_unsorted(MAP<INT64, INT64>) -> ARRAY<STRUCT<key INT64, value INT64>>)
    |         |             |           |     |                 |     | |       |   +-ColumnRef(type=MAP<INT64, INT64>, column=$subquery1.input_map#54, is_correlated=TRUE)
    |         |             |           |     |                 |     | |       +-element_column_list=[$array.t#66]
    |         |             |           |     |                 |     | +-output_column_list=$union_all1.[key#65, value#67, is_new#68]
    |         |             |           |     |                 |     +-SetOperationItem
    |         |             |           |     |                 |       +-scan=
    |         |             |           |     |                 |       | +-ProjectScan
    |         |             |           |     |                 |       |   +-column_list=[$union_all.key#74, $union_all.value#75, $union_all2.is_new#69]
    |         |             |           |     |                 |       |   +-expr_list=
    |         |             |           |     |                 |       |   | +-is_new#69 := Literal(type=INT64, value=1)
    |         |             |           |     |                 |       |   +-input_scan=
    |         |             |           |     |                 |       |     +-SetOperationScan
    |         |             |           |     |                 |       |       +-column_list=$union_all.[key#74, value#75]
    |         |             |           |     |                 |       |       +-op_type=UNION_ALL
    |         |             |           |     |                 |       |       +-input_item_list=
    |         |             |           |     |                 |       |         +-SetOperationItem
    |         |             |           |     |                 |       |         | +-scan=
    |         |             |           |     |                 |       |         | | +-ProjectScan
    |         |             |           |     |                 |       |         | |   +-column_list=$union_all1.[key#70, value#71]
    |         |             |           |     |                 |       |         | |   +-expr_list=
    |         |             |           |     |                 |       |         | |   | +-key#70 := ColumnRef(type=INT64, column=$subquery1.key#55, is_correlated=TRUE)
    |         |             |           |     |                 |       |         | |   | +-value#71 := ColumnRef(type=INT64, column=$subquery1.value#58, is_correlated=TRUE)
    |         |             |           |     |                 |       |         | |   +-input_scan=
    |         |             |           |     |                 |       |         | |     +-SingleRowScan
    |         |             |           |     |                 |       |         | +-output_column_list=$union_all1.[key#70, value#71]
    |         |             |           |     |                 |       |         +-SetOperationItem
    |         |             |           |     |                 |       |           +-scan=
    |         |             |           |     |                 |       |           | +-ProjectScan
    |         |             |           |     |                 |       |           |   +-column_list=$union_all2.[key#72, value#73]
    |         |             |           |     |                 |       |           |   +-expr_list=
    |         |             |           |     |                 |       |           |   | +-key#72 := ColumnRef(type=INT64, column=$subquery1.repeated_key_1#56, is_correlated=TRUE)
    |         |             |           |     |                 |       |           |   | +-value#73 := ColumnRef(type=INT64, column=$subquery1.repeated_value_1#57, is_correlated=TRUE)
    |         |             |           |     |                 |       |           |   +-input_scan=
    |         |             |           |     |                 |       |           |     +-SingleRowScan
    |         |             |           |     |                 |       |           +-output_column_list=$union_all2.[key#72, value#73]
    |         |             |           |     |                 |       +-output_column_list=[$union_all.key#74, $union_all.value#75, $union_all2.is_new#69]
    |         |             |           |     |                 +-group_by_list=
    |         |             |           |     |                 | +-key#61 := ColumnRef(type=INT64, column=$union_all.key#76)
    |         |             |           |     |                 +-aggregate_list=
    |         |             |           |     |                   +-$agg1#60 :=
    |         |             |           |     |                   | +-AggregateFunctionCall(GoogleSQL:sum(INT64) -> INT64)
    |         |             |           |     |                   |   +-ColumnRef(type=INT64, column=$union_all.is_new#78)
    |         |             |           |     |                   +-$agg2#62 :=
    |         |             |           |     |                   | +-AggregateFunctionCall(GoogleSQL:sum(INT64) -> INT64)
    |         |             |           |     |                   |   +-ColumnRef(type=INT64, column=$union_all.is_new#78)
    |         |             |           |     |                   +-$agg3#63 := AggregateFunctionCall(GoogleSQL:$count_star() -> INT64)
    |         |             |           |     |                   +-$agg4#64 :=
    |         |             |           |     |                     +-AggregateFunctionCall(GoogleSQL:any_value(INT64) -> INT64)
    |         |             |           |     |                       +-ColumnRef(type=INT64, column=$union_all.value#77)
    |         |             |           |     |                       +-having_modifier=
    |         |             |           |     |                         +-AggregateHavingModifier
    |         |             |           |     |                           +-kind=MAX
    |         |             |           |     |                           +-having_expr=
    |         |             |           |     |                             +-ColumnRef(type=INT64, column=$union_all.is_new#78)
    |         |             |           |     +-input_scan=
    |         |             |           |       +-ProjectScan
    |         |             |           |         +-column_list=$subquery1.[input_map#54, key#55, repeated_key_1#56, repeated_value_1#57, value#58]
    |         |             |           |         +-expr_list=
    |         |             |           |         | +-input_map#54 := ColumnRef(type=MAP<INT64, INT64>, column=$aggregate.$agg4#48, is_correlated=TRUE)
    |         |             |           |         | +-key#55 := Literal(type=INT64, value=1)
    |         |             |           |         | +-repeated_key_1#56 := Literal(type=INT64, value=2)
    |         |             |           |         | +-repeated_value_1#57 := Literal(type=INT64, value=2)
    |         |             |           |         | +-value#58 := Literal(type=INT64, value=1)
    |         |             |           |         +-input_scan=
    |         |             |           |           +-SingleRowScan
    |         |             |           +-ColumnRef(type=MAP<INT64, INT64>, column=$aggregate.$agg5#49)
    |         |             +-input_scan=
    |         |               +-AggregateScan
    |         |                 +-column_list=[$groupby.key#50, $aggregate.$agg1#45, $aggregate.$agg2#46, $aggregate.$agg3#47, $aggregate.$agg4#48, $aggregate.$agg5#49]
    |         |                 +-input_scan=
    |         |                 | +-SetOperationScan
    |         |                 |   +-column_list=$union_all.[key#41, value#42, is_new#43]
    |         |                 |   +-op_type=UNION_ALL
    |         |                 |   +-input_item_list=
    |         |                 |     +-SetOperationItem
    |         |                 |     | +-scan=
    |         |                 |     | | +-ProjectScan
    |         |                 |     | |   +-column_list=$union_all1.[key#33, value#34, is_new#35]
    |         |                 |     | |   +-expr_list=
    |         |                 |     | |   | +-key#33 :=
    |         |                 |     | |   | | +-GetStructField
    |         |                 |     | |   | |   +-type=STRING
    |         |                 |     | |   | |   +-expr=
    |         |                 |     | |   | |   | +-ColumnRef(type=STRUCT<key STRING, value MAP<INT64, INT64>>, column=$array.t#32)
    |         |                 |     | |   | |   +-field_idx=0
    |         |                 |     | |   | +-value#34 :=
    |         |                 |     | |   | | +-GetStructField
    |         |                 |     | |   | |   +-type=MAP<INT64, INT64>
    |         |                 |     | |   | |   +-expr=
    |         |                 |     | |   | |   | +-ColumnRef(type=STRUCT<key STRING, value MAP<INT64, INT64>>, column=$array.t#32)
    |         |                 |     | |   | |   +-field_idx=1
    |         |                 |     | |   | +-is_new#35 := Literal(type=INT64, value=0)
    |         |                 |     | |   +-input_scan=
    |         |                 |     | |     +-ArrayScan
    |         |                 |     | |       +-column_list=[$array.t#32]
    |         |                 |     | |       +-array_expr_list=
    |         |                 |     | |       | +-FunctionCall(GoogleSQL:map_entries_unsorted(MAP<STRING, MAP<INT64, INT64>>) -> ARRAY<STRUCT<key STRING, value MAP<INT64, INT64>>>)
    |         |                 |     | |       |   +-ColumnRef(type=MAP<STRING, MAP<INT64, INT64>>, column=$subquery1.input_map#29, is_correlated=TRUE)
    |         |                 |     | |       +-element_column_list=[$array.t#32]
    |         |                 |     | +-output_column_list=$union_all1.[key#33, value#34, is_new#35]
    |         |                 |     +-SetOperationItem
    |         |                 |       +-scan=
    |         |                 |       | +-ProjectScan
    |         |                 |       |   +-column_list=[$union_all.key#38, $union_all2_cast.value#44, $union_all2.is_new#40]
    |         |                 |       |   +-expr_list=
    |         |                 |       |   | +-value#44 := Literal(type=MAP<INT64, INT64>, value=NULL)
    |         |                 |       |   +-input_scan=
    |         |                 |       |     +-ProjectScan
    |         |                 |       |       +-column_list=[$union_all.key#38, $union_all2.value#39, $union_all2.is_new#40]
    |         |                 |       |       +-expr_list=
    |         |                 |       |       | +-value#39 := Literal(type=INT64, value=NULL)
    |         |                 |       |       | +-is_new#40 := Literal(type=INT64, value=1)
    |         |                 |       |       +-input_scan=
    |         |                 |       |         +-SetOperationScan
    |         |                 |       |           +-column_list=[$union_all.key#38]
    |         |                 |       |           +-op_type=UNION_ALL
    |         |                 |       |           +-input_item_list=
    |         |                 |       |             +-SetOperationItem
    |         |                 |       |             | +-scan=
    |         |                 |       |             | | +-ProjectScan
    |         |                 |       |             | |   +-column_list=[$union_all1.key#36]
    |         |                 |       |             | |   +-expr_list=
    |         |                 |       |             | |   | +-key#36 := ColumnRef(type=STRING, column=$subquery1.key#30, is_correlated=TRUE)
    |         |                 |       |             | |   +-input_scan=
    |         |                 |       |             | |     +-SingleRowScan
    |         |                 |       |             | +-output_column_list=[$union_all1.key#36]
    |         |                 |       |             +-SetOperationItem
    |         |                 |       |               +-scan=
    |         |                 |       |               | +-ProjectScan
    |         |                 |       |               |   +-column_list=[$union_all2.key#37]
    |         |                 |       |               |   +-expr_list=
    |         |                 |       |               |   | +-key#37 := ColumnRef(type=STRING, column=$subquery1.repeated_key_1#31, is_correlated=TRUE)
    |         |                 |       |               |   +-input_scan=
    |         |                 |       |               |     +-SingleRowScan
    |         |                 |       |               +-output_column_list=[$union_all2.key#37]
    |         |                 |       +-output_column_list=[$union_all.key#38, $union_all2_cast.value#44, $union_all2.is_new#40]
    |         |                 +-group_by_list=
    |         |                 | +-key#50 := ColumnRef(type=STRING, column=$union_all.key#41)
    |         |                 +-aggregate_list=
    |         |                   +-$agg1#45 :=
    |         |                   | +-AggregateFunctionCall(GoogleSQL:sum(INT64) -> INT64)
    |         |                   |   +-ColumnRef(type=INT64, column=$union_all.is_new#43)
    |         |                   +-$agg2#46 :=
    |         |                   | +-AggregateFunctionCall(GoogleSQL:min(INT64) -> INT64)
    |         |                   |   +-ColumnRef(type=INT64, column=$union_all.is_new#43)
    |         |                   +-$agg3#47 :=
    |         |                   | +-AggregateFunctionCall(GoogleSQL:max(INT64) -> INT64)
    |         |                   |   +-ColumnRef(type=INT64, column=$union_all.is_new#43)
    |         |                   +-$agg4#48 :=
    |         |                   | +-AggregateFunctionCall(GoogleSQL:any_value(MAP<INT64, INT64>) -> MAP<INT64, INT64>)
    |         |                   |   +-ColumnRef(type=MAP<INT64, INT64>, column=$union_all.value#42)
    |         |                   |   +-having_modifier=
    |         |                   |     +-AggregateHavingModifier
    |         |                   |       +-kind=MIN
    |         |                   |       +-having_expr=
    |         |                   |         +-ColumnRef(type=INT64, column=$union_all.is_new#43)
    |         |                   +-$agg5#49 :=
    |         |                     +-AggregateFunctionCall(GoogleSQL:any_value(MAP<INT64, INT64>) -> MAP<INT64, INT64>)
    |         |                       +-ColumnRef(type=MAP<INT64, INT64>, column=$union_all.value#42)
    |         +-input_scan=
    |           +-ProjectScan
    |             +-column_list=$subquery1.[input_map#29, key#30, repeated_key_1#31]
    |             +-expr_list=
    |             | +-input_map#29 :=
    |             | | +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<k STRING, v MAP<INT64, INT64>>>) -> MAP<STRING, MAP<INT64, INT64>>)
    |             | |   +-FunctionCall(GoogleSQL:$make_array(repeated(2) STRUCT<k STRING, v MAP<INT64, INT64>>) -> ARRAY<STRUCT<k STRING, v MAP<INT64, INT64>>>)
    |             | |     +-MakeStruct
    |             | |     | +-type=STRUCT<k STRING, v MAP<INT64, INT64>>
    |             | |     | +-field_list=
    |             | |     |   +-Literal(type=STRING, value="a")
    |             | |     |   +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<k INT64, v INT64>>) -> MAP<INT64, INT64>)
    |             | |     |     +-Literal(type=ARRAY<STRUCT<k INT64, v INT64>>, value=[{k:0, v:0}])
    |             | |     +-MakeStruct
    |             | |       +-type=STRUCT<k STRING, v MAP<INT64, INT64>>
    |             | |       +-field_list=
    |             | |         +-Literal(type=STRING, value="b")
    |             | |         +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<k INT64, v INT64>>) -> MAP<INT64, INT64>)
    |             | |           +-Literal(type=ARRAY<STRUCT<k INT64, v INT64>>, value=[{k:0, v:0}])
    |             | +-key#30 := Literal(type=STRING, value="a")
    |             | +-repeated_key_1#31 := Literal(type=STRING, value="b")
    |             +-input_scan=
    |               +-SingleRowScan
    +-input_scan=
      +-SingleRowScan
==

# Test that non-variadic MAP functions like MAP_FROM_ARRAY and
# MAP_ENTRIES_UNSORTED are not affected by the rewriter.
[enabled_ast_rewrites=NONE,+VARIADIC_FUNCTION_SIGNATURE_EXPANDER,+BUILTIN_FUNCTION_INLINER]
SELECT
  MAP_DELETE(MAP_FROM_ARRAY([STRUCT(0 AS k, 0 AS v), STRUCT(1 AS k, 1 AS v), STRUCT(2 AS k, 2 AS v)]), 1, 2, 3),
  MAP_FROM_ARRAY([STRUCT(1 as k, 1 as v)]),
  MAP_ENTRIES_UNSORTED(MAP_FROM_ARRAY([STRUCT(1 as k, 1 as v)]))
--
QueryStmt
+-output_column_list=
| +-$query.$col1#1 AS `$col1` [MAP<INT64, INT64>]
| +-$query.$col2#2 AS `$col2` [MAP<INT64, INT64>]
| +-$query.$col3#3 AS `$col3` [ARRAY<STRUCT<key INT64, value INT64>>]
+-query=
  +-ProjectScan
    +-column_list=$query.[$col1#1, $col2#2, $col3#3]
    +-expr_list=
    | +-$col1#1 :=
    | | +-FunctionCall(GoogleSQL:map_delete(MAP<INT64, INT64> input_map, INT64 key, repeated(2) INT64 repeated_key) -> MAP<INT64, INT64>)
    | |   +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<k INT64, v INT64>>) -> MAP<INT64, INT64>)
    | |   | +-Literal(type=ARRAY<STRUCT<k INT64, v INT64>>, value=[{k:0, v:0}, {k:1, v:1}, {k:2, v:2}])
    | |   +-Literal(type=INT64, value=1)
    | |   +-Literal(type=INT64, value=2)
    | |   +-Literal(type=INT64, value=3)
    | +-$col2#2 :=
    | | +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<k INT64, v INT64>>) -> MAP<INT64, INT64>)
    | |   +-Literal(type=ARRAY<STRUCT<k INT64, v INT64>>, value=[{k:1, v:1}])
    | +-$col3#3 :=
    |   +-FunctionCall(GoogleSQL:map_entries_unsorted(MAP<INT64, INT64>) -> ARRAY<STRUCT<key INT64, value INT64>>)
    |     +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<k INT64, v INT64>>) -> MAP<INT64, INT64>)
    |       +-Literal(type=ARRAY<STRUCT<k INT64, v INT64>>, value=[{k:1, v:1}])
    +-input_scan=
      +-SingleRowScan

[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-$query.$col1#1 AS `$col1` [MAP<INT64, INT64>]
| +-$query.$col2#2 AS `$col2` [MAP<INT64, INT64>]
| +-$query.$col3#3 AS `$col3` [ARRAY<STRUCT<key INT64, value INT64>>]
+-query=
  +-ProjectScan
    +-column_list=$query.[$col1#1, $col2#2, $col3#3]
    +-expr_list=
    | +-$col1#1 :=
    | | +-SubqueryExpr
    | |   +-type=MAP<INT64, INT64>
    | |   +-subquery_type=SCALAR
    | |   +-subquery=
    | |     +-ProjectScan
    | |       +-column_list=[$expr_subquery.$col1#25]
    | |       +-expr_list=
    | |       | +-$col1#25 :=
    | |       |   +-FunctionCall(GoogleSQL:if(BOOL, MAP<INT64, INT64>, MAP<INT64, INT64>) -> MAP<INT64, INT64>)
    | |       |     +-FunctionCall(GoogleSQL:$is_null(MAP<INT64, INT64>) -> BOOL)
    | |       |     | +-ColumnRef(type=MAP<INT64, INT64>, column=$subquery1.input_map#4)
    | |       |     +-Literal(type=MAP<INT64, INT64>, value=NULL)
    | |       |     +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<key INT64, INT64>>) -> MAP<INT64, INT64>)
    | |       |       +-SubqueryExpr
    | |       |         +-type=ARRAY<STRUCT<key INT64, INT64>>
    | |       |         +-subquery_type=ARRAY
    | |       |         +-parameter_list=
    | |       |         | +-ColumnRef(type=MAP<INT64, INT64>, column=$subquery1.input_map#4)
    | |       |         | +-ColumnRef(type=INT64, column=$subquery1.key#5)
    | |       |         | +-ColumnRef(type=INT64, column=$subquery1.repeated_key_1#6)
    | |       |         | +-ColumnRef(type=INT64, column=$subquery1.repeated_key_2#7)
    | |       |         +-subquery=
    | |       |           +-ProjectScan
    | |       |             +-column_list=[$expr_subquery.$col1#23]
    | |       |             +-input_scan=
    | |       |               +-FilterScan
    | |       |                 +-column_list=[$aggregate.$agg1#21, $groupby.key#22, $expr_subquery.$col1#23, $aggregate.$agg2#24]
    | |       |                 +-input_scan=
    | |       |                 | +-ProjectScan
    | |       |                 |   +-column_list=[$aggregate.$agg1#21, $groupby.key#22, $expr_subquery.$col1#23, $aggregate.$agg2#24]
    | |       |                 |   +-expr_list=
    | |       |                 |   | +-$col1#23 :=
    | |       |                 |   |   +-MakeStruct
    | |       |                 |   |     +-type=STRUCT<key INT64, INT64>
    | |       |                 |   |     +-field_list=
    | |       |                 |   |       +-ColumnRef(type=INT64, column=$groupby.key#22)
    | |       |                 |   |       +-ColumnRef(type=INT64, column=$aggregate.$agg1#21)
    | |       |                 |   +-input_scan=
    | |       |                 |     +-AggregateScan
    | |       |                 |       +-column_list=[$groupby.key#22, $aggregate.$agg1#21, $aggregate.$agg2#24]
    | |       |                 |       +-input_scan=
    | |       |                 |       | +-SetOperationScan
    | |       |                 |       |   +-column_list=$union_all.[key#18, value#19, is_delete_key#20]
    | |       |                 |       |   +-op_type=UNION_ALL
    | |       |                 |       |   +-input_item_list=
    | |       |                 |       |     +-SetOperationItem
    | |       |                 |       |     | +-scan=
    | |       |                 |       |     | | +-ProjectScan
    | |       |                 |       |     | |   +-column_list=$union_all1.[key#9, value#10, is_delete_key#11]
    | |       |                 |       |     | |   +-expr_list=
    | |       |                 |       |     | |   | +-key#9 :=
    | |       |                 |       |     | |   | | +-GetStructField
    | |       |                 |       |     | |   | |   +-type=INT64
    | |       |                 |       |     | |   | |   +-expr=
    | |       |                 |       |     | |   | |   | +-ColumnRef(type=STRUCT<key INT64, value INT64>, column=$array.t#8)
    | |       |                 |       |     | |   | |   +-field_idx=0
    | |       |                 |       |     | |   | +-value#10 :=
    | |       |                 |       |     | |   | | +-GetStructField
    | |       |                 |       |     | |   | |   +-type=INT64
    | |       |                 |       |     | |   | |   +-expr=
    | |       |                 |       |     | |   | |   | +-ColumnRef(type=STRUCT<key INT64, value INT64>, column=$array.t#8)
    | |       |                 |       |     | |   | |   +-field_idx=1
    | |       |                 |       |     | |   | +-is_delete_key#11 := Literal(type=INT64, value=0)
    | |       |                 |       |     | |   +-input_scan=
    | |       |                 |       |     | |     +-ArrayScan
    | |       |                 |       |     | |       +-column_list=[$array.t#8]
    | |       |                 |       |     | |       +-array_expr_list=
    | |       |                 |       |     | |       | +-FunctionCall(GoogleSQL:map_entries_unsorted(MAP<INT64, INT64>) -> ARRAY<STRUCT<key INT64, value INT64>>)
    | |       |                 |       |     | |       |   +-ColumnRef(type=MAP<INT64, INT64>, column=$subquery1.input_map#4, is_correlated=TRUE)
    | |       |                 |       |     | |       +-element_column_list=[$array.t#8]
    | |       |                 |       |     | +-output_column_list=$union_all1.[key#9, value#10, is_delete_key#11]
    | |       |                 |       |     +-SetOperationItem
    | |       |                 |       |       +-scan=
    | |       |                 |       |       | +-ProjectScan
    | |       |                 |       |       |   +-column_list=[$union_all.key#15, $union_all2.value#16, $union_all2.is_delete_key#17]
    | |       |                 |       |       |   +-expr_list=
    | |       |                 |       |       |   | +-value#16 := Literal(type=INT64, value=NULL)
    | |       |                 |       |       |   | +-is_delete_key#17 := Literal(type=INT64, value=1)
    | |       |                 |       |       |   +-input_scan=
    | |       |                 |       |       |     +-SetOperationScan
    | |       |                 |       |       |       +-column_list=[$union_all.key#15]
    | |       |                 |       |       |       +-op_type=UNION_ALL
    | |       |                 |       |       |       +-input_item_list=
    | |       |                 |       |       |         +-SetOperationItem
    | |       |                 |       |       |         | +-scan=
    | |       |                 |       |       |         | | +-ProjectScan
    | |       |                 |       |       |         | |   +-column_list=[$union_all1.key#12]
    | |       |                 |       |       |         | |   +-expr_list=
    | |       |                 |       |       |         | |   | +-key#12 := ColumnRef(type=INT64, column=$subquery1.key#5, is_correlated=TRUE)
    | |       |                 |       |       |         | |   +-input_scan=
    | |       |                 |       |       |         | |     +-SingleRowScan
    | |       |                 |       |       |         | +-output_column_list=[$union_all1.key#12]
    | |       |                 |       |       |         +-SetOperationItem
    | |       |                 |       |       |         | +-scan=
    | |       |                 |       |       |         | | +-ProjectScan
    | |       |                 |       |       |         | |   +-column_list=[$union_all2.key#13]
    | |       |                 |       |       |         | |   +-expr_list=
    | |       |                 |       |       |         | |   | +-key#13 := ColumnRef(type=INT64, column=$subquery1.repeated_key_1#6, is_correlated=TRUE)
    | |       |                 |       |       |         | |   +-input_scan=
    | |       |                 |       |       |         | |     +-SingleRowScan
    | |       |                 |       |       |         | +-output_column_list=[$union_all2.key#13]
    | |       |                 |       |       |         +-SetOperationItem
    | |       |                 |       |       |           +-scan=
    | |       |                 |       |       |           | +-ProjectScan
    | |       |                 |       |       |           |   +-column_list=[$union_all3.key#14]
    | |       |                 |       |       |           |   +-expr_list=
    | |       |                 |       |       |           |   | +-key#14 := ColumnRef(type=INT64, column=$subquery1.repeated_key_2#7, is_correlated=TRUE)
    | |       |                 |       |       |           |   +-input_scan=
    | |       |                 |       |       |           |     +-SingleRowScan
    | |       |                 |       |       |           +-output_column_list=[$union_all3.key#14]
    | |       |                 |       |       +-output_column_list=[$union_all.key#15, $union_all2.value#16, $union_all2.is_delete_key#17]
    | |       |                 |       +-group_by_list=
    | |       |                 |       | +-key#22 := ColumnRef(type=INT64, column=$union_all.key#18)
    | |       |                 |       +-aggregate_list=
    | |       |                 |         +-$agg1#21 :=
    | |       |                 |         | +-AggregateFunctionCall(GoogleSQL:any_value(INT64) -> INT64)
    | |       |                 |         |   +-ColumnRef(type=INT64, column=$union_all.value#19)
    | |       |                 |         +-$agg2#24 :=
    | |       |                 |           +-AggregateFunctionCall(GoogleSQL:max(INT64) -> INT64)
    | |       |                 |             +-ColumnRef(type=INT64, column=$union_all.is_delete_key#20)
    | |       |                 +-filter_expr=
    | |       |                   +-FunctionCall(GoogleSQL:$equal(INT64, INT64) -> BOOL)
    | |       |                     +-ColumnRef(type=INT64, column=$aggregate.$agg2#24)
    | |       |                     +-Literal(type=INT64, value=0)
    | |       +-input_scan=
    | |         +-ProjectScan
    | |           +-column_list=$subquery1.[input_map#4, key#5, repeated_key_1#6, repeated_key_2#7]
    | |           +-expr_list=
    | |           | +-input_map#4 :=
    | |           | | +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<k INT64, v INT64>>) -> MAP<INT64, INT64>)
    | |           | |   +-Literal(type=ARRAY<STRUCT<k INT64, v INT64>>, value=[{k:0, v:0}, {k:1, v:1}, {k:2, v:2}])
    | |           | +-key#5 := Literal(type=INT64, value=1)
    | |           | +-repeated_key_1#6 := Literal(type=INT64, value=2)
    | |           | +-repeated_key_2#7 := Literal(type=INT64, value=3)
    | |           +-input_scan=
    | |             +-SingleRowScan
    | +-$col2#2 :=
    | | +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<k INT64, v INT64>>) -> MAP<INT64, INT64>)
    | |   +-Literal(type=ARRAY<STRUCT<k INT64, v INT64>>, value=[{k:1, v:1}])
    | +-$col3#3 :=
    |   +-FunctionCall(GoogleSQL:map_entries_unsorted(MAP<INT64, INT64>) -> ARRAY<STRUCT<key INT64, value INT64>>)
    |     +-FunctionCall(GoogleSQL:map_from_array(ARRAY<STRUCT<k INT64, v INT64>>) -> MAP<INT64, INT64>)
    |       +-Literal(type=ARRAY<STRUCT<k INT64, v INT64>>, value=[{k:1, v:1}])
    +-input_scan=
      +-SingleRowScan
