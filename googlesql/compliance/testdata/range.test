[default required_features=RANGE_TYPE]

[prepare_database]
CREATE TABLE date_ranges
(
  id INT64,
  name STRING,
  date_range_val RANGE<DATE>
)
AS SELECT 1, "a", RANGE<DATE> '[2014-01-01, 2015-01-01)'
UNION ALL SELECT 2, "a", RANGE<DATE> '[2014-01-01, UNBOUNDED)'
UNION ALL SELECT 3, "a", RANGE<DATE> '[UNBOUNDED, 2015-01-01)'
UNION ALL SELECT 4, "b", RANGE<DATE> '[UNBOUNDED, UNBOUNDED)'
UNION ALL SELECT 5, "b", RANGE<DATE> '[2014-01-01, UNBOUNDED)'
UNION ALL SELECT 6, "b", RANGE<DATE> '[UNBOUNDED, 2015-01-01)'
UNION ALL SELECT 7, "c", RANGE<DATE> '[UNBOUNDED, UNBOUNDED)'
UNION ALL SELECT 8, "c", RANGE<DATE> '[UNBOUNDED, 2015-01-01)'
UNION ALL SELECT 9, "c", RANGE<DATE> '[UNBOUNDED, UNBOUNDED)'
UNION ALL SELECT 10, "d", RANGE<DATE> '[UNBOUNDED, UNBOUNDED)';
--
ARRAY<STRUCT<
        id INT64,
        name STRING,
        date_range_val RANGE<DATE>
      >>
[{
   1,
   "a",
   [2014-01-01, 2015-01-01)
 },
 {2, "a", [2014-01-01, NULL)},
 {3, "a", [NULL, 2015-01-01)},
 {4, "b", [NULL, NULL)},
 {5, "b", [2014-01-01, NULL)},
 {6, "b", [NULL, 2015-01-01)},
 {7, "c", [NULL, NULL)},
 {8, "c", [NULL, 2015-01-01)},
 {9, "c", [NULL, NULL)},
 {10, "d", [NULL, NULL)}]
==

[required_features=RANGE_TYPE,CIVIL_TIME]
[prepare_database]
CREATE TABLE datetime_ranges
(
  id INT64,
  name STRING,
  datetime_range_val RANGE<DATETIME>
)
AS SELECT 1, "a", RANGE<DATETIME> '[2016-01-01 12:00:00, 2017-01-01 12:00:00)'
UNION ALL SELECT 2, "a", RANGE<DATETIME> '[2016-01-01 12:00:00, UNBOUNDED)'
UNION ALL SELECT 3, "a", RANGE<DATETIME> '[UNBOUNDED, 2017-01-01 12:00:00)'
UNION ALL SELECT 4, "b", RANGE<DATETIME> '[UNBOUNDED, UNBOUNDED)'
UNION ALL SELECT 5, "b", RANGE<DATETIME> '[2016-01-01 12:00:00, UNBOUNDED)'
UNION ALL SELECT 6, "b", RANGE<DATETIME> '[UNBOUNDED, 2017-01-01 12:00:00)'
UNION ALL SELECT 7, "c", RANGE<DATETIME> '[UNBOUNDED, UNBOUNDED)'
UNION ALL SELECT 8, "c", RANGE<DATETIME> '[UNBOUNDED, 2017-01-01 12:00:00)'
UNION ALL SELECT 9, "c", RANGE<DATETIME> '[UNBOUNDED, UNBOUNDED)'
UNION ALL SELECT 10, "d", RANGE<DATETIME> '[UNBOUNDED, UNBOUNDED)';
--
ARRAY<STRUCT<
        id INT64,
        name STRING,
        datetime_range_val RANGE<DATETIME>
      >>
[{
   1,
   "a",
   [2016-01-01 12:00:00, 2017-01-01 12:00:00)
 },
 {
   2,
   "a",
   [2016-01-01 12:00:00, NULL)
 },
 {
   3,
   "a",
   [NULL, 2017-01-01 12:00:00)
 },
 {4, "b", [NULL, NULL)},
 {
   5,
   "b",
   [2016-01-01 12:00:00, NULL)
 },
 {
   6,
   "b",
   [NULL, 2017-01-01 12:00:00)
 },
 {7, "c", [NULL, NULL)},
 {
   8,
   "c",
   [NULL, 2017-01-01 12:00:00)
 },
 {9, "c", [NULL, NULL)},
 {10, "d", [NULL, NULL)}]
==

[prepare_database]
CREATE TABLE timestamp_ranges
(
  id INT64,
  name STRING,
  timestamp_range_val RANGE<TIMESTAMP>
)
AS SELECT 1, "a", RANGE<TIMESTAMP> '[2018-10-01 12:00:00+08, 2019-01-01 12:00:00+08)'
UNION ALL SELECT 2, "a",  RANGE<TIMESTAMP> '[2018-10-01 12:00:00+08, 2019-01-01 12:00:00+08)'
UNION ALL SELECT 3, "a", RANGE<TIMESTAMP> '[2018-10-01 12:00:00+08, 2019-01-01 12:00:00+08)'
UNION ALL SELECT 4, "b", RANGE<TIMESTAMP> '[2018-10-01 12:00:00+08, 2019-01-01 12:00:00+08)'
UNION ALL SELECT 5, "b", RANGE<TIMESTAMP> '[2018-10-01 12:00:00+08, UNBOUNDED)'
UNION ALL SELECT 6, "b", RANGE<TIMESTAMP> '[2018-10-01 12:00:00+08, UNBOUNDED)'
UNION ALL SELECT 7, "c", RANGE<TIMESTAMP> '[UNBOUNDED, 2019-01-01 12:00:00+08)'
UNION ALL SELECT 8, "c", RANGE<TIMESTAMP> '[UNBOUNDED, 2019-01-01 12:00:00+08)'
UNION ALL SELECT 9, "c", RANGE<TIMESTAMP> '[UNBOUNDED, 2019-01-01 12:00:00+08)'
UNION ALL SELECT 10, "d", RANGE<TIMESTAMP> '[UNBOUNDED, UNBOUNDED)';
--
ARRAY<STRUCT<
        id INT64,
        name STRING,
        timestamp_range_val RANGE<TIMESTAMP>
      >>
[{1,
  "a",
  [
    2018-10-01 04:00:00+00,
    2019-01-01 04:00:00+00
  )},
 {2,
  "a",
  [
    2018-10-01 04:00:00+00,
    2019-01-01 04:00:00+00
  )},
 {3,
  "a",
  [
    2018-10-01 04:00:00+00,
    2019-01-01 04:00:00+00
  )},
 {4,
  "b",
  [
    2018-10-01 04:00:00+00,
    2019-01-01 04:00:00+00
  )},
 {5,
  "b",
  [
    2018-10-01 04:00:00+00,
    NULL
  )},
 {6,
  "b",
  [
    2018-10-01 04:00:00+00,
    NULL
  )},
 {7,
  "c",
  [
    NULL,
    2019-01-01 04:00:00+00
  )},
 {8,
  "c",
  [
    NULL,
    2019-01-01 04:00:00+00
  )},
 {9,
  "c",
  [
    NULL,
    2019-01-01 04:00:00+00
  )},
 {10, "d", [NULL, NULL)}]
==

[name=group_by_single_date_range]
SELECT date_range_val, COUNT(id)
FROM date_ranges
GROUP BY date_range_val
ORDER BY COUNT(id) DESC;
--
ARRAY<STRUCT<
        date_range_val RANGE<DATE>,
        INT64
      >>
[known order:{[NULL, NULL), 4},
             {[NULL, 2015-01-01), 3},
             {[2014-01-01, NULL), 2},
             {
               [2014-01-01, 2015-01-01),
               1
             }]
==

[required_features=RANGE_TYPE,CIVIL_TIME]
[name=group_by_single_datetime_range]
SELECT datetime_range_val, COUNT(id)
FROM datetime_ranges
GROUP BY datetime_range_val
ORDER BY COUNT(id) DESC;
--
ARRAY<STRUCT<
        datetime_range_val RANGE<DATETIME>,
        INT64
      >>
[known order:{[NULL, NULL), 4},
             {
               [NULL, 2017-01-01 12:00:00),
               3
             },
             {
               [2016-01-01 12:00:00, NULL),
               2
             },
             {
               [2016-01-01 12:00:00, 2017-01-01 12:00:00),
               1
             }]
==

[name=group_by_single_timestamp_range]
SELECT timestamp_range_val, COUNT(id)
FROM timestamp_ranges
GROUP BY timestamp_range_val
ORDER BY COUNT(id) DESC;
--
ARRAY<STRUCT<
        timestamp_range_val RANGE<TIMESTAMP>,
        INT64
      >>
[known order:{[
                2018-10-01 04:00:00+00,
                2019-01-01 04:00:00+00
              ),
              4},
             {[
                NULL,
                2019-01-01 04:00:00+00
              ),
              3},
             {[
                2018-10-01 04:00:00+00,
                NULL
              ),
              2},
             {[NULL, NULL), 1}]
==

[name=group_by_single_date_range_and_non_range]
SELECT date_range_val, name, COUNT(id)
FROM date_ranges
GROUP BY date_range_val, name
ORDER BY COUNT(id) DESC;
--
ARRAY<STRUCT<
        date_range_val RANGE<DATE>,
        name STRING,
        INT64
      >>
[unknown order:{[NULL, NULL), "c", 2},
               {[NULL, 2015-01-01), "b", 1},
               {[NULL, NULL), "b", 1},
               {[NULL, NULL), "d", 1},
               {[2014-01-01, NULL), "a", 1},
               {[NULL, 2015-01-01), "a", 1},
               {[NULL, 2015-01-01), "c", 1},
               {
                 [2014-01-01, 2015-01-01),
                 "a",
                 1
               },
               {[2014-01-01, NULL), "b", 1}]
==

[required_features=RANGE_TYPE,CIVIL_TIME]
[name=group_by_single_datetime_range_and_non_range]
SELECT datetime_range_val, name, COUNT(id)
FROM datetime_ranges
GROUP BY datetime_range_val, name
ORDER BY COUNT(id) DESC;
--
ARRAY<STRUCT<
        datetime_range_val RANGE<DATETIME>,
        name STRING,
        INT64
      >>
[unknown order:{[NULL, NULL), "c", 2},
               {
                 [NULL, 2017-01-01 12:00:00),
                 "b",
                 1
               },
               {[NULL, NULL), "b", 1},
               {[NULL, NULL), "d", 1},
               {
                 [2016-01-01 12:00:00, NULL),
                 "a",
                 1
               },
               {
                 [NULL, 2017-01-01 12:00:00),
                 "a",
                 1
               },
               {
                 [NULL, 2017-01-01 12:00:00),
                 "c",
                 1
               },
               {
                 [2016-01-01 12:00:00, 2017-01-01 12:00:00),
                 "a",
                 1
               },
               {
                 [2016-01-01 12:00:00, NULL),
                 "b",
                 1
               }]
==

[name=group_by_single_timestamp_range_and_non_range]
SELECT timestamp_range_val, name, COUNT(id)
FROM timestamp_ranges
GROUP BY timestamp_range_val, name
ORDER BY COUNT(id) DESC;
--
ARRAY<STRUCT<
        timestamp_range_val RANGE<TIMESTAMP>,
        name STRING,
        INT64
      >>
[unknown order:{[
                  NULL,
                  2019-01-01 04:00:00+00
                ),
                "c",
                3},
               {[
                  2018-10-01 04:00:00+00,
                  2019-01-01 04:00:00+00
                ),
                "a",
                3},
               {[
                  2018-10-01 04:00:00+00,
                  NULL
                ),
                "b",
                2},
               {[NULL, NULL), "d", 1},
               {[
                  2018-10-01 04:00:00+00,
                  2019-01-01 04:00:00+00
                ),
                "b",
                1}]
==

[name=group_by_multiple_ranges]
SELECT date_range_val, timestamp_range_val, COUNT(id)
FROM date_ranges FULL JOIN timestamp_ranges USING (id, name)
GROUP BY date_range_val, timestamp_range_val
ORDER BY COUNT(id) DESC;
--
ARRAY<STRUCT<
        date_range_val RANGE<DATE>,
        timestamp_range_val RANGE<TIMESTAMP>,
        INT64
      >>
[unknown order:{[NULL, NULL),
                [
                  NULL,
                  2019-01-01 04:00:00+00
                ),
                2},
               {[NULL, 2015-01-01),
                [
                  2018-10-01 04:00:00+00,
                  2019-01-01 04:00:00+00
                ),
                1},
               {[NULL, NULL),
                [
                  2018-10-01 04:00:00+00,
                  2019-01-01 04:00:00+00
                ),
                1},
               {[2014-01-01, NULL),
                [
                  2018-10-01 04:00:00+00,
                  2019-01-01 04:00:00+00
                ),
                1},
               {[NULL, 2015-01-01),
                [
                  NULL,
                  2019-01-01 04:00:00+00
                ),
                1},
               {[NULL, 2015-01-01),
                [
                  2018-10-01 04:00:00+00,
                  NULL
                ),
                1},
               {[NULL, NULL), [NULL, NULL), 1},
               {[2014-01-01, 2015-01-01),
                [
                  2018-10-01 04:00:00+00,
                  2019-01-01 04:00:00+00
                ),
                1},
               {[2014-01-01, NULL),
                [
                  2018-10-01 04:00:00+00,
                  NULL
                ),
                1}]
==

[name=group_by_multiple_ranges_and_non_range]
SELECT date_range_val, timestamp_range_val, name, COUNT(id)
FROM date_ranges FULL JOIN timestamp_ranges USING (id, name)
GROUP BY date_range_val, timestamp_range_val, name
ORDER BY COUNT(id) DESC;
--
ARRAY<STRUCT<
        date_range_val RANGE<DATE>,
        timestamp_range_val RANGE<TIMESTAMP>,
        name STRING,
        INT64
      >>
[unknown order:{[NULL, NULL),
                [
                  NULL,
                  2019-01-01 04:00:00+00
                ),
                "c",
                2},
               {[NULL, 2015-01-01),
                [
                  2018-10-01 04:00:00+00,
                  2019-01-01 04:00:00+00
                ),
                "a",
                1},
               {[NULL, NULL),
                [
                  2018-10-01 04:00:00+00,
                  2019-01-01 04:00:00+00
                ),
                "b",
                1},
               {[2014-01-01, NULL),
                [
                  2018-10-01 04:00:00+00,
                  2019-01-01 04:00:00+00
                ),
                "a",
                1},
               {[NULL, 2015-01-01),
                [
                  NULL,
                  2019-01-01 04:00:00+00
                ),
                "c",
                1},
               {[NULL, 2015-01-01),
                [
                  2018-10-01 04:00:00+00,
                  NULL
                ),
                "b",
                1},
               {[NULL, NULL), [NULL, NULL), "d", 1},
               {[2014-01-01, 2015-01-01),
                [
                  2018-10-01 04:00:00+00,
                  2019-01-01 04:00:00+00
                ),
                "a",
                1},
               {[2014-01-01, NULL),
                [
                  2018-10-01 04:00:00+00,
                  NULL
                ),
                "b",
                1}]
==

[required_features=RANGE_TYPE,TIMESTAMP_PICOS]
[name=range_literal_with_picoseconds]
SELECT
  RANGE<TIMESTAMP> '[UNBOUNDED, 2020-12-31 12:00:00.123456789123+08)',
  RANGE<TIMESTAMP> '[2020-10-01 12:00:00.123456789123+08, UNBOUNDED)',
  RANGE<TIMESTAMP> '[2020-10-01 12:00:00.123456789123+08, 2020-12-31 12:00:00.123456789123+08)'
--
ARRAY<STRUCT<RANGE<TIMESTAMP>, RANGE<TIMESTAMP>, RANGE<TIMESTAMP>>>[
  {[
     NULL,
     2020-12-31 04:00:00.123456789123+00
   ),
   [
     2020-10-01 04:00:00.123456789123+00,
     NULL
   ),
   [
     2020-10-01 04:00:00.123456789123+00,
     2020-12-31 04:00:00.123456789123+00
   )}
]
==
