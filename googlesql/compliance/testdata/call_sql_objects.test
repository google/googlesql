# This file includes tests that call a mix of different sorts of SQL objects
# such as UDFs, UDAs, and TVFs.
#
# We have a separate test file for these cases because some of the test drivers
# cannot handle the mix yet and we didn't want to unnessarily break the other
# test files for some drivers.

[prepare_database]
CREATE TABLE t1 AS
  SELECT * FROM UNNEST([
    STRUCT(1 AS rowid, 1 AS x, 100 AS y, 1000 AS z),
    STRUCT(2 AS rowid, 1 AS x, 100 AS y, 1000 AS z),
    STRUCT(3 AS rowid, 1 AS x, 100 AS y, 1001 AS z),
    STRUCT(4 AS rowid, 1 AS x, 100 AS y, 1002 AS z),
    STRUCT(5 AS rowid, 1 AS x, 100 AS y, 1003 AS z),
    STRUCT(6 AS rowid, 1 AS x, 100 AS y, 1004 AS z),
    STRUCT(7 AS rowid, 1 AS x, 101 AS y, 1000 AS z),
    STRUCT(8 AS rowid, 1 AS x, 101 AS y, 1001 AS z),
    STRUCT(9 AS rowid, 1 AS x, 101 AS y, 1002 AS z),
    STRUCT(10 AS rowid, 2 AS x, 100 AS y, 1000 AS z),
    STRUCT(11 AS rowid, 2 AS x, 101 AS y, 1001 AS z),
    STRUCT(12 AS rowid, 2 AS x, 102 AS y, 1002 AS z),
    STRUCT(13 AS rowid, 2 AS x, 102 AS y, NULL AS z),
    STRUCT(14 AS rowid, 2 AS x, 102 AS y, NULL AS z),
    STRUCT(15 AS rowid, 2 AS x, NULL AS y, 1002 AS z),
    STRUCT(16 AS rowid, 2 AS x, NULL AS y, 1002 AS z)
    ]);
--
ARRAY<STRUCT<rowid INT64, x INT64, y INT64, z INT64>>[
  {2, 1, 100, 1000},
  {4, 1, 100, 1002},
  {6, 1, 100, 1004},
  {8, 1, 101, 1001},
  {10, 2, 100, 1000},
  {12, 2, 102, 1002},
  {14, 2, 102, NULL},
  {16, 2, NULL, 1002},
  {1, 1, 100, 1000},
  {3, 1, 100, 1001},
  {5, 1, 100, 1003},
  {7, 1, 101, 1000},
  {9, 1, 101, 1002},
  {11, 2, 101, 1001},
  {13, 2, 102, NULL},
  {15, 2, NULL, 1002}
]
==
[prepare_database]
CREATE TEMP AGGREGATE FUNCTION CountStar() RETURNS INT64 AS ( COUNT(*) );
==
[prepare_database]
[required_features=TEMPLATE_FUNCTIONS]
CREATE TEMP FUNCTION CallsCountStar(arg0 ANY TYPE) AS
((SELECT AS STRUCT arg0, CountStar()
  FROM (SELECT 1)
  WHERE (true) IS TRUE
  GROUP BY 1));
==
[prepare_database]
CREATE TEMP AGGREGATE FUNCTION JustRefOneArg(
    arg0 STRING NOT AGGREGATE) AS (
  arg0
);
==
[prepare_database]
[required_features=TEMPLATE_FUNCTIONS]
CREATE TEMP FUNCTION CallsJustRefOneArg(arg1 ANY TYPE) AS
(
  (SELECT JustRefOneArg('b') as col FROM (SELECT 1) WHERE false)
);
==
[prepare_database]
[required_features=TEMPLATE_FUNCTIONS]
CREATE TEMP AGGREGATE FUNCTION AggregateCallsJustRefOneArg(arg0 ANY TYPE) AS
(
  JustRefOneArg('b')
);
==
[prepare_database]
CREATE TEMP CONSTANT CLiteral = 1;
==
[prepare_database]
CREATE TEMP CONSTANT CSubquery = (SELECT COUNT(*) FROM (SELECT 1 UNION ALL SELECT 2));
==
[prepare_database]
CREATE TEMP CONSTANT CArray = GENERATE_ARRAY(1, 10);
==
[prepare_database]
CREATE TEMP CONSTANT CRand = Rand();
==
[name=repro350574193]
SELECT CallsCountStar(e) FROM UNNEST([NULL, 'a']) AS e;
--
ARRAY<STRUCT<STRUCT<arg0 STRING, INT64>>>[unknown order:
  {{"a", 1}},
  {{NULL, 1}}
]
==
[name=repro350786470]
SELECT CallsJustRefOneArg('a')
FROM UNNEST([1, 2, 3]);
--
ARRAY<STRUCT<STRING>>[unknown order:{"b"}, {"b"}, {"b"}]
==
[name=repro350786470_2]
[parameters='a' AS p]
SELECT JustRefOneArg(@p) FROM (SELECT 1) WHERE false;
--
ARRAY<STRUCT<STRING>>[{"a"}]
==
[name=repro350786470_3]
SELECT AggregateCallsJustRefOneArg('b') FROM (SELECT 1) WHERE false;
--
ARRAY<STRUCT<STRING>>[{"b"}]
==
[name=reference_constants]
SELECT CLiteral, CSubquery, CArray, CRand = CRand;
--
ARRAY<STRUCT<CLiteral INT64, CSubquery INT64, CArray ARRAY<>, BOOL>>[
  {
    1,
    2,
    ARRAY<INT64>[known order:1, 2, 3, 4, 5, 6, 7, 8, 9, 10],
    true
  }
]
