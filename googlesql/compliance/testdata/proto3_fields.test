[load_proto_files=googlesql/testdata/test_proto3.proto,googlesql/testdata/test_schema.proto]
[load_proto_names=googlesql_test.Proto3KitchenSink,googlesql_test.Proto3KitchenSink.Nested,googlesql_test.Proto3MessageWithNulls,googlesql_test.EmptyMessage,googlesql_test.Proto3TestExtraPB]
[prepare_database]
CREATE TABLE Table0 AS
select 0 key
--
ARRAY<STRUCT<key INT64>>[{0}]
==

# This table has rows with an int64 'key' and a Proto3KitchenSink 'value'.
# Row 1: a minimal proto.
# Row 2: a null proto
# Row 3: a partially populated proto
# Row 4: a heavily populated proto with fields of most types
[prepare_database]
CREATE TABLE Table1 AS
SELECT 1 key, cast('''
''' as `googlesql_test.Proto3KitchenSink`) as value
union all
select 2, null
union all
select 3, cast('''
  int32_val: 6
  bool_val: true
  repeated_uint32_val: 7
  repeated_uint32_val: 8
  repeated_uint32_val: 9
  nested_value {
    nested_int64: 10
    nested_repeated_int64: 11
    nested_repeated_int64: 12
  }
''' as `googlesql_test.Proto3KitchenSink`) as value
union all
select 4, cast('''
  int32_val: 12
  uint32_val: 12
  int64_val: 12
  uint64_val: 12
  string_val: 'sss'
  float_val: 12.5
  double_val: 12.5
  bytes_val: 'bbb'
  bool_val: true
  fixed32_val: 12
  fixed64_val: 12
  sfixed32_val: 12
  sfixed64_val: 12
  sint32_val: 12
  sint64_val: 12

  repeated_int32_val: 13
  repeated_uint32_val: 13
  repeated_int64_val: 13
  repeated_uint64_val: 13
  repeated_string_val: 'sss'
  repeated_float_val: 13.5
  repeated_double_val: 13.5
  repeated_bytes_val: 'bbb'
  repeated_bool_val: true
  repeated_fixed32_val: 13
  repeated_fixed64_val: 13
  repeated_sfixed32_val: 13
  repeated_sfixed64_val: 13
  repeated_sint32_val: 13
  repeated_sint64_val: 13

  nested_value {
    nested_int64: 14
    nested_repeated_int64: 15
    nested_repeated_int64: 15
  }

  nested_repeated_value {
    nested_int64: 16
  }
  nested_repeated_value {
  }
  nested_repeated_value {
    nested_repeated_int64: 17
    nested_repeated_int64: 17
  }

  repeated_holder {}
  repeated_holder {
    repeated_field { int32_val1: 18 }
    repeated_field {  # This is a repeated TestExtraPB.
      int32_val1: 19
      str_value: "abc"
      str_value: 'def'
    }
  }

  test_enum: ENUM1
  repeated_test_enum: ENUM0
  repeated_test_enum: ENUM1
  repeated_test_enum: ENUM2
  repeated_test_enum: ENUM2
  repeated_test_enum: 2  # same as ENUM2
  repeated_test_enum: ENUM2147483647

  # TODO Add example fields for the rest of these field types, where
  # useful.
  #
  #   optional group OptionalGroup = 38 {
  #     required int64 int64_val = 1;
  #     optional string string_val = 2;
  #     repeated group OptionalGroupNested = 3 {
  #       required int64 int64_val = 1;
  #     }
  #   }
  #   optional OptionalGroup optional_group = 39;
  #
  #   repeated group NestedRepeatedGroup = 40 {
  #     required int64 id = 1;
  #     optional string idstr = 2;
  #     repeated group NestedRepeatedGroupNested = 3 {
  #       required int64 id = 1;
  #     }
  #   }
  #   repeated NestedRepeatedGroup nested_repeated_group = 41;
  #
  #   // Annotated date types.  We use the current <format> annotation and the
  #   // deprecated <type> annotation interchangeably.  <format> overrides <type>
  #   // if both are present.
  #   optional int32 date = 42 [ (googlesql.format) = DATE ];
  #   optional int32 date_decimal = 65 [ (googlesql.type) = DATE_DECIMAL ];
  #   optional int32 date_decimal_legacy = 68
  #       [ (googlesql.type) = DATE, (googlesql.encoding) = DATE_PACKED32 ];
  #
  #   optional int64 date64 = 43 [ (googlesql.type) = DATE ];
  #   optional int64 date64_decimal = 69 [
  #       (googlesql.format) = DATE_DECIMAL,
  #       (googlesql.type) = TIMESTAMP_MILLIS /* this is ignored */ ];
  #   optional int64 date64_decimal_legacy = 66
  #       [ (googlesql.encoding) = DATE_PACKED32, (googlesql.format) = DATE ];
  #
  #   optional int64 timestamp_seconds = 44
  #       [ (googlesql.type) = TIMESTAMP_SECONDS ];
  #   optional int64 timestamp_millis = 45 [ (googlesql.type) = TIMESTAMP_MILLIS ];
  #   optional int64 timestamp_micros = 46 [ (googlesql.type) = TIMESTAMP_MICROS ];
  #   optional uint64 timestamp_uint64 = 80 [ (googlesql.format) = TIMESTAMP_MICROS ];
  #
  #   repeated int32 repeated_date = 48 [ (googlesql.type) = DATE ];
  #   repeated int64 repeated_date64 = 49 [ (googlesql.type) = DATE ];
  #   repeated int64 repeated_timestamp_seconds = 50
  #       [ (googlesql.type) = TIMESTAMP_SECONDS ];
  #   repeated int64 repeated_timestamp_millis = 51
  #       [ (googlesql.type) = TIMESTAMP_MILLIS ];
  #   repeated int64 repeated_timestamp_micros = 52
  #       [ (googlesql.type) = TIMESTAMP_MICROS ];

  # Some of these are excluded right now because they break the framework
  # for f1, preventing other tests from running.
  # TODO Figure out another workaround.
  # date64: -7
  date: 7
  date_default: 13
  date_decimal: 20110215
  timestamp_seconds: 1409091248
  timestamp_millis: 1409091248111
  timestamp_micros: 1409091248111222
  timestamp_uint64: 1407431700000007

  #
  #   optional MessageWithNulls message_with_nulls = 58;
  #
  #   // Protos annotated as wrappers just for adding nullability.
  #   optional NullableInt nullable_int = 59;
  #   repeated NullableInt nullable_int_array = 60;
  #
  #   // Proto annotated so it should act like a struct.
  #   optional KeyValueStruct key_value = 61;
  #   repeated KeyValueStruct key_value_array = 62;
  #
  #   // Field with the prefix has_ that isn't a has bit.
  #   optional string has_confusing_name = 63;
  #
  #   optional string MIXED_case = 64;
  #
  #   optional AnnotatedStruct annotated_struct = 70;
  #   repeated AnnotatedStruct annotated_struct_array = 71;
  #
  #   optional RewrappedNullableInt rewrapped_nullable_int = 72;
  #
  #   repeated NullableDate array_of_nullable_date = 73;
  #   optional NullableArrayOfNullableDate nullable_array_of_nullable_date = 74;

  empty_message {}

''' as `googlesql_test.Proto3KitchenSink`) as value
--
ARRAY<STRUCT<
        key INT64,
        value PROTO<googlesql_test.Proto3KitchenSink>
      >>
[{1, {}},
 {2, NULL},
 {3,
  {
    int32_val: 6
    bool_val: true
    repeated_uint32_val: 7
    repeated_uint32_val: 8
    repeated_uint32_val: 9
    nested_value {
      nested_int64: 10
      nested_repeated_int64: 11
      nested_repeated_int64: 12
    }
  }},
 {4,
  {
    int32_val: 12
    uint32_val: 12
    int64_val: 12
    uint64_val: 12
    string_val: "sss"
    float_val: 12.5
    double_val: 12.5
    bytes_val: "bbb"
    bool_val: true
    fixed32_val: 12
    fixed64_val: 12
    sfixed32_val: 12
    sfixed64_val: 12
    sint32_val: 12
    sint64_val: 12
    repeated_int32_val: 13
    repeated_uint32_val: 13
    repeated_int64_val: 13
    repeated_uint64_val: 13
    repeated_string_val: "sss"
    repeated_float_val: 13.5
    repeated_double_val: 13.5
    repeated_bytes_val: "bbb"
    repeated_bool_val: true
    repeated_fixed32_val: 13
    repeated_fixed64_val: 13
    repeated_sfixed32_val: 13
    repeated_sfixed64_val: 13
    repeated_sint32_val: 13
    repeated_sint64_val: 13
    nested_value {
      nested_int64: 14
      nested_repeated_int64: 15
      nested_repeated_int64: 15
    }
    nested_repeated_value {
      nested_int64: 16
    }
    nested_repeated_value {
    }
    nested_repeated_value {
      nested_repeated_int64: 17
      nested_repeated_int64: 17
    }
    date: 7
    date_default: 13
    date_decimal: 20110215
    timestamp_seconds: 1409091248
    timestamp_millis: 1409091248111
    timestamp_micros: 1409091248111222
    timestamp_uint64: 1407431700000007
    test_enum: ENUM1
    empty_message {
    }
    repeated_holder {
    }
    repeated_holder {
      repeated_field {
        int32_val1: 18
      }
      repeated_field {
        int32_val1: 19
        str_value: "abc"
        str_value: "def"
      }
    }
    repeated_test_enum: ENUM0
    repeated_test_enum: ENUM1
    repeated_test_enum: ENUM2
    repeated_test_enum: ENUM2
    repeated_test_enum: ENUM2
    repeated_test_enum: ENUM2147483647
  }}]
==

[prepare_database]
CREATE TABLE EmptyMessageColumn AS
SELECT 1 key,
       cast(null as `googlesql_test.EmptyMessage`) null_empty,
       cast('' as `googlesql_test.EmptyMessage`) empty
--
ARRAY<STRUCT<
        key INT64,
        null_empty PROTO<googlesql_test.EmptyMessage>,
        empty PROTO<googlesql_test.EmptyMessage>
      >>[{1, NULL, {}}]
==

[prepare_database]
CREATE TABLE MessageWithNulls AS
SELECT 1 key, cast("" as googlesql_test.Proto3MessageWithNulls) as value
union all
SELECT 2 key, """i1: 5 i2: 5"""
union all
SELECT 3, NULL
--
ARRAY<STRUCT<
        key INT64,
        value PROTO<googlesql_test.Proto3MessageWithNulls>
      >>
[{1, {}},
 {2,
  {
    i1: 5
    i2: 5
  }},
 {3, NULL}]
==

[prepare_database]
CREATE TABLE TableWithNulls AS
SELECT cast(1 as int64) as primary_key,
       cast(null as int64) as int64_val UNION ALL
  SELECT 2,  null UNION ALL
  SELECT 3, null UNION ALL
  SELECT 4, null UNION ALL
  SELECT 5, 4 UNION ALL
  SELECT 6, 5 UNION ALL
  SELECT 7, 6
--
ARRAY<STRUCT<primary_key INT64, int64_val INT64>>[
  {1, NULL},
  {2, NULL},
  {3, NULL},
  {4, NULL},
  {5, 4},
  {6, 5},
  {7, 6}
]
==

[name=select_small_proto]
select key, value from Table1 where key=1
--
ARRAY<STRUCT<
        key INT64,
        value PROTO<googlesql_test.Proto3KitchenSink>
      >>[{1, {}}]
==

[name=select_null_proto]
select key, value from Table1 where key=2
--
ARRAY<STRUCT<
        key INT64,
        value PROTO<googlesql_test.Proto3KitchenSink>
      >>[{2, NULL}]
==

[name=select_medium_proto]
select key, value from Table1 where key=3
--
ARRAY<STRUCT<
        key INT64,
        value PROTO<googlesql_test.Proto3KitchenSink>
      >>
[{3,
  {
    int32_val: 6
    bool_val: true
    repeated_uint32_val: 7
    repeated_uint32_val: 8
    repeated_uint32_val: 9
    nested_value {
      nested_int64: 10
      nested_repeated_int64: 11
      nested_repeated_int64: 12
    }
  }}]
==

[name=empty_message_field]
select value.empty_message from Table1
where key in (1,2,4) order by key
--
ARRAY<STRUCT<empty_message PROTO<googlesql_test.EmptyMessage>>>[known order:
  {NULL},
  {NULL},
  {{}}
]
==

[name=empty_message_column]
select null_empty, empty from EmptyMessageColumn
--
ARRAY<STRUCT<
        null_empty PROTO<googlesql_test.EmptyMessage>,
        empty PROTO<googlesql_test.EmptyMessage>
      >>[{NULL, {}}]
==

[name=empty_message_expr]
select cast(null as `googlesql_test.EmptyMessage`) null_empty,
       cast('' as `googlesql_test.EmptyMessage`) empty
--
ARRAY<STRUCT<
        null_empty PROTO<googlesql_test.EmptyMessage>,
        empty PROTO<googlesql_test.EmptyMessage>
      >>[{NULL, {}}]
==

[name=empty_message_subquery]
select null_empty, empty from (
  select cast(null as `googlesql_test.EmptyMessage`) null_empty,
         cast('' as `googlesql_test.EmptyMessage`) empty)
--
ARRAY<STRUCT<
        null_empty PROTO<googlesql_test.EmptyMessage>,
        empty PROTO<googlesql_test.EmptyMessage>
      >>[{NULL, {}}]
==

# Note that we're getting proto defaults for some of these columns.
[name=scalar_fields]
select key,
       value.int32_val,
       value.uint32_val,
       value.int64_val,
       value.uint64_val,
       value.string_val,
       value.float_val,
       value.double_val,
       value.bytes_val,
       value.bool_val
from Table1 order by key
--
ARRAY<STRUCT<key INT64,
             int32_val INT32,
             uint32_val UINT32,
             int64_val INT64,
             uint64_val UINT64,
             string_val STRING,
             float_val FLOAT,
             double_val DOUBLE,
             bytes_val BYTES,
             bool_val BOOL>>
[known order:
  {1, 0, 0, 0, 0, "", 0, 0, b"", false},
  {2, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL},
  {3, 6, 0, 0, 0, "", 0, 0, b"", true},
  {4, 12, 12, 12, 12, "sss", 12.5, 12.5, b"bbb", true}
]
==

[name=has_scalar_fields]
select key,
       value.has_int32_val,
       value.has_uint32_val,
       value.has_int64_val,
       value.has_uint64_val,
       value.has_string_val,
       value.has_float_val,
       value.has_double_val,
       value.has_bytes_val,
       value.has_bool_val
from Table1 order by key
--
ARRAY<STRUCT<key INT64,
             has_int32_val BOOL,
             has_uint32_val BOOL,
             has_int64_val BOOL,
             has_uint64_val BOOL,
             has_string_val BOOL,
             has_float_val BOOL,
             has_double_val BOOL,
             has_bytes_val BOOL,
             has_bool_val BOOL>>
[known order:
  {1, false, false, false, false, false, false, false, false, false},
  {2, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL},
  {3, true, false, false, false, false, false, false, false, true},
  {4, true, true, true, true, true, true, true, true, true}
]
==

[name=repeated_scalar_fields]
select key,
       value.repeated_int32_val,
       value.repeated_uint32_val,
       value.repeated_int64_val,
       value.repeated_uint64_val,
       value.repeated_string_val,
       value.repeated_float_val,
       value.repeated_double_val,
       value.repeated_bytes_val,
       value.repeated_bool_val
from Table1 order by key
--
ARRAY<STRUCT<
        key INT64,
        repeated_int32_val ARRAY<>,
        repeated_uint32_val ARRAY<>,
        repeated_int64_val ARRAY<>,
        repeated_uint64_val ARRAY<>,
        repeated_string_val ARRAY<>,
        repeated_float_val ARRAY<>,
        repeated_double_val ARRAY<>,
        repeated_bytes_val ARRAY<>,
        repeated_bool_val ARRAY<>
      >>
[known order:{1,
              ARRAY<INT32>[],
              ARRAY<UINT32>[],
              ARRAY<INT64>[],
              ARRAY<UINT64>[],
              ARRAY<STRING>[],
              ARRAY<FLOAT>[],
              ARRAY<DOUBLE>[],
              ARRAY<BYTES>[],
              ARRAY<BOOL>[]},
             {2,
              ARRAY<INT32>(NULL),
              ARRAY<UINT32>(NULL),
              ARRAY<INT64>(NULL),
              ARRAY<UINT64>(NULL),
              ARRAY<STRING>(NULL),
              ARRAY<FLOAT>(NULL),
              ARRAY<DOUBLE>(NULL),
              ARRAY<BYTES>(NULL),
              ARRAY<BOOL>(NULL)},
             {
               3,
               ARRAY<INT32>[],
               ARRAY<UINT32>[known order:7, 8, 9],
               ARRAY<INT64>[],
               ARRAY<UINT64>[],
               ARRAY<STRING>[],
               ARRAY<FLOAT>[],
               ARRAY<DOUBLE>[],
               ARRAY<BYTES>[],
               ARRAY<BOOL>[]
             },
             {4,
              ARRAY<INT32>[13],
              ARRAY<UINT32>[13],
              ARRAY<INT64>[13],
              ARRAY<UINT64>[13],
              ARRAY<STRING>["sss"],
              ARRAY<FLOAT>[13.5],
              ARRAY<DOUBLE>[13.5],
              ARRAY<BYTES>[b"bbb"],
              ARRAY<BOOL>[true]}]
==

[name=has_repeated_scalar_fields]
select key,
       value.has_repeated_int32_val
from Table1 order by key
--
ERROR: generic::invalid_argument: Protocol buffer googlesql_test.Proto3KitchenSink field repeated_int32_val is repeated, so has_repeated_int32_val is not allowed [at 2:14]
       value.has_repeated_int32_val
             ^
==

[name=scalar_fields_encoded]
select key,
       value.fixed32_val,
       value.fixed64_val,
       value.sfixed32_val,
       value.sfixed64_val,
       value.sint32_val,
       value.sint64_val
from Table1 order by key
--
ARRAY<STRUCT<key INT64,
             fixed32_val UINT32,
             fixed64_val UINT64,
             sfixed32_val INT32,
             sfixed64_val INT64,
             sint32_val INT32,
             sint64_val INT64>>
[known order:
  {1, 0, 0, 0, 0, 0, 0},
  {2, NULL, NULL, NULL, NULL, NULL, NULL},
  {3, 0, 0, 0, 0, 0, 0},
  {4, 12, 12, 12, 12, 12, 12}
]
==

[name=has_scalar_fields_encoded]
select key,
       value.has_fixed32_val,
       value.has_fixed64_val,
       value.has_sfixed32_val,
       value.has_sfixed64_val,
       value.has_sint32_val,
       value.has_sint64_val
from Table1 order by key
--
ARRAY<STRUCT<
        key INT64,
        has_fixed32_val BOOL,
        has_fixed64_val BOOL,
        has_sfixed32_val BOOL,
        has_sfixed64_val BOOL,
        has_sint32_val BOOL,
        has_sint64_val BOOL
      >>
[known order:
  {1, false, false, false, false, false, false},
  {2, NULL, NULL, NULL, NULL, NULL, NULL},
  {3, false, false, false, false, false, false},
  {4, true, true, true, true, true, true}
]
==

[name=repeated_scalar_fields_encoded]
select key,
       value.repeated_fixed32_val,
       value.repeated_fixed64_val,
       value.repeated_sfixed32_val,
       value.repeated_sfixed64_val,
       value.repeated_sint32_val,
       value.repeated_sint64_val
from Table1 where key!=3 order by key
--
ARRAY<STRUCT<
        key INT64,
        repeated_fixed32_val ARRAY<>,
        repeated_fixed64_val ARRAY<>,
        repeated_sfixed32_val ARRAY<>,
        repeated_sfixed64_val ARRAY<>,
        repeated_sint32_val ARRAY<>,
        repeated_sint64_val ARRAY<>
      >>
[known order:{1,
              ARRAY<UINT32>[],
              ARRAY<UINT64>[],
              ARRAY<INT32>[],
              ARRAY<INT64>[],
              ARRAY<INT32>[],
              ARRAY<INT64>[]},
             {2,
              ARRAY<UINT32>(NULL),
              ARRAY<UINT64>(NULL),
              ARRAY<INT32>(NULL),
              ARRAY<INT64>(NULL),
              ARRAY<INT32>(NULL),
              ARRAY<INT64>(NULL)},
             {4,
              ARRAY<UINT32>[13],
              ARRAY<UINT64>[13],
              ARRAY<INT32>[13],
              ARRAY<INT64>[13],
              ARRAY<INT32>[13],
              ARRAY<INT64>[13]}]
==

[name=enum_fields]
select key, value.test_enum
from Table1
where key in (1,2,4) order by key
--
ARRAY<STRUCT<
        key INT64,
        test_enum ENUM<googlesql_test.TestProto3Enum>
      >>
[known order:{1, ENUM0}, {2, NULL}, {4, ENUM1}]
==

[name=repeated_enum_fields]
select key, value.repeated_test_enum
from Table1 where key in (1,2,4) order by key
--
ARRAY<STRUCT<
        key INT64,
        repeated_test_enum ARRAY<>
      >>
[known order:{
               1,
               ARRAY<ENUM<googlesql_test.TestProto3Enum>>[]
             },
             {
               2,
               ARRAY<ENUM<googlesql_test.TestProto3Enum>>(NULL)
             },
             {4,
              ARRAY<ENUM<googlesql_test.TestProto3Enum>>[known order:
                ENUM0,
                ENUM1,
                ENUM2,
                ENUM2,
                ENUM2,
                ENUM2147483647
              ]}]
==

[name=repeated_enum_fields2]
select key, e
from Table1 t, t.value.repeated_test_enum e
where key in (1,2,4)
order by 1,2
--
ARRAY<STRUCT<
        key INT64,
        e ENUM<googlesql_test.TestProto3Enum>
      >>
[known order:{4, ENUM0},
             {4, ENUM1},
             {4, ENUM2},
             {4, ENUM2},
             {4, ENUM2},
             {4, ENUM2147483647}]
==

[required_features=SINGLE_TABLE_NAME_ARRAY_PATH]
[name=repeated_enum_fields2_from_table_name_array_path]
select e
from Table1.value.repeated_test_enum e
order by 1
--
ARRAY<STRUCT<e ENUM<googlesql_test.TestProto3Enum>>>[known order:
  {ENUM0},
  {ENUM1},
  {ENUM2},
  {ENUM2},
  {ENUM2},
  {ENUM2147483647}
]
==

[name=insert_bad_proto_enum_int_value]
select as googlesql_test.Proto3KitchenSink
  coalesce(1234) as test_enum  # non-const enum value
--
ARRAY<PROTO<googlesql_test.Proto3KitchenSink>>[{test_enum: 1234}]
==

[name=insert_bad_proto_enum_string_value]
select as googlesql_test.Proto3KitchenSink
  coalesce("bad enum string") as test_enum  # non-const enum value
--
ERROR: generic::out_of_range: Out of range cast of string 'bad enum string' to enum type googlesql_test.TestProto3Enum
==

[name=string_cast_invalid_proto_enum_field_value]
SELECT CAST("test_enum: 7" AS googlesql_test.Proto3KitchenSink) AS pb
--
ARRAY<STRUCT<pb PROTO<googlesql_test.Proto3KitchenSink>>>[{{test_enum: 7}}]
==

[name=bytes_cast_invalid_proto_enum_field_value]
SELECT CAST(b"\x90\x03\x07" AS googlesql_test.Proto3KitchenSink) AS pb
--
ARRAY<STRUCT<pb PROTO<googlesql_test.Proto3KitchenSink>>>[{{test_enum: 7}}]
==

[name=roundtrip_string_cast_invalid_proto_enum_field_value]
SELECT CAST(CAST("test_enum: 7" AS googlesql_test.Proto3KitchenSink) AS STRING) AS s
--
ARRAY<STRUCT<s STRING>>[{"test_enum: 7"}]

NOTE: Reference implementation reports non-determinism.
==

[name=back_to_proto_through_bytes_cast_invalid_proto_enum_field_value]
SELECT CAST(CAST(CAST("test_enum: 7" AS googlesql_test.Proto3KitchenSink) AS BYTES) as googlesql_test.Proto3KitchenSink) AS pb
--
ARRAY<STRUCT<pb PROTO<googlesql_test.Proto3KitchenSink>>>[{{test_enum: 7}}]

NOTE: Reference implementation reports non-determinism.
==

[name=nested_proto_field]
select key, value.nested_value
from Table1 where key in (1,2,4) order by key
--
ARRAY<STRUCT<
        key INT64,
        nested_value PROTO<googlesql_test.Proto3KitchenSink.Nested>
      >>
[known order:{1, NULL},
             {2, NULL},
             {4,
              {
                nested_int64: 14
                nested_repeated_int64: 15
                nested_repeated_int64: 15
              }}]
==

[name=nested_repeated_proto_field]
select key, value.nested_repeated_value
from Table1 where key in (1,2,4) order by key
--
ARRAY<STRUCT<
        key INT64,
        nested_repeated_value ARRAY<>
      >>
[known order:
  {
    1,
    ARRAY<PROTO<googlesql_test.Proto3KitchenSink.Nested>>[]
  },
  {
    2,
    ARRAY<PROTO<googlesql_test.Proto3KitchenSink.Nested>>(NULL)
  },
  {4,
   ARRAY<PROTO<googlesql_test.Proto3KitchenSink.Nested>>[known order:
     {nested_int64: 16},
     {},
     {
       nested_repeated_int64: 17
       nested_repeated_int64: 17
     }
   ]}
]
==

[name=nested_repeated_proto_field2]
select key, nrv, nrv.nested_int64, nrv.nested_repeated_int64
from Table1 t, t.value.nested_repeated_value nrv
where key in (1,2,4)
order by key
--
ARRAY<STRUCT<
        key INT64,
        nrv PROTO<googlesql_test.Proto3KitchenSink.Nested>,
        nested_int64 INT64,
        nested_repeated_int64 ARRAY<>
      >>
[unknown order:{4, {nested_int64: 16}, 16, ARRAY<INT64>[]},
               {4, {}, 0, ARRAY<INT64>[]},
               {4,
                {
                  nested_repeated_int64: 17
                  nested_repeated_int64: 17
                },
                0,
                ARRAY<INT64>[known order:17, 17]}]
==

[required_features=SINGLE_TABLE_NAME_ARRAY_PATH]
[name=nested_repeated_proto_field2_from_table_name_array_path]
select nrv, nrv.nested_int64, nrv.nested_repeated_int64
from Table1.value.nested_repeated_value nrv
order by 2
--
ARRAY<STRUCT<
        nrv PROTO<googlesql_test.Proto3KitchenSink.Nested>,
        nested_int64 INT64,
        nested_repeated_int64 ARRAY<>
      >>
[unknown order:{{}, 0, ARRAY<INT64>[]},
               {{
                  nested_repeated_int64: 17
                  nested_repeated_int64: 17
                },
                0,
                ARRAY<INT64>[known order:17, 17]},
               {{nested_int64: 16}, 16, ARRAY<INT64>[]}]
==

[name=nested_repeated_proto_field2_left]
select key, nrv, nrv.nested_int64, nrv.nested_repeated_int64
from Table1 t LEFT JOIN t.value.nested_repeated_value nrv
where key in (1,2,4)
order by key
--
ARRAY<STRUCT<
        key INT64,
        nrv PROTO<googlesql_test.Proto3KitchenSink.Nested>,
        nested_int64 INT64,
        nested_repeated_int64 ARRAY<>
      >>
[unknown order:{1, NULL, NULL, ARRAY<INT64>(NULL)},
               {2, NULL, NULL, ARRAY<INT64>(NULL)},
               {4, {nested_int64: 16}, 16, ARRAY<INT64>[]},
               {4,
                {
                  nested_repeated_int64: 17
                  nested_repeated_int64: 17
                },
                0,
                ARRAY<INT64>[known order:17, 17]},
               {4, {}, 0, ARRAY<INT64>[]}]
==

[name=twice_nested_repeated_proto_field]
select key, nrv.nested_int64, i
from Table1 t, t.value.nested_repeated_value nrv, nrv.nested_repeated_int64 i
where key in (1,2,4)
order by 1,2,3
--
ARRAY<STRUCT<key INT64, nested_int64 INT64, i INT64>>[known order:
  {4, 0, 17},
  {4, 0, 17}
]
==

[required_features=SINGLE_TABLE_NAME_ARRAY_PATH]
[name=twice_nested_repeated_proto_field_from_table_name_array_path]
select nrv.nested_int64, i
from Table1.value.nested_repeated_value nrv, nrv.nested_repeated_int64 i
order by 1,2
--
ARRAY<STRUCT<nested_int64 INT64, i INT64>>[known order:{0, 17}, {0, 17}]
==

[name=twice_nested_repeated_proto_field_left]
select key, nrv.nested_int64, i
from Table1 t
  LEFT JOIN t.value.nested_repeated_value nrv
  LEFT JOIN nrv.nested_repeated_int64 i
where key in (1,2,4)
order by 1,2,3
--
ARRAY<STRUCT<key INT64, nested_int64 INT64, i INT64>>[known order:
  {1, NULL, NULL},
  {2, NULL, NULL},
  {4, 0, NULL},
  {4, 0, 17},
  {4, 0, 17},
  {4, 16, NULL}
]
==

[name=nested_holder]
select key, value.repeated_holder
from Table1 t
where key in (1,2,4)
order by 1
--
ARRAY<STRUCT<
        key INT64,
        repeated_holder ARRAY<>
      >>
[known order:
  {
    1,
    ARRAY<PROTO<googlesql_test.Proto3RepeatedHolderPB>>[]
  },
  {
    2,
    ARRAY<PROTO<googlesql_test.Proto3RepeatedHolderPB>>(NULL)
  },
  {4,
   ARRAY<PROTO<googlesql_test.Proto3RepeatedHolderPB>>[known order:
     {},
     {
       repeated_field {
         int32_val1: 18
       }
       repeated_field {
         int32_val1: 19
         str_value: "abc"
         str_value: "def"
       }
     }
   ]}
]
==

[name=nested_holder2]
select key, off1, off2, f.int32_val1, f.int32_val2, f.str_value
from Table1 t
     LEFT JOIN t.value.repeated_holder h with offset off1
     LEFT JOIN h.repeated_field f with offset off2
where key in (1,2,4)
order by 1,2,3
--
ARRAY<STRUCT<key INT64,
             off1 INT64,
             off2 INT64,
             int32_val1 INT32,
             int32_val2 INT32,
             str_value ARRAY<>>>
[known order:{1, NULL, NULL, NULL, NULL, ARRAY<STRING>(NULL)},
             {2, NULL, NULL, NULL, NULL, ARRAY<STRING>(NULL)},
             {4, 0, NULL, NULL, NULL, ARRAY<STRING>(NULL)},
             {4, 1, 0, 18, 0, ARRAY<STRING>[]},
             {
               4,
               1,
               1,
               19,
               0,
               ARRAY<STRING>[known order:"abc", "def"]
             }]
==

# TODO Figure out how to make dates work in the proto value without
# breaking too many other things.
# [name=date_field]
# select key, value.date, value.has_date
# from Table1 where key != 3 order by 1
# --
# ==
#
# [name=date64_field]
# select key, value.date64, value.has_date64
# from Table1 where key != 3 order by 1
# --
# ==
[name=date_decimal_field]
select key, value.date_decimal, value.has_date_decimal
from Table1 where key != 3 order by 1
--
ARRAY<STRUCT<
        key INT64,
        date_decimal DATE,
        has_date_decimal BOOL
      >>
[known order:
  {1, NULL, false},
  {2, NULL, NULL},
  {4, 2011-02-15, true}
]
==

[name=timestamp_seconds_field]
select key, value.timestamp_seconds, value.has_timestamp_seconds
from Table1 where key != 3 order by 1
--
ARRAY<STRUCT<
        key INT64,
        timestamp_seconds TIMESTAMP,
        has_timestamp_seconds BOOL
      >>
[known order:{
               1,
               1970-01-01 00:00:00+00,
               false
             },
             {2, NULL, NULL},
             {
               4,
               2014-08-26 22:14:08+00,
               true
             }]
==

[name=timestamp_millis_field]
select key, value.timestamp_millis, value.has_timestamp_millis
from Table1 where key != 3 order by 1
--
ARRAY<STRUCT<
        key INT64,
        timestamp_millis TIMESTAMP,
        has_timestamp_millis BOOL
      >>
[known order:{
               1,
               1970-01-01 00:00:00+00,
               false
             },
             {2, NULL, NULL},
             {
               4,
               2014-08-26 22:14:08.111+00,
               true
             }]
==

[name=timestamp_micros_field]
select key, value.timestamp_micros, value.has_timestamp_micros
from Table1 where key != 3 order by 1
--
ARRAY<STRUCT<
        key INT64,
        timestamp_micros TIMESTAMP,
        has_timestamp_micros BOOL
      >>
[known order:{
               1,
               1970-01-01 00:00:00+00,
               false
             },
             {2, NULL, NULL},
             {
               4,
               2014-08-26 22:14:08.111222+00,
               true
             }]
==

[name=timestamp_uint64_field]
select key, value.timestamp_uint64, value.has_timestamp_uint64
from Table1 where key != 3 order by 1
--
ARRAY<STRUCT<
        key INT64,
        timestamp_uint64 TIMESTAMP,
        has_timestamp_uint64 BOOL
      >>
[known order:{
               1,
               1970-01-01 00:00:00+00,
               false
             },
             {2, NULL, NULL},
             {
               4,
               2014-08-07 17:15:00.000007+00,
               true
             }]
==

[name=read_grandchild_with_missing_parent]
select key, value.has_nested_value, value.nested_value.nested_int64
from Table1 order by key
--
ARRAY<STRUCT<
        key INT64,
        has_nested_value BOOL,
        nested_int64 INT64
      >>
[known order:{1, false, NULL}, {2, NULL, NULL}, {3, true, 10}, {4, true, 14}]
==

[name=has_grandchild_with_missing_parent]
select key, value.has_nested_value, value.nested_value.has_nested_int64
from Table1 order by key
--
ARRAY<STRUCT<
        key INT64,
        has_nested_value BOOL,
        has_nested_int64 BOOL
      >>
[known order:{1, false, NULL},
             {2, NULL, NULL},
             {3, true, true},
             {4, true, true}]
==

[name=grandchild_is_null_with_missing_parent]
select key, value is null, value.nested_value is null, value.nested_value.nested_int64 is null
from Table1 order by key
--
ARRAY<STRUCT<key INT64, BOOL, BOOL, BOOL>>[known order:
  {1, false, true, true},
  {2, true, true, true},
  {3, false, false, false},
  {4, false, false, false}
]
==

[name=read_field_from_null]
select value.nested_int64, value.has_nested_int64, value.nested_int64 is null
from (select cast(NULL as googlesql_test.Proto3KitchenSink.Nested) value)
--
ARRAY<STRUCT<
        nested_int64 INT64,
        has_nested_int64 BOOL,
        BOOL
      >>[{NULL, NULL, true}]
==

[name=construct_proto_with_null_field_and_extract]
select p.int32_val1, p.int32_val2
from
  (select 1 r, NEW googlesql_test.Proto3TestExtraPB(1 as int32_val1) p
   union all
   select 2, NEW googlesql_test.Proto3TestExtraPB(null as int32_val1))
order by r
--
ARRAY<STRUCT<int32_val1 INT32, int32_val2 INT32>>[known order:{1, 0}, {0, 0}]
==

[required_features=PROTO_DEFAULT_IF_NULL]
[name=proto_default_if_null_optional]
select value.int32_val, proto_default_if_null(value.int32_val)
from Table1
--
ARRAY<STRUCT<int32_val INT32, INT32>>[unknown order:
  {NULL, 0},
  {12, 12},
  {0, 0},
  {6, 6}
]
==

[required_features=PROTO_DEFAULT_IF_NULL]
[name=proto_default_if_null_repeated]
select value.repeated_int32_val, proto_default_if_null(value.repeated_int32_val)
from Table1
--
ARRAY<STRUCT<
        repeated_int32_val ARRAY<>,
        ARRAY<>
      >>
[unknown order:
  {ARRAY<INT32>(NULL), ARRAY<INT32>[]},
  {ARRAY<INT32>[13], ARRAY<INT32>[13]},
  {ARRAY<INT32>[], ARRAY<INT32>[]},
  {ARRAY<INT32>[], ARRAY<INT32>[]}
]
==

[required_features=PROTO_DEFAULT_IF_NULL]
[name=proto_default_if_null_annotated_field]
select value.date, proto_default_if_null(value.date)
from Table1
--
ARRAY<STRUCT<date DATE, DATE>>[unknown order:
  {NULL, 1970-01-01},
  {1970-01-08, 1970-01-08},
  {1970-01-01, 1970-01-01},
  {1970-01-01, 1970-01-01}
]
==

[required_features=PROTO_DEFAULT_IF_NULL]
[name=proto_default_if_null_annotated_field_with_default]
select value.date_default, proto_default_if_null(value.date_default)
from Table1
--
ARRAY<STRUCT<date_default DATE, DATE>>[unknown order:
  {NULL, 1970-01-01},
  {1970-01-14, 1970-01-14},
  {1970-01-01, 1970-01-01},
  {1970-01-01, 1970-01-01}
]
==


[required_features=PROTO_DEFAULT_IF_NULL]
[name=proto_default_if_null_proto_table]
select proto_default_if_null(float_val)
from (select as googlesql_test.Proto3KitchenSink
      5 int32_val, NULL float_val)
--
ARRAY<STRUCT<FLOAT>>[{0}]
==

[required_features=EXTRACT_FROM_PROTO]
[name=extract_field_optional]
select extract(field(int32_val) from value)
from Table1
--
ARRAY<STRUCT<INT32>>[unknown order:{NULL}, {12}, {0}, {6}]
==

[required_features=EXTRACT_FROM_PROTO]
[name=extract_field_repeated]
select extract(field(repeated_int32_val) from value)
from Table1
--
ARRAY<STRUCT<ARRAY<>>>[unknown order:
  {ARRAY<INT32>(NULL)},
  {ARRAY<INT32>[13]},
  {ARRAY<INT32>[]},
  {ARRAY<INT32>[]}
]
==

[required_features=EXTRACT_FROM_PROTO]
[name=extract_field_nested_message]
select extract(field(nested_value) from value)
from Table1
--
ARRAY<STRUCT<PROTO<googlesql_test.Proto3KitchenSink.Nested>>>[unknown order:
  {NULL},
  {{
     nested_int64: 14
     nested_repeated_int64: 15
     nested_repeated_int64: 15
   }},
  {NULL},
  {{
     nested_int64: 10
     nested_repeated_int64: 11
     nested_repeated_int64: 12
   }}
]
==

[required_features=EXTRACT_FROM_PROTO]
[name=extract_has_field_optional]
select extract(has(int32_val) from value)
from Table1
--
ARRAY<STRUCT<BOOL>>[unknown order:{NULL}, {true}, {false}, {true}]
==

[required_features=EXTRACT_FROM_PROTO]
[name=extract_has_field_nested_message]
select extract(has(nested_value) from value)
from Table1
--
ARRAY<STRUCT<BOOL>>[unknown order:{NULL}, {true}, {false}, {true}]
==

[required_features=EXTRACT_FROM_PROTO]
[name=extract_raw_optional_primitive]
select extract(raw(int64_val) from value)
from Table1
--
ARRAY<STRUCT<INT64>>[unknown order:{NULL}, {12}, {0}, {0}]
==

[required_features=EXTRACT_FROM_PROTO]
[name=extract_raw_field_date]
select extract(raw(date) from value)
from Table1
--
ARRAY<STRUCT<INT32>>[unknown order:{NULL}, {7}, {0}, {0}]
==

[required_features=EXTRACT_FROM_PROTO]
[name=extract_raw_field_date_decimal]
select extract(raw(date_decimal) from value)
from Table1
--
ARRAY<STRUCT<INT32>>[unknown order:{NULL}, {20110215}, {0}, {0}]
==

[required_features=EXTRACT_FROM_PROTO]
[name=extract_raw_field_timestamp]
select extract(raw(timestamp_micros) from value)
from Table1
--
ARRAY<STRUCT<INT64>>[unknown order:{NULL}, {1409091248111222}, {0}, {0}]
==

[required_features=EXTRACT_FROM_PROTO]
[name=extract_raw_field_primitive]
select extract(raw(int32_val) from value)
from Table1
--
ARRAY<STRUCT<INT32>>[unknown order:{NULL}, {12}, {0}, {6}]
==

[required_features=EXTRACT_FROM_PROTO]
[name=extract_raw_field_repeated_primitive]
select extract(raw(repeated_int32_val) from value)
from Table1
--
ARRAY<STRUCT<ARRAY<>>>[unknown order:
  {ARRAY<INT32>(NULL)},
  {ARRAY<INT32>[13]},
  {ARRAY<INT32>[]},
  {ARRAY<INT32>[]}
]
==

[required_features=EXTRACT_FROM_PROTO]
[name=extract_raw_field_repeated_date]
select extract(raw(repeated_date) from value)
from Table1
--
ARRAY<STRUCT<ARRAY<>>>[unknown order:
  {ARRAY<INT32>(NULL)},
  {ARRAY<INT32>[]},
  {ARRAY<INT32>[]},
  {ARRAY<INT32>[]}
]
==

[name=proto_default_if_null_in_both_select_and_group_by]
[required_features=PROTO_DEFAULT_IF_NULL]
SELECT
  PROTO_DEFAULT_IF_NULL(value.int32_val)
FROM Table1
GROUP BY PROTO_DEFAULT_IF_NULL(value.int32_val)
--
ARRAY<STRUCT<INT32>>[unknown order:{0}, {6}, {12}]
